<!doctype html>
<html lang="es" data-theme="finpro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SGF — v 1.260802.01_estable</title>

  <!-- Bootstrap (requerido por SGF_v1_00_00.js) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
/* =======================
   SGF UI (Prototype look) + SGF v1_00_00 functionality
   - Layout inspirado en SGF_UI_Prototype_v1.html
   - Funcionalidad: SGF_v1_00_00.js
   ======================= */

/* Theme tokens (map: finpro/finsoft/darkledger) */
:root{
  --bg:#f6f7fb;--panel:#ffffff;--panel2:#fbfbfd;--text:#0f172a;--muted:#5b6475;--border:rgba(15,23,42,.10);
  --shadow:0 10px 28px rgba(2,6,23,.10);--shadow2:0 8px 18px rgba(2,6,23,.08);
  --brand:#2563eb;--brand2:#0ea5e9;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;
  --chip:rgba(37,99,235,.10);--chipText:#1d4ed8;--focus:rgba(37,99,235,.25);--stripe:rgba(2,6,23,.03);
  --radius:18px;--r2:14px;
  --font:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
}
html[data-theme="finpro"]{
  /* mismo que :root */
}
html[data-theme="finsoft"]{
  --bg:#fbfbfe;--panel:#ffffff;--panel2:#f6f7fb;
  --shadow:0 10px 26px rgba(2,6,23,.08);--shadow2:0 8px 16px rgba(2,6,23,.07);
  --chip:rgba(14,165,233,.10);--chipText:#0369a1;--focus:rgba(14,165,233,.20);
}
html[data-theme="darkledger"]{
  --bg:#0b1220;--panel:#0f172a;--panel2:#0c1426;--text:#ffffff;--muted:#a4aec3;--border:rgba(226,232,240,.12);
  --shadow:0 14px 40px rgba(0,0,0,.40);--shadow2:0 10px 26px rgba(0,0,0,.32);
  --brand:#60a5fa;--brand2:#22d3ee;--good:#34d399;--warn:#fbbf24;--bad:#fb7185;
  --chip:rgba(96,165,250,.15);--chipText:#93c5fd;--focus:rgba(96,165,250,.28);--stripe:rgba(255,255,255,.04);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1200px 500px at 18% 0%, rgba(37,99,235,.10), transparent 55%),
    radial-gradient(900px 450px at 80% 0%, rgba(14,165,233,.10), transparent 55%),
    var(--bg);
}

/* Layout (Prototype) */
.app{display:grid;grid-template-columns:292px 1fr;min-height:100vh}
.sidebar{
  position:sticky;top:0;height:100vh;overflow:auto;padding:16px 14px;
  background:linear-gradient(180deg, rgba(255,255,255,.75), transparent 75%), var(--panel2);
  border-right:1px solid var(--border)
}
html[data-theme="darkledger"] .sidebar{
  background:linear-gradient(180deg, rgba(15,23,42,.68), transparent 75%), var(--panel2);
}
.brand{display:flex;gap:10px;align-items:center;justify-content:center;padding:10px}
.logo{
  height:36px;min-width:36px;padding:0 12px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;
  font-weight:800;font-size:12px;letter-spacing:.2px;white-space:nowrap;
  box-shadow:var(--shadow2)
}

.logo i{font-size:18px;line-height:1;display:block}
html[data-theme="darkledger"] .logo{color:#fff}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.main{min-width:0;display:flex;flex-direction:column}

.topbar{
  position:sticky;top:0;z-index:5;
  background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,0)), var(--panel2);
  border-bottom:1px solid var(--border);
  padding:12px 16px;
}
html[data-theme="darkledger"] .topbar{
  background:linear-gradient(180deg, rgba(15,23,42,.68), rgba(15,23,42,0)), var(--panel2);
}
.toprow{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1400px;margin:0 auto}
.hamb{
  display:none;
  width:44px;height:40px;border-radius:14px;border:1px solid var(--border);
  background:var(--panel);box-shadow:var(--shadow2);
}
.title h1{margin:0;font-size:18px}
.crumb{margin-top:2px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

.content{padding:16px;max-width:1400px;margin:0 auto;width:100%}

/* Responsive: desktop sidebar + mobile offcanvas */
@media (max-width:991.98px){
  .app{grid-template-columns:1fr}
  .sidebar{display:none}
  .hamb{display:inline-flex;align-items:center;justify-content:center}
}

/* =======================
   Layout option: Sidebar vs Top menu
   - Default: sidebar (current)
   - layout-top: hide sidebar on desktop and show top horizontal nav
   ======================= */
.topnav{
  display:none;
  max-width:1400px;
  margin:10px auto 0;
  padding:0 0 6px;
}
.sgf-nav-top{
  flex-direction:row;
  gap:8px;
  padding:0;
  flex-wrap:nowrap;
  overflow:auto;
  scrollbar-width:thin;
}
.sgf-nav-top .nav-link{
  white-space:nowrap;
  padding:8px 12px !important;
  border-radius:999px;
}
.sgf-nav-top .nav-link i.bi{
  width:28px;height:28px;border-radius:999px;
}

/* Top menu MUST be horizontal (strong override) */
body.layout-top .sgf-nav-top{
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  flex-wrap:nowrap !important;
}
body.layout-top .sgf-nav-top > li,
body.layout-top .sgf-nav-top .nav-item{
  flex:0 0 auto !important;
}
body.layout-top .sgf-nav-top .nav-link{
  width:auto !important;
}
body.layout-top .app{grid-template-columns:1fr}
body.layout-top .sidebar{display:none}
body.layout-top .topnav{display:block}
@media (max-width:991.98px){
  body.layout-top .topnav{display:none}
}


/* =======================
   Bootstrap look -> Prototype look (scoped)
   ======================= */
.sgf-shell{
  --bs-body-color:var(--text);
  --bs-body-bg:transparent;
  --bs-border-color:var(--border);
  --bs-border-color-translucent:var(--border);
}

/* Cards */
.sgf-shell .card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.sgf-shell .card-header{
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(37,99,235,.06), transparent);
}
html[data-theme="darkledger"] .sgf-shell .card-header{
  background:linear-gradient(180deg, rgba(96,165,250,.10), transparent);
}
.sgf-shell .card-body{padding:14px}
.sgf-shell .card .card-body.filters-bar{padding:14px}
.sgf-shell hr{border-color:var(--border)}

/* Buttons */
.sgf-shell .btn{
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
  box-shadow:var(--shadow2);
  font-weight:800;
  transition:transform .04s;
}
.sgf-shell .btn:hover{transform:translateY(-1px)}
.sgf-shell .btn:active{transform:translateY(0)}
.sgf-shell .btn-dark,
.sgf-shell .btn-primary{
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  border-color:transparent;
  color:#fff;
}
.sgf-shell .btn-outline-dark,
.sgf-shell .btn-outline-secondary,
.sgf-shell .btn-outline-primary,
.sgf-shell .btn-outline-success,
.sgf-shell .btn-outline-danger{
  background:var(--panel);
}
.sgf-shell .btn-outline-dark{color:var(--text)}
.sgf-shell .btn-outline-primary{color:var(--chipText);border-color:rgba(37,99,235,.24)}
.sgf-shell .btn-outline-success{color:var(--good);border-color:rgba(22,163,74,.28)}
.sgf-shell .btn-outline-danger{color:var(--bad);border-color:rgba(239,68,68,.28)}
.sgf-shell .btn-sm{padding:.42rem .62rem;border-radius:12px;font-weight:800}
.sgf-shell .btn-group .btn{box-shadow:none}
.sgf-shell .btn-close{filter:none}

/* Inputs */
.sgf-shell .form-control,
.sgf-shell .form-select,
.sgf-shell .input-group-text{
  border-radius:14px !important;
  border:1px solid var(--border) !important;
  background:var(--panel2) !important;
  color:var(--text) !important;
  box-shadow:none !important;
}
.sgf-shell .input-group > :not(:first-child){border-left:0 !important}
.sgf-shell .input-group-text{color:var(--muted)}
.sgf-shell .form-control:focus,
.sgf-shell .form-select:focus{
  box-shadow:0 0 0 6px var(--focus) !important;
  border-color:rgba(37,99,235,.35) !important;
}

/* Tables */
.sgf-shell .table{
  --bs-table-bg:transparent;
  color:var(--text);
  margin:0;
}
.sgf-shell .table-responsive{
  border-radius:var(--r2);
  border:1px solid var(--border);
}
.sgf-shell .table > :not(caption) > * > *{
  border-bottom:1px solid var(--border);
}
.sgf-shell .table thead th{
  position:sticky; top:0; z-index:1;
  background:var(--panel2);
  color:var(--muted);
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.sgf-shell .table-striped > tbody > tr:nth-of-type(odd) > *{
  background:var(--stripe);
}
.sgf-shell .progress{height:8px;border-radius:999px;background:rgba(2,6,23,.06)}
html[data-theme="darkledger"] .sgf-shell .progress{background:rgba(255,255,255,.08)}
.sgf-shell .progress-bar{background:linear-gradient(135deg,var(--brand),var(--brand2))}

/* Badges */
.badge-soft{
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  color:var(--muted);
  background:rgba(2,6,23,.03);
}
html[data-theme="darkledger"] .badge-soft{background:rgba(255,255,255,.06)}

/* Nav (generated by SGF buildNav) */
.sgf-nav{display:flex;flex-direction:column;gap:6px;padding:8px;margin:0;list-style:none}
.sgf-nav .nav-link{
  border-radius:14px;
  border:1px solid transparent;
  color:var(--muted);
  transition:background .2s,border-color .2s,color .2s;
}
.sgf-nav .nav-link:hover{
  background:rgba(37,99,235,.08);
  border-color:rgba(37,99,235,.16);
  color:var(--text);
}
.sgf-nav .nav-link.active{
  background:rgba(37,99,235,.12);
  border-color:rgba(37,99,235,.24);
  color:var(--text);
}
.sgf-nav .nav-link i.bi{
  width:30px;height:30px;border-radius:12px;
  display:inline-grid;place-items:center;
  border:1px solid var(--border);
  background:rgba(2,6,23,.06);
}
html[data-theme="darkledger"] .sgf-nav .nav-link i.bi{background:rgba(255,255,255,.06)}

/* KPI blocks (Dashboard) */
.kpi{
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  background:var(--panel);
  padding:14px;
}
.kpi-title{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.4px}
.kpi-value{font-size:26px;font-weight:900;margin-top:2px}
.kpi-sub{margin-top:6px;font-size:12px;color:var(--muted)}
.kpi-income{border-left:6px solid var(--good)}
.kpi-expense{border-left:6px solid var(--warn)}
.kpi-savings{border-left:6px solid var(--brand2)}
.kpi-neutral{border-left:6px solid var(--brand)}
.kpi-warn{border-left:6px solid var(--bad)}

/* Tree view */
.tree ul{padding-left:0;margin:0;list-style:none}
.tree li{margin:6px 0}
.tree .node{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid transparent;
  color:var(--muted);
}
.tree .node:hover{background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.16);color:var(--text)}
.tree .node.sel{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.24);color:var(--text)}
.tree .caret{cursor:pointer;min-width:22px;display:inline-flex;justify-content:center}
.tree .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
.tree .name{font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.tree .meta{margin-left:auto;display:flex;align-items:center}
.tree .actions{display:flex;gap:6px;margin-left:10px}
.tree ul.hide{display:none}
.tree ul ul{margin-left:22px;padding-left:20px;border-left:1px solid var(--border)}
.tree ul ul ul{margin-left:18px;padding-left:26px}

/* Links */
a.dash-link, a{color:inherit;text-decoration:none}
.sgf-link{color:inherit}
.sgf-link:hover{text-decoration:underline}
.rep-link{
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  padding:.18rem .55rem;
  background:rgba(255,255,255,.85);
  border:1px solid rgba(15,23,42,.14);
  border-radius:999px;
  color:inherit;
  text-decoration:underline;
  font-weight:700;
  line-height:1.1;
  box-shadow:0 1px 2px rgba(15,23,42,.08);
}
.rep-link:hover{
  background:rgba(255,255,255,1);
  border-color:rgba(15,23,42,.22);
  text-decoration:underline;
  color:inherit;
}
.rep-link:focus{
  outline:none;
  box-shadow:0 0 0 .2rem rgba(37,99,235,.18);
}

a.dash-link:hover{text-decoration:underline}

/* Offcanvas & modals look */
.offcanvas{
  background:var(--panel2);
  color:var(--text);
  border-right:1px solid var(--border);
}

/* --- SGF Modals (match app design) --- */
.sgf-modal .modal-dialog{ --bs-modal-margin:1.25rem; }
.sgf-modal .modal-content{
  border-radius:22px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  background:var(--panel);
  color:var(--text);
  overflow:hidden;
}
.sgf-modal .modal-header{
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  padding:1rem 1.25rem;
}
.sgf-modal .modal-title{
  font-weight:800;
  letter-spacing:.2px;
}
.sgf-modal .modal-subtitle{
  margin-top:.15rem;
  font-size:.9rem;
  color:var(--muted);
}
.sgf-modal .modal-body{
  padding:1rem 1.25rem 1.25rem 1.25rem;
}
.sgf-modal .modal-footer{
  border-top:1px solid var(--border);
  background:color-mix(in srgb, var(--panel2) 88%, transparent);
  padding:.9rem 1.25rem;
  gap:.5rem;
}

/* Sticky footer for long forms */
.sgf-modal .modal-dialog-scrollable .modal-footer{
  position:sticky;
  bottom:0;
  z-index:5;
  backdrop-filter:saturate(1.2) blur(8px);
}


/* Modal button palette (match Prototype) */
.sgf-modal .btn{
  border-radius:14px;
  font-weight:700;
  letter-spacing:.15px;
}
.sgf-modal .btn.btn-dark{
  /* SGF JS usa btn-dark para acciones primarias en modales */
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  border-color:transparent;
  color:#fff;
  box-shadow:0 10px 22px rgba(37,99,235,.18);
}
.sgf-modal .btn.btn-dark:hover{filter:brightness(1.03)}
.sgf-modal .btn.btn-dark:active{transform:translateY(1px)}
.sgf-modal .btn.btn-dark:focus{
  box-shadow:0 0 0 .25rem var(--focus), 0 10px 22px rgba(37,99,235,.18);
}

.sgf-modal .btn-outline-dark{
  /* Botones tipo Cerrar/Cancelar */
  color:var(--text);
  border-color:var(--border);
  background:transparent;
}
.sgf-modal .btn-outline-dark:hover{
  background:color-mix(in srgb, var(--chip) 65%, transparent);
  border-color:color-mix(in srgb, var(--brand) 35%, var(--border));
}
.sgf-modal .btn-outline-dark:focus{box-shadow:0 0 0 .25rem var(--focus)}

.sgf-modal .btn-danger{
  border-color:transparent;
  box-shadow:0 10px 22px rgba(239,68,68,.14);
}

/* Close button visibility on dark */
.theme-darkledger .sgf-modal .btn-close{
  filter:invert(1) grayscale(100%);
  opacity:.85;
}
.theme-darkledger .sgf-modal .btn-close:hover{ opacity:1; }

/* Normalize Bootstrap light/white utilities inside modals */
.theme-darkledger .sgf-modal .bg-white,
.theme-darkledger .sgf-modal .bg-light,
.theme-darkledger .sgf-modal .table-light,
.theme-darkledger .sgf-modal .text-bg-light{
  background-color:var(--panel2) !important;
  color:var(--text) !important;
}

/* Buttons: keep existing markup but theme them properly */
.theme-darkledger .btn-outline-dark{
  color:var(--text) !important;
  border-color:color-mix(in srgb, var(--border) 70%, transparent) !important;
}
.theme-darkledger .btn-outline-dark:hover{
  background:color-mix(in srgb, var(--panel2) 70%, transparent) !important;
}

/* Inputs inside modals */
.sgf-modal .form-control,
.sgf-modal .form-select{
  border-radius:14px;
}
.sgf-modal .input-group-text{
  border-radius:14px;
}

/* =======================
   Dark Ledger: force legibility (white text)
   ======================= */
html[data-theme="darkledger"]{
  --text:#ffffff;
}
html[data-theme="darkledger"] .text-dark{ color:#ffffff !important; }
html[data-theme="darkledger"] .text-secondary{ color:rgba(255,255,255,.85) !important; }
html[data-theme="darkledger"] .text-muted{ color:rgba(255,255,255,.70) !important; }

html[data-theme="darkledger"] .text-bg-light{
  background-color:rgba(255,255,255,.14) !important;
  color:#ffffff !important;
}
html[data-theme="darkledger"] .bg-light{
  background-color:rgba(255,255,255,.08) !important;
}

html[data-theme="darkledger"] ::placeholder{ color:rgba(255,255,255,.60) !important; }
html[data-theme="darkledger"] .btn-close{ filter:invert(1) grayscale(100%); }

/* Dark Ledger: tables & light rows (avoid white blocks) */
html[data-theme="darkledger"] .sgf-shell .table{
  --bs-table-color: var(--text) !important;
  --bs-table-border-color: rgba(255,255,255,.12) !important;
  --bs-table-striped-bg: rgba(255,255,255,.04) !important;
  --bs-table-striped-color: var(--text) !important;
  --bs-table-active-bg: rgba(255,255,255,.06) !important;
  --bs-table-active-color: var(--text) !important;
  --bs-table-hover-bg: rgba(255,255,255,.06) !important;
  --bs-table-hover-color: var(--text) !important;
}
/* Bootstrap helper backgrounds that are hard-coded to white */
html[data-theme="darkledger"] .bg-white,
html[data-theme="darkledger"] .bg-light{
  background-color: var(--panel2) !important;
  color: var(--text) !important;
}
/* Rows/cells marked as table-light (tfoot totals, pivot net rows, etc.) */
html[data-theme="darkledger"] .table-light{
  --bs-table-color: var(--text) !important;
  --bs-table-bg: rgba(255,255,255,.06) !important;
  --bs-table-border-color: rgba(255,255,255,.12) !important;
  color: var(--text) !important;
}
html[data-theme="darkledger"] .table-light > :not(caption) > * > *{
  background-color: rgba(255,255,255,.06) !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.12) !important;
}
/* Ensure sticky headers stay dark even if JS adds bg-white */
html[data-theme="darkledger"] .table thead.bg-white,
html[data-theme="darkledger"] .table thead.bg-light{
  background-color: var(--panel2) !important;
}


/* ===== UI tweaks (unificar tipografía / evitar bold / tablas menos estrechas) ===== */
.sgf-shell, .sgf-shell *{ font-family: var(--font); }
.sgf-shell .fw-bold,
.sgf-shell .fw-semibold,
.sgf-shell strong,
.sgf-shell b{ font-weight:500 !important; } /* neutraliza excesos de bold */
.sgf-shell h1,.sgf-shell h2,.sgf-shell h3,.sgf-shell h4,.sgf-shell h5,.sgf-shell h6{ font-weight:600; }
.sgf-shell .sgf-nav .nav-link span{ font-weight:500; }
.sgf-shell label, .sgf-shell .form-label{ font-weight:500; }
.sgf-shell .table th{ font-weight:500; }
.sgf-shell .table td{ font-weight:400; }

/* tablas: más aire y menos “apretadas” */
.sgf-shell .table th,
.sgf-shell .table td{
  padding:.85rem 1rem;
  vertical-align:middle;
  min-width:130px;
}
.sgf-shell .table th:last-child,
.sgf-shell .table td:last-child{
  min-width:96px;
}
@media (max-width: 576px){
  .sgf-shell .table th,
  .sgf-shell .table td{ min-width:110px; }
}


/* === v3 tweaks: tablas más espaciosas + filtros colapsables === */
.table td, .table th{ padding:.8rem 1.15rem; }
.table thead th{ white-space:nowrap; }
.table td{ vertical-align:middle; }
.table-responsive{ overflow-x:auto; }
.table{ min-width: 1120px; }


/* === v8: Ajuste de tablas en Configuración (FX histórico / Auto-backups) === */
#v-settings .table{ min-width:0 !important; width:100% !important; }
#v-settings .table th, #v-settings .table td{ min-width:0 !important; white-space:normal; }
#v-settings .table thead th{ white-space:nowrap; } /* headers cortos */
#v-settings .table td{ word-break:break-word; }
#v-settings .table td:last-child, #v-settings .table th:last-child{ white-space:nowrap; } /* acciones */
#v-settings .table-responsive{ overflow-x:hidden; } /* evita scroll innecesario si cabe */
@media (max-width: 768px){
  #v-settings .table-responsive{ overflow-x:auto; } /* en móvil sí */
}


/* filtros collapsible */
.filters-bar{ position:relative; }
.filters-bar .btn.sgf-filters-toggle{ padding:.25rem .5rem; }
.filters-bar.sgf-filters-collapsed .sgf-filters-collapsible{ display:none !important; }


/* Actions column: keep buttons aligned in one row */
.table th:last-child, .table td:last-child{white-space:nowrap}
.table td:last-child{min-width:140px}
.table td:last-child .btn.btn-sm{
  width:38px;height:38px;padding:0;
  display:inline-flex;align-items:center;justify-content:center;
  border-radius:12px;
  margin-left:.4rem;
}
.table td:last-child .btn.btn-sm:first-child{margin-left:0}












/* v1.00.8 - Pivot Pro: categorías clickeables SOLO texto azul tipo link (forzado) */
a.rep-link,
button.rep-link,
.rep-link{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0 !important;

  display: inline !important;
  color: var(--primary, #2563eb) !important;
  font-weight: 700 !important;
  text-decoration: underline !important;
  text-underline-offset: 2px !important;
  text-decoration-thickness: 2px !important;

  cursor: pointer !important;
}
a.rep-link:visited{ color: var(--primary, #2563eb) !important; }
a.rep-link:hover,
button.rep-link:hover,
.rep-link:hover{
  filter: brightness(.9) !important;
}


/* --- AUTH (local) --- */
.auth-overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,.75),rgba(2,6,23,.55));display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}
.auth-card{width:min(520px,100%);background:var(--panel2,#fff);color:var(--text,#0f172a);border:1px solid var(--border,rgba(15,23,42,.12));border-radius:16px;box-shadow:0 24px 64px rgba(2,6,23,.35);overflow:hidden}
.auth-head{padding:18px 18px 0 18px}
.auth-title{font-weight:800;font-size:1.1rem}
.auth-sub{color:var(--muted,#64748b);font-size:.92rem;margin-top:4px}
.auth-body{padding:18px;display:grid;gap:12px}
.auth-actions{padding:0 18px 18px 18px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
.auth-msg{padding:0 18px 16px 18px}

</style>
</head>
<body class="layout-side">
  <div class="app sgf-shell">
    <aside class="sidebar">
      <div class="brand"><div class="logo" aria-label="SGF v 1.260802.01_estable">SGF v 1.260802.01_estable</div></div>

      <nav>
        <ul id="navDesk" class="sgf-nav"></ul>
      </nav>

      <div style="padding:12px 10px 6px;margin-top:12px;border-top:1px dashed var(--border);color:var(--muted);font-size:12px">
        <div class="d-flex justify-content-between align-items-center">
          <span>Atajos</span>
          <span class="badge-soft">Ctrl + K</span>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <button class="btn btn-sm btn-dark" type="button" onclick="go('movements');movEdit();"><i class="bi bi-plus-lg"></i> Nuevo</button>
          </div>
        <div style="margin-top:10px">Datos en <b>LocalStorage</b>. Exporta/Importa desde Atajos.</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="toprow">
          <div class="d-flex align-items-center gap-2" style="min-width:0">
            <button class="hamb" type="button" data-bs-toggle="offcanvas" data-bs-target="#ocNav" aria-controls="ocNav" aria-label="Abrir menú">☰</button>
            <div class="title" style="min-width:0">
              <h1 id="pageTitle">Sistema de Gestión Financiera</h1>
              <div class="crumb" id="pageCrumb">KPIs • Top gastos/cuentas</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-primary" id="btnQuickAdd" type="button"><i class="bi bi-plus-lg"></i> Nuevo</button>
            <button class="btn btn-outline-dark" id="btnConfig" type="button" onclick="go('settings');"><i class="bi bi-gear"></i> Configuración</button>
            <button class="btn btn-outline-dark" id="btnExport" type="button" onclick="exportJson();"><i class="bi bi-download"></i> Exportar</button>
            <button class="btn btn-outline-danger" id="btnLogout" type="button" onclick="authLogout()" title="Cerrar sesión"><i class="bi bi-box-arrow-right"></i> Salir</button>
          </div>
        </div>
        <div class="topnav" id="topNavWrap">
          <ul id="navTop" class="sgf-nav sgf-nav-top"></ul>
        </div>
      </header>

      <section class="content">
        <div id="v-dashboard" class="view"></div>
        <div id="v-accounts" class="view d-none"></div>
        <div id="v-categories" class="view d-none"></div>
        <div id="v-movements" class="view d-none"></div>
        <div id="v-reconciliations" class="view d-none"></div>
        <div id="v-savings" class="view d-none"></div>
        <div id="v-budgets" class="view d-none"></div>
        <div id="v-reports" class="view d-none"></div>
        <div id="v-settings" class="view d-none"></div>
      </section>
    </main>
  </div>

  <!-- Mobile Nav (Bootstrap Offcanvas) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="ocNav" aria-labelledby="ocNavLabel">
    <div class="offcanvas-header">
      <div class="w-100 d-flex justify-content-center">
        <div class="logo" aria-label="SGF v 1.100_estable">SGF v 1.100_estable</div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <ul id="navMob" class="sgf-nav"></ul>
      <div class="mt-3 small text-secondary">Usa Atajos para exportar/importar datos.</div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <!-- Modal: Message -->
  <div class="modal fade sgf-modal" id="msgM" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center gap-2">
            <span id="msgB" class="badge rounded-pill">INFO</span>
            <div><h5 class="modal-title m-0" id="msgT">Mensaje</h5><div class="modal-subtitle" id="msgS">Notificación</div></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="msgC"></div>
        <div class="modal-footer">
          <button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Help -->
  <div class="modal fade sgf-modal" id="helpM" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div><h5 class="modal-title" id="helpT">Ayuda</h5><div class="modal-subtitle">Guía rápida del sistema</div></div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="helpC"></div>
        <div class="modal-footer">
          <button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Editor (generic) -->
  <div class="modal fade sgf-modal" id="editM" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div><h5 class="modal-title" id="editT">Editor</h5><div class="modal-subtitle" id="editS">Complete la información</div></div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="editC"></div>
        <div class="modal-footer" id="editF"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SGF v1_00_00 (inline) -->
  <script>
const APP_VERSION='SGF v 1.100_estable';
const APP_VERSION_NUM='1.100';
/* SGF v 1.100_estable — basado en el documento adjunto (detalle SGF) */
const STORAGE_KEY="sgf_v1_0";
const LEGACY_KEYS=["sgf_v1_100","sgf_v1_200","sgf_v1_101"];
const COLL_KEYS={acc:"sgf_v1_0_accTreeCollapsed_v2",cat:"sgf_v1_0_catTreeCollapsed_v2"};

// ===== Estructura predefinida (Cuentas + Categorías) =====
const STRUCTURE_PRESET_JKSOTOROJAS = {"config":{"baseCurrency":"CRC","fxRates":{"USD":500},"fxHistory":[{"currency":"USD","date":"2026-01-01","rate":500}],"savingsAccountId":"8e0518af-8760-4f01-b706-5a26aca4ddca","savingsAccountIdUSD":"9d9c31c7-248c-4aa0-8092-b4fa19e00ef5","theme":"finpro","navLayout":"side","autoBackupEnabled":true,"autoBackupEveryOps":25,"autoBackupMax":5},"accounts":[{"id":"81943880-bb60-48ac-a8dc-6dcc676f0c35","name":"Bancos","type":"Banco","parentId":null,"active":true,"color":"#0d6efd","currency":"CRC","allowNegative":false},{"id":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","name":"Tarjetas","type":"Tarjeta","parentId":null,"active":true,"color":"#f59e0b","currency":"CRC","allowNegative":true},{"id":"d4519fd1-cbce-49d9-b658-cbc5362f5a6c","name":"Billeteras","type":"Efectivo","parentId":null,"active":true,"color":"#1eccb5","currency":"CRC","allowNegative":false},{"id":"cf0373dd-0ebf-4a89-9fdb-62469c684974","name":"BAC Colones","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#32a9f7","currency":"CRC","allowNegative":false},{"id":"5dac6a41-405d-443e-b48d-dbece9eb3223","name":"BAC Dólares","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#3ca0f7","currency":"USD","allowNegative":false},{"id":"40a84cf7-4ff4-452b-812e-48a74a564202","name":"BCR Colones","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#4599f8","currency":"CRC","allowNegative":false},{"id":"be612cba-92f0-451c-b42f-ee6b7a6f9b29","name":"BCR Dólares","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#4f93f8","currency":"USD","allowNegative":false},{"id":"3ac486b7-36cf-4256-a2a5-ebf21dc9cbb4","name":"BN Colones","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#638bf9","currency":"CRC","allowNegative":false},{"id":"22239c8e-2749-4e82-bc9d-b289c591b8aa","name":"BN Dólares","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#6d89f9","currency":"USD","allowNegative":false},{"id":"5c5ae2ca-0b7d-4641-80a1-93503df35017","name":"Promerica Colones","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#32a9f7","currency":"CRC","allowNegative":false},{"id":"1778bb43-cd98-40b9-bf29-9f78f01b570e","name":"Promerica Dólares","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#3ca0f7","currency":"USD","allowNegative":false},{"id":"dfd29105-6954-495f-8872-edf03ded6df9","name":"BCR Virtual Colones","type":"Banco","parentId":"81943880-bb60-48ac-a8dc-6dcc676f0c35","active":true,"color":"#598ff8","currency":"CRC","allowNegative":false},{"id":"f5baa78e-4aca-4ce3-8ca5-ec292ecd4736","name":"BAC Amex Colones","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f0812f","currency":"CRC","allowNegative":true},{"id":"95b814d0-2193-41a5-98b6-a0846de8de01","name":"BAC Amex Dólares","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f09339","currency":"USD","allowNegative":true},{"id":"21b3246d-7dd7-4199-a1d1-d95cf8f4189e","name":"BAC PriceSmart Colones","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f1a442","currency":"CRC","allowNegative":true},{"id":"80d0bb7b-4b1d-425e-ac13-3e8e4b2ffd80","name":"BAC PriceSmart Dólares","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f2b44c","currency":"USD","allowNegative":true},{"id":"64c4a5ae-dca7-45f6-bed2-62f27373b79b","name":"BAC Walmart Colones","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f2c255","currency":"CRC","allowNegative":true},{"id":"94ea3e88-35c7-4b4d-8313-797e7f14bc09","name":"BAC Walmart Dólares","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f3d05f","currency":"USD","allowNegative":true},{"id":"5cff9803-d1cd-4a10-9130-04b71c30b9d1","name":"Credisiman Colones","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f09339","currency":"CRC","allowNegative":true},{"id":"51327679-dc8f-4807-bc3d-ef65789df093","name":"Credisiman Dólares","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f1a442","currency":"USD","allowNegative":true},{"id":"517b9516-5be0-4f5f-9aa2-237ba22642bc","name":"Billetera jksotorojas","type":"Efectivo","parentId":"d4519fd1-cbce-49d9-b658-cbc5362f5a6c","active":true,"color":"#42dbbd","currency":"CRC","allowNegative":false},{"id":"d8d9ede1-3667-402e-8647-8e3f0153f2c7","name":"Billetera ghernandez","type":"Efectivo","parentId":"d4519fd1-cbce-49d9-b658-cbc5362f5a6c","active":true,"color":"#39daaf","currency":"CRC","allowNegative":false},{"id":"8e0518af-8760-4f01-b706-5a26aca4ddca","name":"Ahorros (SGF) - CRC","type":"Ahorro","parentId":null,"active":true,"color":"#10b981","currency":"CRC","allowNegative":false},{"id":"9d9c31c7-248c-4aa0-8092-b4fa19e00ef5","name":"Ahorros (SGF) - USD","type":"Ahorro","parentId":null,"active":true,"color":"#0ea5e9","currency":"USD","allowNegative":false},{"id":"b5825d0b-ed57-45f1-a714-bedd019000ac","name":"BP AutoPremia Colones","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f4dc68","currency":"CRC","allowNegative":true},{"id":"cedba510-3ca0-4f5a-ad05-b5e2049f9aea","name":"BP AutoPremia Dólares","type":"Tarjeta","parentId":"76cf8dd7-cfa4-49af-9f8f-523e3187ef15","active":true,"color":"#f0812f","currency":"USD","allowNegative":true},{"id":"f83b5a64-4a85-4d87-a4a1-286a5cfa9a75","name":"Caja Chica","type":"Banco","parentId":"517b9516-5be0-4f5f-9aa2-237ba22642bc","active":true,"color":"#61dab2","currency":"CRC","allowNegative":false},{"id":"87017af4-96fb-477c-b082-b6691fd08768","name":"Billetera FSH","type":"Banco","parentId":"d4519fd1-cbce-49d9-b658-cbc5362f5a6c","active":true,"color":"#30d8a0","currency":"CRC","allowNegative":false}],"categories":[{"id":"630b6d1a-fb63-40f1-8d73-66078f3b8176","name":"Ingresos","parentId":null,"active":true,"color":"#10b981"},{"id":"936aed8e-c6e4-4e1d-bf1f-2de046867e14","name":"Salario","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#22e4a4"},{"id":"2c9ca49c-5774-4736-8fe9-5a65a14f1943","name":"Otros ingresos","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#1ce092"},{"id":"6f151d52-d13d-4e4b-9d45-818ff8466204","name":"Saldo inicial","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#35e6c3"},{"id":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","name":"Vivienda","parentId":null,"active":true,"color":"#ef4444"},{"id":"d0057f0f-df77-4f52-88eb-77ac5979e043","name":"Alquiler / Hipoteca","parentId":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","active":true,"color":"#ec6580"},{"id":"d67f9c45-c75b-48a5-a9fc-ef2f30acc85a","name":"Mantenimiento","parentId":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","active":true,"color":"#ee787f"},{"id":"c91415ec-6f10-4df9-863e-6092788dfd17","name":"Servicios Públicos","parentId":null,"active":true,"color":"#f97316"},{"id":"5b2d5f38-42ab-41fe-8f97-ce56bab084b1","name":"CNFL - 28014711","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f5874d"},{"id":"d17f8303-e502-4998-9d76-0aa0e88f6e2e","name":"Agua","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f47444"},{"id":"511e1916-a5c7-46e3-a648-4cdfbf94d732","name":"Internet","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f6b66a"},{"id":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","name":"Teléfonos","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f7c474"},{"id":"d9b232e8-2799-44d4-b9e0-44d292d2cfaa","name":"Supermercado","parentId":null,"active":true,"color":"#fb7185"},{"id":"fe963422-ccef-4699-ac73-600e9af8a9ca","name":"Supermercado","parentId":"d9b232e8-2799-44d4-b9e0-44d292d2cfaa","active":true,"color":"#f99cb6"},{"id":"55c79978-4355-4598-b6ac-f77498bb34b5","name":"Feria del Agricultor","parentId":"d9b232e8-2799-44d4-b9e0-44d292d2cfaa","active":true,"color":"#f892b5"},{"id":"23c033e3-88be-486c-a986-d32dd17fb21f","name":"Restaurantes y Otros","parentId":null,"active":true,"color":"#ec4899"},{"id":"8b07e87e-2b41-4b70-8434-5fadbb8fca23","name":"Restaurantes","parentId":"23c033e3-88be-486c-a986-d32dd17fb21f","active":true,"color":"#ea69c2"},{"id":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","name":"Transporte","parentId":null,"active":true,"color":"#a855f7"},{"id":"adb5ec36-52a2-45a1-a10c-042aff85a324","name":"Combustible","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#9e77f4"},{"id":"da9adb14-460a-4f7b-b9ae-73336f3f478a","name":"Uber / Taxi","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#dba6f8"},{"id":"54c2e192-d677-49dd-bd29-a818f47fcbec","name":"Mantenimiento","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#ac80f5"},{"id":"9b1972ed-ad9c-4a54-820f-995440cb9ad0","name":"Peajes / Estacionamiento","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#ba8af5"},{"id":"8ea1561f-6a5f-41ce-a8bd-6fdae43aca39","name":"Médicos","parentId":null,"active":true,"color":"#6366f1"},{"id":"5dd5c0a6-cc85-4f91-821f-927cb7b39f70","name":"Consultas","parentId":"8ea1561f-6a5f-41ce-a8bd-6fdae43aca39","active":true,"color":"#839bef"},{"id":"f6c3444c-fc60-470c-981c-e30635fb1376","name":"Farmacia","parentId":"8ea1561f-6a5f-41ce-a8bd-6fdae43aca39","active":true,"color":"#959df2"},{"id":"1638581a-7587-4ea3-8abe-f9fb95f04b51","name":"Seguros Médicos","parentId":"8ea1561f-6a5f-41ce-a8bd-6fdae43aca39","active":true,"color":"#9ea0f3"},{"id":"ea76916e-dd86-4678-94a1-773a26fc36d3","name":"Educación","parentId":null,"active":true,"color":"#0ea5e9"},{"id":"69daf0ec-77ed-48d3-9329-0676f408321c","name":"Personal","parentId":null,"active":true,"color":"#14b8a6"},{"id":"a72fa976-b40d-40bd-a9de-fed34a91e312","name":"JoaKo","parentId":"69daf0ec-77ed-48d3-9329-0676f408321c","active":true,"color":"#21debd"},{"id":"4852d164-b21f-4330-8f75-6567d99f03e6","name":"Josué","parentId":"69daf0ec-77ed-48d3-9329-0676f408321c","active":true,"color":"#2ae0cc"},{"id":"e67545be-478f-4131-bf1e-96e3305ccd27","name":"Gema","parentId":"69daf0ec-77ed-48d3-9329-0676f408321c","active":true,"color":"#1ecd97"},{"id":"1a8f3589-7d43-43dd-9c52-51501755b0d2","name":"Departamentales","parentId":null,"active":true,"color":"#f59e0b"},{"id":"7e49d1f4-e6f5-41c7-83d5-809cde91d577","name":"Tecnología","parentId":"1a8f3589-7d43-43dd-9c52-51501755b0d2","active":true,"color":"#f1a442"},{"id":"c9c15e1e-5d00-4f15-9035-738e4000b2f5","name":"Hogar","parentId":"1a8f3589-7d43-43dd-9c52-51501755b0d2","active":true,"color":"#f0812f"},{"id":"ad624147-f28f-434f-9c6a-97d8c0c7c0a4","name":"Regalos","parentId":"1a8f3589-7d43-43dd-9c52-51501755b0d2","active":true,"color":"#f09339"},{"id":"1e52f07f-c1c3-4b89-9a90-1ddd6ab3b426","name":"Entretenimiento","parentId":null,"active":true,"color":"#22c55e"},{"id":"00eade3b-ccea-4520-9186-a2dd81ff879d","name":"Vacaciones","parentId":"1e52f07f-c1c3-4b89-9a90-1ddd6ab3b426","active":true,"color":"#43d770"},{"id":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","name":"Suscripciones","parentId":"1e52f07f-c1c3-4b89-9a90-1ddd6ab3b426","active":true,"color":"#3bd55f"},{"id":"08b7ad0f-882b-40b4-b7e2-95ddb51c77ba","name":"Bancarios","parentId":null,"active":true,"color":"#111827"},{"id":"00e341e2-ddac-4de9-8766-d5c969093b56","name":"Social","parentId":null,"active":true,"color":"#3b82f6"},{"id":"ee8c7e6f-25c7-4d35-b532-50967bce435c","name":"Actividades Sociales","parentId":"00e341e2-ddac-4de9-8766-d5c969093b56","active":true,"color":"#5db4f2"},{"id":"df4af4ce-36ee-4edf-8f47-37d0027ba7e9","name":"Grupos","parentId":"00e341e2-ddac-4de9-8766-d5c969093b56","active":true,"color":"#70abf4"},{"id":"bd3c34b0-31c2-4146-a6e9-cf9562208dc1","name":"Donaciones","parentId":"00e341e2-ddac-4de9-8766-d5c969093b56","active":true,"color":"#67aff3"},{"id":"662c09d1-97dd-4ea9-9717-fd5bd8587f04","name":"Otros","parentId":null,"active":true,"color":"#9ca3af"},{"id":"49178158-c28f-4a14-965a-50809a94bc72","name":"Imprevistos","parentId":"662c09d1-97dd-4ea9-9717-fd5bd8587f04","active":true,"color":"#a6b7c4"},{"id":"2dd1b37b-0b21-437c-a706-863efd3d3c31","name":"Fondos de Inversión","parentId":"08b7ad0f-882b-40b4-b7e2-95ddb51c77ba","active":true,"color":"#25394b"},{"id":"154623ff-f991-4ec3-885a-ca5f1d1cc31d","name":"Fondo 01 - Alquiler","parentId":"2dd1b37b-0b21-437c-a706-863efd3d3c31","active":true,"color":"#324558"},{"id":"9a52fa1e-4bfd-4e8c-a810-2e388f959f4f","name":"Fondo 02 - Colones","parentId":"2dd1b37b-0b21-437c-a706-863efd3d3c31","active":true,"color":"#36485e"},{"id":"a25628d4-2716-47ec-be02-50c8def03089","name":"Fondo 03 - Dólares","parentId":"2dd1b37b-0b21-437c-a706-863efd3d3c31","active":true,"color":"#394a65"},{"id":"ce6a0cee-7368-4bda-aab3-2f8a19376fdd","name":"JK Pro","parentId":"7e49d1f4-e6f5-41c7-83d5-809cde91d577","active":true,"color":"#ee9f64"},{"id":"c3272564-cbe4-4402-9855-6d2914b43257","name":"Colegio El Rosario","parentId":"ea76916e-dd86-4678-94a1-773a26fc36d3","active":true,"color":"#34cbec"},{"id":"39ca1625-1aa6-4b5c-acfe-cc5cfd0995be","name":"Academia Rhema","parentId":"ea76916e-dd86-4678-94a1-773a26fc36d3","active":true,"color":"#2bd6eb"},{"id":"01843f28-5bbc-4f06-a6bf-e46d8fc2e08b","name":"Actividades","parentId":"39ca1625-1aa6-4b5c-acfe-cc5cfd0995be","active":true,"color":"#5fdaea"},{"id":"f55bd78a-c913-4f6c-9961-26c2286b1bf4","name":"Matrícula","parentId":"c3272564-cbe4-4402-9855-6d2914b43257","active":true,"color":"#5fdaea"},{"id":"59cf6e9e-ed75-41ec-91d6-354a219f1505","name":"Mensualidad","parentId":"c3272564-cbe4-4402-9855-6d2914b43257","active":true,"color":"#68d4eb"},{"id":"cc25c504-616f-40ec-b8ef-bd31af780078","name":"Útiles","parentId":"c3272564-cbe4-4402-9855-6d2914b43257","active":true,"color":"#71ceec"},{"id":"786f858d-9cef-488d-a307-b2cdae86d423","name":"Paseos","parentId":"00eade3b-ccea-4520-9186-a2dd81ff879d","active":true,"color":"#62d676"},{"id":"2e54dd16-98d1-4426-b6e4-128de19a4224","name":"Disney Plus","parentId":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","active":true,"color":"#6bd884"},{"id":"4553cf91-98fd-4bbc-877f-a4cb503ca34f","name":"Netflix","parentId":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","active":true,"color":"#83dfab"},{"id":"c68b3ccf-f8ca-40f4-a166-4c392818c2bf","name":"ChatGPT","parentId":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","active":true,"color":"#62d676"},{"id":"3f08c693-e222-4972-a9ac-672b6fb47dab","name":"IPTV","parentId":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","active":true,"color":"#73da92"},{"id":"447c8573-3706-4c2d-b404-1c9fd8d5a984","name":"NBA","parentId":"9794ce36-b2f3-4fbc-af51-4cf9e46a0c7d","active":true,"color":"#7bdc9f"},{"id":"cd49e149-56cc-47e9-b6c4-1621e24ea535","name":"Viajes","parentId":"00eade3b-ccea-4520-9186-a2dd81ff879d","active":true,"color":"#6bd884"},{"id":"74e9955b-e034-4242-bb4b-ac310bc03417","name":"Salario Escolar","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#2be5b4"},{"id":"271f7439-79eb-4c41-a252-941262a7da20","name":"Aguinaldo","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#19ce6e"},{"id":"3a163cf9-c535-46b6-8c50-f462ddc5d002","name":"Ian","parentId":"69daf0ec-77ed-48d3-9329-0676f408321c","active":true,"color":"#1fd5a9"},{"id":"69293a4c-2e5b-4824-82a8-7b7473588e21","name":"Administración de Cuentas","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f4613a"},{"id":"d5b13571-127e-4154-b60d-d41959927a1d","name":"Colegiaturas","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f59857"},{"id":"618e96bf-7a06-4a36-b791-8c42d9419a39","name":"Kolbi - 88343121","parentId":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","active":true,"color":"#f28a6f"},{"id":"203dea52-f1f3-4963-b2b8-63b6ccd579f1","name":"Kolbi - 88451201","parentId":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","active":true,"color":"#f29a78"},{"id":"4eb646c7-0cd7-49e9-a666-677349158b26","name":"Liberty - 62614490","parentId":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","active":true,"color":"#f3a982"},{"id":"95cc0b54-c04c-400b-b9aa-686493940395","name":"Liberty - 64302890","parentId":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","active":true,"color":"#f4b68b"},{"id":"34ad7417-a512-4d47-bb19-e2bd13789a57","name":"Liberty - 64319558","parentId":"a36e8fda-86d1-4214-a22f-3e4c9bd584aa","active":true,"color":"#f5c294"},{"id":"e76d9389-ebed-4aa4-a45b-4a6934d94f7f","name":"CPIC","parentId":"d5b13571-127e-4154-b60d-d41959927a1d","active":true,"color":"#f28a6f"},{"id":"01c85683-8970-4c05-ad94-5f329752c1c4","name":"Gastos Funerales","parentId":"c91415ec-6f10-4df9-863e-6092788dfd17","active":true,"color":"#f6a861"},{"id":"09432969-3d9c-44a1-ac4c-2fc43a6aaa11","name":"Cumpleaños","parentId":"ee8c7e6f-25c7-4d35-b532-50967bce435c","active":true,"color":"#90c9f2"},{"id":"1bdf96fd-153b-4589-b4f5-fe716a716810","name":"World Vision","parentId":"bd3c34b0-31c2-4146-a6e9-cf9562208dc1","active":true,"color":"#90c9f2"},{"id":"cc399e84-6f92-40de-9081-09be423a4457","name":"G08","parentId":"df4af4ce-36ee-4edf-8f47-37d0027ba7e9","active":true,"color":"#90c9f2"},{"id":"3220af01-4677-4f88-b37d-c900d98cbc4d","name":"Kyriacos","parentId":"df4af4ce-36ee-4edf-8f47-37d0027ba7e9","active":true,"color":"#9ac8f3"},{"id":"545e38e8-22bc-4350-a983-4eaf1c85ae4f","name":"Taller","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#d19cf7"},{"id":"9fcbf313-fe2a-4593-8f09-40f692e287ed","name":"Limpieza","parentId":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","active":true,"color":"#ed6e7f"},{"id":"fc4fb907-8f51-47a6-879b-610685901944","name":"Aguinaldo","parentId":"9fcbf313-fe2a-4593-8f09-40f692e287ed","active":true,"color":"#ee96a8"},{"id":"7f36ee94-3ade-4db5-b9b7-bcc11fe95f7a","name":"Alquiler Moravia","parentId":"d0057f0f-df77-4f52-88eb-77ac5979e043","active":true,"color":"#ee96a8"},{"id":"92bac6e5-f279-48d8-9076-08e55d2f6467","name":"Seguro","parentId":"c3fb09d8-9846-486e-bad4-5e6573fcd1a3","active":true,"color":"#c693f6"},{"id":"0408312e-03f6-4148-b696-e82e9db545a3","name":"Kolbi - 17504899","parentId":"511e1916-a5c7-46e3-a648-4cdfbf94d732","active":true,"color":"#f28a6f"},{"id":"fbaa8618-4e8b-406b-a513-b29dad9b2a9d","name":"Metrocom - 986396","parentId":"511e1916-a5c7-46e3-a648-4cdfbf94d732","active":true,"color":"#f29a78"},{"id":"0ac28f5e-b6de-4a33-a879-48ea422d4731","name":"Municipalidad","parentId":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","active":true,"color":"#f08181"},{"id":"f4edfed8-bbb9-4c25-8429-d1d84107d61b","name":"Tibás Urbano","parentId":"f174bc4a-5fd3-423b-99c0-e3aae5debe3a","active":true,"color":"#f1918a"},{"id":"eb1155dc-8a55-4fac-bcb8-686bb733fb93","name":"Mantenimiento","parentId":"f4edfed8-bbb9-4c25-8429-d1d84107d61b","active":true,"color":"#ee96a8"},{"id":"b216579e-13d1-44d4-b689-e1e5999a5d89","name":"Primer Quincena","parentId":"936aed8e-c6e4-4e1d-bf1f-2de046867e14","active":true,"color":"#3bdf88"},{"id":"2ec3affd-beaa-46ff-b230-832ae3f86862","name":"Segunda Quincena","parentId":"936aed8e-c6e4-4e1d-bf1f-2de046867e14","active":true,"color":"#44e198"},{"id":"c4327f19-6c2b-4f8c-afe6-c2f7c9f6ef47","name":"Deportes","parentId":"1e52f07f-c1c3-4b89-9a90-1ddd6ab3b426","active":true,"color":"#33d34e"},{"id":"faafbe93-81d9-4a80-9e3d-31d3b8d047ac","name":"Mejenga","parentId":"c4327f19-6c2b-4f8c-afe6-c2f7c9f6ef47","active":true,"color":"#62d676"},{"id":"5a6ad512-2068-4978-996a-1c8f5054d326","name":"Alquileres","parentId":"630b6d1a-fb63-40f1-8d73-66078f3b8176","active":true,"color":"#1bd780"},{"id":"8ad63bce-1526-4bab-b175-9a0979924b45","name":"Moravia","parentId":"5a6ad512-2068-4978-996a-1c8f5054d326","active":true,"color":"#3bdf88"},{"id":"79c73734-978c-4abb-9c5c-7b88db627e08","name":"Dentista","parentId":"8ea1561f-6a5f-41ce-a8bd-6fdae43aca39","active":true,"color":"#8c9cf0"},{"id":"adea5211-4201-4b9c-8fa5-c50aa80c26da","name":"Caja Chica","parentId":"a72fa976-b40d-40bd-a9de-fed34a91e312","active":true,"color":"#0d6efd"},{"id":"9f82bf7d-9e1d-4c0b-8288-551da956ffc6","name":"Caja Chica","parentId":"e67545be-478f-4131-bf1e-96e3305ccd27","active":true,"color":"#0d6efd"},{"id":"84512cd1-d92b-4e39-b378-ef1b8aadd79b","name":"Caja Chica","parentId":"3a163cf9-c535-46b6-8c50-f462ddc5d002","active":true,"color":"#0d6efd"},{"id":"59c3e7cd-a63c-4e67-bfe5-e2783917396c","name":"Caja Chica","parentId":"4852d164-b21f-4330-8f75-6567d99f03e6","active":true,"color":"#0d6efd"}]};

const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const escAttr=esc;
const uuid=()=>crypto?.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:(r&0x3|0x8);return v.toString(16)});
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
// ----- Sorting helpers -----
function getSort(scope, defKey, defDir){
  state.ui.sort = state.ui.sort || {};
  const s = state.ui.sort[scope];
  if(!s) return {key:defKey, dir:defDir};
  return {key:s.key||defKey, dir:s.dir||defDir};
}
function toggleSort(scope, key, rerenderFn){
  state.ui.sort = state.ui.sort || {};
  const cur = state.ui.sort[scope] || {};
  const dir = (cur.key===key && cur.dir==="asc") ? "desc" : "asc";
  state.ui.sort[scope] = {key, dir};
  rerenderFn();
}
function sortIcon(scope, key){
  const s = state.ui.sort && state.ui.sort[scope];
  if(!s || s.key!==key) return '<i class="bi bi-arrow-down-up ms-1 small text-secondary"></i>';
  return s.dir==="asc" ? '<i class="bi bi-arrow-up ms-1 small"></i>' : '<i class="bi bi-arrow-down ms-1 small"></i>';
}

function sortSelectOptions(sel, keepFirstIfEmpty=true){
  const el = (typeof sel==="string")?document.querySelector(sel):sel;
  if(!el) return;
  const opts=[...el.options];
  if(opts.length<=1) return;
  let first=null, rest=opts;
  if(keepFirstIfEmpty && opts[0] && (opts[0].value==="" || opts[0].value==null)){
    first=opts[0];
    rest=opts.slice(1);
  }
  rest.sort((a,b)=>a.text.localeCompare(b.text,"es",{sensitivity:"base"}));
  el.innerHTML="";
  if(first) el.add(first);
  for(const o of rest) el.add(o);
}

const DEBOUNCE = {};
function debounce(key, fn, delay=220){
  if(DEBOUNCE[key]) clearTimeout(DEBOUNCE[key]);
  DEBOUNCE[key] = setTimeout(fn, delay);
}

// ----- Theme (FinPro / FinSoft / DarkLedger) -----
function normalizeTheme(theme){
  if(theme==="finsoft") return "finsoft";
  if(theme==="darkledger") return "darkledger";
  return "finpro";
}
function applyTheme(theme){
  const t = normalizeTheme(theme);
  document.documentElement.setAttribute("data-theme", t);
  // Helps native controls match the theme (supported browsers)
  try{ document.documentElement.style.colorScheme = (t==="darkledger") ? "dark" : "light"; }catch{}
}
function updateThemeButtons(){
  const t = normalizeTheme(state?.config?.theme);
  const bP=document.getElementById("btnThemePro");
  const bS=document.getElementById("btnThemeSoft");
  const bD=document.getElementById("btnThemeDark");
  if(bP) bP.className = `btn ${t==="finpro"?"btn-primary":"btn-outline-primary"}`;
  if(bS) bS.className = `btn ${t==="finsoft"?"btn-primary":"btn-outline-primary"}`;
  if(bD) bD.className = `btn ${t==="darkledger"?"btn-primary":"btn-outline-primary"}`;
}
function setTheme(theme){
  state.config = state.config || {};
  state.config.theme = normalizeTheme(theme);
  applyTheme(state.config.theme);
  logEvent("update","config",null,`Tema: ${state.config.theme}`);
  save();
  updateThemeButtons();
  updateNavLayoutButtons();
  if(state.config.theme==="finsoft") toast("Tema claro suave activado.","success");
  else if(state.config.theme==="darkledger") toast("Tema oscuro activado.","success");
  else toast("Tema claro pro activado.","success");
}


// ----- Nav layout (Sidebar / Top) -----
function normalizeNavLayout(layout){
  return (layout==="top") ? "top" : "side";
}
function applyNavLayout(layout){
  const l = normalizeNavLayout(layout || state?.config?.navLayout);
  document.body.classList.toggle("layout-top", l==="top");
  document.body.classList.toggle("layout-side", l!=="top");
  // If top layout is active and we are on desktop, keep sidebar hidden (CSS) and show topnav.
  // Mobile keeps offcanvas.
}
function updateNavLayoutButtons(){
  const l = normalizeNavLayout(state?.config?.navLayout);
  const bS=document.getElementById("btnNavSide");
  const bT=document.getElementById("btnNavTop");
  if(bS) bS.className = `btn ${l==="side"?"btn-primary":"btn-outline-primary"}`;
  if(bT) bT.className = `btn ${l==="top"?"btn-primary":"btn-outline-primary"}`;
}
function setNavLayout(layout){
  state.config = state.config || {};
  state.config.navLayout = normalizeNavLayout(layout);
  applyNavLayout(state.config.navLayout);
  logEvent("update","config",null,`NavLayout: ${state.config.navLayout}`);
  save();
  updateNavLayoutButtons();
  toast(state.config.navLayout==="top" ? "Menú superior activado." : "Menú lateral activado.","success");
}

// ---- Color helpers (HSL) ----
function hexToRgb(hex){
  const h=String(hex||"").replace("#","").trim();
  if(h.length===3){
    const r=parseInt(h[0]+h[0],16), g=parseInt(h[1]+h[1],16), b=parseInt(h[2]+h[2],16);
    return {r,g,b};
  }
  if(h.length===6){
    const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
    return {r,g,b};
  }
  return {r:17,g:24,b:39}; // #111827
}
function rgbToHex(r,g,b){
  const to=(n)=>{const s=Math.max(0,Math.min(255,Math.round(n))).toString(16).padStart(2,"0");return s;};
  return `#${to(r)}${to(g)}${to(b)}`;
}
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0,s=0,l=(max+min)/2;
  if(max!==min){
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      case b: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  return {h:h*360, s:s*100, l:l*100};
}
function hslToRgb(h,s,l){
  h=((h%360)+360)%360; s=Math.max(0,Math.min(100,s))/100; l=Math.max(0,Math.min(100,l))/100;
  const c=(1-Math.abs(2*l-1))*s;
  const x=c*(1-Math.abs((h/60)%2-1));
  const m=l-c/2;
  let r=0,g=0,b=0;
  if(h<60){r=c;g=x;b=0;}
  else if(h<120){r=x;g=c;b=0;}
  else if(h<180){r=0;g=c;b=x;}
  else if(h<240){r=0;g=x;b=c;}
  else if(h<300){r=x;g=0;b=c;}
  else {r=c;g=0;b=x;}
  return {r:(r+m)*255,g:(g+m)*255,b:(b+m)*255};
}
function deriveColor(rootHex, depth, idx){
  const {r,g,b}=hexToRgb(rootHex||"#111827");
  const hsl=rgbToHsl(r,g,b);
  const wobble=((idx%7)-3)*2;        // -6..+6
  const depthLift = depth===1?12:(depth===2?22:30);
  const satDrop = depth*6;
  const h = hsl.h + wobble*2;
  const s = Math.max(20, Math.min(95, hsl.s - satDrop));
  const l = Math.max(22, Math.min(88, hsl.l + depthLift + wobble));
  const rgb=hslToRgb(h,s,l);
  return rgbToHex(rgb.r,rgb.g,rgb.b);
}
function regenColors(kind){
  const isAcc = kind==="acc";
  const items = isAcc ? state.accounts : state.categories;
  const roots = items.filter(x=>!x.parentId);
  const byParent=new Map();
  for(const it of items){
    const p=it.parentId||null;
    if(!byParent.has(p)) byParent.set(p,[]);
    byParent.get(p).push(it);
  }
  const sortedKids=(pid)=> (byParent.get(pid)||[]).slice().sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""),"es",{sensitivity:"base"}));
  const apply=(root)=>{
    const rootColor=safeColor(root.color,"#111827");
    const walk=(pid,depth)=>{
      const kids=sortedKids(pid);
      kids.forEach((k,idx)=>{
        if(depth>=1) k.color = deriveColor(rootColor, depth, idx);
        walk(k.id, depth+1);
      });
    };
    walk(root.id,1);
  };
  msg({title:"Regenerar colores",kind:"warning",body:`Se recalcularán los colores de <b>subniveles</b> basados en el color de cada raíz.<br>
    Esto <b>sobrescribe</b> colores en subcuentas/subcategorías (las raíces se mantienen).<div class="d-grid gap-2 mt-3">
    <button class="btn btn-dark" onclick="regenColorsOk('${kind}')"><i class="bi bi-palette2"></i> Regenerar ahora</button></div>`});
}
function regenColorsOk(kind){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  const isAcc = kind==="acc";
  const items = isAcc ? state.accounts : state.categories;
  const roots = items.filter(x=>!x.parentId);
  const byParent=new Map();
  for(const it of items){
    const p=it.parentId||null;
    if(!byParent.has(p)) byParent.set(p,[]);
    byParent.get(p).push(it);
  }
  const sortedKids=(pid)=> (byParent.get(pid)||[]).slice().sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""),"es",{sensitivity:"base"}));
  const apply=(root)=>{
    const rootColor=safeColor(root.color,"#111827");
    const walk=(pid,depth)=>{
      const kids=sortedKids(pid);
      kids.forEach((k,idx)=>{
        if(depth>=1) k.color = deriveColor(rootColor, depth, idx);
        walk(k.id, depth+1);
      });
    };
    walk(root.id,1);
  };
  roots.forEach(apply);
  save(); toast("Colores regenerados.","success");
  if(isAcc) renderAccounts(); else renderCategories();
}


function isAccountUsed(id){
  if(!id) return false;
  if(state.config?.savingsAccountId && id===state.config.savingsAccountId) return true;
  if(state.config?.savingsAccountIdUSD && id===state.config.savingsAccountIdUSD) return true;
  for(const m of state.movements){
    if(!m) continue;
    if(m.isOpening) continue;
    if(m.accountId===id || m.accountToId===id) return true;
  }
  // presupuestos (compatibilidad de esquemas)
  for(const b of (state.budgets||[])){
    if(!b) continue;
    if(b.accountId===id) return true;
    const items=b.items||b.lines||b.rows;
    if(Array.isArray(items)){
      for(const it of items){
        if(it && it.accountId===id) return true;
      }
    }
  }
  for(const r of (state.recurrings||[])){
    if(!r) continue;
    if(r.accountId===id || r.accountToId===id) return true;
  }
  return false;
}
function isAccountUsedSubtree(id){
  if(isAccountUsed(id)) return true;
  for(const a of state.accounts.filter(x=>x.parentId===id)){
    if(isAccountUsedSubtree(a.id)) return true;
  }
  return false;
}
function isCategoryUsed(id){
  return catUsageCount(id)>0;
}
function isCategoryUsedSubtree(id){
  if(isCategoryUsed(id)) return true;
  for(const c of state.categories.filter(x=>x.parentId===id)){
    if(isCategoryUsedSubtree(c.id)) return true;
  }
  return false;
}


const CURRENCIES=[
  {code:"CRC",label:"CRC (₡)",dec:0},
  {code:"USD",label:"USD ($)",dec:2}
];
const baseCur=()=>state.config.baseCurrency||"CRC";
const fxRate=(cur)=>{
  const b=baseCur();
  if(!cur||cur===b) return 1;
  const r=Number(state.config.fxRates?.[cur]);
  return (Number.isFinite(r)&&r>0)?r:null; // 1 CUR = r BASE
};

const fxRateAt=(cur,dateStr)=>{
  const b=baseCur();
  if(!cur||cur===b) return 1;
  const d=(dateStr||"").trim();
  const hist=Array.isArray(state.config.fxHistory)?state.config.fxHistory:[];
  if(d){
    let best=null;
    for(const it of hist){
      if(!it||it.currency!==cur) continue;
      const rd=String(it.date||"");
      const rr=Number(it.rate);
      if(!rd || !(Number.isFinite(rr)&&rr>0)) continue;
      if(rd<=d && (!best || rd>best.date)) best={date:rd,rate:rr};
    }
    if(best) return best.rate;
  }
  const r=Number(state.config.fxRates?.[cur]);
  return (Number.isFinite(r)&&r>0)?r:null;
};

function isBootstrapEmpty(){
  // Considera "vacío" cuando solo existen las 2 cuentas de ahorro SGF (CRC/USD) y no hay datos reales.
  const onlySysSavings = (state.accounts||[]).every(a =>
    a && a.type==="Ahorro" && String(a.name||"").startsWith("Ahorros (SGF)")
  );
  const hasOtherAccounts = (!onlySysSavings) && (state.accounts||[]).length>0;
  const hasData = (state.categories||[]).length
    || (state.movements||[]).length
    || (state.budgets||[]).length
    || (state.recurrings||[]).length
    || (state.reconciliations||[]).length;
  return !(hasOtherAccounts || hasData);
}


const AUDIT_MAX=5000;
const logEvent=(action,entity,id,detail="")=>{
  try{
    if(!Array.isArray(state.audit)) state.audit=[];
    state.audit.push({ts:new Date().toISOString(),action,entity,id,detail:String(detail||"")});
    if(state.audit.length>AUDIT_MAX) state.audit=state.audit.slice(state.audit.length-AUDIT_MAX);
  }catch{}
};

const BACKUP_KEY=STORAGE_KEY+"_autobackups";
const getBackups=()=>{ try{return JSON.parse(localStorage.getItem(BACKUP_KEY)||"[]")||[]}catch{return[]} };
const setBackups=(arr)=>{ try{localStorage.setItem(BACKUP_KEY,JSON.stringify(arr||[]))}catch{} };
const maybeAutoBackup=(payloadJson)=>{
  try{
    if(!state?.config?.autoBackupEnabled) return;
    const every=Math.max(1,Number(state.config.autoBackupEveryOps||25));
    const maxN=Math.max(1,Number(state.config.autoBackupMax||5));
    state.meta=state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
    state.meta.opCount=Number(state.meta.opCount||0)+1;
    const now=Date.now();
    const last=state.meta.lastBackupAt?Date.parse(state.meta.lastBackupAt):0;
    const dueByOps = every>0 && (state.meta.opCount%every===0);
    const dueByTime = !last || (now-last)>(24*60*60*1000);
    if(!(dueByOps||dueByTime)) return;

    const sz=(payloadJson||"").length;
    if(sz>1_500_000) return;

    const list=getBackups();
    list.push({ts:new Date().toISOString(),app:APP_VERSION,size:sz,mode:"auto",data:payloadJson});
    while(list.length>maxN) list.shift();
    setBackups(list);
    state.meta.lastBackupAt=new Date().toISOString();
  }catch{}
};

function fxHistDel(cur,date){
  try{
    state.config.fxHistory = (Array.isArray(state.config.fxHistory)?state.config.fxHistory:[])
      .filter(x=>!(x && x.currency===cur && String(x.date)===String(date)));
    logEvent("delete","fxHistory",null,`${cur} ${date}`);
    save();
    try{ renderSettings(); }catch{}
  }catch{}
}

function backupDelete(ts){
  const list=getBackups().filter(b=>b?.ts!==ts);
  setBackups(list);
  toast("Backup eliminado.","success");
  try{ renderSettings(); }catch{}
}

function backupRestore(ts){
  const b=getBackups().find(x=>x?.ts===ts);
  if(!b){msg({title:"Auto-backup",kind:"warning",body:"Backup no encontrado."});return}
  msg({title:"Restaurar auto-backup",kind:"warning",body:`Se restaurará el estado del backup de <b>${esc((b.ts||"").replace("T"," ").slice(0,16))}</b>. Esta acción reemplaza el estado actual.
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="backupRestoreOk('${esc(ts)}')"><i class="bi bi-arrow-counterclockwise"></i> Sí, restaurar</button></div>`});
}
function backupRestoreOk(ts){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  const b=getBackups().find(x=>x?.ts===ts);
  if(!b){toast("Backup no encontrado.","warning");return}
  try{
    const obj=JSON.parse(String(b.data||"{}"));
    const payload=obj.config?obj:obj;
    applyImportedState(payload);
    logEvent("restore-backup","system",null,`Restore auto-backup ${ts}`);
    toast("Backup restaurado.","success");
    render(state.ui.route);

  // Auth UI
  try{
    const a = authGet();
    const b = document.getElementById("btnLogout");
    if(b) b.style.display = (a && a.enabled) ? "" : "none";
  }catch{}

  }catch(e){
    console.error(e);
    msg({title:"Restaurar",kind:"danger",body:"No se pudo restaurar el backup."});
  }
}
function backupExport(ts){
  const b=getBackups().find(x=>x?.ts===ts);
  if(!b){toast("Backup no encontrado.","warning");return}
  try{
    const blob=new Blob([String(b.data||"")],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`SGF_autobackup_${APP_VERSION}_${String(ts).replace(/[:T]/g,"-").slice(0,16)}.json`;
    document.body.appendChild(a);a.click();a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),500);
    toast("Backup exportado.","success");
  }catch(e){
    console.error(e);
    msg({title:"Auto-backup",kind:"danger",body:"No se pudo exportar el backup."});
  }
}

function exportAudit(){
  try{
    const payload={meta:{app:"SGF",version:APP_VERSION,exportedAt:new Date().toISOString(),type:"audit"},audit:state.audit||[]};
    const json=JSON.stringify(payload,null,2);
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`SGF_audit_${APP_VERSION}_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);a.click();a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),500);
    toast("Auditoría exportada.","success");
    logEvent("export","audit",null,"Export audit");
  }catch(e){
    console.error(e);
    msg({title:"Auditoría",kind:"danger",body:"No se pudo exportar la auditoría."});
  }
}

function audClearOk(){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  state.audit=[];
  save();
  toast("Auditoría limpiada.","success");
  try{ renderSettings(); }catch{}
}
const accById=(id)=>state.accounts.find(a=>a.id===id);
const accCur=(id)=>accById(id)?.currency||baseCur();
const roundMoney=(amt,cur)=>{
  const d=2; // decimales en toda la solución
  const p=Math.pow(10,d);
  return Math.round((Number(amt)||0)*p)/p;
};
const toBase=(amt,cur,rate=null)=>{
  const b=baseCur(); const a=Number(amt)||0;
  if(cur===b) return a;
  const r=(Number.isFinite(Number(rate))&&Number(rate)>0)?Number(rate):fxRate(cur);
  return r? a*r : NaN;
};
const fromBase=(baseAmt,cur,rate=null)=>{
  const b=baseCur(); const a=Number(baseAmt)||0;
  if(cur===b) return a;
  const r=(Number.isFinite(Number(rate))&&Number(rate)>0)?Number(rate):fxRate(cur);
  return r? a/r : NaN;
};
const fmtMoney=(n,currency=null)=>{
  const cur=currency||baseCur();
  const code=/^[A-Z]{3}$/.test(cur)?cur:baseCur();
  const opt={style:"currency",currency:code,minimumFractionDigits:2,maximumFractionDigits:2};
  try{return new Intl.NumberFormat("es-CR",opt).format(Number(n)||0)}catch{return `${cur} ${Number(n)||0}`}
};
const fmtDate=(iso)=>{if(!iso)return"";const [y,m,d]=iso.split("-").map(Number);return new Date(y,m-1,d).toLocaleDateString("es-CR",{year:"numeric",month:"short",day:"2-digit"})};
const monthLabel=(p)=>{if(!p)return"";const [y,m]=p.split("-").map(Number);return new Date(y,m-1,1).toLocaleDateString("es-CR",{year:"numeric",month:"long"})};const periodAdd=(p,delta=0)=>{
  if(!p) return null;
  const [y,m]=String(p).split("-").map(Number);
  if(!y||!m) return null;
  const d=new Date(y,m-1+delta,1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
};
const periodToDate=(p,day=1,regOffset=0)=>{
  const pp=periodAdd(p,regOffset);
  if(!pp) return null;
  const [y,m]=pp.split("-").map(Number);
  const last=new Date(y,m,0).getDate();
  const dd=Math.min(Math.max(1,Number(day)||1),last);
  return `${y}-${String(m).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
};

const getMonthFromDate=(iso)=>iso?.length>=7?iso.slice(0,7):"";
const parseAmount=(v)=>{
  const s=String(v??"").trim();
  if(!s) return NaN;
  let x=s.replace(/[^0-9,\.\-]/g,"").replace(/\s+/g,"");
  if(!x) return NaN;
  const neg=x.startsWith("-");
  x=x.replace(/-/g,"");
  const hasDot=x.includes(".");
  const hasComma=x.includes(",");
  if(hasDot && hasComma){
    // decimal = el último separador
    if(x.lastIndexOf(",")>x.lastIndexOf(".")){
      x=x.replace(/\./g,"").replace(",",".");
    }else{
      x=x.replace(/,/g,"");
    }
  }else if(hasComma && !hasDot){
    x=x.replace(/\./g,"").replace(",",".");
  }else{
    x=x.replace(/,/g,"");
  }
  const n=Number(x);
  return Number.isFinite(n)?(neg?-n:n):NaN;
};
function toast(text,type="info"){
  const id="t_"+uuid();const cls=type==="success"?"text-bg-success":type==="warning"?"text-bg-warning":type==="danger"?"text-bg-danger":"text-bg-dark";
  $(".toast-container").insertAdjacentHTML("beforeend",`
    <div id="${id}" class="toast ${cls} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${esc(text)}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`);
  const el=document.getElementById(id);const t=new bootstrap.Toast(el,{delay:2400});t.show();el.addEventListener("hidden.bs.toast",()=>el.remove());
}
function msg({title="Mensaje",subtitle="",body="",kind="info"}={}){
  const showMsg=()=>{
    const b=$("#msgB");b.className="badge rounded-pill";
    if(kind==="danger"){b.classList.add("text-bg-danger");b.textContent="ERROR"}
    else if(kind==="warning"){b.classList.add("text-bg-warning");b.textContent="ADVERTENCIA"}
    else if(kind==="success"){b.classList.add("text-bg-success");b.textContent="OK"}
    else{b.classList.add("text-bg-dark");b.textContent="INFO"}
    $("#msgT").textContent=title;
    const s=$("#msgS"); if(s){ s.textContent=subtitle||""; s.style.display=(subtitle? "block":"none"); }
    $("#msgC").innerHTML=body;
    bootstrap.Modal.getOrCreateInstance($("#msgM")).show();
  };

  const edit=$("#editM");
  // Si el editor está abierto, lo ocultamos para evitar modales apilados (Bootstrap no soporta bien el nesting).
  if(edit && edit.classList.contains("show")){
    const editInst=bootstrap.Modal.getInstance(edit) || bootstrap.Modal.getOrCreateInstance(edit,{backdrop:"static",keyboard:false});
    $("#msgM").addEventListener("hidden.bs.modal",()=>{
      // reabrir el editor al cerrar el mensaje
      setTimeout(()=>editInst.show(),80);
    },{once:true});
    edit.addEventListener("hidden.bs.modal",()=>showMsg(),{once:true});
    editInst.hide();
    return;
  }
  showMsg();
}
function help(k,subtitle=""){
  $("#helpT").textContent=HELP[k]?.title||HELP.global.title;
  $("#helpC").innerHTML=HELP[k]?.body||HELP.global.body;
  new bootstrap.Modal($("#helpM")).show();
}
function editor({title="Editor",subtitle="",body="",footer=""}={}){
  $("#editT").textContent=title;
  const sEl=$("#editS");
  if(sEl){ sEl.textContent=subtitle||""; sEl.style.display = (subtitle? "block":"none"); }
  $("#editC").innerHTML=body;
  $("#editF").innerHTML=footer||`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>`;
  bootstrap.Modal.getOrCreateInstance($("#editM"),{backdrop:"static",keyboard:false}).show();
}
function closeEditor(){bootstrap.Modal.getInstance($("#editM"))?.hide()}

// ----- State -----
const state={
  config:{theme:"finpro",navLayout:"side",baseCurrency:"CRC",fxRates:{USD:520},fxHistory:[],savingsAccountId:null,savingsAccountIdUSD:null,autoBackupEnabled:true,autoBackupEveryOps:25,autoBackupMax:5},
  accounts:[],
  categories:[],
  movements:[],
  budgets:[],
  goals:[],
  recurrings:[],
  reconciliations:[],
  audit:[],
  meta:{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null},
  ui:{route:"dashboard",accCol:new Set(),catCol:new Set(),selAcc:null,selCat:null}
};

// ----- Nav -----
const ROUTES=[
  {k:"dashboard",l:"Dashboard",i:"bi-speedometer2"},
  {k:"accounts",l:"Cuentas",i:"bi-folder2-open"},
  {k:"categories",l:"Categorías",i:"bi-diagram-3"},
  {k:"movements",l:"Movimientos",i:"bi-arrow-left-right"},
  {k:"reconciliations",l:"Conciliaciones",i:"bi-check2-square"},
  {k:"savings",l:"Ahorros",i:"bi-piggy-bank"},
  {k:"budgets",l:"Presupuesto",i:"bi-graph-up-arrow"},
  {k:"reports",l:"Reportes",i:"bi-file-earmark-bar-graph"},
  ];
function buildNav(){
  const mk=()=>ROUTES.map(r=>`
      <li class="nav-item">
        <a class="nav-link px-3 py-2 d-flex gap-2 align-items-center" href="#" data-route="${r.k}" onclick="return false;">
          <i class="bi ${r.i}"></i><span>${r.l}</span>
        </a>
      </li>`).join("");
$("#navDesk").innerHTML=mk();
  $("#navMob").innerHTML=mk();
  const nt=document.getElementById("navTop"); if(nt) nt.innerHTML=mk();

  $$("[data-route]").forEach(a=>a.addEventListener("click",()=>{
    go(a.dataset.route);
    bootstrap.Offcanvas.getInstance($("#ocNav"))?.hide();
  }));
}
function go(k){
  state.ui.route=k;
  $$(".view").forEach(v=>v.classList.add("d-none"));
  $(`#v-${k}`).classList.remove("d-none");
  $$("[data-route]").forEach(a=>a.classList.toggle("active",a.dataset.route===k));
  render(k);window.scrollTo({top:0,behavior:"smooth"});
}

// ----- Persistence -----
function loadCollapsed(){
  try{
    state.ui.accCol=new Set(JSON.parse(localStorage.getItem(COLL_KEYS.acc)||"[]"));
    state.ui.catCol=new Set(JSON.parse(localStorage.getItem(COLL_KEYS.cat)||"[]"));
  }catch{state.ui.accCol=new Set();state.ui.catCol=new Set()}
}
function saveCollapsed(){
  localStorage.setItem(COLL_KEYS.acc,JSON.stringify([...state.ui.accCol]));
  localStorage.setItem(COLL_KEYS.cat,JSON.stringify([...state.ui.catCol]));
}
function save(){
  try{
    const payload={
      version:APP_VERSION_NUM,app:APP_VERSION,savedAt:new Date().toISOString(),
      config:state.config,accounts:state.accounts,categories:state.categories,movements:state.movements,budgets:state.budgets,goals:state.goals,recurrings:state.recurrings,reconciliations:state.reconciliations,
      audit:state.audit,meta:state.meta
    };
    const json=JSON.stringify(payload);
    localStorage.setItem(STORAGE_KEY,json);
    try{ maybeAutoBackup(json); }catch{}
  }catch(e){
    console.error(e);
    try{
      msg({title:"Almacenamiento",kind:"danger",body:"No se pudo guardar en el navegador (posible cuota llena). Recomendación: <b>Exporta</b> tu información y luego limpia datos del navegador o usa otro perfil."});
    }catch{
      alert("No se pudo guardar en el navegador. Exporta tu información y libera espacio.");
    }
  }
}

function sanitizeState(){
  // config
  state.config = state.config || {baseCurrency:"CRC",fxRates:{USD:520},fxHistory:[],savingsAccountId:null,savingsAccountIdUSD:null,autoBackupEnabled:true,autoBackupEveryOps:25,autoBackupMax:5,theme:"finpro"};
  if(state.config.currency && !state.config.baseCurrency) state.config.baseCurrency = state.config.currency;
  state.config.baseCurrency = state.config.baseCurrency || "CRC";
  state.config.fxRates = state.config.fxRates || {USD:520};
  state.config.fxHistory = Array.isArray(state.config.fxHistory)?state.config.fxHistory:[];
  if(state.config.autoBackupEnabled===undefined) state.config.autoBackupEnabled=true;
  state.config.autoBackupEveryOps = Number(state.config.autoBackupEveryOps||25);
  state.config.autoBackupMax = Number(state.config.autoBackupMax||5);
  if(state.config.savingsAccountId===undefined) state.config.savingsAccountId = null;
  if(state.config.savingsAccountIdUSD===undefined) state.config.savingsAccountIdUSD = null;
  if(!state.config.theme) state.config.theme = "finpro";
  // migrate legacy keys if present
  if(state.config.theme==="dark") state.config.theme="darkledger";
  if(state.config.theme!=="finpro" && state.config.theme!=="finsoft" && state.config.theme!=="darkledger") state.config.theme="finpro";

  // arrays
  state.accounts = Array.isArray(state.accounts)?state.accounts.filter(Boolean):[];
  state.categories = Array.isArray(state.categories)?state.categories.filter(Boolean):[];
  state.movements = Array.isArray(state.movements)?state.movements.filter(Boolean):[];
  state.budgets = Array.isArray(state.budgets)?state.budgets.filter(Boolean):[];
  state.goals = Array.isArray(state.goals)?state.goals.filter(Boolean):[];
  state.recurrings = Array.isArray(state.recurrings)?state.recurrings.filter(Boolean):[];
  state.reconciliations = Array.isArray(state.reconciliations)?state.reconciliations.filter(Boolean):[];
  state.audit = Array.isArray(state.audit)?state.audit.filter(Boolean):[];
  state.meta = state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
  if(!state.meta.schemaVersion) state.meta.schemaVersion=APP_VERSION_NUM;
  state.meta.lastSeenApp=APP_VERSION;

  // defaults
  for(const a of state.accounts){
    if(a.active===undefined) a.active=true;
    if(a.parentId===undefined) a.parentId=null;
    if(a.color===undefined) a.color="#111827";
    if(a.allowNegative===undefined) a.allowNegative = (a.type==="Tarjeta");
    // Ahorros (SGF) nunca debería quedar en negativo
    if(a.id===state.config.savingsAccountId || a.id===state.config.savingsAccountIdUSD) a.allowNegative=false;
  }
  for(const c of state.categories){
    if(c.active===undefined) c.active=true;
    if(c.parentId===undefined) c.parentId=null;
    if(c.color===undefined) c.color="#111827";
  }
  for(const m of state.movements){
    if(m && m.system && !m.isSystem) m.isSystem=true;
    if(m && m.isSystem===undefined) m.isSystem=false;
    if(m && m.isOpening===undefined) m.isOpening=false;
    if(m && m.reconciled===undefined) m.reconciled=false;
    if(m && m.reconMonth===undefined) m.reconMonth=null;
    if(m && m.reconciledAt===undefined) m.reconciledAt=null;
    if(m.isSystem===undefined) m.isSystem=false;
    if(m.desc===undefined) m.desc="";
    // split lines
    if(m.splits && m.type!=="Gasto") delete m.splits;
    if(m.splits!==undefined && m.splits!==null && !Array.isArray(m.splits)) m.splits=null;
    if(Array.isArray(m.splits)){
      const fromCur=m.currency||accCur(m.accountId)||baseCur();
      m.splits = m.splits.filter(Boolean).map(s=>({
        id: s.id||uuid(),
        categoryId: s.categoryId||null,
        amount: roundMoney(parseAmount(String(s.amount??"")), fromCur),
        amountBase: (s.amountBase!=null)?Number(s.amountBase):null,
        desc: String(s.desc||"")
      })).filter(s=>s.categoryId && Number.isFinite(Number(s.amount)) && Number(s.amount)>0);
    }
  }


  // budgets
  for(const b of state.budgets){
    if(!b) continue;
    if(b.isRecurring===undefined) b.isRecurring=!!b.periodFrom;
    if(b.period===undefined) b.period="";
    if(b.periodFrom===undefined) b.periodFrom="";
    if(b.periodTo===undefined) b.periodTo="";
    if(b.type===undefined) b.type="Gasto";
    if(b.categoryId===undefined) b.categoryId=null;
    if(b.amount===undefined) b.amount=0;
    if(b.desc===undefined) b.desc="";
  }

// goals (metas de ahorro)
  for(const g of state.goals){
    if(g.active===undefined) g.active=true;
    if(!g.currency) g.currency=state.config.baseCurrency||"CRC";
    g.targetAmount = Number(g.targetAmount||0);
    if(!g.note) g.note="";
    if(g.targetDate===undefined) g.targetDate="";
  }





  for(const r of state.recurrings){
    if(r.active===undefined) r.active=true;
    if(r.name===undefined) r.name="";
    if(r.type===undefined) r.type="Gasto";
    if(r.accountId===undefined) r.accountId=null;
    if(r.accountToId===undefined) r.accountToId=null;
    if(r.categoryId===undefined) r.categoryId=null;
    if(r.amount===undefined) r.amount=0;
    if(r.day===undefined) r.day=1;
    if(r.regOffset===undefined) r.regOffset=0; // -1 mes anterior, 0 mismo mes, +1 mes siguiente
    if(r.startPeriod===undefined) r.startPeriod=null;
    if(r.endPeriod===undefined) r.endPeriod=null;
    if(r.desc===undefined) r.desc="";
  }

  ensureSavingsAccount();
  normalizeCurrencyModel();
}

function applyImportedState(obj){
  state.config=obj.config;
  state.accounts=obj.accounts;
  state.categories=obj.categories;
  state.movements=obj.movements;
  state.budgets=obj.budgets;
  state.goals=obj.goals||[];
  state.recurrings=obj.recurrings||[];
  state.reconciliations=obj.reconciliations||[];
  state.audit=obj.audit||[];
  state.meta=obj.meta||state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
  sanitizeState();
  save();
}

function migrate(){
  if(localStorage.getItem(STORAGE_KEY))return;
  for(const k of LEGACY_KEYS){
    const raw=localStorage.getItem(k);if(!raw)continue;
    try{
      const d=JSON.parse(raw);if(!d)continue;
      const payload=d.config?d:{config:d.config||{baseCurrency:"CRC",fxRates:{USD:520},savingsAccountId:null,savingsAccountIdUSD:null},accounts:d.accounts||[],categories:d.categories||[],movements:d.movements||[],budgets:d.budgets||[]};
      // normalize legacy config.currency
      if(payload.config && payload.config.currency && !payload.config.baseCurrency){
        payload.config.baseCurrency=payload.config.currency;
      }
      payload.config.baseCurrency=payload.config.baseCurrency||"CRC";
      payload.config.fxRates=payload.config.fxRates||{USD:520};
      localStorage.setItem(STORAGE_KEY,JSON.stringify({version:APP_VERSION_NUM,app:APP_VERSION,migratedFrom:k,savedAt:new Date().toISOString(),...payload}));
      toast("Datos migrados desde una versión anterior.","success");break;
    }catch{}
  }
}
function normalizeCurrencyModel(){
  // config
  if(state.config && state.config.currency && !state.config.baseCurrency){
    state.config.baseCurrency=state.config.currency;
  }
  state.config.baseCurrency=state.config.baseCurrency||"CRC";
  state.config.fxRates=state.config.fxRates||{};
  // default fx rate if missing (safe starter)
  if(state.config.baseCurrency==="CRC" && !state.config.fxRates.USD) state.config.fxRates.USD=520;
  if(state.config.baseCurrency==="USD" && !state.config.fxRates.CRC) state.config.fxRates.CRC=0.0019;

  // accounts: currency inheritance
  const byId=new Map(state.accounts.map(a=>[a.id,a]));
  const getCur=(id,guard=0)=>{
    const a=byId.get(id); if(!a) return state.config.baseCurrency;
    if(a.currency) return a.currency;
    if(a.parentId && guard<10) return getCur(a.parentId,guard+1);
    return state.config.baseCurrency;
  };
  for(const a of state.accounts){
    if(!a.currency) a.currency=getCur(a.id);
  }
  

  // --- color: migrar/inheredar color del padre (solo si está vacío o en default) ---
  const getCol=(id,guard=0)=>{
    const a=byId.get(id); if(!a) return "#111827";
    if(a.color && String(a.color).trim()) return safeColor(a.color,"#111827");
    if(a.parentId && guard<10) return getCol(a.parentId,guard+1);
    return "#111827";
  };
  for(const a of state.accounts){
    if(!a.parentId) continue;
    const parent=byId.get(a.parentId);
    if(!parent) continue;
    const curCol=(a.color==null?"":String(a.color)).trim().toLowerCase();
    const parentCol=(parent.color==null?"":String(parent.color)).trim();
    if(!curCol || (curCol==="#111827" && parentCol && parentCol.trim().toLowerCase()!=="#111827")){
      a.color = parentCol || getCol(a.parentId);
    }
  }
// enforce savings accounts currencies
  const savC=state.accounts.find(a=>a.id===state.config.savingsAccountId);
  if(savC) savC.currency=state.config.baseCurrency;
  const savU=state.accounts.find(a=>a.id===state.config.savingsAccountIdUSD);
  if(savU) savU.currency="USD";

  // movements: amountBase, rateToBase, transfer amountTo
  for(const m of state.movements){
    const srcCur=accCur(m.accountId);
    if(!m.currency) m.currency=srcCur;

    if(m.type==="Ingreso"||m.type==="Gasto"||m.type==="Transferencia"){
      if(m.currency===state.config.baseCurrency){
        m.rateToBase=1;
        m.amountBase=Number(m.amount)||0;
      }else{
        const r=Number(m.rateToBase);
        m.rateToBase=(Number.isFinite(r)&&r>0)?r:(fxRateAt(m.currency,m.date)||1);
        m.amountBase=toBase(Number(m.amount)||0,m.currency,m.rateToBase);
      }
      if(m.type==="Transferencia"){
        const dstCur=accCur(m.accountToId);
        m.currencyTo=m.currencyTo||dstCur;
        if(m.currencyTo===state.config.baseCurrency){
          m.rateToBaseTo=1;
        }else{
          const r2=Number(m.rateToBaseTo);
          m.rateToBaseTo=(Number.isFinite(r2)&&r2>0)?r2:(fxRateAt(m.currencyTo,m.date)||m.rateToBase||1);
        }
        if(m.amountTo==null){
          m.amountTo=(m.currency===m.currencyTo)?(Number(m.amount)||0):roundMoney(fromBase(Number(m.amountBase)||0,m.currencyTo,m.rateToBaseTo),m.currencyTo);
        }
      }
    }else if(m.type==="Ahorro"||m.type==="RetiroAhorro"){
      // logical savings values stored in the currency of the savings account, with amountBase for consolidation
      const cur=accCur(m.accountId);
      m.currency=cur||state.config.baseCurrency;
      if(m.currency===state.config.baseCurrency){
        m.rateToBase=1;
        m.amountBase=Number(m.amount)||0;
      }else{
        const r=Number(m.rateToBase);
        m.rateToBase=(Number.isFinite(r)&&r>0)?r:(fxRateAt(m.currency,m.date)||1);
        m.amountBase=toBase(Number(m.amount)||0,m.currency,m.rateToBase);
      }
    }
  }
  // cleanup legacy field (keep if you want, but not used)

  // --- sync savings-linked system transfers: categoría y descripción (migración) ---
  for(const t of state.movements){
    if(t && t.type==="Transferencia" && t.isSystem){
      let logical=null;
      if(t.linkedTo) logical = state.movements.find(x=>x.id===t.linkedTo);
      if(!logical) logical = state.movements.find(x=>x.linkedTransferId===t.id);
      if(logical && (logical.type==="Ahorro" || logical.type==="RetiroAhorro")){
        if(!t.categoryId && logical.categoryId) t.categoryId = logical.categoryId;
        // si es un desc genérico del sistema, lo enriquecemos
        const p = logical.categoryId ? (catPath(logical.categoryId)||"—") : "—";
        if(!t.desc || String(t.desc).startsWith("(Sistema) Transferencia por")){
          t.desc = `(Sistema) Transferencia por ${logical.type} • ${p}`;
        }
      }
    }
  }
}

function load(){
  migrate();
  const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return false;
  try{
    const d=JSON.parse(raw);
    state.config=d.config||state.config;
    state.accounts=d.accounts||[];
    state.categories=d.categories||[];
    state.movements=d.movements||[];
    state.budgets=d.budgets||[];
    state.goals=d.goals||[];
    state.recurrings=d.recurrings||[];
    state.reconciliations=d.reconciliations||[];
    state.audit=d.audit||[];
    state.meta=d.meta||state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
    sanitizeState();
    return true;
  }catch{return false}
}

// ----- Rules -----
function ensureSavingsAccount(){
  const base=state.config.baseCurrency||"CRC";

  // ---- CRC (moneda base) ----
  const idC=state.config.savingsAccountId;
  let aC=idC?state.accounts.find(x=>x.id===idC):null;

  // legacy lookup
  if(!aC) aC=state.accounts.find(x=>(x.name||"").toLowerCase()==="ahorros (sgf)" && x.type==="Ahorro" && (x.currency||base)===base);
  if(!aC) aC=state.accounts.find(x=>(x.name||"").toLowerCase()==="ahorros (sgf) - crc" && x.type==="Ahorro");
  if(!aC){
    aC={id:uuid(),name:"Ahorros (SGF) - CRC",type:"Ahorro",parentId:null,active:true,color:"#10b981",currency:base};
    state.accounts.push(aC);
  }else{
    // si era legacy, lo aclaramos (sin romper si el usuario lo renombró intencionalmente)
    const nm=(aC.name||"").toLowerCase().trim();
    if(nm==="ahorros (sgf)") aC.name="Ahorros (SGF) - CRC";
  }
  aC.type="Ahorro";
  aC.currency=base;
  aC.active=true;
  state.config.savingsAccountId=aC.id;

  // ---- USD ----
  const idU=state.config.savingsAccountIdUSD;
  let aU=idU?state.accounts.find(x=>x.id===idU):null;

  if(!aU) aU=state.accounts.find(x=>(x.name||"").toLowerCase()==="ahorros (sgf) - usd" && x.type==="Ahorro");
  if(!aU){
    aU={id:uuid(),name:"Ahorros (SGF) - USD",type:"Ahorro",parentId:null,active:true,color:"#0ea5e9",currency:"USD"};
    state.accounts.push(aU);
  }
  aU.type="Ahorro";
  aU.currency="USD";
  aU.active=true;
  state.config.savingsAccountIdUSD=aU.id;
}
function hasCycle(items,childId,newParentId){
  if(!newParentId)return false;
  let cur=newParentId;const seen=new Set([childId]);
  while(cur){
    if(seen.has(cur))return true;
    seen.add(cur);cur=items.find(x=>x.id===cur)?.parentId||null;
  }
  return false;
}
function depthOf(items,id){
  let d=1,cur=items.find(x=>x.id===id);
  while(cur?.parentId){d++;cur=items.find(x=>x.id===cur.parentId);if(d>99)break}
  return d;
}
function maxSubDepth(items,rootId){
  const byP=new Map();items.forEach(it=>{const p=it.parentId||null;if(!byP.has(p))byP.set(p,[]);byP.get(p).push(it.id)});
  let max=1;const st=[{id:rootId,dep:1}];const seen=new Set();
  while(st.length){
    const {id,dep}=st.pop();if(seen.has(id))continue;seen.add(id);
    max=Math.max(max,dep);(byP.get(id)||[]).forEach(k=>st.push({id:k,dep:dep+1}));
  }
  return max;
}
function exceed3(items,childId,newParentId){
  const newDepth=(newParentId?depthOf(items,newParentId):0)+1;
  if(newDepth>3)return true;
  return (newDepth-1+maxSubDepth(items,childId))>3;
}
function byIdMap(arr){return new Map(arr.map(x=>[x.id,x]))}
function pathOf(arr,id){
  if(!id)return"";const map=byIdMap(arr);const parts=[];let cur=map.get(id);let g=0;
  while(cur&&g++<10){parts.unshift(cur.name);cur=cur.parentId?map.get(cur.parentId):null}
  return parts.slice(-3).join(" / ");
}
function safeColor(v, fallback="#111827"){
  const s = (v==null ? "" : String(v)).trim();
  if(!s) return fallback;
  if(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{4}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(s)) return s;
  let m = s.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/i);
  if(m){
    const r=+m[1], g=+m[2], b=+m[3];
    if([r,g,b].every(n=>Number.isFinite(n)&&n>=0&&n<=255)) return `rgb(${r},${g},${b})`;
  }
  m = s.match(/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(0|1|0?\.\d+)\s*\)$/i);
  if(m){
    const r=+m[1], g=+m[2], b=+m[3], a=+m[4];
    if([r,g,b].every(n=>Number.isFinite(n)&&n>=0&&n<=255) && Number.isFinite(a) && a>=0 && a<=1){
      const aa = (a===0||a===1) ? String(a) : String(Math.round(a*1000)/1000);
      return `rgba(${r},${g},${b},${aa})`;
    }
  }
  return fallback;
}

function sanitizeColorsInState(){
  try{
    (state.accounts||[]).forEach(a=>{ if(a) a.color = safeColor(a.color, "#111827"); });
    (state.categories||[]).forEach(c=>{ if(c) c.color = safeColor(c.color, "#111827"); });
  }catch{}
}

const catPath=(id)=>pathOf(state.categories,id);
const accPath=(id)=>pathOf(state.accounts,id);
const catColor=(id)=>safeColor(state.categories.find(c=>c.id===id)?.color,"#0d6efd");

function canGoNegative(accId){
  const a=accById(accId)||state.accounts.find(x=>x.id===accId);
  return !!(a && a.allowNegative===true);
}

function balances(){
  // Saldos por cuenta en su propia moneda (redondeo estable a 2 decimales).
  const bal=new Map(state.accounts.map(a=>[a.id,0]));
  const r=(x)=>roundMoney(x, baseCur());
  for(const m of state.movements){
    const amt=Number(m.amount);
    if(!Number.isFinite(amt) || Math.abs(amt)<1e-12) continue;

    if(m.type==="Ingreso"){
      bal.set(m.accountId, r((bal.get(m.accountId)||0)+amt));
    }else if(m.type==="Gasto"){
      bal.set(m.accountId, r((bal.get(m.accountId)||0)-amt));
    }else if(m.type==="Transferencia"){
      bal.set(m.accountId, r((bal.get(m.accountId)||0)-amt));
      if(m.accountToId){
        const toAmt=Number(m.amountTo);
        const add = Number.isFinite(toAmt) ? toAmt : amt;
        bal.set(m.accountToId, r((bal.get(m.accountToId)||0)+add));
      }
    }
  }
  // normalizar
  for(const [k,v] of bal.entries()) bal.set(k, r(v));
  return bal;
}

function movOutflowEffect(m){
  if(!m) return 0;
  const amt = Number(m.amount)||0;
  // Devuelve lo que antes se descontó del saldo de la cuenta origen (para edición)
  if(m.type==="Gasto") return amt;
  if(m.type==="Transferencia") return amt;
  return 0;
}


function ensureSaldoInicialCategory(){
  const norm=(s)=>String(s||"").trim().toLowerCase();
  let inc=state.categories.find(c=>!c?.parentId && norm(c.name)==="ingresos");
  if(!inc){
    inc={id:uuid(),name:"Ingresos",parentId:null,active:true,color:"#10b981"};
    state.categories.push(inc);
  }
  let si=state.categories.find(c=>c?.parentId===inc.id && norm(c.name)==="saldo inicial");
  if(!si){
    si={id:uuid(),name:"Saldo inicial",parentId:inc.id,active:true,color:"#22c55e"};
    state.categories.push(si);
  }
  return si.id;
}

function openingMovForAccount(accId){
  return state.movements.find(m=>m && m.isOpening && m.accountId===accId) || null;
}

function upsertOpeningBalance(accId, amount, dateStr){
  const amt=Number(amount);
  const d=(dateStr||"").trim();
  const cur=accCur(accId);
  const catId=ensureSaldoInicialCategory();
  const period = d ? d.slice(0,7) : (new Date().toISOString().slice(0,7));
  let m=openingMovForAccount(accId);

  if(!(Number.isFinite(amt)) || amt<=0){
    if(m){
      state.movements = state.movements.filter(x=>x.id!==m.id);
      logEvent("delete","openingBalance",m.id,`Saldo inicial eliminado • ${accPath(accId)||""}`);
      normalizeCurrencyModel(); save();
    }
    return;
  }

  if(!d){
    msg({title:"Validación",kind:"warning",body:"La <b>Fecha</b> del saldo inicial es requerida."});
    return;
  }

  if(!m){
    m={id:uuid(),type:"Ingreso",date:d,period,accountId:accId,categoryId:catId,desc:"(Sistema) Saldo inicial",amount:amt,isSystem:true,isOpening:true};
    state.movements.push(m);
    logEvent("create","openingBalance",m.id,`Saldo inicial ${fmtMoney(amt,cur)} • ${accPath(accId)||""}`);
  }else{
    m.type="Ingreso";
    m.date=d; m.period=period;
    m.accountId=accId;
    m.categoryId=catId;
    m.desc="(Sistema) Saldo inicial";
    m.amount=amt;
    m.isSystem=true;
    m.isOpening=true;
    logEvent("update","openingBalance",m.id,`Saldo inicial ${fmtMoney(amt,cur)} • ${accPath(accId)||""}`);
  }
  normalizeCurrencyModel(); save();
}

function dateRangeForMonth(ym){
  if(!ym||!/^\d{4}-\d{2}$/.test(ym)) return null;
  const y=parseInt(ym.slice(0,4),10);
  const m=parseInt(ym.slice(5,7),10);
  const last=new Date(y,m,0).getDate();
  const start=`${ym}-01`;
  const end=`${ym}-${String(last).padStart(2,"0")}`;
  return {start,end};
}

function currentPeriod(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function ymAdd(ym,delta){
  if(!ym||!/^\d{4}-\d{2}$/.test(ym)) return currentPeriod();
  const y=parseInt(ym.slice(0,4),10);
  const m=parseInt(ym.slice(5,7),10)-1;
  const d=new Date(y, m+delta, 1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function lastNMonths(endYm,n=12){
  const end=endYm||currentPeriod();
  const out=[];
  for(let i=n-1;i>=0;i--) out.push(ymAdd(end,-i));
  return out;
}


function accBalanceAt(accId, dateStr){
  if(!accId) return 0;
  const d=(dateStr||"").trim();
  let bal=0;
  for(const m of state.movements){
    if(!m||!m.date) continue;
    if(d && String(m.date)>d) continue;
    const amt=Number(m.amount)||0; if(!amt) continue;
    if(m.type==="Ingreso" && m.accountId===accId) bal += amt;
    else if(m.type==="Gasto" && m.accountId===accId) bal -= amt;
    else if(m.type==="Transferencia"){
      if(m.accountId===accId) bal -= amt;
      if(m.accountToId===accId){
        const toAmt=Number(m.amountTo);
        bal += (Number.isFinite(toAmt)?toAmt:amt);
      }
    }
  }
  return bal;
}

function recGet(accId, ym){
  if(!accId||!ym) return null;
  return (state.reconciliations||[]).find(r=>r && r.accountId===accId && r.month===ym) || null;
}

function recUpsert(accId, ym, startAmt, endAmt, closed=false){
  state.reconciliations = Array.isArray(state.reconciliations)?state.reconciliations:[];
  const cur=accCur(accId);
  const s=Number(startAmt), e=Number(endAmt);
  let r=recGet(accId,ym);
  if(!r){
    r={id:uuid(),accountId:accId,month:ym,currency:cur,start:s,end:e,closed:!!closed,updatedAt:new Date().toISOString()};
    state.reconciliations.push(r);
    logEvent("create","reconciliation",r.id,`${accPath(accId)||""} • ${ym}`);
  }else{
    r.currency=cur;
    r.start=s;
    r.end=e;
    r.closed=!!closed;
    r.updatedAt=new Date().toISOString();
    logEvent("update","reconciliation",r.id,`${accPath(accId)||""} • ${ym}`);
  }
  save();
  return r;
}

function recToggleMovement(mid, ym, on){
  const m=state.movements.find(x=>x && x.id===mid);
  if(!m) return;
  if(on){
    m.reconciled=true;
    m.reconMonth=ym;
    m.reconciledAt=new Date().toISOString();
  }else{
    m.reconciled=false;
    m.reconMonth=null;
    m.reconciledAt=null;
  }
  save();
}



function balTotal(map){
  let s=0;
  for(const v of map.values()) s+=Number(v)||0;
  return s;
}
function kpis({year=null,month=null}){
  let inc=0,exp=0,sIn=0,sOut=0;
  for(const m of state.movements){
    if(year && !(m.period||"").startsWith(String(year)))continue;
    if(month && m.period!==month)continue;
    const amt=Number(m.amount)||0;if(!amt)continue;
    if(m.type==="Ingreso")inc+=amt; else if(m.type==="Gasto")exp+=amt;
    else if(m.type==="Ahorro")sIn+=amt; else if(m.type==="RetiroAhorro")sOut+=amt;
  }
  const sNet=sIn-sOut, available=inc-exp, net=available-sNet;
  const pctExp=inc>0?(exp/inc)*100:0;
  let status={t:"OK",k:"success",i:"bi-check-circle"};
  if(inc===0&&exp>0)status={t:"Sin ingresos",k:"warning",i:"bi-exclamation-triangle"};
  if(available<0||net<0)status={t:"Neto negativo",k:"danger",i:"bi-x-circle"};
  if(pctExp>=90&&inc>0)status={t:"Gasto alto",k:"warning",i:"bi-exclamation-triangle"};
  return {inc,exp,sNet,available,net,pctExp,status};
}
function years(){
  const s=new Set();
  for(const p of months()){
    const y=String(p||"").slice(0,4);
    if(y.length===4) s.add(y);
  }
  return [...s].sort((a,b)=>b.localeCompare(a));
}

function yearsRec(){
  const now=new Date().getFullYear();
  const s=new Set();
  for(let i=-1;i<=5;i++) s.add(now - i); // now+1 ... now-5
  for(const y of years()) s.add(Number(y));
  return [...s].filter(x=>Number.isFinite(x)).sort((a,b)=>b-a);
}
function monthsForYear(y){
  const yy=String(y||new Date().getFullYear());
  return Array.from({length:12},(_,i)=>`${yy}-${String(i+1).padStart(2,"0")}`);
}

function normalizeYearMonthInput(y,m,{syncYearFromMonth=true}={}){
  y=String(y||"").trim();
  m=String(m||"").trim();
  if(y && !/^\d{4}$/.test(y)) y="";
  if(m && !/^\d{4}-\d{2}$/.test(m)) m="";
  if(syncYearFromMonth && m){
    const my=m.slice(0,4);
    if(!y || y!==my) y=my;
  }
  return {y,m};
}
function ensureSelectHasValue(sel, value){
  const el = (typeof sel==="string")?document.querySelector(sel):sel;
  const v = String(value||"");
  if(!el || !v) return v||"";
  const ok = [...el.options].some(o=>String(o.value||o.text||"")===v || String(o.text||"")===v);
  return ok ? v : "";
}


function months(){
  const s=new Set();
  // meses presentes en datos
  state.movements.forEach(m=>m.period&&s.add(m.period));
  state.budgets.forEach(b=>b.period&&s.add(b.period));
  // rango util (±24 meses) para permitir selección aun sin datos
  const now=new Date();
  for(let i=-24;i<=24;i++){
    const d=new Date(now.getFullYear(), now.getMonth()+i, 1);
    s.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`);
  }
  return [...s].sort((a,b)=>b.localeCompare(a));
}

// ----- View helpers -----
function card(title,right,body){
  return `<div class="card sgf mb-3">
    <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
      <h2 class="h5 m-0 fw-bold">${title}</h2>
      <div class="d-flex gap-2 flex-wrap">${right||""}</div>
    </div>
    <div class="card-body">${body||""}</div>
  </div>`;
}
function buildTree(items,{collapsed,selected,metaFn,onToggle,onSelect,onEdit,onAdd,onActive}){
  const byP=new Map();items.forEach(it=>{const p=it.parentId||null;if(!byP.has(p))byP.set(p,[]);byP.get(p).push(it)});
  for(const [k,arr] of byP.entries())arr.sort((a,b)=>String(a.name).localeCompare(String(b.name),"es"));
  const node=(it)=>{
    const kids=byP.get(it.id)||[];const has=kids.length>0;const col=collapsed.has(it.id);
    const meta=metaFn?metaFn(it):"";
    return `<li>
      <div class="node ${selected===it.id?"sel":""}" data-id="${it.id}">
        <span class="caret" data-a="tog">${has?`<i class="bi ${col?"bi-caret-right-fill":"bi-caret-down-fill"}"></i>`:`<i class="bi bi-dot"></i>`}</span>
        <span class="d-flex align-items-center gap-2 flex-grow-1" data-a="sel">
          <span class="dot" style="background:${safeColor(it.color,"#111827")}"></span>
          <i class="bi ${has?(col?"bi-folder":"bi-folder2-open"):"bi-file-earmark"} text-secondary"></i>
          <span class="name" title="${esc(it.name)}">${esc(it.name)}</span>
          ${it.active?``:`<span class="badge text-bg-secondary rounded-pill">Inactiva</span>`}
        </span>
        <span class="meta">${meta}</span>
        <span class="actions">
          <button class="btn btn-sm btn-outline-dark" data-a="add" title="Agregar"><i class="bi bi-plus"></i></button>
          <button class="btn btn-sm btn-outline-primary" data-a="edit" title="Editar"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-secondary" data-a="act" title="Activar/Inactivar"><i class="bi ${it.active?"bi-eye-slash":"bi-eye"}"></i></button>
        </span>
      </div>
      ${has?`<ul class="${col?"hide":""}">${kids.map(node).join("")}</ul>`:""}
    </li>`;
  };
  const roots=byP.get(null)||[];
  const html=`<div class="tree"><ul class="p-0 m-0" style="list-style:none">${roots.map(node).join("")||`<li class="text-secondary">Sin registros</li>`}</ul></div>`;
  const wire=(host)=>{
    host.addEventListener("click",(ev)=>{
      const n=ev.target.closest(".node");if(!n)return;
      const id=n.dataset.id;const a=ev.target.closest("[data-a]")?.dataset.a;
      if(a==="tog")onToggle?.(id);
      else if(a==="edit")onEdit?.(id);
      else if(a==="add")onAdd?.(id);
      else if(a==="act")onActive?.(id);
      else onSelect?.(id);
    });
  };
  return {html,wire};
}

// ----- Render routes -----
function render(k){
if(k==="dashboard")renderDashboard();
  if(k==="accounts")renderAccounts();
  if(k==="categories")renderCategories();
  if(k==="movements")renderMovements();
  if(k==="reconciliations")renderReconciliations();
  if(k==="savings")renderSavings();
  if(k==="budgets")renderBudgets();
  if(k==="reports")renderReports();
  if(k==="settings")renderSettings();
}

/* Dashboard */
function renderDashboard(){
  const ys=years(), ms=months();
  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros (Periodo)</div>
          <div class="small text-secondary">Periodo contable ≠ fecha del registro.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap"><button class="btn btn-sm btn-dark" onclick="dashApply()"><i class="bi bi-funnel"></i> Aplicar</button>
          <button class="btn btn-sm btn-outline-dark" onclick="dashClear()"><i class="bi bi-x-circle"></i> Limpiar</button>
        </div>
      </div>
      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-3">
          <label class="form-label">Año</label>
          <select class="form-select" id="dY"><option value="">(Todo)</option>${ys.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Mes</label>
          <select class="form-select" id="dM"><option value="">(Todo)</option>${ms.map(m=>`<option value="${m}">${monthLabel(m)}</option>`).join("")}</select>
        </div>
      </div>
    </div>
  </div>`;

  const body=`${filters}<div id="dashHost"></div>`;

  $("#v-dashboard").innerHTML=card("Dashboard",
    `<button class="btn btn-outline-dark" onclick="help('dashboard')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#dY").value=state.ui.dY||"";$("#dM").value=state.ui.dM||"";

  // auto-aplicar al cambiar filtros
  $("#dY").onchange=()=>dashApply();
  $("#dM").onchange=()=>dashApply();

  dashApply();
}

function dashApply(){
  let y = $("#dY")?.value || "";
  let m = $("#dM")?.value || "";
  ({y,m} = normalizeYearMonthInput(y,m,{syncYearFromMonth:true}));

  // validar que existan en los combos (evita valores stale)
  y = ensureSelectHasValue("#dY", y);
  m = ensureSelectHasValue("#dM", m);

  // si hay mes, forzar coherencia año-mes
  if(m){
    const my = m.slice(0,4);
    if(!y || y!==my){
      y = ensureSelectHasValue("#dY", my) || my;
    }
  }

  state.ui.dY = y || "";
  state.ui.dM = m || "";

  if($("#dY")) $("#dY").value = state.ui.dY;
  if($("#dM")) $("#dM").value = state.ui.dM;

  dashRender(state.ui.dY||null, state.ui.dM||null);
}
function dashClear(){
  state.ui.dY="";
  state.ui.dM="";
  if($("#dY")) $("#dY").value="";
  if($("#dM")) $("#dM").value="";
  dashRender(null,null);
}
function dashRender(year=null,month=null){
  const items=state.movements.filter(x=>["Ingreso","Gasto","Transferencia"].includes(x.type))
    .filter(x=>!year||(x.period||"").startsWith(String(year)))
    .filter(x=>!month||x.period===month)
    .filter(x=>!x.isSystem && !x.isOpening);

  let inc=0,out=0;
  for(const x of items){
    const a=Number(x.amountBase!=null?x.amountBase:x.amount)||0;
    if(x.type==="Ingreso") inc+=a;
    else if(x.type==="Gasto") out+=a;
  }
  const net=inc-out;

  // balances in base currency (using config fxRates)
  const bal=balances();
  const savAcc=state.config.savingsAccountId;
  const savAccUSD=state.config.savingsAccountIdUSD;
  let totalBase=0, savBase=0, missing=[];
  for(const [id,v] of bal.entries()){
    const cur=accCur(id);
    const r=fxRate(cur);
    if(cur!==baseCur() && !r) missing.push(cur);
    const b=(cur===baseCur())?Number(v)||0:toBase(Number(v)||0,cur,r);
    if(Number.isFinite(b)) totalBase+=b;
    if((id===savAcc || id===savAccUSD) && Number.isFinite(b)) savBase+=b;
  }
  const dispo=totalBase - savBase;
  const pct = inc>0 ? clamp((out/inc)*100,0,999) : 0;

  const warn = missing.length
    ? `<div class="alert alert-warning border-0 mb-3" style="background:rgba(255,193,7,.15)"><b>Falta tipo de cambio</b> para: ${[...new Set(missing)].join(", ")}. Ajusta en <b>Configuración</b>.</div>`
    : ``;

  const kpi=`${warn}<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-4">
      <div class="kpi kpi-income">
        <div class="kpi-title">Ingresos (${baseCur()})</div>
        <div class="kpi-value">${fmtMoney(inc,baseCur())}</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi kpi-expense">
        <div class="kpi-title">Gastos (${baseCur()})</div>
        <div class="kpi-value">${fmtMoney(out,baseCur())}</div>
        <div class="kpi-sub">${pct.toFixed(0)}% de ingresos</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi kpi-savings">
        <div class="kpi-title">Ahorros netos (${baseCur()})</div>
        <div class="kpi-value">${fmtMoney(savBase,baseCur())}</div>
        <div class="kpi-sub">Saldo en Ahorros (SGF)</div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="kpi kpi-neutral">
        <div class="kpi-title">Disponible (${baseCur()})</div>
        <div class="kpi-value">${fmtMoney(dispo,baseCur())}</div>
        <div class="kpi-sub">Total consolidado sin Ahorros</div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="kpi ${net>=0?'kpi-neutral':'kpi-warn'}">
        <div class="kpi-title">Neto (${baseCur()})</div>
        <div class="kpi-value">${fmtMoney(net,baseCur())}</div>
        <div class="kpi-sub">${net>=0?'Balance positivo':'Balance negativo'}</div>
      </div>
    </div>
</div>`;

  const extra = dashBuildExtras({items,year,month,bal});

  $("#dashHost").innerHTML=`${kpi}${extra}`;
}

function dashGoRoot(rootId){
  // Reutiliza el periodo del Dashboard como periodo de Reportes
  state.ui.rY = state.ui.dY||"";
  state.ui.rM = state.ui.dM||"";
  state.ui.rV = "pro";
  state.ui.rT = "Gasto";
  state.ui.rRoot = rootId||"";
  state.ui.rQ = "";
  go("reports");
}
function dashGoAcc(accId){
  state.ui.selAcc = accId;
  go("accounts");
}

function dashBuildExtras({items,year,month,bal}){
  const act = ``;

  const exp = dashExpenseByRoot(items);
  const topR = [...exp.byRoot.entries()]
    .map(([id,amt])=>({id,amt,name:(state.categories.find(c=>c.id===id)?.name)||"(Sin nombre)"}))
    .sort((a,b)=>b.amt-a.amt)
    .slice(0,6);

  const expRows = topR.length ? topR.map(r=>{
    const pct = exp.total>0 ? clamp((r.amt/exp.total)*100,0,999) : 0;
    return `<tr>
      <td><a href="#" class="dash-link" onclick="dashGoRoot('${esc(r.id)}');return false;">${esc(r.name)}</a></td>
      <td class="text-end">${fmtMoney(r.amt, baseCur())}</td>
      <td style="width:160px">
        <div class="progress"><div class="progress-bar" role="progressbar" style="width:${pct.toFixed(1)}%"></div></div>
      </td>
    </tr>`;
  }).join("") : `<tr><td colspan="3" class="text-secondary">Sin gastos en el periodo.</td></tr>`;

  const accList = [];
  for(const [id,v] of bal.entries()){
    const cur=accCur(id);
    const r=fxRate(cur);
    const base = (cur===baseCur()) ? Number(v)||0 : (r? toBase(Number(v)||0,cur,r) : null);
    accList.push({id,cur,raw:Number(v)||0,base});
  }
  const topA = accList
    .filter(x=>x.base!=null && Number.isFinite(x.base))
    .sort((a,b)=>b.base-a.base)
    .slice(0,6);

  const accRows = topA.length ? topA.map(a=>{
    const nm = (state.accounts.find(x=>x.id===a.id)?.name)||"(Sin nombre)";
    const isSav = (a.id===state.config.savingsAccountId || a.id===state.config.savingsAccountIdUSD);
    return `<tr>
      <td>
        <a href="#" class="dash-link" onclick="dashGoAcc('${esc(a.id)}');return false;">${esc(nm)}</a>
        ${isSav?`<span class="badge text-bg-light border ms-1">Ahorros</span>`:""}
      </td>
      <td class="text-end">${fmtMoney(a.base, baseCur())}</td>
    </tr>`;
  }).join("") : `<tr><td colspan="2" class="text-secondary">No hay saldos para mostrar.</td></tr>`;

  const tables = `<div class="row g-3 mt-0 dash-mini sgf-land-stack">
  </div>`;

  return act + tables;
}

function dashExpenseByRoot(items){
  const byRoot = new Map();
  let total = 0;

  const rootOf = (catId)=>{
    if(!catId) return null;
    let cur = state.categories.find(c=>c.id===catId);
    let g=0;
    while(cur && cur.parentId && g++<20){
      const p = state.categories.find(c=>c.id===cur.parentId);
      if(!p) break;
      cur=p;
    }
    return cur ? cur.id : catId;
  };

  const splitBase = (m,s)=>{
    if(!s) return 0;
    if(s.amountBase!=null) return Number(s.amountBase)||0;
    const base=baseCur();
    const cur=(m.currency||accCur(m.accountId)||base);
    const a=Number(s.amount)||0;
    if(cur===base) return a;
    const r=Number(m.rateToBase)||fxRateAt(cur,m.date)||1;
    return toBase(a,cur,r);
  };

  for(const m of items){
    if(!m || m.type!=="Gasto") continue;

    if(Array.isArray(m.splits) && m.splits.length){
      for(const s of m.splits){
        if(!s || !s.categoryId) continue;
        const rid=rootOf(s.categoryId); if(!rid) continue;
        const amt=splitBase(m,s);
        total += amt;
        byRoot.set(rid, (byRoot.get(rid)||0) + amt);
      }
    }else{
      if(!m.categoryId) continue;
      const rid=rootOf(m.categoryId); if(!rid) continue;
      const amt=Number(m.amountBase!=null?m.amountBase:m.amount)||0;
      total += amt;
      byRoot.set(rid, (byRoot.get(rid)||0) + amt);
    }
  }
  return {byRoot,total};
}



/* Accounts */
function renderAccounts(){
  const q=(state.ui.accQ||"").trim().toLowerCase();

  const body=`<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="small text-secondary">Treeview estilo Explorer. Máximo <b>3 niveles</b>.</div>
        <div class="small text-secondary" id="accCount"></div>
      </div>
      <div class="input-group mb-2">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input class="form-control" id="accSearch" placeholder="Buscar cuenta..." value="${esc(state.ui.accQ||"")}">
        <button class="btn btn-outline-dark" id="accClear" type="button" title="Limpiar"><i class="bi bi-x-lg"></i></button>
      </div>
      <div id="accTree"></div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="card sgf"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center"><div class="fw-bold">Detalle</div><span class="badge-soft">Selecciona una cuenta</span></div>
        <div id="accDet" class="mt-3 small text-secondary">Usa el botón <b>+</b> en el árbol para crear subcuentas.</div>
      </div></div>
    </div>
</div>`;

  $("#v-accounts").innerHTML=card("Cuentas",
    `<button class="btn btn-dark" onclick="accEdit()"><i class="bi bi-plus"></i> Nueva</button>
     <button class="btn btn-outline-dark" onclick="treeExpand('acc')"><i class="bi bi-arrows-expand"></i></button>
     <button class="btn btn-outline-dark" onclick="treeCollapse('acc')"><i class="bi bi-arrows-collapse"></i></button>
     <button class="btn btn-outline-dark" onclick="regenColors('acc')"><i class="bi bi-palette2"></i></button>
     <button class="btn btn-outline-dark" onclick="help('accounts')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  // filtro (muestra coincidencias + ancestros + descendientes)
  let list=[...state.accounts];
  if(q){
    const byId=new Map(list.map(a=>[a.id,a]));
    const children=new Map();
    for(const a of list){
      const p=a.parentId||null;
      if(!children.has(p)) children.set(p,[]);
      children.get(p).push(a.id);
    }
    const visible=new Set();
    const addAnc=(id)=>{
      let cur=byId.get(id);
      while(cur && cur.parentId){
        visible.add(cur.parentId);
        cur=byId.get(cur.parentId);
      }
    };
    const addDesc=(id)=>{
      const stack=[id];
      while(stack.length){
        const x=stack.pop();
        const kids=children.get(x)||[];
        for(const k of kids){ if(!visible.has(k)){ visible.add(k); stack.push(k);} }
      }
    };
    for(const a of list){
      const txt=((accPath(a.id)||a.name||"")+"").toLowerCase();
      if(txt.includes(q)){
        visible.add(a.id);
        addAnc(a.id);
        addDesc(a.id);
      }
    }
    list=list.filter(a=>visible.has(a.id));
    // si no hay coincidencias, mostrar vacío
  }

  const metaFn=(a)=> isAccountUsedSubtree(a.id) ? `<span class="badge-soft ms-2" title="Tiene movimientos/presupuestos asociados">En uso</span>` : ``;
  const host=$("#accTree");
  const t=buildTree(list,{collapsed:state.ui.accCol,selected:state.ui.selAcc,metaFn,
    onToggle:(id)=>{state.ui.accCol.has(id)?state.ui.accCol.delete(id):state.ui.accCol.add(id);saveCollapsed();renderAccounts()},
    onSelect:(id)=>{state.ui.selAcc=id;renderAccounts()},
    onEdit:(id)=>accEdit(id),
    onAdd:(id)=>accEdit(null,id),
    onActive:(id)=>accToggle(id)
  });
  host.innerHTML=t.html; t.wire(host);

  // contador + buscador
  $("#accCount").textContent = q ? `${list.length} resultado(s)` : `${state.accounts.length} cuenta(s)`;
  const inp=$("#accSearch");
  const clr=$("#accClear");
  if(state.ui._accFocus){
    try{inp.focus(); const p=Number(state.ui._accPos||inp.value.length); inp.setSelectionRange(p,p);}catch{}
    state.ui._accFocus=false;
  }
  inp.addEventListener("input",()=>{state.ui.accQ=inp.value; state.ui._accPos=inp.selectionStart||0; state.ui._accFocus=true; debounce("accSearch",()=>renderAccounts(),260);});
  clr.addEventListener("click",()=>{state.ui.accQ=""; state.ui._accFocus=true; state.ui._accPos=0; renderAccounts();});
  try{accDetail();}catch(e){console.error(e); try{$('#accDet').innerHTML='<div class="text-danger small">Error al cargar detalle de cuenta.</div>'}catch{}}
}
function accTotal(rootId,bal){
  let sum=bal.get(rootId)||0;
  state.accounts.filter(a=>a.parentId===rootId).forEach(c=>sum+=accTotal(c.id,bal));
  return sum;
}
function treeExpand(kind){(kind==="acc"?state.ui.accCol:state.ui.catCol).clear();saveCollapsed();render(state.ui.route)}
function treeCollapse(kind){
  const set=(kind==="acc"?state.ui.accCol:state.ui.catCol);
  const items=(kind==="acc"?state.accounts:state.categories);
  const parents=new Set(items.map(x=>x.parentId).filter(Boolean));parents.forEach(id=>set.add(id));
  saveCollapsed();render(state.ui.route);
}
function accDetail(){
  const id=state.ui.selAcc;
  const el=$("#accDet");
  if(!el) return;

  if(!id){
    el.innerHTML=`<div class="text-secondary">No hay cuenta seleccionada.</div>`;
    return;
  }
  const a=state.accounts.find(x=>x.id===id);
  if(!a){ el.textContent="No encontrada"; return; }

  const bal=balances();
  const self=bal.get(id)||0;
  const total=accTotal(id,bal);
  const cur=a.currency||baseCur();

  const open=openingMovForAccount(id);
  const openTxt=open ? `${fmtMoney(Number(open.amount)||0,cur)} • ${esc(open.date||"")}` : `<span class="text-secondary">No definido</span>`;

  const now=new Date();
  const ymDef=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const ym=(state.ui.recYM && String(state.ui.recYM).match(/^\d{4}-\d{2}$/)) ? state.ui.recYM : ymDef;
  const yVal=ym.slice(0,4);

  const ys=yearsRec();
  const makeMonths=(y)=>Array.from({length:12},(_,i)=>`${y}-${String(i+1).padStart(2,"0")}`);
  const ms=makeMonths(yVal);

  el.innerHTML=`
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">${esc(a.name)}</div>
        <div class="small text-secondary">Tipo: <b>${esc(a.type)}</b> • Moneda: <b>${esc(cur)}</b></div>
      </div>
      <span class="dot" style="width:18px;height:18px;border-radius:6px;background:${safeColor(a.color,"#111827")}"></span>
    </div>
    <hr class="my-3"/>

    <div class="row g-2">
      <div class="col-6">
        <div class="small text-secondary">Saldo actual</div>
        <div class="fw-bold">${fmtMoney(self,cur)}</div>
      </div>
      <div class="col-6">
        <div class="small text-secondary">Total (incl. subcuentas)</div>
        <div class="fw-bold">${fmtMoney(total,cur)}</div>
      </div>
    </div>

    <div class="card sgf mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Saldo inicial</div>
          <button class="btn btn-sm btn-outline-dark" onclick="accOpenEdit('${esc(id)}')"><i class="bi bi-pencil-square"></i> Editar</button>
        </div>
        <div class="small mt-2">${openTxt}</div>
        <div class="small text-secondary mt-2">El saldo inicial <b>no se considera ingreso</b> para KPIs/reportes (por defecto), pero sí para el cálculo de saldos.</div>
      </div>
    </div>

    <div class="card sgf mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Conciliación mensual</div>
          <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-dark" type="button" onclick="help('reconciliation')"><i class="bi bi-question-circle"></i> Ayuda</button>
            <span class="badge-soft">Extracto bancario</span>
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label">Año</label>
            <select class="form-select" id="recY">${ys.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
          </div>
          <div class="col-6">
            <label class="form-label">Mes</label>
            <select class="form-select" id="recM">${ms.map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}</select>
          </div>
        </div>
        <div id="recHost" class="mt-3"></div>
      </div>
    </div>

    ${(a.id===state.config.savingsAccountId||a.id===state.config.savingsAccountIdUSD)?`<div class="small text-secondary mt-3"><b>Nota:</b> cuenta especial de Ahorros (SGF) (${esc(a.currency||baseCur())}).</div>`:""}
  `;

  const ySel=$("#recY"), mSel=$("#recM");
  if(ySel) ySel.value=yVal;
  if(mSel) mSel.value=ym;

  const refresh=()=>{
    const ym2=(($("#recM")?.value)||ymDef);
    state.ui.recYM=ym2;
    recRender(id, ym2);
  };

  ySel?.addEventListener("change",()=>{
    const y=($("#recY")?.value)||yVal;
    const prevMm=(String($("#recM")?.value||ym).slice(5,7) || "01");
    const next=`${y}-${prevMm}`;
    const opts=makeMonths(y).map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("");
    if(mSel){ mSel.innerHTML=opts; mSel.value=next; }
    refresh();
  });

  mSel?.addEventListener("change",refresh);
  refresh();
}

function accOpenEdit(accId){
  const a=accById(accId); if(!a) return;
  const cur=accCur(accId);
  const open=openingMovForAccount(accId);
  const body=`<div class="row g-3">
    <div class="col-12"><div class="small text-secondary">Cuenta: <b>${esc(accPath(accId)||a.name)}</b> • Moneda: <b>${esc(cur)}</b></div></div>
    <div class="col-12 col-md-6">
      <label class="form-label">Monto</label>
      <input class="form-control" id="opAmt" inputmode="decimal" placeholder="0.00" value="${esc(open?String(open.amount||""):"")}">
      <div class="small text-secondary mt-1">Usa 0 para <b>eliminar</b> el saldo inicial.</div>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Fecha</label>
      <input type="date" class="form-control" id="opDate" value="${esc(open?.date||new Date().toISOString().slice(0,10))}">
      <div class="small text-secondary mt-1">Se guarda el periodo contable según la fecha.</div>
    </div>
</div>`;
  const footer=`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="opSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:"Saldo inicial",body,footer});
  $("#opSave").addEventListener("click",()=>{
    const amt=parseAmount($("#opAmt").value||"0");
    const date=$("#opDate").value||"";
    upsertOpeningBalance(accId, amt, date);
    closeEditor();
    toast("Saldo inicial actualizado.","success");
    renderAccounts();
  });
}

function recRender(accId, ym, hostSel="#recHost"){
  const host = (typeof hostSel==="string") ? $(hostSel) : hostSel;
  if(!host) return;
  const a=accById(accId); if(!a) return;
  const cur=accCur(accId);
  const rg=dateRangeForMonth(ym);
  if(!rg){ host.innerHTML=`<div class="text-secondary small">Seleccione un mes válido.</div>`; return; }

  const prevDay = (()=>{ const d=new Date(rg.start+"T00:00:00"); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
  const startBal = accBalanceAt(accId, prevDay);
  const endBal = accBalanceAt(accId, rg.end);

  const rec=recGet(accId,ym);
  const startVal = (rec && Number.isFinite(Number(rec.start))) ? Number(rec.start) : startBal;
  const endVal = (rec && Number.isFinite(Number(rec.end))) ? Number(rec.end) : endBal;
  const closed = !!rec?.closed;

  const diff = Number(endVal) - Number(endBal);

  const movs = state.movements.filter(m=>{
    if(!m||!m.date) return false;
    if(m.isOpening) return false;
    if(!["Ingreso","Gasto","Transferencia"].includes(m.type)) return false;
    if(m.date < rg.start || m.date > rg.end) return false;
    return m.accountId===accId || m.accountToId===accId;
  }).sort((a,b)=> String(a.date||"").localeCompare(String(b.date||"")) || String(a.id||"").localeCompare(String(b.id||"")));

  const signedAmt=(m)=>{
    const amt=Number(m.amount)||0;
    if(m.type==="Ingreso" && m.accountId===accId) return +amt;
    if(m.type==="Gasto" && m.accountId===accId) return -amt;
    if(m.type==="Transferencia"){
      if(m.accountId===accId) return -amt;
      if(m.accountToId===accId){
        const toAmt=Number(m.amountTo);
        return +(Number.isFinite(toAmt)?toAmt:amt);
      }
    }
    return 0;
  };

  const recNet = movs.filter(m=>m.reconciled && m.reconMonth===ym).reduce((s,m)=>s+signedAmt(m),0);
  const unrecNet = movs.filter(m=>!(m.reconciled && m.reconMonth===ym)).reduce((s,m)=>s+signedAmt(m),0);

  const rows = movs.map(m=>{
    const s=signedAmt(m);
    const badge=m.type==="Ingreso"?"text-bg-success":m.type==="Gasto"?"text-bg-danger":"text-bg-primary";
    const chk = (m.reconciled && m.reconMonth===ym) ? "checked" : "";
    const cat = movementHasSplit(m) ? splitLabelShort(m) : (m.categoryId ? (catPath(m.categoryId)||"") : "");
    const desc = esc(m.desc||"");
    const amtTxt = s>=0 ? `<span class="text-success">${fmtMoney(s,cur)}</span>` : `<span class="text-danger">${fmtMoney(s,cur)}</span>`;
    return `<tr>
      <td class="text-nowrap">${esc(m.date||"")}</td>
      <td><span class="badge ${badge}">${esc(m.type)}</span></td>
      <td class="small">${desc}${m.isSystem?` <span class="badge-soft ms-1">Sistema</span>`:""}</td>
      <td class="small text-secondary">${esc(cat)}</td>
      <td class="text-end text-nowrap">${amtTxt}</td>
      <td class="text-end">
        <input class="form-check-input recChk" type="checkbox" data-id="${esc(m.id)}" ${chk} ${closed?"disabled":""}>
      </td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="text-secondary small">Sin movimientos para este mes.</td></tr>`;

  host.innerHTML = `
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <div class="small text-secondary">Saldo inicial (sistema)</div>
        <div class="fw-bold">${fmtMoney(startBal,cur)}</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="small text-secondary">Saldo final (sistema)</div>
        <div class="fw-bold">${fmtMoney(endBal,cur)}</div>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 col-md-6">
        <label class="form-label">Saldo inicial (extracto)</label>
        <input class="form-control recStart" inputmode="decimal" value="${esc(String(startVal))}" ${closed?"disabled":""}>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Saldo final (extracto)</label>
        <input class="form-control recEnd" inputmode="decimal" value="${esc(String(endVal))}" ${closed?"disabled":""}>
      </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
      <div class="small text-secondary">Diferencia (extracto - sistema): <b>${fmtMoney(diff,cur)}</b></div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-dark recAll" ${closed?"disabled":""} title="Marcar todos"><i class="bi bi-check2-square"></i></button>
        <button class="btn btn-sm btn-outline-dark recNone" ${closed?"disabled":""} title="Desmarcar"><i class="bi bi-square"></i></button>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <div class="small text-secondary">Neto conciliado</div>
        <div class="fw-bold">${fmtMoney(recNet,cur)}</div>
      </div>
      <div class="col-6">
        <div class="small text-secondary">Neto sin conciliar</div>
        <div class="fw-bold">${fmtMoney(unrecNet,cur)}</div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-dark btn-sm recSave" ${closed?"disabled":""}><i class="bi bi-save"></i> Guardar</button>
      <button class="btn btn-outline-dark btn-sm recClose">${closed?'<i class="bi bi-unlock"></i> Reabrir':'<i class="bi bi-lock"></i> Cerrar mes'}</button>
    </div>

    <div class="table-responsive mt-3" style="max-height:340px;overflow:auto">
      <table class="table table-sm align-middle">
        <thead class="sticky-top bg-white">
          <tr><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Categoría</th><th class="text-end">Monto</th><th class="text-end">OK</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  host.querySelectorAll(".recChk").forEach(ch=>{
    ch.addEventListener("change",(ev)=>{
      const id=ev.target.getAttribute("data-id");
      const on=!!ev.target.checked;
      recToggleMovement(id, ym, on);
    });
  });

  host.querySelector(".recAll")?.addEventListener("click",()=>{
    host.querySelectorAll(".recChk").forEach(ch=>{ if(!ch.checked){ ch.checked=true; recToggleMovement(ch.getAttribute("data-id"),ym,true); }});
    recRender(accId,ym,hostSel);
  });
  host.querySelector(".recNone")?.addEventListener("click",()=>{
    host.querySelectorAll(".recChk").forEach(ch=>{ if(ch.checked){ ch.checked=false; recToggleMovement(ch.getAttribute("data-id"),ym,false); }});
    recRender(accId,ym,hostSel);
  });

  host.querySelector(".recSave")?.addEventListener("click",()=>{
    const s=parseAmount(host.querySelector(".recStart")?.value||"0");
    const e=parseAmount(host.querySelector(".recEnd")?.value||"0");
    recUpsert(accId, ym, s, e, false);
    toast("Conciliación guardada.","success");
    recRender(accId, ym, hostSel);
  });

  host.querySelector(".recClose")?.addEventListener("click",()=>{
    const s=parseAmount(host.querySelector(".recStart")?.value||"0");
    const e=parseAmount(host.querySelector(".recEnd")?.value||"0");
    const r=recUpsert(accId, ym, s, e, !closed);
    toast(r.closed?"Mes cerrado.":"Mes reabierto.","success");
    recRender(accId, ym, hostSel);
  });
}


function accToggle(id){
  const a=state.accounts.find(x=>x.id===id);if(!a)return;
  if((a.id===state.config.savingsAccountId || a.id===state.config.savingsAccountIdUSD) && a.active){
    msg({title:"No permitido",kind:"warning",body:"Las cuentas <b>Ahorros (SGF)</b> no pueden inactivarse."});return;
  }
  a.active=!a.active;save();toast("Cuenta actualizada.","success");renderAccounts();
}
function accEdit(editId=null,parentId=null){
  const isEdit=!!editId;const a=isEdit?state.accounts.find(x=>x.id===editId):null;if(isEdit&&!a)return;
  const types=["Efectivo","Banco","Tarjeta","Ahorro"];
  const parentOpts=state.accounts.filter(x=>x.active && (!isEdit||x.id!==editId))
    .map(x=>`<option value="${x.id}">${esc(accPath(x.id)||x.name)}</option>`).join("");

  const parInit = parentId||a?.parentId||"";
  const inheritedCur = parInit ? accCur(parInit) : null;
  const inheritedCol = parInit ? (accById(parInit)?.color||null) : null;
  const curInit = (a?.currency||inheritedCur||baseCur());

  const curOpts=CURRENCIES.map(c=>`<option value="${c.code}">${c.label}</option>`).join("");
  const curHelp = inheritedCur
    ? `<div class="small text-secondary mt-1">La moneda se <b>hereda</b> de la cuenta padre (${esc(inheritedCur)}).</div>`
    : `<div class="small text-secondary mt-1">Moneda de la cuenta (afecta montos y conversiones).</div>`;

  const body=`<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-6"><label class="form-label">Nombre</label><input class="form-control" id="aName" maxlength="120" value="${esc(a?.name||"")}" placeholder="Ej: Banco"></div>
    <div class="col-12 col-md-3"><label class="form-label">Tipo</label><select class="form-select" id="aType">${types.map(t=>`<option>${t}</option>`).join("")}</select></div>
    <div class="col-12 col-md-3"><label class="form-label">Color</label><input type="color" class="form-control form-control-color w-100" id="aCol" value="${esc(a?.color||inheritedCol||"#111827")}"></div>
    <div class="col-12 col-md-6"><label class="form-label">Cuenta padre (opcional)</label>
      <select class="form-select" id="aPar"><option value="">(Raíz)</option>${parentOpts}</select>
      <div class="small text-secondary mt-1">Máximo 3 niveles, sin ciclos.</div>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Moneda</label>
      <select class="form-select" id="aCur" ${inheritedCur?"disabled":""}>${curOpts}</select>
      ${curHelp}
    </div>
    <div class="col-12 col-md-6">
      <div class="form-check mt-4 pt-2">
        <input class="form-check-input" type="checkbox" id="aNeg">
        <label class="form-check-label" for="aNeg">Permitir saldo negativo</label>
        <div class="small text-secondary mt-1">Útil para <b>tarjetas de crédito</b> o cuentas con <b>sobregiro</b>.</div>
      </div>
    </div>
</div>`;
  const delBtn = (isEdit && canDeleteAccount(editId).ok) ? `<button class="btn btn-outline-danger me-auto" id="aDel"><i class="bi bi-trash"></i> Eliminar</button>` : ``;
  const footer=`${delBtn}<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="aSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:isEdit?"Editar cuenta":"Nueva cuenta",body,footer});
  const aDel=$("#aDel"); if(aDel) aDel.addEventListener("click",()=>{closeEditor();accDelete(editId);});
  $("#aType").value=a?.type||"Banco";
  const aNeg=$("#aNeg");
  let negTouched=false;
  if(aNeg){
    aNeg.checked = (a?.allowNegative!==undefined) ? !!a.allowNegative : ( ($("#aType").value||"") === "Tarjeta");
    aNeg.addEventListener("change",()=>{negTouched=true;});
  }
  $("#aType").addEventListener("change",()=>{
    if(!isEdit && aNeg && !negTouched){
      aNeg.checked = (($("#aType").value||"") === "Tarjeta");
    }
  });
  sortSelectOptions("#aPar",true);
  $("#aPar").value=parInit;
  sortSelectOptions("#aCur",false);
  $("#aCur").value=curInit;
  let colTouched=false;
  $("#aCol").addEventListener("input",()=>{colTouched=true;});

  // if editing savings account, lock
  if(isEdit && (editId===state.config.savingsAccountId || editId===state.config.savingsAccountIdUSD)){
    $("#aPar").disabled=true;
    $("#aType").disabled=true;
    $("#aCur").disabled=true;
  }

  const syncCur=()=>{
    const p=$("#aPar").value||"";
    if(p){
      const pc=accCur(p);
      $("#aCur").value=pc;
      $("#aCur").disabled=true;

      const pa=accById(p);
      if(pa && pa.color && !colTouched){
        const cur=($("#aCol").value||"").trim().toLowerCase();
        // en creación o si venía con default, copiamos el color del padre
        if(!isEdit || !cur || cur==="#111827") $("#aCol").value=pa.color;
      }
    }else{
      // if not inherited, allow unless editing subaccount
      if(!isEdit || !a?.parentId) $("#aCur").disabled=false;
      if(isEdit && a?.parentId) $("#aCur").disabled=true;
    }
  };
  $("#aPar").addEventListener("change",syncCur); syncCur();
$("#aSave").addEventListener("click",()=>{
    const btn=$("#aSave"); if(btn) btn.disabled=false;
    const name=$("#aName").value.trim();
    const type=$("#aType").value;
    const color=$("#aCol").value||"#111827";
    const p=$("#aPar").value||null;
    const cur = p ? accCur(p) : ($("#aCur").value||baseCur());
    const allowNegative = !!($("#aNeg")?.checked);

    if(!name){if(btn) btn.disabled=false;
    msg({title:"Validación",kind:"warning",body:"El <b>Nombre</b> es requerido."});return}
    if(isEdit && (editId===state.config.savingsAccountId || editId===state.config.savingsAccountIdUSD)){
      if(p){msg({title:"No permitido",kind:"warning",body:"<b>Ahorros (SGF)</b> debe estar en la raíz."});return}
      if(type!=="Ahorro"){msg({title:"No permitido",kind:"warning",body:"<b>Ahorros (SGF)</b> debe ser tipo <b>Ahorro</b>."});return}
      // always base currency
      const b=baseCur();
      if(cur!==b){msg({title:"No permitido",kind:"warning",body:"<b>Ahorros (SGF)</b> siempre usa la <b>moneda base</b>."});return}
    }
    if(isEdit && hasCycle(state.accounts,editId,p)){msg({title:"Validación",kind:"danger",body:"No se permiten ciclos padre/hijo."});return}
    if(isEdit && exceed3(state.accounts,editId,p)){msg({title:"Validación",kind:"warning",body:"Máximo <b>3 niveles</b>."});return}
    if(!isEdit){
      const d=(p?depthOf(state.accounts,p):0)+1;
      if(d>3){msg({title:"Validación",kind:"warning",body:"Máximo <b>3 niveles</b>."});return}
      state.accounts.push({id:uuid(),name,type,parentId:p,active:true,color,currency:cur,allowNegative});
    }else{
      // currency rules: inherit from parent; cannot change if has children or movements
      const hasKids=state.accounts.some(x=>x.parentId===a.id);
      const used=state.movements.some(m=>m.accountId===a.id||m.accountToId===a.id);
      if((a.currency||baseCur())!==cur){
        if(hasKids){msg({title:"No permitido",kind:"warning",body:"No puedes cambiar la <b>moneda</b> de una cuenta con <b>subcuentas</b>."});return}
        if(used){msg({title:"No permitido",kind:"warning",body:"No puedes cambiar la <b>moneda</b> de una cuenta con <b>movimientos</b>."});return}
      }
      a.name=name;a.type=type;a.parentId=p;a.color=color;a.currency=cur;a.allowNegative=allowNegative;
    }

  ensureSavingsAccount();save();closeEditor();toast("Cuenta guardada.","success");renderAccounts();
  });
}

/* Categories */
function renderCategories(){
  const q=(state.ui.catQ||"").trim().toLowerCase();

  const body=`<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="small text-secondary">Categorías con color. Máximo <b>3 niveles</b>.</div>
        <div class="small text-secondary" id="catCount"></div>
      </div>
      <div class="input-group mb-2">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input class="form-control" id="catSearch" placeholder="Buscar categoría..." value="${esc(state.ui.catQ||"")}">
        <button class="btn btn-outline-dark" id="catClear" type="button" title="Limpiar"><i class="bi bi-x-lg"></i></button>
      </div>
      <div id="catTree"></div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="card sgf"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center"><div class="fw-bold">Detalle</div><span class="badge-soft">Selecciona una categoría</span></div>
        <div id="catDet" class="mt-3 small text-secondary">Usa <b>+</b> para crear subcategorías.</div>
      </div></div>
    </div>
</div>`;

  $("#v-categories").innerHTML=card("Categorías",
    `<button class="btn btn-dark" onclick="catEdit()"><i class="bi bi-plus"></i> Nueva</button>
     <button class="btn btn-outline-dark" onclick="treeExpand('cat')"><i class="bi bi-arrows-expand"></i></button>
     <button class="btn btn-outline-dark" onclick="treeCollapse('cat')"><i class="bi bi-arrows-collapse"></i></button>
     <button class="btn btn-outline-dark" onclick="regenColors('cat')"><i class="bi bi-palette2"></i></button>
     <button class="btn btn-outline-dark" onclick="help('categories')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  let list=[...state.categories];
  if(q){
    const byId=new Map(list.map(a=>[a.id,a]));
    const children=new Map();
    for(const c of list){
      const p=c.parentId||null;
      if(!children.has(p)) children.set(p,[]);
      children.get(p).push(c.id);
    }
    const visible=new Set();
    const addAnc=(id)=>{
      let cur=byId.get(id);
      while(cur && cur.parentId){
        visible.add(cur.parentId);
        cur=byId.get(cur.parentId);
      }
    };
    const addDesc=(id)=>{
      const stack=[id];
      while(stack.length){
        const x=stack.pop();
        const kids=children.get(x)||[];
        for(const k of kids){ if(!visible.has(k)){ visible.add(k); stack.push(k);} }
      }
    };
    for(const c of list){
      const txt=((catPath(c.id)||c.name||"")+"").toLowerCase();
      if(txt.includes(q)){
        visible.add(c.id);
        addAnc(c.id);
        addDesc(c.id);
      }
    }
    list=list.filter(c=>visible.has(c.id));
  }

  const metaFn=(c)=> isCategoryUsedSubtree(c.id) ? `<span class="badge-soft ms-2" title="Usada en movimientos/presupuestos">En uso</span>` : ``;
  const host=$("#catTree");
  const t=buildTree(list,{collapsed:state.ui.catCol,selected:state.ui.selCat,metaFn,
    onToggle:(id)=>{state.ui.catCol.has(id)?state.ui.catCol.delete(id):state.ui.catCol.add(id);saveCollapsed();renderCategories()},
    onSelect:(id)=>{state.ui.selCat=id;renderCategories()},
    onEdit:(id)=>catEdit(id),
    onAdd:(id)=>catEdit(null,id),
    onActive:(id)=>catToggle(id)
  });
  host.innerHTML=t.html;t.wire(host);

  $("#catCount").textContent = q ? `${list.length} resultado(s)` : `${state.categories.length} categoría(s)`;
  const inp=$("#catSearch");
  const clr=$("#catClear");
  if(state.ui._catFocus){
    try{inp.focus(); const p=Number(state.ui._catPos||inp.value.length); inp.setSelectionRange(p,p);}catch{}
    state.ui._catFocus=false;
  }
  inp.addEventListener("input",()=>{state.ui.catQ=inp.value; state.ui._catPos=inp.selectionStart||0; state.ui._catFocus=true; debounce("catSearch",()=>renderCategories(),260);});
  clr.addEventListener("click",()=>{state.ui.catQ=""; state.ui._catFocus=true; state.ui._catPos=0; renderCategories();});
  catDetail();
}
function catToggle(id){const c=state.categories.find(x=>x.id===id);if(!c)return;c.active=!c.active;save();toast("Categoría actualizada.","success");renderCategories()}
function catDetail(){
  const id=state.ui.selCat;const el=$("#catDet");
  if(!id){el.innerHTML=`<div class="text-secondary">No hay categoría seleccionada.</div>`;return}
  const c=state.categories.find(x=>x.id===id);if(!c){el.textContent="No encontrada";return}
  const used=catUsageCount(id);
  el.innerHTML=`
    <div class="d-flex justify-content-between align-items-center">
      <div><div class="fw-bold">${esc(c.name)}</div><div class="small text-secondary">Ruta: <b>${esc(catPath(id)||c.name)}</b></div></div>
      <span class="dot" style="width:18px;height:18px;border-radius:6px;background:${safeColor(c.color,"#0d6efd")}"></span>
    </div>
    <hr class="my-3"/>
        <div id="cfgExtra"></div>
    <div class="row g-2">
      <div class="col-6"><div class="small text-secondary">Estado</div><div class="fw-bold">${c.active?"Activa":"Inactiva"}</div></div>
      <div class="col-6"><div class="small text-secondary">Usos</div><div class="fw-bold">${used}</div></div>
    </div>`;
}
function catEdit(editId=null,parentId=null){
  const isEdit=!!editId;const c=isEdit?state.categories.find(x=>x.id===editId):null;if(isEdit&&!c)return;
  const parentOpts=state.categories.filter(x=>x.active && (!isEdit||x.id!==editId))
    .map(x=>`<option value="${x.id}">${esc(catPath(x.id)||x.name)}</option>`).join("");
  const body=`<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-6"><label class="form-label">Nombre</label><input class="form-control" id="cName" maxlength="120" value="${esc(c?.name||"")}" placeholder="Ej: Vivienda"></div>
    <div class="col-12 col-md-6"><label class="form-label">Color</label><input type="color" class="form-control form-control-color w-100" id="cCol" value="${esc(c?.color||"#0d6efd")}"></div>
    <div class="col-12"><label class="form-label">Categoría padre (opcional)</label>
      <select class="form-select" id="cPar"><option value="">(Raíz)</option>${parentOpts}</select>
      <div class="small text-secondary mt-1">Máximo 3 niveles, sin ciclos.</div>
    </div>
</div>`;
  const delBtn = (isEdit && canDeleteCategory(editId).ok) ? `<button class="btn btn-outline-danger me-auto" id="cDel"><i class="bi bi-trash"></i> Eliminar</button>` : ``;
  const footer=`${delBtn}<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="cSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:isEdit?"Editar categoría":"Nueva categoría",body,footer});
  const cDel=$("#cDel"); if(cDel) cDel.addEventListener("click",()=>{closeEditor();catDelete(editId);});
  sortSelectOptions("#cPar",true);
  $("#cPar").value=parentId||c?.parentId||"";
  $("#cSave").addEventListener("click",()=>{
    const btn=$("#cSave"); if(btn) btn.disabled=false;
    const name=$("#cName").value.trim();const color=$("#cCol").value||"#0d6efd";const p=$("#cPar").value||null;
    if(!name){if(btn) btn.disabled=false;
    msg({title:"Validación",kind:"warning",body:"El <b>Nombre</b> es requerido."});return}
    if(isEdit && hasCycle(state.categories,editId,p)){msg({title:"Validación",kind:"danger",body:"No se permiten ciclos padre/hijo."});return}
    if(isEdit && exceed3(state.categories,editId,p)){msg({title:"Validación",kind:"warning",body:"Máximo <b>3 niveles</b>."});return}
    if(!isEdit){
      const d=(p?depthOf(state.categories,p):0)+1;
      if(d>3){msg({title:"Validación",kind:"warning",body:"Máximo <b>3 niveles</b>."});return}
      state.categories.push({id:uuid(),name,parentId:p,active:true,color});
    }else{c.name=name;c.parentId=p;c.color=color}
    save();closeEditor();toast("Categoría guardada.","success");renderCategories();
  });
}

/* Movements (Ingreso/Gasto/Transferencia) */
function renderMovements(){
  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros</div>
          <div class="small text-secondary">Filtra por periodo, tipo o texto.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap"><button class="btn btn-sm btn-dark" onclick="movApply()"><i class="bi bi-funnel"></i> Aplicar</button>
          <button class="btn btn-sm btn-outline-dark" onclick="movClear()"><i class="bi bi-x-circle"></i> Limpiar</button>
        </div>
      </div>
      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-2">
          <label class="form-label">Año</label>
          <select class="form-select" id="mY"><option value="">(Todo)</option>${years().map(y=>`<option>${y}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Mes</label>
          <select class="form-select" id="mM"><option value="">(Todo)</option>${months().map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="mT"><option value="">(Todos)</option><option>Ingreso</option><option>Gasto</option><option>Transferencia</option></select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Texto</label>
          <input class="form-control" id="mQ" placeholder="Buscar descripción...">
        </div>
      </div>
    </div>
</div>`;

  const body=`${filters}<div id="movHost"></div>`;

  $("#v-movements").innerHTML=card("Movimientos",
    `<button class="btn btn-dark" onclick="movEdit()"><i class="bi bi-plus"></i> Nuevo</button>
     <button class="btn btn-outline-dark" onclick="recManage()"><i class="bi bi-repeat"></i> Recurrentes</button>
     <button class="btn btn-outline-dark" onclick="help('movements')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#mY").value=state.ui.mY||"";$("#mM").value=state.ui.mM||"";$("#mT").value=state.ui.mT||"";$("#mQ").value=state.ui.mQ||"";
  // Auto-aplicar (mejor UX en tablas grandes)
  $("#mY").onchange=movApply;$("#mM").onchange=movApply;$("#mT").onchange=movApply;
  $("#mQ").oninput=()=>debounce("movQ", movApply, 260);
  movList();
}

function movApply(){
  state.ui.mY=$("#mY").value||"";
  state.ui.mM=$("#mM").value||"";
  state.ui.mT=$("#mT").value||"";
  state.ui.mQ=$("#mQ").value||"";
  state.ui.movP=1;
  movList();
}
function movClear(){
  state.ui.mY="";state.ui.mM="";state.ui.mT="";state.ui.mQ="";
  $("#mY").value="";$("#mM").value="";$("#mT").value="";$("#mQ").value="";
  state.ui.movP=1;
  movList();
}
function movSetPage(p){
  state.ui.movP=Math.max(1,Number(p)||1);
  movList();
}
function movSetPageSize(ps){
  state.ui.movPS=Math.max(25,Number(ps)||100);
  state.ui.movP=1;
  movList();
}
function savSumSetPage(p){
  state.ui.savSumP=Math.max(1,Number(p)||1);
  savRender();
}
function savSumSetPageSize(ps){
  state.ui.savSumPS=Math.max(10,Number(ps)||50);
  state.ui.savSumP=1;
  savRender();
}
function savTxSetPage(p){
  state.ui.savTxP=Math.max(1,Number(p)||1);
  savRender();
}
function savTxSetPageSize(ps){
  state.ui.savTxPS=Math.max(25,Number(ps)||100);
  state.ui.savTxP=1;
  savRender();
}
function budSetPage(p){
  state.ui.budP=Math.max(1,Number(p)||1);
  budList();
}
function budSetPageSize(ps){
  state.ui.budPS=Math.max(25,Number(ps)||100);
  state.ui.budP=1;
  budList();
}

function movList(){
  const y=state.ui.mY||null,m=state.ui.mM||null,t=state.ui.mT||null,q=(state.ui.mQ||"").trim().toLowerCase();
  let items=state.movements.filter(x=>["Ingreso","Gasto","Transferencia"].includes(x.type))
    .filter(x=>!y || (x.period||"").startsWith(String(y))).filter(x=>!m||x.period===m).filter(x=>!t||x.type===t)
    .filter(x=>!q||String(x.desc||"").toLowerCase().includes(q));

  const so=getSort("mov","date","desc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  items = items.sort((a,b)=>{
    const av = key==="date" ? (a.date||"")
      : key==="type" ? (a.type||"")
      : key==="account" ? (accPath(a.accountId)||"")
      : key==="category" ? movementCatKey(a)
      : key==="desc" ? (a.desc||"")
      : key==="amount" ? Number(a.amountBase!=null?a.amountBase:a.amount||0)
      : (a.date||"");
    const bv = key==="date" ? (b.date||"")
      : key==="type" ? (b.type||"")
      : key==="account" ? (accPath(b.accountId)||"")
      : key==="category" ? movementCatKey(b)
      : key==="desc" ? (b.desc||"")
      : key==="amount" ? Number(b.amountBase!=null?b.amountBase:b.amount||0)
      : (b.date||"");
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
    if(c!==0) return c*mult;
    return String(b.date||"").localeCompare(String(a.date||""));
  });

  const base=baseCur();

  // Totales (en moneda base) - sobre TODO el resultado filtrado
  const baseAmtOf=(x)=>{
    const fromCur=accCur(x.accountId);
    return Number(x.amountBase!=null?x.amountBase:toBase(Number(x.amount)||0,fromCur,x.rateToBase));
  };
  const sumIn = items.filter(x=>x.type==="Ingreso").reduce((s,x)=>s+baseAmtOf(x),0);
  const sumOut = items.filter(x=>x.type==="Gasto").reduce((s,x)=>s+baseAmtOf(x),0);
  const net = sumIn - sumOut;
  const trCount = items.filter(x=>x.type==="Transferencia").length;

  // Paginación (mejor rendimiento)
  const pageSize = Number(state.ui.movPS||100);
  const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
  let page = Number(state.ui.movP||1);
  if(page>totalPages) page=totalPages;
  if(page<1) page=1;
  state.ui.movP=page;

  const start = (page-1)*pageSize;
  const end = start + pageSize;
  const pageItems = items.slice(start, end);
  const showFrom = items.length ? (start+1) : 0;
  const showTo = Math.min(end, items.length);

  const rows=pageItems.map(x=>{
    const badge=x.type==="Ingreso"?"text-bg-success":x.type==="Gasto"?"text-bg-danger":"text-bg-primary";
    const fromCur=accCur(x.accountId);
    const isFx=(fromCur!==base);
    const baseAmt=baseAmtOf(x);
    const amtCell= x.type!=="Transferencia"
      ? `<div class="fw-bold">${fmtMoney(Number(x.amount)||0,fromCur)}</div>${isFx?`<div class="small text-secondary">≈ ${fmtMoney(baseAmt,base)}</div>`:""}`
      : (()=>{
          const toCur=accCur(x.accountToId);
          const toAmt=Number(x.amountTo!=null?x.amountTo:Number(x.amount)||0);
          const isFx2=(fromCur!==toCur);
          return `<div class="fw-bold">${fmtMoney(Number(x.amount)||0,fromCur)} <span class="text-secondary">→</span> ${fmtMoney(toAmt,toCur)}</div>${isFx2?`<div class="small text-secondary">≈ ${fmtMoney(baseAmt,base)}</div>`:""}`;
        })();

    const catDots = movementHasSplit(x)
      ? (x.splits||[]).slice(0,3).map(s=>s?.categoryId?`<span class="dot" style="background:${catColor(s.categoryId)}"></span>`:"").join("")
      : (x.categoryId?`<span class="dot" style="background:${catColor(x.categoryId)}"></span>`:"");
    const catMain = movementHasSplit(x) ? `Split (${(x.splits||[]).length})` : (x.categoryId?esc(catPath(x.categoryId)):"—");
    const catSub = movementHasSplit(x) ? esc(splitLabelShort(x).replace(/^Split:\s*/,"")) : "";

    return `<tr>
      <td><div class="fw-semibold">${fmtDate(x.date)}</div><div class="small text-secondary">Periodo: ${esc(monthLabel(x.period))}</div></td>
      <td><span class="badge ${badge} rounded-pill">${x.type}</span></td>
      <td><div class="fw-semibold">${esc(accPath(x.accountId)||"(Cuenta)")}</div>${x.type==="Transferencia"?`<div class="small text-secondary">→ ${esc(accPath(x.accountToId)||"(Cuenta)")}</div>`:""}</td>
      <td>
        <div class="d-flex gap-2 align-items-center">${catDots}<span>${catMain}</span></div>
        ${catSub?`<div class="small text-secondary">${catSub}</div>`:""}
      </td>
      <td class="td-desc">
        <div class="text-truncate" style="max-width:260px" title="${esc(x.desc||"")}">${x.desc?esc(x.desc):"<span class='text-secondary'>—</span>"}</div>
      </td>
      <td class="text-end">${amtCell}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" onclick="movEdit('${x.id}')"><i class="bi bi-pencil"></i></button>
        ${ ((x.attachments&&x.attachments.length)||(x.adjuntos&&x.adjuntos.length)) ? '<button class="btn btn-sm btn-outline-secondary" data-mid="'+x.id+'" onclick="attView(this.dataset.mid)" title="Adjuntos"><i class="bi bi-paperclip"></i></button>' : '' }
        <button class="btn btn-sm btn-outline-danger" onclick="movDel('${x.id}')"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`;
  }).join("");

  const foot = items.length ? `<tfoot><tr class="table-light">
      <td colspan="5" class="text-end fw-semibold">Totales (Ingresos / Gastos / Neto) <span class="text-secondary fw-normal ms-2">Transferencias: ${trCount}</span></td>
      <td class="text-end fw-bold">
        <div class="small"><span class="text-success">+${fmtMoney(sumIn,base)}</span> / <span class="text-danger">-${fmtMoney(sumOut,base)}</span></div>
        <div class="fw-bold">${fmtMoney(net,base)}</div>
      </td>
      <td></td>
    </tr></tfoot>` : ``;

  const disPrev = page<=1 ? "disabled" : "";
  const disNext = page>=totalPages ? "disabled" : "";
  const pager = `<div class="d-flex align-items-center gap-1 sgf-pager">
      <button class="btn btn-sm btn-outline-dark" ${disPrev} onclick="movSetPage(1)"><i class="bi bi-chevron-bar-left"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disPrev} onclick="movSetPage(${page-1})"><i class="bi bi-chevron-left"></i></button>
      <span class="small text-secondary px-2">Página <b>${page}</b> / ${totalPages}</span>
      <button class="btn btn-sm btn-outline-dark" ${disNext} onclick="movSetPage(${page+1})"><i class="bi bi-chevron-right"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disNext} onclick="movSetPage(${totalPages})"><i class="bi bi-chevron-bar-right"></i></button>
    </div>`;

  const psSel = `<select class="form-select form-select-sm" style="width:auto" onchange="movSetPageSize(this.value)">
      ${[50,100,200].map(n=>`<option value="${n}" ${n===pageSize?"selected":""}>${n}/pág</option>`).join("")}
    </select>`;

  const summary = items.length ? `<div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <span class="badge-soft"><span class="text-success">+${fmtMoney(sumIn,base)}</span></span>
      <span class="badge-soft"><span class="text-danger">-${fmtMoney(sumOut,base)}</span></span>
      <span class="badge-soft">Neto: ${fmtMoney(net,base)}</span>
      <span class="badge-soft text-secondary">Transferencias: ${trCount}</span>
    </div>` : "";

  $("#movHost").innerHTML=`
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <div class="fw-bold">Listado</div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="small text-secondary">Mostrando ${showFrom}-${showTo} de ${items.length}</div>
        ${psSel}
        ${pager}
      </div>
    </div>
    ${summary}
    <div class="card sgf p-2">
      <div class="table-responsive sgf-table-scroll sgf-table-sticky">
        <table class="table table-hover align-middle mb-0" id="tblMov">
          <thead><tr>
            <th class="th-sort" onclick="toggleSort('mov','date',()=>{state.ui.movP=1;movList()})">Fecha ${sortIcon('mov','date')}</th>
            <th class="th-sort" onclick="toggleSort('mov','type',()=>{state.ui.movP=1;movList()})">Tipo ${sortIcon('mov','type')}</th>
            <th class="th-sort" onclick="toggleSort('mov','account',()=>{state.ui.movP=1;movList()})">Cuenta ${sortIcon('mov','account')}</th>
            <th class="th-sort" onclick="toggleSort('mov','category',()=>{state.ui.movP=1;movList()})">Categoría ${sortIcon('mov','category')}</th>
            <th class="th-sort" onclick="toggleSort('mov','desc',()=>{state.ui.movP=1;movList()})">Descripción ${sortIcon('mov','desc')}</th>
            <th class="text-end th-sort" onclick="toggleSort('mov','amount',()=>{state.ui.movP=1;movList()})">Monto (${base}) ${sortIcon('mov','amount')}</th>
            <th class="text-end">Acciones</th>
          </tr></thead>
          <tbody>${rows||`<tr><td colspan="7" class="text-secondary">Sin resultados.</td></tr>`}</tbody>
          ${foot}
        </table>
      </div>
    </div>
  `;
}function movEdit(editId=null){
  const isEdit=!!editId;const m=isEdit?state.movements.find(x=>x.id===editId):null;if(isEdit&&!m)return;
  if(isEdit && m.isOpening){msg({title:"Saldo inicial",kind:"warning",body:"El <b>Saldo inicial</b> se edita desde <b>Cuentas</b> (Detalle → Saldo inicial)."});return;}
  const isLinkedSys = !!(isEdit && m && m.type==='Transferencia' && m.isSystem && (m.linkedTo || state.movements.some(x=>x.linkedTransferId===m.id)));
  const linkedLogicalId = isLinkedSys ? (m.linkedTo || (state.movements.find(x=>x.linkedTransferId===m.id)||{}).id) : null;
  const linkedLogical = linkedLogicalId ? state.movements.find(x=>x.id===linkedLogicalId) : null;
  if(isEdit && (m.type==="Ahorro"||m.type==="RetiroAhorro")){savCatEdit(m.id);return}
  const types=["Ingreso","Gasto","Transferencia"];
  const accs=state.accounts.filter(a=>a.active);
  const accOpts=accs.map(a=>`<option value="${a.id}">${esc(accPath(a.id)||a.name)} (${esc(a.currency||baseCur())})</option>`).join("");
  const catOpts=state.categories.filter(c=>c.active).map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");
  const now=new Date();const d=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
  const p=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const note = (isLinkedSys && linkedLogical) ? `<div class="alert alert-warning border-0" style="background:rgba(245,158,11,.12)">
<b>Movimiento del sistema (Ahorros)</b>: este registro está ligado a <b>${esc(linkedLogical.type)}</b>. 
Los cambios de <b>monto/fecha/periodo</b> se reflejarán automáticamente en <b>Ahorros</b>.
<div class="d-grid gap-2 mt-2">
  <button class="btn btn-dark btn-sm" type="button" onclick="savCatEdit('${linkedLogicalId}')"><i class="bi bi-tag"></i> Editar categoría asociada</button>
</div>
</div>` : ``;
  const body=`${note}<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-4"><label class="form-label">Tipo</label><select class="form-select" id="meT">${types.map(t=>`<option>${t}</option>`).join("")}</select></div>
    <div class="col-12 col-md-4"><label class="form-label">Fecha de registro</label><input type="date" class="form-control" id="meD" value="${esc(m?.date||d)}"></div>
    <div class="col-12 col-md-4"><label class="form-label">Periodo contable</label><input type="month" class="form-control" id="meP" value="${esc(m?.period||getMonthFromDate(m?.date)||p)}"><div class="small text-secondary mt-1">Ej: 31/ene pertenece a feb/2026.</div></div>

    <div class="col-12 col-md-6"><label class="form-label">Cuenta origen</label><select class="form-select" id="meA">${accOpts}</select></div>
    <div class="col-12 col-md-6" id="meToW"><label class="form-label">Cuenta destino</label><select class="form-select" id="meTo"><option value="">(Seleccione)</option>${accOpts}</select></div>

    <div class="col-12 col-md-6" id="meCatW">
      <label class="form-label">Categoría (opcional)</label>
      <div class="d-flex gap-2">
        <select class="form-select" id="meC"><option value="">(Sin categoría)</option>${catOpts}</select>
        <button class="btn btn-outline-dark" type="button" id="meSplitOn" title="Dividir gasto por categorías"><i class="bi bi-diagram-3"></i></button>
      </div>
      <div class="small text-secondary mt-1" id="meSplitHint">Para <b>Gastos</b>, puedes dividir el monto en varias categorías.</div>
    </div>

    <div class="col-12" id="meSplitW" style="display:none">
      <div class="card sgf mt-1">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Split por categorías</div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-dark" type="button" id="meSplitAdd"><i class="bi bi-plus"></i> Línea</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="meSplitOff"><i class="bi bi-x-circle"></i> Quitar</button>
            </div>
          </div>
          <div class="small text-secondary mt-1">La suma de líneas debe igualar el monto. Estas líneas alimentan <b>Presupuestos</b> y <b>Reportes</b>.</div>
          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th style="width:45%">Categoría</th><th class="text-end" style="width:20%">Monto</th><th style="width:30%">Detalle</th><th class="text-end" style="width:5%"></th></tr></thead>
              <tbody id="meSplitTb"></tbody>
              <tfoot><tr class="table-light">
                <td class="fw-semibold">Total líneas</td>
                <td class="text-end fw-bold" id="meSplitTot"></td>
                <td class="text-secondary small" id="meSplitDiff" colspan="2"></td>
              </tr></tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Monto origen</label>
      <div class="input-group">
        <span class="input-group-text" id="meCurFrom">${esc(baseCur())}</span>
        <input class="form-control" id="meAmt" inputmode="decimal" value="${m?String(m.amount):""}" placeholder="0">
      </div>
      <div class="small text-secondary mt-1" id="meEqBase"></div>
    </div>

    <div class="col-12 col-md-6" id="meAmtToW">
      <label class="form-label">Monto destino</label>
      <div class="input-group">
        <span class="input-group-text" id="meCurTo">${esc(baseCur())}</span>
        <input class="form-control" id="meAmtTo" inputmode="decimal" value="${m?String(m.amountTo??""):""}" placeholder="0" readonly>
      </div>
      <div class="small text-secondary mt-1" id="meEqBaseTo"></div>
    </div>

    <div class="col-12 col-md-6" id="meRateFromW">
      <label class="form-label" id="meRateFromLbl">Tipo de cambio</label>
      <input class="form-control" id="meRateFrom" inputmode="decimal" placeholder="Ej: 520" value="${m?String(m.rateToBase??""):""}">
      <div class="small text-secondary mt-1">Se guarda en el movimiento (histórico).</div>
    </div>
    <div class="col-12 col-md-6" id="meRateToW">
      <label class="form-label" id="meRateToLbl">Tipo de cambio</label>
      <input class="form-control" id="meRateTo" inputmode="decimal" placeholder="Ej: 520" value="${m?String(m.rateToBaseTo??""):""}">
      <div class="small text-secondary mt-1">Para calcular el monto destino.</div>
    </div>

    <div class="col-12"><label class="form-label">Descripción</label><input class="form-control" id="meDesc" maxlength="200" value="${esc(m?.desc||"")}" placeholder="Detalle..."></div>
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between">
        <label class="form-label mb-0">Adjuntos (enlaces)</label>
        <button class="btn btn-sm btn-outline-primary" type="button" id="meAttAdd"><i class="bi bi-link-45deg"></i> Agregar</button>
      </div>
      <div id="meAttList" class="mt-2 d-grid gap-2"></div>
      <div class="small text-secondary mt-1">Se guardan como URL o ruta local (texto) en el respaldo JSON.</div>
    </div>
</div>`;
  const footer=`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="meSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:isEdit?"Editar movimiento":"Nuevo movimiento",body,footer});
  // ordenar combos
  sortSelectOptions("#meA",false);
  sortSelectOptions("#meTo",true);
  sortSelectOptions("#meC",true);
  // Split de gastos (por categorías)
  let splitLines = (isEdit && m && movementHasSplit(m)) ? (m.splits||[]).map(s=>({id:s.id||uuid(),categoryId:s.categoryId||"",amount:(s.amount!=null?String(s.amount):""),desc:s.desc||""})) : [];
  let splitEnabled = splitLines.length>0;

  const renderSplit = ()=>{
    const w=$("#meSplitW"), tb=$("#meSplitTb");
    if(!w||!tb) return;
    if(!splitEnabled){ w.style.display="none"; return; }
    w.style.display="";
    const fromCur=accCur($("#meA")?.value||"")||baseCur();

    const rows = splitLines.map((s,i)=>`<tr>
      <td>
        <select class="form-select form-select-sm" data-i="${i}" data-k="cat">
          <option value="">(Seleccione)</option>${catOpts}
        </select>
      </td>
      <td><input class="form-control form-control-sm text-end" inputmode="decimal" data-i="${i}" data-k="amt" value="${esc(s.amount??"")}" placeholder="0"></td>
      <td><input class="form-control form-control-sm" maxlength="100" data-i="${i}" data-k="desc" value="${esc(s.desc??"")}" placeholder="Opcional"></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" type="button" data-act="del" data-i="${i}" title="Eliminar"><i class="bi bi-trash"></i></button></td>
    </tr>`).join("") || `<tr><td colspan="4" class="text-secondary small">Agrega líneas para distribuir el gasto.</td></tr>`;

    tb.innerHTML = rows;

    // set selected categories after render
    [...tb.querySelectorAll("select[data-k='cat']")].forEach(sel=>{
      const i=Number(sel.dataset.i);
      sel.value = splitLines[i]?.categoryId || "";
    });

    const total = splitLines.reduce((sum,x)=>sum+(parseAmount(String(x.amount??""))||0),0);
    const amt = parseAmount($("#meAmt")?.value||"")||0;
    const diff = roundMoney(amt-total, fromCur);

    const totEl=$("#meSplitTot"), diffEl=$("#meSplitDiff");
    if(totEl) totEl.textContent = fmtMoney(total, fromCur);
    if(diffEl){
      diffEl.innerHTML = (amt>0)
        ? (Math.abs(diff)<=0.01 ? `<span class="text-success">Cuadra con el monto.</span>` : `<span class="text-warning">Diferencia: <b>${fmtMoney(diff,fromCur)}</b></span>`)
        : `<span class="text-secondary">Defina el monto total para validar.</span>`;
    }
  };

  const setSplitEnabled=(on)=>{
    splitEnabled=!!on;
    const btn=$("#meSplitOn");
    if(btn) btn.classList.toggle("active", splitEnabled);
    if($("#meC")){
      $("#meC").disabled = splitEnabled;
      if(splitEnabled) $("#meC").value="";
    }
    renderSplit();
  };

  const addSplitLine=()=>{
    splitLines.push({id:uuid(),categoryId:"",amount:"",desc:""});
    renderSplit();
  };

  $("#meSplitOn")?.addEventListener("click",()=>{
    if($("#meT")?.value!=="Gasto"){ return; }
    if(!splitEnabled) setSplitEnabled(true);
    if(splitEnabled && !splitLines.length) addSplitLine();
  });
  $("#meSplitAdd")?.addEventListener("click",addSplitLine);
  $("#meSplitOff")?.addEventListener("click",()=>{ setSplitEnabled(false); });

  const splitHost=$("#meSplitTb");
  if(splitHost){
    splitHost.addEventListener("input",(e)=>{
      const t=e.target;
      const i=Number(t?.dataset?.i);
      const k=t?.dataset?.k;
      if(!Number.isFinite(i)||!k||!splitLines[i]) return;
      if(k==="amt") splitLines[i].amount = t.value;
      if(k==="desc") splitLines[i].desc = t.value;
      renderSplit();
    });
    splitHost.addEventListener("change",(e)=>{
      const t=e.target;
      const i=Number(t?.dataset?.i);
      const k=t?.dataset?.k;
      if(!Number.isFinite(i)||!k||!splitLines[i]) return;
      if(k==="cat") splitLines[i].categoryId = t.value;
      renderSplit();
    });
    splitHost.addEventListener("click",(e)=>{
      const btn=e.target.closest("[data-act='del']");
      if(!btn) return;
      const i=Number(btn.dataset.i);
      if(Number.isFinite(i)){ splitLines.splice(i,1); renderSplit(); }
    });
  }

  // init
  if(splitEnabled){ setSplitEnabled(true); } else { setSplitEnabled(false); }

  // si es transferencia del sistema ligada a Ahorros, bloquear campos estructurales
  if(isLinkedSys){
    $("#meT").disabled=true;
    $("#meA").disabled=true;
    $("#meTo").disabled=true;
    $("#meC").disabled=true;
    $("#meDesc").disabled=true;
  }

  $("#meT").value=m?.type||"Gasto";
  $("#meA").value=m?.accountId||accs[0]?.id||"";
  $("#meTo").value=m?.accountToId||"";
  $("#meC").value=m?.categoryId||"";

  const ui=()=>{
    const t=$("#meT").value;
    const splitBtn=$("#meSplitOn"), splitHint=$("#meSplitHint");
    if(splitBtn) splitBtn.style.display = (t==="Gasto") ? "" : "none";
    if(splitHint) splitHint.style.display = (t==="Gasto") ? "" : "none";
    if(t!=="Gasto" && splitEnabled){ setSplitEnabled(false); }
    $("#meToW").style.display=t==="Transferencia"?"":"none";
    $("#meCatW").style.display=t==="Transferencia"?"none":"";
    $("#meAmtToW").style.display=t==="Transferencia"?"":"none";
    $("#meRateToW").style.display=t==="Transferencia"?"":"none";
    recalc();
  };

  const recalc=()=>{
    const t=$("#meT").value;
    const acc=$("#meA").value||null;
    const to=$("#meTo").value||null;
    const fromCur=acc?accCur(acc):baseCur();
    const toCur=(t==="Transferencia"&&to)?accCur(to):baseCur();

    $("#meCurFrom").textContent=fromCur;
    $("#meCurTo").textContent=toCur;

    // rates
    const b=baseCur();
    const needsFrom = fromCur!==b;
    const needsTo = (t==="Transferencia" && toCur!==b);

    $("#meRateFromW").style.display=needsFrom?"":"none";
    $("#meRateFromLbl").textContent = needsFrom ? `Tipo de cambio a ${b} (1 ${fromCur} = ? ${b})` : "Tipo de cambio";
    const rf=$("#meRateFrom");
    if(needsFrom){
      const def=fxRateAt(fromCur,$("#meD").value||"");
      const last=rf.dataset.cur||"";
      const now=fromCur||"";
      const changed=last!==now;
      const v=parseAmount(rf.value||"");
      if(changed){ if(def) rf.value=String(def); rf.dataset.cur=now; }
      else { if((!rf.value || v===1) && def) rf.value=String(def); }
    }else{ rf.value="1"; rf.dataset.cur=b; }
$("#meRateToW").style.display=needsTo?"":"none";
    $("#meRateToLbl").textContent = needsTo ? `Tipo de cambio a ${b} (1 ${toCur} = ? ${b})` : "Tipo de cambio";
    const rt=$("#meRateTo");
    if(needsTo){
      const def=fxRateAt(toCur,$("#meD").value||"");
      const last=rt.dataset.cur||"";
      const now=toCur||"";
      const changed=last!==now;
      const v=parseAmount(rt.value||"");
      if(changed){ if(def) rt.value=String(def); rt.dataset.cur=now; }
      else { if((!rt.value || v===1) && def) rt.value=String(def); }
    }else{ rt.value="1"; rt.dataset.cur=b; }
// if both are same currency, align rates
    if(t==="Transferencia" && fromCur===toCur){
      $("#meRateTo").value=$("#meRateFrom").value||$("#meRateTo").value;
    }

    const amt=parseAmount($("#meAmt").value);
    const rFrom = (fromCur!==baseCur()) ? (parseAmount($("#meRateFrom").value)||fxRate(fromCur)||NaN) : 1;
    const baseAmt = (Number.isFinite(amt)&&amt>0) ? toBase(amt,fromCur,rFrom) : 0;

    if(needsFrom && !(Number.isFinite(rFrom)&&rFrom>0)){
      $("#meEqBase").innerHTML=`<span class="text-warning">Defina un tipo de cambio válido.</span>`;
    }else if(Number.isFinite(amt)&&amt>0 && fromCur!==b){
      $("#meEqBase").innerHTML=`Equivalente: <b>${fmtMoney(baseAmt,b)}</b>`;
    }else{
      $("#meEqBase").innerHTML=``;
    }

    if(t==="Transferencia"){
      const rTo=parseAmount($("#meRateTo").value||"1");
      const destAmt = (Number.isFinite(amt)&&amt>0) ? fromBase(baseAmt,toCur,rTo) : 0;
      const rounded = roundMoney(destAmt,toCur);
      $("#meAmtTo").value = (Number.isFinite(rounded)&&rounded>0) ? String(rounded) : "";
      if(toCur!==b && !(Number.isFinite(rTo)&&rTo>0)){
        $("#meEqBaseTo").innerHTML=`<span class="text-warning">Defina tipo de cambio del destino.</span>`;
      }else if(Number.isFinite(amt)&&amt>0 && (fromCur!==toCur)){
        $("#meEqBaseTo").innerHTML=`Equivalente base: <b>${fmtMoney(baseAmt,b)}</b>`;
      }else{
        $("#meEqBaseTo").innerHTML=``;
      }
    }
    if(splitEnabled) renderSplit();
  };

  ["change","keyup"].forEach(ev=>{
    $("#meT").addEventListener(ev,ui);
    $("#meA").addEventListener(ev,recalc);
    $("#meTo").addEventListener(ev,recalc);
    $("#meAmt").addEventListener(ev,recalc);
    $("#meRateFrom").addEventListener(ev,recalc);
    $("#meRateTo").addEventListener(ev,recalc);
  });
  ui();

  // Adjuntos (URLs)
  let attLines = normalizeAttachments(isEdit? (m.attachments||m.adjuntos||[]) : []);
  const attRender = ()=>{
    const host = $("#meAttList"); if(!host) return;
    if(!attLines.length){ host.innerHTML = `<div class="text-secondary small">Sin adjuntos.</div>`; return; }
    host.innerHTML = attLines.map(a=>`
      <div class="d-flex gap-2 align-items-start">
        <div class="flex-grow-1">
          <input class="form-control form-control-sm mb-2" data-att-name="${a.id}" placeholder="Nombre" value="${escAttr(a.name)}">
          <input class="form-control form-control-sm" data-att-url="${a.id}" placeholder="https://... / file:///... / C:\\..." value="${escAttr(a.url)}">
        </div>
        <div class="d-flex flex-column gap-2">
          <button class="btn btn-sm btn-outline-primary" type="button" title="Abrir" onclick="attOpen(\'${a.id}\', \'me\')"><i class="bi bi-box-arrow-up-right"></i></button>
          <button class="btn btn-sm btn-outline-danger" type="button" title="Quitar" onclick="attRemove(\'${a.id}\', \'me\')"><i class="bi bi-x-lg"></i></button>
        </div>
      </div>
    `).join("");
  };
  window.attRemove = (id,scope)=>{ if(scope!=='me') return; attLines = attLines.filter(x=>x.id!==id); attRender(); };
  window.attOpen = (id,scope)=>{
    const list = (scope==='me') ? attLines : [];
    const it = list.find(x=>x.id===id); if(!it || !it.url) return;
    try{ openAttachmentUrl(it.url); }catch(e){}
  };
  const btnAdd = $("#meAttAdd");
  if(btnAdd) btnAdd.addEventListener("click",()=>{ attLines.push({id:uuid(), name:"", url:""}); attRender(); });
  attRender();

  $("#meSave").addEventListener("click",()=>{
    const btn=$("#meSave"); if(btn) btn.disabled=false;
    const type=$("#meT").value,
      date=$("#meD").value,
      period=$("#meP").value,
      acc=$("#meA").value,
      to=$("#meTo").value||null,
      cat=$("#meC").value||null,
      desc=$("#meDesc").value.trim(),
      amt=parseAmount($("#meAmt").value);

    // Adjuntos: leer inputs del editor
    attLines = attLines.map(a=>({
      id:a.id,
      name:(document.querySelector(`[data-att-name="${a.id}"]`)?.value||"").trim(),
      url:(document.querySelector(`[data-att-url="${a.id}"]`)?.value||"").trim(),
      addedAt:a.addedAt||new Date().toISOString()
    })).filter(a=>a.name||a.url);
    const bad = attLines.find(a=>a.url && !isAllowedAttachmentUrl(a.url));
    if(bad){ msg({title:"Validación",kind:"warning",body:"Adjunto con ruta/URL inválida. Evita esquemas peligrosos (javascript:, data:)."}); if(btn) btn.disabled=false; return; }

    if(!date||!period){if(btn) btn.disabled=false;
    msg({title:"Validación",kind:"warning",body:"<b>Fecha</b> y <b>Periodo</b> son requeridos."});return}
    if(!acc){msg({title:"Validación",kind:"warning",body:"Seleccione una <b>Cuenta</b>."});return}
    if(!Number.isFinite(amt)||amt<=0){msg({title:"Validación",kind:"warning",body:"El <b>Monto</b> debe ser > 0."});return}

    const fromCur=accCur(acc);
    const b=baseCur();
    const needsFrom = fromCur!==b;
    const rateFrom = needsFrom ? parseAmount($("#meRateFrom").value) : 1;
    if(needsFrom && !(Number.isFinite(rateFrom)&&rateFrom>0)){
      msg({title:"Validación",kind:"warning",body:`Tipo de cambio inválido para <b>${esc(fromCur)}</b>.`});return;
    }
    const amountBase = roundMoney(toBase(amt,fromCur,rateFrom), baseCur());
    if(!Number.isFinite(amountBase)){
      msg({title:"Validación",kind:"warning",body:`No se pudo calcular el equivalente en <b>${esc(b)}</b>.`});return;
    }

    let amountTo=null, toCur=null, rateTo=null;
    if(type==="Transferencia"){
      if(!to){msg({title:"Validación",kind:"warning",body:"Seleccione la <b>Cuenta destino</b>."});return}
      if(to===acc){msg({title:"Validación",kind:"warning",body:"Destino debe ser distinto al origen."});return}
      toCur=accCur(to);
      const needsTo = toCur!==b;
      rateTo = needsTo ? parseAmount($("#meRateTo").value) : 1;
      if(needsTo && !(Number.isFinite(rateTo)&&rateTo>0)){
        msg({title:"Validación",kind:"warning",body:`Tipo de cambio inválido para <b>${esc(toCur)}</b>.`});return;
      }
      amountTo = roundMoney(fromBase(amountBase,toCur,rateTo),toCur);
      if(!Number.isFinite(amountTo)||amountTo<=0){
        msg({title:"Validación",kind:"warning",body:"No se pudo calcular el <b>monto destino</b>."});return;
      }
    }

    // saldo (en moneda de la cuenta origen)
    const bal=balances();const curBal=bal.get(acc)||0;const old=isEdit?movOutflowEffect(m):0;const available=roundMoney(curBal+old,fromCur);
    const allowNeg = canGoNegative(acc);
    if((type==="Gasto"||type==="Transferencia") && !allowNeg && roundMoney(amt,fromCur)>available){
      msg({title:"Saldo insuficiente",kind:"danger",body:`Disponible: <b>${fmtMoney(available,fromCur)}</b>.`});return;
    }

    const payload={
      date,period,type,
      accountId:acc,
      accountToId:type==="Transferencia"?to:null,
      categoryId:(type==="Transferencia" ? ((isLinkedSys && linkedLogical)?(linkedLogical.categoryId||m.categoryId||null):(m?.categoryId||null)) : ((type==="Gasto" && splitEnabled)?null:cat)),
      amount:roundMoney(amt,fromCur),
      currency:fromCur,
      rateToBase:needsFrom?rateFrom:1,
      amountBase:roundMoney(amountBase,baseCur()),
      desc,
      isSystem:isEdit?(m.isSystem||false):false
    };

    if(isEdit){
      // preservar metadatos del sistema
      if(m.isSystem) payload.isSystem = true;
      if(m.linkedTo) payload.linkedTo = m.linkedTo;
      if(m.linkedTransferId) payload.linkedTransferId = m.linkedTransferId;
      if(m.system) payload.system = m.system;
    }
    if(type==="Transferencia"){
      payload.currencyTo=toCur;
      payload.rateToBaseTo=(toCur===b)?1:rateTo;
      payload.amountTo=amountTo;
    }

        // Split: validar y asignar líneas (solo Gastos)
    if(type==="Gasto" && splitEnabled){
      const norm = normalizeSplits(splitLines, payload.amount, fromCur, rateFrom);
      if(!norm.length){
        msg({title:"Validación",kind:"warning",body:"Agrega al menos <b>una línea</b> de split con categoría y monto."});
        return;
      }
      const sum = norm.reduce((s,l)=>s+(Number(l.amount)||0),0);
      const diff = roundMoney(sum - payload.amount, fromCur);
      if(Math.abs(diff)>0.01){
        msg({title:"Validación",kind:"warning",body:`El split no cuadra con el monto. Diferencia: <b>${fmtMoney(diff,fromCur)}</b>.`});
        return;
      }
      payload.splits = norm;
      payload.categoryId = null;
    }else{
      // sin split
      if(payload.splits) delete payload.splits;
    }

    // Adjuntos
    payload.attachments = normalizeAttachments(attLines);

    if(!isEdit){
      state.movements.push({id:uuid(),...payload});
    }else{
      Object.assign(m,payload);
      if(m.splits && !(payload.type==="Gasto" && splitEnabled)) delete m.splits;
      // si es una transferencia del sistema ligada a Ahorros, sincronizar el movimiento lógico
      if(isLinkedSys && linkedLogical && (linkedLogical.type==='Ahorro' || linkedLogical.type==='RetiroAhorro')){
        linkedLogical.date = payload.date;
        linkedLogical.period = payload.period;
        linkedLogical.amount = payload.amountBase;
        linkedLogical.amountBase = payload.amountBase;
        linkedLogical.currency = baseCur();
        linkedLogical.rateToBase = 1;
        linkedLogical.accountId = payload.accountId;
        linkedLogical.accountToId = payload.accountToId;
      }
    }

    save();closeEditor();toast("Movimiento guardado.","success");renderMovements();
    try{renderSavings();}catch{}
    try{renderDashboard();}catch{}
    try{renderReports();}catch{}
  });
}
function movDel(id){
  const m=state.movements.find(x=>x.id===id);if(!m)return;
  const cur = m.currency || accCur(m.accountId);
  let extra="";
  // Si es una transferencia del sistema ligada a Ahorros, eliminamos en cascada para mantener consistencia.
  if(m.type==="Transferencia" && m.isSystem && m.linkedTo){
    const lm=state.movements.find(x=>x.id===m.linkedTo) || state.movements.find(x=>x.linkedTransferId===id);
    if(lm){
      extra = `<div class="alert alert-warning border-0 mt-2" style="background:rgba(245,158,11,.12)">
        <b>Movimiento vinculado</b>: este registro es del sistema y está ligado a <b>${esc(lm.type)}</b>.<br>
        Si lo eliminas, también se eliminará el registro asociado (Ahorro/Retiro) para que el total en <b>Ahorros</b> quede correcto.
      </div>`;
    }
  }
  msg({title:"Eliminar movimiento",kind:"warning",body:`Se eliminará <b>${esc(m.type)}</b> por <b>${fmtMoney(Number(m.amount)||0, cur)}</b> (${fmtDate(m.date)}).
    ${extra}
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="movDelOk('${id}')"><i class="bi bi-trash"></i> Sí, eliminar</button></div>`});
}
function movDelOk(id){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  const m=state.movements.find(x=>x.id===id);if(!m)return;

  const del=new Set([id]);

  // Caso Ahorro/Retiro (lógico) -> eliminar transferencia del sistema
  if(m.linkedTransferId) del.add(m.linkedTransferId);

  // Caso Transferencia del sistema -> eliminar registro lógico asociado
  if(m.linkedTo) del.add(m.linkedTo);
  const logical = state.movements.find(x=>x.linkedTransferId===id);
  if(logical) del.add(logical.id);

  // Caso registro lógico -> si existe transferencia que apunte a él (por linkedTo), eliminarla también
  const sys = state.movements.find(x=>x.linkedTo===id);
  if(sys) del.add(sys.id);

  logEvent("delete","movement",id,`${m.type} ${fmtMoney(Number(m.amount)||0,(m.currency||accCur(m.accountId)))}`);

  state.movements = state.movements.filter(x=>!del.has(x.id));
  save();toast("Movimiento eliminado.","success");
  renderMovements();
  // refrescar totales dependientes (Ahorros/Dashboard/Reportes)
  try{ renderSavings(); }catch{}
  try{ renderDashboard(); }catch{}
  try{ renderReports(); }catch{}
}
/* Recurrentes */
/* ============================
   RECURRENTES (v1.08) — port desde v1.05, adaptado
   - Movimientos normales (isSystem=false)
   - Si falta FX => aborta generación completa
   ============================ */

function recGenerateFromFilters(){
  // usa el periodo del filtro de Movimientos
  const p = state.ui.mM || "";
  if(!p){
    msg({title:"Recurrentes",kind:"warning",body:"Selecciona <b>Mes</b> en filtros para generar."});
    return;
  }
  recGenerate(p);
}

function recManage(){
  const items = [...(state.recurrings || [])]
    .filter(Boolean)
    .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""), "es", {sensitivity:"base"}));

  const base = baseCur();

  const rows = items.map(r=>{
    const typeBadge = r.type==="Ingreso" ? "text-bg-success"
      : r.type==="Gasto" ? "text-bg-danger"
      : "text-bg-primary";

    const acc = accPath(r.accountId) || "—";
    const accTo = r.type==="Transferencia" ? (accPath(r.accountToId) || "—") : "";
    const cat = r.categoryId ? (catPath(r.categoryId) || "—") : "—";
    const cur = accCur(r.accountId) || base;
    const amt = fmtMoney(Number(r.amount)||0, cur);

    const day = Number(r.day || 1);
    const off = Number(r.regOffset || 0);
    const offLbl = off===0 ? "mismo mes" : off===-1 ? "mes anterior" : "mes siguiente";
    const range = `${r.startPeriod || "—"}${r.endPeriod ? (" → " + r.endPeriod) : ""}`;

    return `
      <tr>
        <td>
          <div class="fw-semibold">${esc(r.name||"")}</div>
          <div class="small text-secondary">${esc(range)}</div>
        </td>
        <td><span class="badge ${typeBadge} rounded-pill">${esc(r.type||"")}</span></td>
        <td>
          <div class="fw-semibold">${esc(String(day))}</div>
          <div class="small text-secondary">${esc(offLbl)}</div>
        </td>
        <td>
          <div class="fw-semibold">${esc(acc)}</div>
          ${r.type==="Transferencia" ? `<div class="small text-secondary">→ ${esc(accTo)}</div>` : ""}
        </td>
        <td>
          <div class="d-flex gap-2 align-items-center">
            ${r.categoryId ? `<span class="dot" style="background:${catColor(r.categoryId)}"></span>` : ""}
            <span>${esc(cat)}</span>
          </div>
        </td>
        <td class="text-end"><div class="fw-bold">${amt}</div></td>
        <td class="text-end">
          <div class="d-flex justify-content-end gap-1">
            <button class="btn btn-sm btn-outline-primary" onclick="recEdit('${esc(r.id)}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="recDel('${esc(r.id)}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `
    <tr><td colspan="7" class="text-secondary small">
      Sin recurrentes. Crea uno con <b>Nuevo</b>.
    </td></tr>
  `;

  const y = state.ui.mY || String(new Date().getFullYear());
  const m = state.ui.mM || `${y}-${String(new Date().getMonth()+1).padStart(2,"0")}`;

  editor({
    title: "Recurrentes",
    body: `
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Plantillas</div>
          <div class="small text-secondary">
            Crea movimientos recurrentes (luz, internet, salario). Luego usa <b>Generar</b> por mes.
          </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-dark btn-sm" onclick="recEdit()">
            <i class="bi bi-plus"></i> Nuevo
          </button>
        </div>
      </div>

      <div class="card sgf mt-3">
        <div class="card-body">
          <div class="fw-bold">Generar para periodo</div>
          <div class="small text-secondary">
            Se crean solo los que no existan aún para ese mes (evita duplicados).
            <br><b>Nota:</b> Si falta tipo de cambio, la generación <b>fallará</b> (no crea nada).
          </div>

          <div class="row g-2 align-items-end mt-2">
            <div class="col-12 col-md-4">
              <label class="form-label">Periodo (mes contable)</label>
              <select class="form-select" id="recP">
                ${months().map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}
              </select>
            </div>
            <div class="col-12 col-md-8 d-grid d-md-block">
              <button class="btn btn-outline-dark" id="recGen">
                <i class="bi bi-calendar2-check"></i> Generar
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="table-responsive card sgf p-2 mt-3">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Nombre</th><th>Tipo</th><th>Día</th><th>Cuenta</th><th>Categoría</th>
              <th class="text-end">Monto</th><th class="text-end">Acción</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `,
    footer: `<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>`
  });

  $("#recP").value = m;
  $("#recGen").addEventListener("click", ()=>recGenerate($("#recP").value));
}

function recEdit(id=null){
  const isEdit = !!id;
  const r = isEdit ? (state.recurrings || []).find(x=>x.id===id) : null;
  if(isEdit && !r) return;

  const base = baseCur();
  const accs = state.accounts.filter(a=>a.active).slice()
    .sort((a,b)=>String(accPath(a.id)||a.name).localeCompare(String(accPath(b.id)||b.name),"es",{sensitivity:"base"}));
  const cats = state.categories.filter(c=>c.active).slice()
    .sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));

  const accOpts = accs.map(a =>
    `<option value="${a.id}">${esc(accPath(a.id)||a.name)} (${esc(a.currency||base)})</option>`
  ).join("");

  const catOpts = cats.map(c =>
    `<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`
  ).join("");

  const now = new Date();
  const pNow = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

  editor({
    title: isEdit ? "Editar recurrente" : "Nuevo recurrente",
    body: `
      <div class="small text-secondary mb-2">
        Define el movimiento que se generará cada mes.
        <b>Periodo</b> es el mes contable; <b>Registro</b> permite guardar la fecha en el mes anterior/siguiente.
      </div>

      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Nombre</label>
          <input class="form-control" id="rName" placeholder="Ej: Luz" value="${esc(r?.name||"")}">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="rType">
            <option>Ingreso</option><option>Gasto</option><option>Transferencia</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Activo</label>
          <select class="form-select" id="rAct">
            <option value="1">Sí</option><option value="0">No</option>
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Cuenta origen</label>
          <select class="form-select" id="rAcc">${accOpts}</select>
        </div>

        <div class="col-12 col-md-6" id="rAccToWrap">
          <label class="form-label">Cuenta destino</label>
          <select class="form-select" id="rAccTo">
            <option value="">(Selecciona)</option>${accOpts}
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Categoría</label>
          <select class="form-select" id="rCat">
            <option value="">(Opcional)</option>${catOpts}
          </select>
          <div class="form-text">Para Transferencia es opcional (sirve para clasificar).</div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Monto (moneda de la cuenta origen)</label>
          <input class="form-control" id="rAmt" inputmode="decimal" placeholder="0" value="${esc(r?String(r.amount||0):"")}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Día del mes</label>
          <input class="form-control" id="rDay" inputmode="numeric" placeholder="1-31" value="${esc(r?String(r.day||1):"1")}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Registro</label>
          <select class="form-select" id="rOff">
            <option value="-1">Mes anterior</option>
            <option value="0">Mismo mes</option>
            <option value="1">Mes siguiente</option>
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Desde</label>
          <input type="month" class="form-control" id="rFrom" value="${esc(r?.startPeriod||pNow)}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Hasta (opcional)</label>
          <input type="month" class="form-control" id="rTo" value="${esc(r?.endPeriod||"")}">
        </div>

        <div class="col-12">
          <label class="form-label">Descripción</label>
          <input class="form-control" id="rDesc" maxlength="200" placeholder="Opcional" value="${esc(r?.desc||"")}">
        </div>
      </div>
    `,
    footer: `
      <button class="btn btn-outline-dark" onclick="recManage()">
        <i class="bi bi-arrow-left"></i> Volver
      </button>
      <button class="btn btn-dark" id="rSave">
        <i class="bi bi-check2"></i> Guardar
      </button>
    `
  });

  // ordenar combos (cuenta/categoría)
  sortSelectOptions("#rAcc", false);
  sortSelectOptions("#rAccTo", true);
  sortSelectOptions("#rCat", true);

  // init values
  $("#rType").value = r?.type || "Gasto";
  $("#rAct").value = (r?.active===false) ? "0" : "1";
  $("#rAcc").value = r?.accountId || (accs[0]?.id || "");
  $("#rAccTo").value = r?.accountToId || "";
  $("#rCat").value = r?.categoryId || "";
  $("#rOff").value = String(r?.regOffset ?? 0);

  const syncType = ()=>{
    const t = $("#rType").value;
    $("#rAccToWrap").classList.toggle("d-none", t!=="Transferencia");
  };
  $("#rType").addEventListener("change", syncType);
  syncType();

  $("#rSave").addEventListener("click", ()=>{
    const name = String($("#rName").value||"").trim();
    const type = $("#rType").value;
    const active = $("#rAct").value === "1";

    const acc = $("#rAcc").value || null;
    const accTo = $("#rAccTo").value || null;
    const cat = $("#rCat").value || null;

    const amt = parseAmount($("#rAmt").value);
    const day = Math.max(1, Math.min(31, parseInt($("#rDay").value||"1",10)));
    const regOffset = parseInt($("#rOff").value||"0",10);

    const start = $("#rFrom").value || "";
    const end = $("#rTo").value || "";
    const desc = String($("#rDesc").value||"").trim();

    // validations
    if(!name){ msg({title:"Validación",kind:"warning",body:"El <b>Nombre</b> es requerido."}); return; }
    if(!acc){ msg({title:"Validación",kind:"warning",body:"Selecciona <b>Cuenta origen</b>."}); return; }
    if(!(Number.isFinite(amt) && amt>0)){ msg({title:"Validación",kind:"warning",body:"El <b>Monto</b> debe ser > 0."}); return; }
    if(!start){ msg({title:"Validación",kind:"warning",body:"<b>Desde</b> es requerido."}); return; }
    if(end && end < start){ msg({title:"Validación",kind:"warning",body:"<b>Hasta</b> no puede ser menor que <b>Desde</b>."}); return; }

    if(type==="Transferencia"){
      if(!accTo){ msg({title:"Validación",kind:"warning",body:"Selecciona <b>Cuenta destino</b>."}); return; }
      if(accTo === acc){ msg({title:"Validación",kind:"warning",body:"Destino debe ser distinto al origen."}); return; }
    }

    const obj = {
      id: isEdit ? r.id : uuid(),
      active,
      name,
      type,
      accountId: acc,
      accountToId: (type==="Transferencia") ? accTo : null,
      categoryId: cat,
      amount: roundMoney(amt, accCur(acc)||base),
      day,
      regOffset,
      startPeriod: start,
      endPeriod: end || null,
      desc
    };

    if(!isEdit){
      state.recurrings.push(obj);
      logEvent("create","recurring",obj.id,`${obj.name} (${obj.type})`);
    }else{
      Object.assign(r, obj);
      logEvent("update","recurring",obj.id,`${obj.name} (${obj.type})`);
    }

    save();
    toast(isEdit ? "Recurrente actualizado." : "Recurrente creado.", "success");
    recManage();
  });
}

function recDel(id){
  const r = (state.recurrings || []).find(x=>x.id===id);
  if(!r) return;
  msg({
    title:"Eliminar recurrente",
    kind:"warning",
    body:`Se eliminará <b>${esc(r.name||"")}</b>. No afecta los movimientos ya generados.
      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-danger" onclick="recDelOk('${esc(id)}')">
          <i class="bi bi-trash"></i> Sí, eliminar
        </button>
      </div>`
  });
}

function recDelOk(id){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  const r = (state.recurrings || []).find(x=>x.id===id);
  state.recurrings = (state.recurrings || []).filter(x=>x.id!==id);
  logEvent("delete","recurring",id,r?.name||"");
  save();
  toast("Recurrente eliminado.","success");
  recManage();
}

function recGenerate(period){
  const base = baseCur();
  const list = (state.recurrings || []).filter(r=>r && r.active!==false);

  if(!list.length){
    msg({title:"Recurrentes",kind:"warning",body:"No hay recurrentes activos."});
    return;
  }

  // anti-duplicados (misma idea que v1.05): templateId|period
  const already = new Set(
    state.movements
      .filter(m=>m && m.recurring && m.recurring.templateId && m.recurring.period)
      .map(m=>`${m.recurring.templateId}|${m.recurring.period}`)
  );

  // balances locales (en moneda de la cuenta) para validar saldo sin recalcular toda la app
  const bal = balances();

  const within = (r)=>{
    const s = r.startPeriod || null;
    const e = r.endPeriod || null;
    if(s && period < s) return false;
    if(e && period > e) return false;
    return true;
  };

  // ====== VALIDACIÓN GLOBAL “FAIL SI FALTA FX” ======
  // Hacemos un pre-scan para detectar cualquier recurrente que requiera FX inexistente.
  // Si falta, abortamos TODO antes de crear movimientos (transaccional).
  for(const r of list){
    if(!within(r)) continue;

    const key = `${r.id}|${period}`;
    if(already.has(key)) continue;

    const acc = r.accountId;
    const a = state.accounts.find(x=>x.id===acc);
    if(!a || !a.active) continue; // inválidos se reportan luego; no cuentan como FX faltante.

    const date = periodToDate(period, r.day || 1, Number(r.regOffset || 0));
    if(!date) continue;

    const fromCur = accCur(acc) || base;
    if(fromCur !== base){
      const rateFrom = fxRateAt(fromCur, date);
      if(!(Number.isFinite(rateFrom) && rateFrom>0)){
        msg({
          title:"Tipo de cambio faltante",
          kind:"danger",
          body:`No existe tipo de cambio válido para <b>${esc(fromCur)}</b> en fecha <b>${esc(date)}</b>.<br>
                La generación se cancela (no se creó ningún movimiento).<br>
                Ajusta en <b>Configuración</b> (FX) e intenta de nuevo.`
        });
        return;
      }
    }

    if(r.type === "Transferencia"){
      const to = r.accountToId;
      const at = state.accounts.find(x=>x.id===to);
      if(!to || !at || !at.active || to===acc) continue;

      const toCur = accCur(to) || base;
      if(toCur !== base){
        const rateTo = fxRateAt(toCur, date);
        if(!(Number.isFinite(rateTo) && rateTo>0)){
          msg({
            title:"Tipo de cambio faltante",
            kind:"danger",
            body:`No existe tipo de cambio válido para <b>${esc(toCur)}</b> en fecha <b>${esc(date)}</b>.<br>
                  La generación se cancela (no se creó ningún movimiento).<br>
                  Ajusta en <b>Configuración</b> (FX) e intenta de nuevo.`
          });
          return;
        }
      }
    }
  }

  // ====== GENERACIÓN (si llegamos aquí, FX está OK) ======
  const rep = {period, generated:0, skippedDup:0, skippedRange:0, skippedInvalid:0, skippedSaldo:0, details:[]};

  for(const r of list){
    if(!within(r)){ rep.skippedRange++; continue; }

    const key = `${r.id}|${period}`;
    if(already.has(key)){ rep.skippedDup++; continue; }

    // validar cuenta origen
    const acc = r.accountId;
    const a = state.accounts.find(x=>x.id===acc);
    if(!a || !a.active){
      rep.skippedInvalid++;
      rep.details.push(`✗ ${r.name}: cuenta origen inválida/inactiva`);
      continue;
    }

    const fromCur = accCur(acc) || base;

    let to = null, toCur = null;
    if(r.type === "Transferencia"){
      to = r.accountToId;
      const at = state.accounts.find(x=>x.id===to);
      if(!to || !at || !at.active || to===acc){
        rep.skippedInvalid++;
        rep.details.push(`✗ ${r.name}: cuenta destino inválida/inactiva`);
        continue;
      }
      toCur = accCur(to) || base;
    }

    const date = periodToDate(period, r.day || 1, Number(r.regOffset || 0));
    if(!date){
      rep.skippedInvalid++;
      rep.details.push(`✗ ${r.name}: fecha inválida`);
      continue;
    }

    const amt = roundMoney(Number(r.amount) || 0, fromCur);
    if(!(Number.isFinite(amt) && amt>0)){
      rep.skippedInvalid++;
      rep.details.push(`✗ ${r.name}: monto inválido`);
      continue;
    }

    // saldo disponible (respeta allowNegative)
    const available = roundMoney(Number(bal.get(acc) || 0), fromCur);
    const allowNeg = canGoNegative(acc); // true si permite negativo (v1.08)
    if((r.type==="Gasto" || r.type==="Transferencia") && !allowNeg && amt > available){
      rep.skippedSaldo++;
      rep.details.push(`⚠ ${r.name}: saldo insuficiente (${fmtMoney(available, fromCur)})`);
      continue;
    }

    // FX rates (ya validados arriba)
    const rateFrom = (fromCur===base) ? 1 : fxRateAt(fromCur, date);
    const amountBase = roundMoney(toBase(amt, fromCur, rateFrom), base);

    let amountTo = null, rateTo = null;
    if(r.type === "Transferencia"){
      rateTo = (toCur===base) ? 1 : fxRateAt(toCur, date);
      amountTo = roundMoney(fromBase(amountBase, toCur, rateTo), toCur);
      if(!(Number.isFinite(amountTo) && amountTo>0)){
        rep.skippedInvalid++;
        rep.details.push(`✗ ${r.name}: monto destino inválido`);
        continue;
      }
    }

    const payload = {
      date,
      period,
      type: r.type,
      accountId: acc,
      accountToId: (r.type==="Transferencia") ? to : null,
      categoryId: r.categoryId || null,
      amount: roundMoney(amt, fromCur),
      currency: fromCur,
      rateToBase: rateFrom,
      amountBase: roundMoney(amountBase, base),
      desc: (r.desc || r.name || ""),
      // clave anti-duplicado / trazabilidad
      recurring: { templateId: r.id, period }
      // isSystem: NO (movimiento normal por tu decisión)
    };

    if(r.type === "Transferencia"){
      payload.currencyTo = toCur;
      payload.rateToBaseTo = (toCur===base) ? 1 : rateTo;
      payload.amountTo = amountTo;
    }

    state.movements.push({ id: uuid(), ...payload });
    rep.generated++;
    already.add(key);

    // actualizar balances locales
    if(r.type==="Ingreso"){
      bal.set(acc, roundMoney(available + amt, fromCur));
    }else if(r.type==="Gasto"){
      bal.set(acc, roundMoney(available - amt, fromCur));
    }else{
      // transferencia
      bal.set(acc, roundMoney(available - amt, fromCur));
      const avTo = roundMoney(Number(bal.get(to) || 0), toCur);
      bal.set(to, roundMoney(avTo + amountTo, toCur));
    }
  }

  // Persistir + refrescar vistas dependientes
  normalizeCurrencyModel(); // asegura consistencia de montos/FX del modelo actual
  save();

  const detailHtml = rep.details.length
    ? `<div class="small mt-2"><b>Detalle:</b><br>${rep.details.map(x=>esc(x)).join("<br>")}</div>`
    : "";

  msg({
    title: "Generación de recurrentes",
    kind: rep.generated ? "success" : "warning",
    body: `
      Periodo: <b>${esc(period)}</b><br>
      Generados: <b>${rep.generated}</b><br>
      Saltados (duplicado): <b>${rep.skippedDup}</b><br>
      Fuera de rango: <b>${rep.skippedRange}</b><br>
      Inválidos: <b>${rep.skippedInvalid}</b><br>
      Saldo insuficiente: <b>${rep.skippedSaldo}</b>
      ${detailHtml}
    `
  });

  // refrescar listados
  try{ renderMovements(); }catch{}
  try{ renderDashboard(); }catch{}
  try{ renderReports(); }catch{}
}

/* Savings: solo crear ahorro y retirar ahorro */
function savingsSum({year=null,month=null,catId=null}){
  const out=new Map();
  for(const m of state.movements){
    if(m.type!=="Ahorro"&&m.type!=="RetiroAhorro")continue;
    if(!m.categoryId)continue;
    if(year && !(m.period||"").startsWith(String(year)))continue;
    if(month && m.period!==month)continue;
    if(catId && !catOrDesc(m.categoryId,catId))continue;
    if(!out.has(m.categoryId))out.set(m.categoryId,{in:0,out:0,b:0});
    const r=out.get(m.categoryId);const amt=Number(m.amountBase!=null?m.amountBase:m.amount)||0;
    if(m.type==="Ahorro")r.in+=amt; else r.out+=amt;
    r.b=r.in-r.out;
  }
  return out;
}
function catOrDesc(candidate,root){
  if(candidate===root)return true;
  let cur=state.categories.find(c=>c.id===candidate);let g=0;
  while(cur?.parentId&&g++<20){if(cur.parentId===root)return true;cur=state.categories.find(c=>c.id===cur.parentId)}
  return false;
}

/* Conciliaciones */
function renderReconciliations(){
  const ys=yearsRec(), ms=months();
  const accs=state.accounts.filter(a=>a.active).slice()
    .sort((a,b)=>String(accPath(a.id)||a.name).localeCompare(String(accPath(b.id)||b.name),"es",{sensitivity:"base"}));
  const accOpts=accs.map(a=>`<option value="${a.id}">${esc(accPath(a.id)||a.name)} (${esc(accCur(a.id))})</option>`).join("");

  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros</div>
          <div class="small text-secondary">Conciliación mensual por <b>fecha</b> (extracto bancario).</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-dark" onclick="rcApply()"><i class="bi bi-funnel"></i> Aplicar</button>
          <button class="btn btn-sm btn-outline-dark" onclick="rcClear()"><i class="bi bi-x-circle"></i> Limpiar</button>
        </div>
      </div>

      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-5">
          <label class="form-label">Cuenta</label>
          <select class="form-select" id="rcA"><option value="">(Todas)</option>${accOpts}</select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Año</label>
          <select class="form-select" id="rcY"><option value="">(Auto)</option>${ys.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Mes</label>
          <select class="form-select" id="rcM"><option value="">(Auto)</option>${ms.map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}</select>
        </div>
      </div>

      <div class="small text-secondary mt-2">
        Sugerencia: selecciona un <b>Mes</b> para conciliar; si no eliges, el sistema muestra <b>últimos 12 meses</b> o el <b>año</b> seleccionado.
      </div>
    </div>
</div>`;

  const body = `${filters}<div id="rcDetail"></div><div id="rcHost"></div>`;

  $("#v-reconciliations").innerHTML = card("Conciliaciones",
    `<button class="btn btn-outline-dark" onclick="exportCsv('recon')"><i class="bi bi-filetype-csv"></i> Exportar CSV</button>
     <button class="btn btn-outline-dark" onclick="help('reconciliation')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#rcA").value = state.ui.rcA || "";
  $("#rcY").value = state.ui.rcY || "";
  $("#rcM").value = state.ui.rcM || "";

  // Auto-aplicar
  $("#rcA").onchange=rcApply;
  $("#rcY").onchange=rcApply;
  $("#rcM").onchange=rcApply;

  rcRender();
}

function rcApply(){
  let y = $("#rcY")?.value || "";
  let m = $("#rcM")?.value || "";
  ({y,m} = normalizeYearMonthInput(y,m,{syncYearFromMonth:true}));

  y = ensureSelectHasValue("#rcY", y);
  m = ensureSelectHasValue("#rcM", m);

  if(m){
    const my = m.slice(0,4);
    if(!y || y!==my){
      y = ensureSelectHasValue("#rcY", my) || my;
    }
  }

  if($("#rcY")) $("#rcY").value = y;
  if($("#rcM")) $("#rcM").value = m;

  state.ui.rcA = $("#rcA")?.value || "";
  state.ui.rcY = y || "";
  state.ui.rcM = m || "";

  rcRender();
}
function rcClear(){
  state.ui.rcA=""; state.ui.rcY=""; state.ui.rcM="";
  if($("#rcA")) $("#rcA").value="";
  if($("#rcY")) $("#rcY").value="";
  if($("#rcM")) $("#rcM").value="";
  rcRender();
}
function rcBack(){
  state.ui.rcM="";
  try{ if($("#rcM")) $("#rcM").value=""; }catch{}
  rcRender();
}

function rcOpen(accId, ym){
  if(!accId || !ym) return;
  state.ui.rcA = accId;
  state.ui.rcM = ym;
  state.ui.rcY = String(ym).slice(0,4);
  renderReconciliations();
}

function rcRender(){
  const accId = state.ui.rcA || "";
  const y = state.ui.rcY || "";
  const m = state.ui.rcM || "";

  const detail = $("#rcDetail");
  const host = $("#rcHost");
  if(!host) return;

  // ---- Detalle ----
  if(detail){
    if(accId && m){
      const a=accById(accId);
      detail.innerHTML = `
        <div class="card sgf mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <div class="fw-bold">Detalle: ${esc(accPath(accId)||a?.name||"(Cuenta)")} • ${esc(monthLabel(m))}</div>
                <div class="small text-secondary">Marca OK por movimiento y guarda. Diferencia debe quedar en <b>0</b>.</div>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="rcBack()"><i class="bi bi-arrow-left"></i> Volver</button>
                <button class="btn btn-sm btn-outline-dark" onclick="go('accounts'); state.ui.selAcc='${esc(accId)}'; renderAccounts();"><i class="bi bi-folder2-open"></i> Ir a Cuenta</button>
              </div>
            </div>
            <div id="rcRecHost" class="mt-3"></div>
          </div>
        </div>`;
      recRender(accId, m, "#rcRecHost");
    }else{
      detail.innerHTML = "";
    }
  }

  // ---- Resumen por mes ----
  let monthsList = m ? [m] : (y ? months().filter(p=>p.startsWith(String(y)+"-")) : lastNMonths(currentPeriod(),12));
  monthsList = monthsList.filter(Boolean).sort((a,b)=>b.localeCompare(a));
  if(!monthsList.length){
    host.innerHTML = `<div class="card sgf"><div class="card-body text-secondary">No hay meses para mostrar.</div></div>`;
    return;
  }

  const accsAll = state.accounts.filter(a=>a.active).slice()
    .sort((a,b)=>String(accPath(a.id)||a.name).localeCompare(String(accPath(b.id)||b.name),"es",{sensitivity:"base"}));
  const accs = accId ? accsAll.filter(a=>a.id===accId) : accsAll;

  const cards = monthsList.map(ym=>{
    const rg=dateRangeForMonth(ym); if(!rg) return "";
    const prevDay = (()=>{ const d=new Date(rg.start+"T00:00:00"); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
    const rows=[];
    for(const a of accs){
      const id=a.id;
      const cur=accCur(id);
      const startBal=accBalanceAt(id, prevDay);
      const endBal=accBalanceAt(id, rg.end);

      const movs = state.movements.filter(mv=>{
        if(!mv||!mv.date) return false;
        if(mv.isOpening) return false;
        if(!["Ingreso","Gasto","Transferencia"].includes(mv.type)) return false;
        if(mv.date < rg.start || mv.date > rg.end) return false;
        return mv.accountId===id || mv.accountToId===id;
      });

      const rec=recGet(id,ym);
      if(!rec && movs.length===0) continue;

      const startVal = (rec && Number.isFinite(Number(rec.start))) ? Number(rec.start) : startBal;
      const endVal = (rec && Number.isFinite(Number(rec.end))) ? Number(rec.end) : endBal;
      const diff = Number(endVal) - Number(endBal);
      const unrecCount = movs.filter(mv=>!(mv.reconciled && mv.reconMonth===ym)).length;

      rows.push({accId:id, accName: accPath(id)||a.name, cur, startVal, endVal, ledgerEnd:endBal, diff, closed:!!rec?.closed, hasRec:!!rec, unrecCount});
    }

    if(!rows.length) return "";

    const trs = rows.map(r=>{
      const diffCls = Math.abs(Number(r.diff)||0) < 0.00001 ? "text-success" : "text-danger";
      const stateBadge = r.hasRec ? (r.closed?'<span class="badge text-bg-success">Cerrada</span>':'<span class="badge text-bg-warning">Abierta</span>') : '<span class="badge text-bg-secondary">Pendiente</span>';
      return `<tr>
        <td><div class="text-truncate" style="max-width:260px" title="${esc(r.accName)}">${esc(r.accName)}</div></td>
        <td class="text-center">${stateBadge}</td>
        <td class="text-end fw-bold">${fmtMoney(r.endVal,r.cur)}</td>
        <td class="text-end">${fmtMoney(r.ledgerEnd,r.cur)}</td>
        <td class="text-end fw-bold ${diffCls}">${fmtMoney(r.diff,r.cur)}</td>
        <td class="text-end">${r.unrecCount}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-dark" onclick="rcOpen('${esc(r.accId)}','${esc(ym)}')"><i class="bi bi-check2-square"></i></button>
        </td>
      </tr>`;
    }).join("");

    return `
      <div class="card sgf mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
              <div class="fw-bold">${esc(monthLabel(ym))}</div>
              <div class="small text-secondary">Diferencia = Estado de cuenta final − Ledger calculado.</div>
            </div>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Cuenta</th>
                  <th class="text-center">Estado</th>
                  <th class="text-end">Final (EC)</th>
                  <th class="text-end">Final (Ledger)</th>
                  <th class="text-end">Diferencia</th>
                  <th class="text-end">No conciliados</th>
                  <th class="text-end">Acción</th>
                </tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }).join("");

  host.innerHTML = cards || `<div class="card sgf"><div class="card-body text-secondary">No hay conciliaciones ni actividad en los meses seleccionados.</div></div>`;
}

function renderSavings(){
  const ys=years(), ms=months();
  const cats=state.categories.filter(c=>c.active).slice()
    .sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));
  const catOpts=cats.map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");
  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros</div>
          <div class="small text-secondary">Incluye subcategorías de Ahorros.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap"><button class="btn btn-sm btn-dark" onclick="savApply()"><i class="bi bi-funnel"></i> Aplicar</button>
          <button class="btn btn-sm btn-outline-dark" onclick="savClear()"><i class="bi bi-x-circle"></i> Limpiar</button>
        </div>
      </div>
      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-2">
          <label class="form-label">Año</label>
          <select class="form-select" id="sY"><option value="">(Todo)</option>${ys.map(y=>`<option>${y}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Mes</label>
          <select class="form-select" id="sM"><option value="">(Todo)</option>${ms.map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}</select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Categoría</label>
          <select class="form-select" id="sC"><option value="">(Todas)</option>${catOpts}</select>
          <div class="small text-secondary mt-1">Incluye subcategorías.</div>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Texto</label>
          <input class="form-control" id="sQ" placeholder="Buscar (cuenta/categoría)">
          <div class="small text-secondary mt-1">Filtra resumen y movimientos.</div>
        </div>
      </div>
    </div>
</div>`;

  const body=`${filters}<div id="savGoals"></div><div id="savHost"></div>`;

  $("#v-savings").innerHTML=card("Ahorros",
    `<button class="btn btn-dark" onclick="savEdit('Ahorro')"><i class="bi bi-plus"></i> Nuevo ahorro</button>
<button class="btn btn-outline-dark" onclick="goalEdit()"><i class="bi bi-flag"></i> Nueva meta</button>
<button class="btn btn-outline-dark" onclick="help('savings')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#sY").value=state.ui.sY||"";$("#sM").value=state.ui.sM||"";$("#sC").value=state.ui.sC||"";
  $("#sQ").value=state.ui.sQ||"";
  // Auto-aplicar filtros (incluye debounce en texto)
  $("#sY").onchange=savApply;
  $("#sM").onchange=savApply;
  $("#sC").onchange=savApply;
  $("#sQ").oninput=()=>debounce("savQ", savApply, 260);

  savRender();
}

function savApply(){
  let y = $("#sY")?.value || "";
  let m = $("#sM")?.value || "";
  ({y,m} = normalizeYearMonthInput(y,m,{syncYearFromMonth:true}));

  y = ensureSelectHasValue("#sY", y);
  m = ensureSelectHasValue("#sM", m);

  if(m){
    const my = m.slice(0,4);
    if(!y || y!==my){
      y = ensureSelectHasValue("#sY", my) || my;
    }
  }

  if($("#sY")) $("#sY").value = y;
  if($("#sM")) $("#sM").value = m;

  state.ui.sY = y || "";
  state.ui.sM = m || "";
  state.ui.sC = $("#sC")?.value || "";
  state.ui.sQ = $("#sQ")?.value || "";
  state.ui.savSumP = 1;
  state.ui.savTxP = 1;
  savRender();
}
function savClear(){
  state.ui.sY="";
  state.ui.sM="";
  state.ui.sC="";
  state.ui.sQ="";
  state.ui.savSumP=1;
  state.ui.savTxP=1;
  if($("#sY")) $("#sY").value="";
  if($("#sM")) $("#sM").value="";
  if($("#sC")) $("#sC").value="";
  if($("#sQ")) $("#sQ").value="";
  savRender();
}
function savRender(){
  const y=state.ui.sY||null,m=state.ui.sM||null,c=state.ui.sC||null,q=(state.ui.sQ||"").trim().toLowerCase();
  const map=savingsSum({year:y,month:m,catId:c});
  let rows=[...map.entries()].map(([cid,r])=>({cid,...r})).filter(r=>r.in||r.out||r.b);

  // filtro por texto (sobre categorías del resumen)
  if(q){
    rows = rows.filter(r=>String(catPath(r.cid)||"").toLowerCase().includes(q));
  }

  const total=rows.reduce((s,r)=>s+r.b,0)||0;

  const so=getSort("sav","saldo","desc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  rows = rows.sort((a,b)=>{
    const av = key==="category" ? (catPath(a.cid)||"")
      : key==="in" ? Number(a.in||0)
      : key==="out" ? Number(a.out||0)
      : key==="saldo" ? Number(a.b||0)
      : Number(a.b||0);
    const bv = key==="category" ? (catPath(b.cid)||"")
      : key==="in" ? Number(b.in||0)
      : key==="out" ? Number(b.out||0)
      : key==="saldo" ? Number(b.b||0)
      : Number(b.b||0);
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv));
    return c*mult;
  });

  const bal=balances();const savBalC=bal.get(state.config.savingsAccountId)||0;const savBalU=bal.get(state.config.savingsAccountIdUSD)||0;

  const sumIn=rows.reduce((s,r)=>s+Number(r.in||0),0);
  const sumOut=rows.reduce((s,r)=>s+Number(r.out||0),0);

  const kpi=`<div class="row g-3 mb-3 sgf-land-stack">
    <div class="col-12 col-md-4"><div class="p-3 border rounded-4"><div class="small text-secondary fw-semibold">Entradas</div><div class="h5 fw-bold m-0">${fmtMoney(sumIn)}</div></div></div>
    <div class="col-12 col-md-4"><div class="p-3 border rounded-4"><div class="small text-secondary fw-semibold">Salidas</div><div class="h5 fw-bold m-0">${fmtMoney(sumOut)}</div></div></div>
    <div class="col-12 col-md-4"><div class="p-3 border rounded-4"><div class="small text-secondary fw-semibold">Saldo disponible</div><div class="h5 fw-bold m-0">${fmtMoney(total)}</div><div class="small text-secondary">En Ahorros (SGF) CRC: <b>${fmtMoney(savBalC)}</b> • USD: <b>${fmtMoney(savBalU,"USD")}</b></div></div></div>
</div>`;

  // Paginación: resumen por categoría
  const pageSizeSum = Number(state.ui.savSumPS||50);
  const totalPagesSum = Math.max(1, Math.ceil(rows.length / pageSizeSum));
  let pageSum = Number(state.ui.savSumP||1);
  if(pageSum>totalPagesSum) pageSum=totalPagesSum;
  if(pageSum<1) pageSum=1;
  state.ui.savSumP=pageSum;

  const startSum = (pageSum-1)*pageSizeSum;
  const endSum = startSum + pageSizeSum;
  const pageRows = rows.slice(startSum, endSum);
  const showFromSum = rows.length ? (startSum+1) : 0;
  const showToSum = Math.min(endSum, rows.length);

  const disPrevSum = pageSum<=1 ? "disabled" : "";
  const disNextSum = pageSum>=totalPagesSum ? "disabled" : "";
  const pagerSum = `<div class="d-flex align-items-center gap-1 sgf-pager">
      <button class="btn btn-sm btn-outline-dark" ${disPrevSum} onclick="savSumSetPage(1)"><i class="bi bi-chevron-bar-left"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disPrevSum} onclick="savSumSetPage(${pageSum-1})"><i class="bi bi-chevron-left"></i></button>
      <span class="small text-secondary px-2">Página <b>${pageSum}</b> / ${totalPagesSum}</span>
      <button class="btn btn-sm btn-outline-dark" ${disNextSum} onclick="savSumSetPage(${pageSum+1})"><i class="bi bi-chevron-right"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disNextSum} onclick="savSumSetPage(${totalPagesSum})"><i class="bi bi-chevron-bar-right"></i></button>
    </div>`;
  const psSelSum = `<select class="form-select form-select-sm" style="width:auto" onchange="savSumSetPageSize(this.value)">
      ${[25,50,100].map(n=>`<option value="${n}" ${n===pageSizeSum?"selected":""}>${n}/pág</option>`).join("")}
    </select>`;

  const tr=pageRows.map(r=>{
    const pct=total>0?clamp((r.b/total)*100,0,100):0;
    return `<tr>
      <td><div class="d-flex gap-2 align-items-center"><span class="dot" style="background:${catColor(r.cid)}"></span><span class="fw-semibold">${esc(catPath(r.cid)||"(Categoría)")}</span></div></td>
      <td class="text-end">${fmtMoney(r.in)}</td><td class="text-end">${fmtMoney(r.out)}</td><td class="text-end fw-bold">${fmtMoney(r.b)}</td>
      <td style="width:240px"><div class="progress"><div class="progress-bar bg-primary" style="width:${pct}%"></div></div><div class="small text-secondary mt-1">${pct.toFixed(0)}%</div></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-dark" onclick="savEdit('RetiroAhorro','${r.cid}')"><i class="bi bi-dash"></i></button></td>
    </tr>`;
  }).join("");

  const summaryFoot = rows.length ? `<tfoot><tr class="table-light">
      <td class="text-end fw-semibold">Totales</td>
      <td class="text-end fw-bold">${fmtMoney(sumIn)}</td>
      <td class="text-end fw-bold">${fmtMoney(sumOut)}</td>
      <td class="text-end fw-bold">${fmtMoney(total)}</td>
      <td></td><td></td>
    </tr></tfoot>` : ``;

  // ---- listado de movimientos de Ahorro/Retiro (para editar categoría) ----
  let tx=state.movements.filter(x=>["Ahorro","RetiroAhorro"].includes(x.type));
  if(y) tx=tx.filter(x=>(x.period||"").startsWith(String(y)));
  if(m) tx=tx.filter(x=>x.period===m);
  if(c) tx=tx.filter(x=>catOrDesc(x.categoryId,c));
  if(q){
    tx = tx.filter(x=>{
      const catT=String(catPath(x.categoryId)||"").toLowerCase();
      const a1=String(accPath(x.accountId)||"").toLowerCase();
      const a2=String(accPath(x.accountToId)||"").toLowerCase();
      const d=String(x.desc||"").toLowerCase();
      return catT.includes(q) || a1.includes(q) || a2.includes(q) || d.includes(q);
    });
  }
    const soTx=getSort("savtx","date","desc");
  const multTx=soTx.dir==="asc"?1:-1;
  const keyTx=soTx.key;
  tx=tx.sort((a,b)=>{
    const av = keyTx==="date" ? (a.date||"")
      : keyTx==="type" ? (a.type||"")
      : keyTx==="accounts" ? ((accPath(a.accountId)||"")+"→"+(accPath(a.accountToId)||""))
      : keyTx==="category" ? (catPath(a.categoryId)||"")
      : keyTx==="desc" ? (a.desc||"")
      : keyTx==="amount" ? Number(a.amountBase!=null?a.amountBase:a.amount||0)
      : (a.date||"");
    const bv = keyTx==="date" ? (b.date||"")
      : keyTx==="type" ? (b.type||"")
      : keyTx==="accounts" ? ((accPath(b.accountId)||"")+"→"+(accPath(b.accountToId)||""))
      : keyTx==="category" ? (catPath(b.categoryId)||"")
      : keyTx==="desc" ? (b.desc||"")
      : keyTx==="amount" ? Number(b.amountBase!=null?b.amountBase:b.amount||0)
      : (b.date||"");
    const c=(typeof av==="number"&&typeof bv==="number")?(av-bv):String(av).localeCompare(String(bv));
    if(c!==0) return c*multTx;
    return String(b.date||"").localeCompare(String(a.date||""));
  });
const totalInTx = tx.filter(x=>x.type==="Ahorro").reduce((s,x)=>s+Number(x.amountBase!=null?x.amountBase:x.amount||0),0);
  const totalOutTx = tx.filter(x=>x.type==="RetiroAhorro").reduce((s,x)=>s+Number(x.amountBase!=null?x.amountBase:x.amount||0),0);
  const netTx = totalInTx - totalOutTx;

  // Paginación: movimientos de ahorros
  const pageSizeTx = Number(state.ui.savTxPS||100);
  const totalPagesTx = Math.max(1, Math.ceil(tx.length / pageSizeTx));
  let pageTx = Number(state.ui.savTxP||1);
  if(pageTx>totalPagesTx) pageTx=totalPagesTx;
  if(pageTx<1) pageTx=1;
  state.ui.savTxP=pageTx;

  const startTx = (pageTx-1)*pageSizeTx;
  const endTx = startTx + pageSizeTx;
  const txSlice = tx.slice(startTx, endTx);
  const showFromTx = tx.length ? (startTx+1) : 0;
  const showToTx = Math.min(endTx, tx.length);

  const disPrevTx = pageTx<=1 ? "disabled" : "";
  const disNextTx = pageTx>=totalPagesTx ? "disabled" : "";
  const pagerTx = `<div class="d-flex align-items-center gap-1 sgf-pager">
      <button class="btn btn-sm btn-outline-dark" ${disPrevTx} onclick="savTxSetPage(1)"><i class="bi bi-chevron-bar-left"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disPrevTx} onclick="savTxSetPage(${pageTx-1})"><i class="bi bi-chevron-left"></i></button>
      <span class="small text-secondary px-2">Página <b>${pageTx}</b> / ${totalPagesTx}</span>
      <button class="btn btn-sm btn-outline-dark" ${disNextTx} onclick="savTxSetPage(${pageTx+1})"><i class="bi bi-chevron-right"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disNextTx} onclick="savTxSetPage(${totalPagesTx})"><i class="bi bi-chevron-bar-right"></i></button>
    </div>`;
  const psSelTx = `<select class="form-select form-select-sm" style="width:auto" onchange="savTxSetPageSize(this.value)">
      ${[50,100,200].map(n=>`<option value="${n}" ${n===pageSizeTx?"selected":""}>${n}/pág</option>`).join("")}
    </select>`;

  const txRows=txSlice.map(x=>{
    const badge=x.type==="Ahorro"?"text-bg-primary":"text-bg-dark";
    const from=accPath(x.accountId)||"(Cuenta)";
    const to=accPath(x.accountToId)||"(Cuenta)";
    return `<tr>
      <td><div class="fw-semibold">${fmtDate(x.date)}</div><div class="small text-secondary">Periodo: ${esc(monthLabel(x.period))}</div></td>
      <td><span class="badge ${badge} rounded-pill">${x.type==="Ahorro"?"Ahorro":"Retiro"}</span></td>
      <td><div class="fw-semibold">${esc(from)}</div><div class="small text-secondary">→ ${esc(to)}</div></td>
      <td><div class="d-flex gap-2 align-items-center"><span class="dot" style="background:${catColor(x.categoryId)}"></span><span>${esc(catPath(x.categoryId)||"—")}</span></div></td>
      <td class="td-desc">
        <div class="text-truncate" style="max-width:260px" title="${esc(x.desc||"")}">${x.desc?esc(x.desc):"<span class='text-secondary'>—</span>"}</div>
      </td>
      <td class="text-end fw-bold">${(()=>{const cur=x.currency||accCur(x.accountId)||baseCur();const amt=Number(x.amount)||0;const baseAmt=Number(x.amountBase!=null?x.amountBase:amt)||0;return cur===baseCur()?fmtMoney(amt,cur):`${fmtMoney(amt,cur)}<div class="small text-secondary">≈ ${fmtMoney(baseAmt,baseCur())}</div>`})()}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" onclick="savCatEdit('${x.id}')"><i class="bi bi-pencil"></i></button>
        ${x.type==="Ahorro" ? `<button class="btn btn-sm btn-outline-dark" title="Duplicar" onclick="savDuplicate('${x.id}')"><i class="bi bi-files"></i></button>` : ``}
        <button class="btn btn-sm btn-outline-danger" onclick="movDel('${x.id}')"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`;
  }).join("");

  const txFoot = tx.length ? `<tfoot><tr class="table-light">
      <td colspan="5" class="text-end fw-semibold">Totales (Ahorros / Retiros / Neto)</td>
      <td class="text-end fw-bold">
        <div class="small"><span class="text-primary">+${fmtMoney(totalInTx)}</span> / <span class="text-dark">-${fmtMoney(totalOutTx)}</span></div>
        <div class="fw-bold">${fmtMoney(netTx)}</div>
      </td>
      <td></td>
    </tr></tfoot>` : ``;

  $("#savHost").innerHTML=`
    <div class="card sgf"><div class="card-body">
      ${kpi}
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2"><div class="fw-bold">Resumen por categoría</div><div class="d-flex align-items-center gap-2 flex-wrap"><div class="small text-secondary">Mostrando ${showFromSum}-${showToSum} de ${rows.length}</div>${psSelSum}${pagerSum}</div></div>
      <div class="table-responsive sgf-table-scroll sgf-table-sticky">
        <table class="table table-hover align-middle" id="tblSav">
          <thead><tr>
            <th class="th-sort" onclick="toggleSort('sav','category',()=>{state.ui.savSumP=1;savRender()})">Categoría ${sortIcon('sav','category')}</th>
            <th class="text-end th-sort" onclick="toggleSort('sav','in',()=>{state.ui.savSumP=1;savRender()})">Entradas ${sortIcon('sav','in')}</th>
            <th class="text-end th-sort" onclick="toggleSort('sav','out',()=>{state.ui.savSumP=1;savRender()})">Salidas ${sortIcon('sav','out')}</th>
            <th class="text-end th-sort" onclick="toggleSort('sav','saldo',()=>{state.ui.savSumP=1;savRender()})">Saldo ${sortIcon('sav','saldo')}</th>
            <th>Progreso</th>
            <th class="text-end">Acción</th>
          </tr></thead>
          <tbody>${tr||`<tr><td colspan="6" class="text-secondary">Sin datos.</td></tr>`}</tbody>
          ${summaryFoot}
        </table>
      </div>

      <hr class="my-4">

      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <div class="fw-bold">Movimientos de ahorros</div>
        <div class="d-flex align-items-center gap-2 flex-wrap"><div class="small text-secondary">Mostrando ${showFromTx}-${showToTx} de ${tx.length}</div>${psSelTx}${pagerTx}</div>
      </div>
      <div class="small text-secondary mb-2">Aquí puedes <b>editar la categoría</b> de un ahorro/retiro sin tocar montos ni fechas.</div>
      <div class="table-responsive sgf-table-scroll sgf-table-sticky">
        <table class="table table-hover align-middle mb-0">
          <thead><tr>
            <th class="th-sort" onclick="toggleSort('savtx','date',()=>{state.ui.savTxP=1;savRender()})">Fecha ${sortIcon('savtx','date')}</th>
            <th class="th-sort" onclick="toggleSort('savtx','type',()=>{state.ui.savTxP=1;savRender()})">Tipo ${sortIcon('savtx','type')}</th>
            <th class="th-sort" onclick="toggleSort('savtx','accounts',()=>{state.ui.savTxP=1;savRender()})">Cuentas ${sortIcon('savtx','accounts')}</th>
            <th class="th-sort" onclick="toggleSort('savtx','category',()=>{state.ui.savTxP=1;savRender()})">Categoría ${sortIcon('savtx','category')}</th>
            <th class="th-sort" onclick="toggleSort('savtx','desc',()=>{state.ui.savTxP=1;savRender()})">Descripción ${sortIcon('savtx','desc')}</th>
            <th class="text-end th-sort" onclick="toggleSort('savtx','amount',()=>{state.ui.savTxP=1;savRender()})">Monto ${sortIcon('savtx','amount')}</th>
            <th class="text-end">Acciones</th>
          </tr></thead>
          <tbody>${txRows||`<tr><td colspan="7" class="text-secondary">No hay movimientos de ahorro para el filtro actual.</td></tr>`}</tbody>
          ${txFoot}
        </table>
      </div>

      <div class="small text-secondary mt-2"><b>Nota:</b> Los ahorros generan transferencias del sistema para mantener consistencia.</div>
    </div></div>`;
  try{ goalsRender(); }catch(e){ console.error(e); }
}



function goalNet(goal, onlyPeriods=null){
  const base=baseCur();
  let net=0;
  for(const m of state.movements){
    if(m.type!=="Ahorro" && m.type!=="RetiroAhorro") continue;
    if(!m.categoryId) continue;
    if(!catOrDesc(m.categoryId, goal.categoryId)) continue;
    if(onlyPeriods && !onlyPeriods.includes(m.period)) continue;

    if((goal.currency||base)===base){
      const amt=Number(m.amountBase!=null?m.amountBase:m.amount)||0;
      net += (m.type==="Ahorro"?1:-1)*amt;
    }else{
      const cur = m.currency || base;
      if(cur!==(goal.currency||"USD")) continue;
      const amt=Number(m.amount)||0;
      net += (m.type==="Ahorro"?1:-1)*amt;
    }
  }
  return net;
}

function savingsRootId(){
  const r = state.categories.find(c=>!c.parentId && String(c.name||"").trim().toLowerCase()==="ahorros");
  return r?.id||null;
}

function goalsRender(){
  const host=$("#savGoals");
  if(!host) return;

  const goals = Array.isArray(state.goals) ? state.goals.filter(g=>g && g.active!==false) : [];
  const base=baseCur();

  if(!goals.length){
    host.innerHTML = `<div class="card sgf mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between gap-2 align-items-center">
          <div>
            <div class="fw-bold">Metas de ahorro</div>
            <div class="small text-secondary">Crea metas por categoría y da seguimiento al progreso.</div>
          </div>
          <button class="btn btn-sm btn-outline-dark" onclick="goalEdit()"><i class="bi bi-flag"></i> Nueva meta</button>
        </div>
        <div class="mt-3 small text-secondary">No hay metas activas.</div>
      </div>
    </div>`;
    return;
  }

  const last3=lastNMonths(currentPeriod(),3);
  const rows = goals.map(g=>{
    const cur = g.currency || base;
    const current = goalNet(g);
    const target = Number(g.targetAmount||0);
    const pct = target>0 ? Math.max(0, Math.min(100, (current/target)*100)) : 0;
    const remaining = Math.max(0, target-current);

    const net3 = goalNet(g, last3);
    const avg3Raw = net3 / Math.max(1, (last3||[]).length || 3);
    const avg3 = Math.max(0, avg3Raw);
    const monthsTo = (remaining<=0 && target>0) ? 0 : ((avg3>0) ? Math.ceil(remaining/avg3) : null);

    return {g,cur,current,target,pct,remaining,avg3,monthsTo};
  });

  host.innerHTML = `<div class="card sgf mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between gap-2 align-items-center">
        <div>
          <div class="fw-bold">Metas de ahorro</div>
          <div class="small text-secondary">Progreso en ${esc(base)} o USD según la meta.</div>
        </div>
        <button class="btn btn-sm btn-outline-dark" onclick="goalEdit()"><i class="bi bi-flag"></i> Nueva meta</button>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Categoría</th>
              <th>Moneda</th>
              <th class="text-end">Objetivo</th>
              <th class="text-end">Actual</th>
              <th style="min-width:220px">Progreso</th>
              <th class="text-end">Restante</th>
              <th>Fecha meta</th>
              <th class="text-end">Prom. 3m</th>
              <th class="text-end">Meses est.</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const name = catPath(r.g.categoryId) || "(Categoría)";
              const done = r.current>=r.target && r.target>0;
              const barCls = done ? "bg-success" : "bg-dark";
              return `<tr>
                <td class="fw-semibold">${esc(name)}</td>
                <td>${esc(r.cur)}</td>
                <td class="text-end">${fmtMoney(r.target, r.cur)}</td>
                <td class="text-end">${fmtMoney(r.current, r.cur)}</td>
                <td>
                  <div class="progress" style="height:10px">
                    <div class="progress-bar ${barCls}" style="width:${r.pct.toFixed(1)}%"></div>
                  </div>
                  <div class="small text-secondary mt-1">
                    ${done ? `<span class="text-success fw-semibold">Completada</span>` : `En progreso`} • ${r.pct.toFixed(1)}%
                  </div>
                </td>
                <td class="text-end">${fmtMoney(r.remaining, r.cur)}</td>
                <td>${r.g.targetDate?esc(r.g.targetDate):"<span class='text-secondary'>(—)</span>"}</td>
                <td class="text-end">${fmtMoney(r.avg3, r.cur)}</td>
                <td class="text-end">${r.monthsTo==null?`<span class="text-secondary">—</span>`:String(r.monthsTo)}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-dark" onclick="goalEdit('${r.g.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="goalDel('${r.g.id}')"><i class="bi bi-trash"></i></button>
                </td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
</div>`;
}

function goalEdit(id=null){
  const base=baseCur();
  const g = id ? (state.goals||[]).find(x=>x.id===id) : null;

  const cats = state.categories.filter(c=>c.active);
const catOpts = cats
    .map(c=>({id:c.id, txt:catPath(c.id)||c.name}))
    .sort((a,b)=>a.txt.localeCompare(b.txt))
    .map(x=>`<option value="${x.id}">${esc(x.txt)}</option>`)
    .join("");

  const cur = g?.currency || base;

  const body = `<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-6">
      <label class="form-label">Categoría</label>
      <select class="form-select" id="gC"><option value="">(Seleccione)</option>${catOpts}</select>
      <div class="small text-secondary mt-1">Se considera la categoría y sus subcategorías.</div>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">Moneda</label>
      <select class="form-select" id="gCur">
        <option value="${esc(base)}">${esc(base)} (base)</option>
        <option value="USD">USD</option>
      </select>
      <div class="small text-secondary mt-1">USD suma solo ahorros en USD.</div>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">Objetivo</label>
      <input class="form-control" id="gAmt" inputmode="decimal" placeholder="0">
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Fecha meta (opcional)</label>
      <input type="date" class="form-control" id="gDue">
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Nota (opcional)</label>
      <input class="form-control" id="gNote" maxlength="200">
    </div>
</div>`;

  const footer = `<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="gSave"><i class="bi bi-check2"></i> Guardar</button>`;

  editor({title: g ? "Editar meta" : "Nueva meta", body, footer});

  $("#gC").value = g?.categoryId || "";
  $("#gCur").value = cur;
  $("#gAmt").value = g?.targetAmount!=null ? String(g.targetAmount) : "";
  $("#gDue").value = g?.targetDate || "";
  $("#gNote").value = g?.note || "";

  $("#gSave").onclick = ()=>{
    const catId = $("#gC").value || "";
    const currency = $("#gCur").value || base;
    const targetAmount = parseAmount($("#gAmt").value);
    const targetDate = ($("#gDue").value||"").trim() || "";
    const note = ($("#gNote").value||"").trim();

    if(!catId){ msg({title:"Validación",kind:"warning",body:"Seleccione una <b>Categoría</b>."}); return; }
    if(!Number.isFinite(targetAmount) || targetAmount<=0){
      msg({title:"Validación",kind:"warning",body:"El <b>Objetivo</b> debe ser > 0."}); return;
    }

    const nowIso = new Date().toISOString();
    if(g){
      g.categoryId=catId;
      g.currency=currency;
      g.targetAmount=roundMoney(targetAmount,currency);
      g.targetDate=targetDate;
      g.note=note;
      g.updatedAt=nowIso;
      g.active=true;
      logEvent("goal-edit","system",g.id,"Meta editada");
    }else{
      const ng = {
        id:uuid(),
        categoryId:catId,
        currency,
        targetAmount:roundMoney(targetAmount,currency),
        targetDate,
        note,
        active:true,
        createdAt:nowIso,
        updatedAt:nowIso
      };
      state.goals = state.goals || [];
      state.goals.push(ng);
      logEvent("goal-new","system",ng.id,"Meta creada");
    }

    save();
    closeEditor();
    toast("Meta guardada.","success");
    try{goalsRender();}catch{}
  };
}

function goalDel(id){
  const g=(state.goals||[]).find(x=>x.id===id);
  if(!g){ toast("Meta no encontrada.","warning"); return; }
  msg({
    title:"Eliminar meta",
    kind:"warning",
    body:`¿Eliminar la meta de <b>${esc(catPath(g.categoryId)||"Categoría")}</b>?<br><span class="text-secondary small">No elimina movimientos, solo la meta.</span>`
  });
  $("#msgOk").onclick=()=>{
    bootstrap.Modal.getInstance($("#msgM"))?.hide();
    state.goals = (state.goals||[]).filter(x=>x.id!==id);
    save();
    toast("Meta eliminada.","success");
    try{goalsRender();}catch{}
  };
}


function savEdit(kind,preCat=null,tplId=null){
  const accs=state.accounts.filter(a=>a.active && a.id!==state.config.savingsAccountId && a.id!==state.config.savingsAccountIdUSD);
  const accOpts=accs.map(a=>`<option value="${a.id}">${esc(accPath(a.id)||a.name)} (${esc(a.currency||baseCur())})</option>`).join("");
  const catOpts=state.categories.filter(c=>c.active).map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");
  const now=new Date();const d=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
  const p=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const bal=balances();const savBalC=bal.get(state.config.savingsAccountId)||0;const savBalU=bal.get(state.config.savingsAccountIdUSD)||0;
  const base=baseCur();

  const body=`<div class="alert alert-dark border-0" style="background:rgba(0,0,0,.04)">
    <div class="d-flex flex-wrap justify-content-between gap-2 align-items-start">
      <div>
        <div class="fw-bold">${kind==="Ahorro"?"Crear ahorro":"Retirar ahorro"}</div>
        <div class="small text-secondary">${kind==="Ahorro"?"Mueve dinero hacia Ahorros (SGF) en la misma moneda de la cuenta origen.":"Mueve dinero desde Ahorros (SGF) en la misma moneda de la cuenta destino."}</div>
      </div>
      <div class="d-flex flex-column gap-1 text-end">
        <div class="badge-soft">Saldo Ahorros (SGF) CRC: ${fmtMoney(savBalC,base)}</div>
        <div class="badge-soft">Saldo Ahorros (SGF) USD: ${fmtMoney(savBalU,"USD")}</div>
        <div class="badge-soft d-none" id="seBalBadge"></div>
      </div>
    </div>
  </div>
  <div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-4"><label class="form-label">Fecha</label><input type="date" class="form-control" id="seD" value="${d}"></div>
    <div class="col-12 col-md-4"><label class="form-label">Periodo</label><input type="month" class="form-control" id="seP" value="${p}"></div>
    <div class="col-12 col-md-4">
      <label class="form-label">Monto</label>
      <div class="input-group">
        <span class="input-group-text" id="seCur">${base}</span>
        <input class="form-control" id="seAmt" inputmode="decimal" placeholder="0">
      </div>
      <div class="small text-secondary mt-1" id="seEq"></div>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">${kind==="Ahorro"?"Cuenta origen":"Cuenta destino"}</label>
      <select class="form-select" id="seA"><option value="">(Seleccione)</option>${accOpts}</select>
      <div class="small text-secondary mt-1" id="seBalLine"></div>
    </div>
    <div class="col-12 col-md-6"><label class="form-label">Categoría (requerida)</label><select class="form-select" id="seC"><option value="">(Seleccione)</option>${catOpts}</select></div>

    <div class="col-12">
      <label class="form-label">Descripción (opcional)</label>
      <input class="form-control" id="seDesc" maxlength="200" placeholder="Detalle / nota...">
    </div>

    <div class="col-12 col-md-6" id="seRateW">
      <label class="form-label" id="seRateLbl">Tipo de cambio</label>
      <input class="form-control" id="seRate" inputmode="decimal" placeholder="Ej: 520">
      <div class="small text-secondary mt-1">Se guarda en la transferencia del sistema.</div>
    </div>
</div>`;
  const footer=`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="seSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:kind==="Ahorro"?"Nuevo ahorro":"Retirar ahorro",body,footer});
  // ordenar combos
  sortSelectOptions("#seA",true);
  sortSelectOptions("#seC",true);
  if(preCat)$("#seC").value=preCat;
  // prefill para duplicar ahorros
  if(tplId){
    const t=state.movements.find(x=>x.id===tplId);
    if(t && t.type==='Ahorro'){
      try{$("#seA").value=t.accountId||"";}catch{}
      try{$("#seC").value=t.categoryId||$("#seC").value;}catch{}
      try{$("#seAmt").value=String(Number(t.amount)||0);}catch{}
            try{$("#seDesc").value=String(t.desc||"");}catch{}
      // fecha/periodo por defecto: hoy y mes actual
      try{$("#seD").value=todayISO();}catch{}
      try{$("#seP").value=todayMonth();}catch{}
    }
  }

  const recalc=()=>{
    const acc=$("#seA").value||null;
    const accC=acc?accCur(acc):base;
    const balNow=balances();
    const accBal = acc ? (balNow.get(acc)||0) : 0;

    // Mostrar saldo de cuenta seleccionada (solo visible cuando hay cuenta)
    const badge=$("#seBalBadge");
    const line=$("#seBalLine");
    if(acc){
      const txt = kind==="Ahorro" ? `Saldo disponible: <b>${fmtMoney(accBal,accC)}</b>` : `Saldo cuenta: <b>${fmtMoney(accBal,accC)}</b>`;
      badge.classList.remove("d-none");
      badge.innerHTML = `Cuenta ${kind==="Ahorro"?"origen":"destino"}: <b>${esc(accC)}</b> • ${txt}`;
      line.innerHTML = txt;
    }else{
      badge.classList.add("d-none");
      badge.innerHTML="";
      line.innerHTML="";
    }

    const needsFx = (acc && accC!==base); // ahorro: origen, retiro: destino (ambos pueden no ser base)
    $("#seRateW").style.display = needsFx ? "" : "none";
    $("#seCur").textContent = accC;
    $("#seRateLbl").textContent = `Tipo de cambio a ${base} (1 ${accC} = ? ${base})`;

    const rateEl=$("#seRate");
    if(needsFx){
      const def=fxRateAt(accC,$("#seD").value||"");
      const curLast=rateEl.dataset.cur||"";
      const curNow=accC||"";
      const curChanged = curLast!==curNow;
      const curVal=parseAmount(rateEl.value||"");
      if(curChanged){
        if(def) rateEl.value=String(def);
        rateEl.dataset.cur=curNow;
      }else{
        if((!rateEl.value || curVal===1) && def) rateEl.value=String(def);
      }
    }else{
      rateEl.value="1";
      rateEl.dataset.cur=base;
    }
const amt=parseAmount($("#seAmt").value);
    const r=parseAmount($("#seRate").value||"1");

    if(!(Number.isFinite(amt)&&amt>0)) { $("#seEq").innerHTML=""; return; }
    if(needsFx && !(Number.isFinite(r)&&r>0)){ $("#seEq").innerHTML=`<span class="text-warning">Defina un tipo de cambio válido.</span>`; return; }

    const baseAmt=needsFx ? toBase(amt,accC,r) : amt;
    $("#seEq").innerHTML = needsFx ? `Equivalente en ${base}: <b>${fmtMoney(baseAmt,base)}</b>` : "";
};

  ["change","keyup"].forEach(ev=>{
    $("#seA").addEventListener(ev,recalc);
    $("#seAmt").addEventListener(ev,recalc);
    $("#seRate").addEventListener(ev,recalc);
  });
  recalc();

  $("#seSave").addEventListener("click",()=>{
        const btn=$("#seSave"); if(btn) btn.disabled=true;
    const date=$("#seD").value,period=$("#seP").value,acc=$("#seA").value,cat=$("#seC").value;
        const desc = (($("#seDesc")?.value)||"").trim();
    let amt=parseAmount($("#seAmt").value);

    if(!date||!period){msg({title:"Validación",kind:"warning",body:"<b>Fecha</b> y <b>Periodo</b> son requeridos."});return}
    if(!acc){msg({title:"Validación",kind:"warning",body:"Seleccione una <b>Cuenta</b>."});return}
    if(!cat){msg({title:"Validación",kind:"warning",body:"La <b>Categoría</b> es requerida en Ahorros."});return}
    if(!Number.isFinite(amt)||amt<=0){msg({title:"Validación",kind:"warning",body:"El <b>Monto</b> debe ser > 0."});return}

    const base=baseCur();
    const balNow=balances();
    const cur=accCur(acc)||base;
    const savId = (cur==="USD") ? state.config.savingsAccountIdUSD : state.config.savingsAccountId;
    if(!savId){msg({title:"Configuración",kind:"warning",body:"Falta configurar las cuentas <b>Ahorros (SGF)</b>."});return}
    const savCur=accCur(savId)||cur;
    if(savCur!==cur){
      msg({title:"Configuración",kind:"warning",body:`La cuenta <b>Ahorros (SGF)</b> para ${esc(cur)} no está en esa moneda. Revisa Configuración.`});
      return;
    }

    const needsFx = cur!==base;
    const rate = needsFx ? parseAmount($("#seRate").value) : 1;
    if(needsFx && !(Number.isFinite(rate)&&rate>0)){msg({title:"Validación",kind:"warning",body:`Tipo de cambio inválido para <b>${esc(cur)}</b>.`});return}
    const baseAmt = needsFx ? roundMoney(toBase(amt,cur,rate), base) : roundMoney(amt, base);

    if(kind==="Ahorro"){
      const available=roundMoney(balNow.get(acc)||0,cur);
      if(!canGoNegative(acc) && roundMoney(amt,cur)>available){msg({title:"Saldo insuficiente",kind:"danger",body:`Disponible: <b>${fmtMoney(available,cur)}</b>.`});return}

      const logical=uuid(),transfer=uuid();
      state.movements.push({
        id:logical,date,period,type:"Ahorro",
        accountId:acc,accountToId:savId,categoryId:cat,
        amount:roundMoney(amt,cur),currency:cur,rateToBase:needsFx?rate:1,amountBase:roundMoney(baseAmt,base),
        desc:desc,isSystem:false,linkedTransferId:transfer
      });
      state.movements.push({
        id:transfer,date,period,type:"Transferencia",
        accountId:acc,accountToId:savId,categoryId:cat,
        amount:roundMoney(amt,cur),currency:cur,rateToBase:needsFx?rate:1,amountBase:roundMoney(baseAmt,base),
        currencyTo:cur,rateToBaseTo:needsFx?rate:1,amountTo:roundMoney(amt,cur),
        desc:`(Sistema) Transferencia por Ahorro • ${catPath(cat)||"—"}${desc?` • ${desc}`:''}`,isSystem:true,linkedTo:logical
      });
    }else{
      const available=roundMoney(balNow.get(savId)||0,cur);
      if(roundMoney(amt,cur)>available){msg({title:"Saldo insuficiente",kind:"danger",body:`En Ahorros (SGF) ${esc(cur)}: <b>${fmtMoney(available,cur)}</b>.`});return}

      const logical=uuid(),transfer=uuid();
      state.movements.push({
        id:logical,date,period,type:"RetiroAhorro",
        accountId:savId,accountToId:acc,categoryId:cat,
        amount:roundMoney(amt,cur),currency:cur,rateToBase:needsFx?rate:1,amountBase:roundMoney(baseAmt,base),
        desc:desc,isSystem:false,linkedTransferId:transfer
      });
      state.movements.push({
        id:transfer,date,period,type:"Transferencia",
        accountId:savId,accountToId:acc,categoryId:cat,
        amount:roundMoney(amt,cur),currency:cur,rateToBase:needsFx?rate:1,amountBase:roundMoney(baseAmt,base),
        currencyTo:cur,rateToBaseTo:needsFx?rate:1,amountTo:roundMoney(amt,cur),
        desc:`(Sistema) Transferencia por RetiroAhorro • ${catPath(cat)||"—"}${desc?` • ${desc}`:''}`,isSystem:true,linkedTo:logical
      });
    }

    logEvent("create","savings",null,`${kind} ${fmtMoney(amt,cur)} • ${catPath(cat)||""}`);
    save();closeEditor();toast(kind==="Ahorro"?"Ahorro registrado.":"Retiro registrado.","success");renderSavings();
  });
}

function savCatEdit(id){
  const m=state.movements.find(x=>x.id===id);
  if(!m || !["Ahorro","RetiroAhorro"].includes(m.type)){
    msg({title:"Edición",kind:"warning",body:"Solo se permite editar la categoría de movimientos de <b>Ahorro</b> / <b>Retiro</b>."});
    return;
  }
  const catOpts=state.categories.filter(c=>c.active).map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");
  const body=`<div class="alert alert-dark border-0" style="background:rgba(0,0,0,.04)">
    <div class="fw-bold">Editar categoría del ${m.type==="Ahorro"?"Ahorro":"Retiro"}</div>
    <div class="small text-secondary">Esto actualizará también la <b>Transferencia del sistema</b> asociada para que reportes y movimientos queden consistentes.</div>
  </div>
  <div class="row g-3 sgf-land-stack">
    <div class="col-12 col-md-4"><label class="form-label">Fecha</label><input type="date" class="form-control" value="${esc(m.date||"")}" disabled></div>
    <div class="col-12 col-md-4"><label class="form-label">Periodo</label><input type="month" class="form-control" value="${esc(m.period||"")}" disabled></div>
    <div class="col-12 col-md-4"><label class="form-label">Monto</label><input class="form-control" value="${fmtMoney(Number(m.amount)||0, baseCur())}" disabled></div>
    <div class="col-12">
      <label class="form-label">Categoría</label>
      <select class="form-select" id="scC"><option value="">(Seleccione)</option>${catOpts}</select>
    </div>
    <div class="col-12">
      <label class="form-label">Descripción (opcional)</label>
      <input class="form-control" id="scDesc" maxlength="200" placeholder="Detalle / nota...">
    </div>
</div>`;
  const footer=`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="scSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:"Editar categoría",body,footer});
  sortSelectOptions("#scC",true);
  $("#scC").value=m.categoryId||"";
  try{$("#scDesc").value=String(m.desc||"");}catch{}

  $("#scSave").addEventListener("click",()=>{
    const cat=$("#scC").value||"";
    const desc = (($("#scDesc")?.value)||"").trim();
    if(!cat){msg({title:"Validación",kind:"warning",body:"Seleccione una <b>Categoría</b>."});return;}
    m.categoryId = cat;
    m.desc = desc;

    // sincronizar transferencia del sistema vinculada
    const tId = m.linkedTransferId || null;
    let t = tId ? state.movements.find(x=>x.id===tId) : null;
    if(!t && m.id) t = state.movements.find(x=>x.linkedTo===m.id);
    if(t){
      t.categoryId = cat;
      const p = catPath(cat)||"—";
      if(t.type==="Transferencia" && t.isSystem){
        t.desc = `(Sistema) Transferencia por ${m.type} • ${p}${desc ? ' • ' + desc : ''}`;
      }
    }

    save(); closeEditor(); toast("Categoría actualizada.","success");
    renderSavings();
    // por si el usuario está en movimientos/reportes
    try{ renderReports(); }catch{}
    try{ renderDashboard(); }catch{}
  });
}

function savDuplicate(id){
  const m=state.movements.find(x=>x.id===id);
  if(!m || m.type!=="Ahorro"){msg({title:"Duplicar",kind:"warning",body:"Solo se puede duplicar un <b>Ahorro</b>."});return;}
  // abre el modal de nuevo ahorro con datos prellenados (monto/cuenta/categoría)
  savEdit("Ahorro", m.categoryId||null, m.id);
}



/* Budgets (con barras de progreso) */
/* Helpers — Split de gastos (v1_04) */
function movementHasSplit(m){
  return !!(m && m.type==="Gasto" && Array.isArray(m.splits) && m.splits.length>0);
}
function movementCatKey(m){
  if(!m) return "";
  if(movementHasSplit(m)){
    return (m.splits||[]).map(s=>s?.categoryId? (catPath(s.categoryId)||"") : "").filter(Boolean).sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"})).join(" | ");
  }
  return m.categoryId ? (catPath(m.categoryId)||"") : "";
}
function splitLabelShort(m){
  if(!movementHasSplit(m)) return (m?.categoryId ? (catPath(m.categoryId)||"") : "");
  const names=(m.splits||[]).map(s=>s?.categoryId? (catPath(s.categoryId)||"") : "").filter(Boolean);
  const uniq=[...new Set(names)];
  if(!uniq.length) return "Split";
  const first=uniq.slice(0,2).join(", ");
  const more=uniq.length>2?` (+${uniq.length-2})`:"";
  return `Split: ${first}${more}`;
}
function normalizeSplits(lines, totalAmt, fromCur, rateFrom){
  const clean=(lines||[]).map(x=>({
    id: x?.id || uuid(),
    categoryId: x?.categoryId || null,
    amount: roundMoney(parseAmount(String(x?.amount??"")), fromCur),
    desc: String(x?.desc||"").trim(),
  })).filter(x=>x.categoryId && Number.isFinite(Number(x.amount)) && Number(x.amount)>0);

  const sum = clean.reduce((s,x)=>s+(Number(x.amount)||0),0);
  const diff = roundMoney((Number(totalAmt)||0) - sum, fromCur);
  if(clean.length && Math.abs(diff)>0 && Math.abs(diff)<=0.05){
    clean[clean.length-1].amount = roundMoney((Number(clean.at(-1).amount)||0)+diff, fromCur);
  }
  const base=baseCur();
  let sumBase=0;
  for(const x of clean){
    x.amountBase = roundMoney(toBase(Number(x.amount)||0, fromCur, rateFrom||1), base);
    sumBase += Number(x.amountBase)||0;
  }
  const totalBase = roundMoney(toBase(Number(totalAmt)||0, fromCur, rateFrom||1), base);
  const diffB = roundMoney(totalBase - sumBase, base);
  if(clean.length && Math.abs(diffB)>0 && Math.abs(diffB)<=0.05){
    clean[clean.length-1].amountBase = roundMoney((Number(clean.at(-1).amountBase)||0)+diffB, base);
  }
  return clean;
}
function catUsageCount(id){
  if(!id) return 0;
  let n=0;
  for(const m of (state.movements||[])){
    if(!m) continue;
    if(m.categoryId===id) n++;
    if(movementHasSplit(m) && (m.splits||[]).some(s=>s && s.categoryId===id)) n++;
  }
  for(const b of (state.budgets||[])){
    if(!b) continue;
    if(b.categoryId===id || b.catId===id) n++;
    const items=b.items||b.lines||b.rows;
    if(Array.isArray(items)) for(const it of items){ if(it && (it.categoryId===id || it.catId===id)) n++; }
  }
  for(const r of (state.recurrings||[])){
    if(r && r.categoryId===id) n++;
  }
  return n;
}

function actualByCat(period,type){
  const m=new Map();
  for(const x of (state.movements||[])){
    if(!x) continue;
    if(x.period!==period) continue;

    if(type==="Ingreso"){
      if(x.type!=="Ingreso") continue;
      if(!x.categoryId) continue;
      const v=Number(x.amountBase!=null?x.amountBase:x.amount)||0;
      m.set(x.categoryId,(m.get(x.categoryId)||0)+v);
      continue;
    }

    if(type==="Gasto"){
      if(x.type!=="Gasto") continue;
      const fromCur=accCur(x.accountId);
      const b=baseCur();
      const rateFrom = (fromCur!==b) ? (Number(x.rateToBase)||fxRateAt(fromCur,x.date||"")||fxRate(fromCur)||NaN) : 1;

      if(movementHasSplit(x)){
        for(const s of (x.splits||[])){
          if(!s || !s.categoryId) continue;
          const v = Number(s.amountBase!=null ? s.amountBase : roundMoney(toBase(Number(s.amount)||0,fromCur,rateFrom), b)) || 0;
          m.set(s.categoryId,(m.get(s.categoryId)||0)+v);
        }
      }else if(x.categoryId){
        const v=Number(x.amountBase!=null?x.amountBase:x.amount)||0;
        m.set(x.categoryId,(m.get(x.categoryId)||0)+v);
      }
      continue;
    }
  }
  return m;
}

function budgetApplies(b, period){
  if(!period) return true;
  if(b && b.isRecurring){
    const from = b.periodFrom || "";
    const to = b.periodTo || "";
    if(!from) return false;
    if(period < from) return false;
    if(to && period > to) return false;
    return true;
  }
  return (b.period === period);
}
function effectiveBudgets(period, typeFilter=null){
  // Regla: si existe presupuesto específico para (periodo,tipo,categoría) => domina sobre el recurrente.
  const cand = state.budgets
    .filter(b => !typeFilter || b.type === typeFilter)
    .filter(b => budgetApplies(b, period))
    .filter(b => (b.isRecurring ? true : b.period === period)); // específicos solo si coincide exacto
  const byKey = new Map();
  for(const b of cand){
    const k = `${b.type}|${b.categoryId}`;
    const prev = byKey.get(k);
    if(!prev){ byKey.set(k, b); continue; }
    // prefer specific over recurring
    if(prev.isRecurring && !b.isRecurring) byKey.set(k, b);
  }
  return [...byKey.values()];
}
function renderBudgets(){
  const cats=state.categories.filter(c=>c.active).slice()
    .sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));

  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros</div>
          <div class="small text-secondary">Selecciona un periodo para ver el real y la barra.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-dark" onclick="budApply()"><i class="bi bi-funnel"></i> Aplicar</button>
          <button class="btn btn-sm btn-outline-dark" onclick="budClear()"><i class="bi bi-x-circle"></i> Limpiar</button>
        </div>
      </div>
      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-3">
          <label class="form-label">Periodo</label>
          <input type="month" class="form-control" id="bP" value="${esc(state.ui.bP||"")}">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="bT"><option value="">(Todos)</option><option>Gasto</option><option>Ingreso</option></select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Categoría</label>
          <select class="form-select" id="bC"><option value="">(Todas)</option>${cats.map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("")}</select>
          <div class="small text-secondary mt-1">Incluye subcategorías.</div>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Texto</label>
          <input class="form-control" id="bQ" placeholder="Buscar..." value="${esc(state.ui.bQ||"")}">
        </div>
      </div>
    </div>
</div>`;

  const body=`${filters}<div id="budHost"></div>`;

  $("#v-budgets").innerHTML=card("Presupuesto",
    `<button class="btn btn-dark" onclick="budEdit()"><i class="bi bi-plus"></i> Nuevo</button>
     <button class="btn btn-outline-dark" onclick="help('budgets')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#bT").value=state.ui.bT||"";
  $("#bC").value=state.ui.bC||"";

  // auto-aplicar filtros
  $("#bP").onchange=()=>budApply();
  $("#bT").onchange=()=>budApply();
  $("#bC").onchange=()=>budApply();
  $("#bQ").oninput=()=>debounce("budQ", ()=>budApply(), 260);

  budList();
}

function budApply(){state.ui.bP=$("#bP").value||"";state.ui.bT=$("#bT").value||"";state.ui.bC=$("#bC").value||"";state.ui.bQ=$("#bQ").value||"";state.ui.budP=1;budList()}
function budClear(){state.ui.bP="";state.ui.bT="";state.ui.bC="";state.ui.bQ="";state.ui.budP=1;$("#bP").value="";$("#bT").value="";$("#bC").value="";$("#bQ").value="";budList()}
function budList(){
  const period=state.ui.bP||null,type=state.ui.bT||null,cat=state.ui.bC||null,q=(state.ui.bQ||"").trim().toLowerCase();

  let list = period
    ? effectiveBudgets(period, type)
    : state.budgets.filter(b=>!type||b.type===type);

  if(cat) list = list.filter(b=>catOrDesc(b.categoryId,cat));
  if(q) list = list.filter(b=>{const c=String(catPath(b.categoryId)||"").toLowerCase();const d=String(b.desc||"").toLowerCase();return c.includes(q)||d.includes(q);});

  const act = period ? {Gasto:actualByCat(period,"Gasto"),Ingreso:actualByCat(period,"Ingreso")} : null;

  const so=getSort("bud","category","asc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  const withCalc = list.map(b=>{
    const actual=period?( (b.type==="Gasto"?act.Gasto:act.Ingreso).get(b.categoryId)||0 ):0;
    const pct=b.amount>0?clamp((actual/b.amount)*100,0,999):0;
    return {b, actual, pct};
  }).sort((A,B)=>{
    const av = key==="period" ? (A.b.isRecurring ? (A.b.periodFrom||"") : (A.b.period||""))
      : key==="type" ? A.b.type
      : key==="category" ? (catPath(A.b.categoryId)||"")
      : key==="desc" ? (A.b.desc||"")
      : key==="amount" ? Number(A.b.amount||0)
      : key==="actual" ? Number(A.actual||0)
      : key==="pct" ? Number(A.pct||0)
      : (catPath(A.b.categoryId)||"");
    const bv = key==="period" ? (B.b.isRecurring ? (B.b.periodFrom||"") : (B.b.period||""))
      : key==="type" ? B.b.type
      : key==="category" ? (catPath(B.b.categoryId)||"")
      : key==="desc" ? (B.b.desc||"")
      : key==="amount" ? Number(B.b.amount||0)
      : key==="actual" ? Number(B.actual||0)
      : key==="pct" ? Number(B.pct||0)
      : (catPath(B.b.categoryId)||"");
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv));
    return c*mult;
  });

  const sumBudgetAll = withCalc.reduce((s,x)=>s+Number(x.b.amount||0),0);
  const sumActualAll = period ? withCalc.reduce((s,x)=>s+Number(x.actual||0),0) : 0;
  const pctAll = (period && sumBudgetAll>0) ? clamp((sumActualAll/sumBudgetAll)*100,0,999) : 0;

  const sumBudgetIn = withCalc.filter(x=>x.b.type==="Ingreso").reduce((s,x)=>s+Number(x.b.amount||0),0);
  const sumBudgetOut = withCalc.filter(x=>x.b.type==="Gasto").reduce((s,x)=>s+Number(x.b.amount||0),0);
  const sumActualIn = period ? withCalc.filter(x=>x.b.type==="Ingreso").reduce((s,x)=>s+Number(x.actual||0),0) : 0;
  const sumActualOut = period ? withCalc.filter(x=>x.b.type==="Gasto").reduce((s,x)=>s+Number(x.actual||0),0) : 0;

  // Paginación (mejor rendimiento con muchos presupuestos)
  const pageSize = Number(state.ui.budPS||100);
  const totalPages = Math.max(1, Math.ceil(withCalc.length / pageSize));
  let page = Number(state.ui.budP||1);
  if(page>totalPages) page=totalPages;
  if(page<1) page=1;
  state.ui.budP=page;

  const start = (page-1)*pageSize;
  const end = start + pageSize;
  const pageCalc = withCalc.slice(start, end);
  const showFrom = withCalc.length ? (start+1) : 0;
  const showTo = Math.min(end, withCalc.length);

  const disPrev = page<=1 ? "disabled" : "";
  const disNext = page>=totalPages ? "disabled" : "";
  const pager = `<div class="d-flex align-items-center gap-1 sgf-pager">
      <button class="btn btn-sm btn-outline-dark" ${disPrev} onclick="budSetPage(1)"><i class="bi bi-chevron-bar-left"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disPrev} onclick="budSetPage(${page-1})"><i class="bi bi-chevron-left"></i></button>
      <span class="small text-secondary px-2">Página <b>${page}</b> / ${totalPages}</span>
      <button class="btn btn-sm btn-outline-dark" ${disNext} onclick="budSetPage(${page+1})"><i class="bi bi-chevron-right"></i></button>
      <button class="btn btn-sm btn-outline-dark" ${disNext} onclick="budSetPage(${totalPages})"><i class="bi bi-chevron-bar-right"></i></button>
    </div>`;
  const psSel = `<select class="form-select form-select-sm" style="width:auto" onchange="budSetPageSize(this.value)">
      ${[50,100,200].map(n=>`<option value="${n}" ${n===pageSize?"selected":""}>${n}/pág</option>`).join("")}
    </select>`;

  const rows=pageCalc.map(({b,actual,pct})=>{
    const cls=b.type==="Gasto"?(pct>=100?"bg-danger":pct>=85?"bg-warning":"bg-primary"):(pct>=100?"bg-success":"bg-primary");
    const perLbl = b.isRecurring
      ? `<span class="badge text-bg-dark rounded-pill">Recurrente</span> <span class="text-secondary small">desde ${esc(monthLabel(b.periodFrom||""))}${b.periodTo?` hasta ${esc(monthLabel(b.periodTo))}`:""}</span>`
      : `<span class="text-secondary small">${esc(monthLabel(b.period||""))}</span>`;

    return `<tr>
      <td>
        <div class="fw-semibold">${period ? esc(monthLabel(period)) : (b.isRecurring ? "Mensual (Recurrente)" : esc(monthLabel(b.period||"")))}</div>
        <div class="small text-secondary">${esc(b.type)} • ${perLbl}</div>
      </td>
      <td><div class="d-flex gap-2 align-items-center"><span class="dot" style="background:${catColor(b.categoryId)}"></span><span class="fw-semibold">${esc(catPath(b.categoryId))}</span></div></td>
      <td class="td-desc">
        <div class="text-truncate" style="max-width:260px" title="${esc(b.desc||"")}">${b.desc?esc(b.desc):"<span class='text-secondary'>—</span>"}</div>
      </td>
      <td class="text-end fw-bold">${fmtMoney(b.amount)}</td>
      <td class="text-end">${period?fmtMoney(actual):`<span class="text-secondary">Seleccione periodo</span>`}</td>
      <td style="width:260px">${period?`<div class="progress"><div class="progress-bar ${cls}" style="width:${clamp(pct,0,100)}%"></div></div><div class="small text-secondary mt-1">${pct.toFixed(0)}%</div>`:"—"}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" onclick="budEdit('${b.id}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-secondary" onclick="budDup('${b.id}')" title="Duplicar"><i class="bi bi-files"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="budDel('${b.id}')"><i class="bi bi-trash"></i></button>
      </td>
    </tr>`;
  }).join("");

  const foot = withCalc.length ? `<tfoot><tr class="table-light">
      <td class="text-end fw-semibold">Totales</td>
      <td></td>
      <td></td>
      <td class="text-end fw-bold">${fmtMoney(sumBudgetAll)}</td>
      <td class="text-end">${period?`<span class="fw-bold">${fmtMoney(sumActualAll)}</span>`:`<span class="text-secondary">—</span>`}</td>
      <td>${period?`<div class="progress"><div class="progress-bar bg-primary" style="width:${clamp(pctAll,0,100)}%"></div></div><div class="small text-secondary mt-1">${pctAll.toFixed(0)}%</div>`:"—"}</td>
      <td></td>
    </tr></tfoot>` : ``;

  const breakdown = (!type && withCalc.length) ? `<div class="small text-secondary mt-2">
    <b>Ingreso</b> Pres: ${fmtMoney(sumBudgetIn)}${period?` • Real: ${fmtMoney(sumActualIn)}`:""} |
    <b>Gasto</b> Pres: ${fmtMoney(sumBudgetOut)}${period?` • Real: ${fmtMoney(sumActualOut)}`:""} |
    <b>Neto</b>${period?` Real: ${fmtMoney(sumActualIn-sumActualOut)}`:` Pres: ${fmtMoney(sumBudgetIn-sumBudgetOut)}`}
  </div>` : `<div class="small text-secondary mt-2"><b>Recurrente:</b> un presupuesto puede aplicar a todos los meses (mensual). Puedes crear un presupuesto específico por mes para sobrescribirlo.</div>`;

  $("#budHost").innerHTML=`<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <div class="fw-bold">Presupuestos</div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="small text-secondary">Mostrando ${showFrom}-${showTo} de ${withCalc.length} ${period?`(efectivos)`:"(definiciones)"}</div>
        ${psSel}
        ${pager}
      </div>
    </div>
    <div class="table-responsive sgf-table-scroll sgf-table-sticky">
      <table class="table table-hover align-middle" id="tblBud">
        <thead><tr>
          <th class="th-sort" onclick="toggleSort('bud','period',()=>{state.ui.budP=1;budList()})">Periodo/Tipo ${sortIcon('bud','period')}</th>
          <th class="th-sort" onclick="toggleSort('bud','category',()=>{state.ui.budP=1;budList()})">Categoría ${sortIcon('bud','category')}</th>
          <th class="th-sort" onclick="toggleSort('bud','desc',()=>{state.ui.budP=1;budList()})">Descripción ${sortIcon('bud','desc')}</th>
          <th class="text-end th-sort" onclick="toggleSort('bud','amount',()=>{state.ui.budP=1;budList()})">Presupuesto ${sortIcon('bud','amount')}</th>
          <th class="text-end th-sort" onclick="toggleSort('bud','actual',()=>{state.ui.budP=1;budList()})">Real ${sortIcon('bud','actual')}</th>
          <th class="th-sort" onclick="toggleSort('bud','pct',()=>{state.ui.budP=1;budList()})">Progreso ${sortIcon('bud','pct')}</th>
          <th class="text-end">Acciones</th>
        </tr></thead>
        <tbody>${rows||`<tr><td colspan="7" class="text-secondary">No hay presupuestos.</td></tr>`}</tbody>
        ${foot}
      </table>
    </div>
    ${breakdown}
  </div></div>`;
}
function budEdit(editId=null, dupFromId=null){
  const isEdit=!!editId;const src=(!isEdit&&dupFromId)?state.budgets.find(x=>x.id===dupFromId):null;const b=isEdit?state.budgets.find(x=>x.id===editId):(src?{...src}:null);if(isEdit&&!b)return;
  const cats=state.categories.filter(c=>c.active).slice().sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));
  const catOpts=cats.map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");
  const now=new Date();const p=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

  const isRec = !!b?.isRecurring;
  const body=`<div class="row g-3">
    <div class="col-12">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="beR" ${isRec?"checked":""}>
        <label class="form-check-label fw-semibold" for="beR">Presupuesto recurrente mensual (sirve para todos los meses)</label>
      </div>
      <div class="small text-secondary">Ej: “Luz ₡25.000” mensual. Si creas uno específico en un mes, ese mes <b>sobrescribe</b> el recurrente.</div>
    </div>

    <div class="col-12 col-md-4" id="bePWrap">
      <label class="form-label">Periodo (solo este mes)</label>
      <input type="month" class="form-control" id="beP" value="${esc(b?.period||p)}">
    </div>

    <div class="col-12 col-md-4 d-none" id="beFromWrap">
      <label class="form-label">Desde (inicio)</label>
      <input type="month" class="form-control" id="beFrom" value="${esc(b?.periodFrom||p)}">
    </div>
    <div class="col-12 col-md-4 d-none" id="beToWrap">
      <label class="form-label">Hasta (opcional)</label>
      <input type="month" class="form-control" id="beTo" value="${esc(b?.periodTo||"")}">
      <div class="small text-secondary mt-1">Vacío = sin fin.</div>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Tipo</label>
      <select class="form-select" id="beT"><option>Gasto</option><option>Ingreso</option></select>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Monto</label>
      <input class="form-control" id="beA" inputmode="decimal" value="${b?String(b.amount):""}" placeholder="0">
    </div>

    <div class="col-12">
      <label class="form-label">Categoría</label>
      <select class="form-select" id="beC"><option value="">(Seleccione)</option>${catOpts}</select>
    </div>

    <div class="col-12">
      <label class="form-label">Descripción</label>
      <input class="form-control" id="beD" value="${esc(b?.desc||"")}" placeholder="Opcional (ej: Luz hogar, Plan anual, etc.)">
    </div>    

  </div>`;

  const footer=`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cancelar</button>
    <button class="btn btn-dark" id="beSave"><i class="bi bi-check2"></i> Guardar</button>`;
  editor({title:isEdit?"Editar presupuesto":"Nuevo presupuesto",body,footer});
  // ordenar combos
  sortSelectOptions('#beC',true);
  sortSelectOptions('#beT',false);

  $("#beT").value=b?.type||"Gasto";$("#beC").value=b?.categoryId||"";

  function syncRec(){
    const r=$("#beR").checked;
    $("#bePWrap").classList.toggle("d-none", r);
    $("#beFromWrap").classList.toggle("d-none", !r);
    $("#beToWrap").classList.toggle("d-none", !r);
  }
  $("#beR").addEventListener("change", syncRec);
  syncRec();

  $("#beSave").addEventListener("click",()=>{
    const btn=$("#beSave"); if(btn) btn.disabled=false;
    const isRecurring=$("#beR").checked;
    const type=$("#beT").value,cat=$("#beC").value,amt=parseAmount($("#beA").value);
    const desc=String($("#beD").value||"").trim();

    if(!cat){if(btn) btn.disabled=false;
    msg({title:"Validación",kind:"warning",body:"La <b>Categoría</b> es requerida."});return}
    if(!Number.isFinite(amt)||amt<=0){msg({title:"Validación",kind:"warning",body:"El <b>Monto</b> debe ser > 0."});return}

    let period="", periodFrom="", periodTo="";
    if(isRecurring){
      periodFrom=$("#beFrom").value;
      periodTo=$("#beTo").value||"";
      if(!periodFrom){msg({title:"Validación",kind:"warning",body:"El <b>Desde</b> es requerido para recurrentes."});return}
      if(periodTo && periodTo < periodFrom){msg({title:"Validación",kind:"warning",body:"<b>Hasta</b> no puede ser menor que <b>Desde</b>."});return}

      const dup = state.budgets.find(x=>x.id!==editId && !!x.isRecurring && x.type===type && x.categoryId===cat);
      if(dup){msg({title:"Validación",kind:"warning",body:"Ya existe un presupuesto <b>recurrente</b> para ese tipo/categoría. Edita el existente."});return}
    }else{
      period=$("#beP").value;
      if(!period){msg({title:"Validación",kind:"warning",body:"El <b>Periodo</b> es requerido."});return}
      const dup=state.budgets.find(x=>x.id!==editId && !x.isRecurring && x.period===period && x.type===type && x.categoryId===cat);
      if(dup){msg({title:"Validación",kind:"warning",body:"Ya existe un presupuesto específico para ese periodo/tipo/categoría."});return}
    }

    if(!isEdit){
      state.budgets.push({id:uuid(),period,isRecurring,periodFrom:isRecurring?periodFrom:"",periodTo:isRecurring?periodTo:"",type,categoryId:cat,amount:amt,desc});
    }else{
      b.period=period;
      b.isRecurring=isRecurring;
      b.periodFrom=isRecurring?periodFrom:"";
      b.periodTo=isRecurring?periodTo:"";
      b.type=type;b.categoryId=cat;b.amount=amt;b.desc=desc;
    }

    save();closeEditor();toast("Presupuesto guardado.","success");renderBudgets();
  });
}

function budDup(id){ const b=state.budgets.find(x=>x.id===id); if(!b){msg({title:"Duplicar",kind:"warning",body:"Presupuesto no encontrado."});return} budEdit(null,id); }

function budDel(id){
  const b=state.budgets.find(x=>x.id===id);if(!b)return;
  msg({title:"Eliminar presupuesto",kind:"warning",body:`Se eliminará el presupuesto de <b>${esc(catPath(b.categoryId))}</b> para <b>${esc(monthLabel(b.period))}</b>.
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="budDelOk('${id}')"><i class="bi bi-trash"></i> Sí, eliminar</button></div>`});
}
function budDelOk(id){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  const b=state.budgets.find(x=>x.id===id);
  state.budgets=state.budgets.filter(x=>x.id!==id);
  logEvent("delete","budget",id,catPath(b?.categoryId)||"");
  save();toast("Presupuesto eliminado.","success");renderBudgets();
}

/* Reports */
function renderReports(){
  const ys=years(),ms=months();
  const roots=state.categories.filter(c=>c.active && !c.parentId).slice()
    .sort((a,b)=>String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"}));
  const rootOpts=roots.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");

  const filters=`<div class="card sgf mb-3">
    <div class="card-body filters-bar sgf-filters-collapsed">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <div class="fw-bold">Filtros</div>
          <div class="small text-secondary">Usa <b>Pro</b> para el pivot (12 meses). <b>Cashflow</b> muestra flujo, y <b>Estado de cuenta</b> es por cuenta.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-dark" onclick="repApply()"><i class="bi bi-funnel"></i> Aplicar</button>
        </div>
      </div>

      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-2">
          <label class="form-label">Año</label>
          <select class="form-select" id="rY"><option value="">(Todo)</option>${ys.map(y=>`<option>${y}</option>`).join("")}</select>
          <div class="small text-secondary mt-1">Para Resumen/Detalle.</div>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Mes</label>
          <select class="form-select" id="rM"><option value="">(Actual / Todo)</option>${ms.map(p=>`<option value="${p}">${monthLabel(p)}</option>`).join("")}</select>
          <div class="small text-secondary mt-1">En Pro = mes final (12 meses).</div>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Vista</label>
          <select class="form-select" id="rV">
            <option value="pro">Pro (Pivot 12 meses)</option>
            <option value="cashflow">Cashflow (12 meses)</option>
            <option value="trend">Tendencias (12 meses)</option>
            <option value="statement">Estado de cuenta</option>
            <option value="budgetroot">Presupuesto vs Real (Raíz)</option>
            <option value="summary">Resumen</option>
            <option value="detail">Detalle</option>
            <option value="budget">Presupuesto (Categoría)</option>
            <option value="recon">Conciliación</option>
          </select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="rT">
            <option value="">(Todos)</option>
            <option>Ingreso</option>
            <option>Gasto</option>
            <option value="Ahorro">Ahorro</option>
            <option value="RetiroAhorro">Retiro</option>
          </select>
          <div class="small text-secondary mt-1">Aplica en Pro.</div>
        </div>
      </div>

      <div class="row g-2 mt-2 sgf-land-stack">
        <div class="col-12 col-md-6">
          <label class="form-label">Categoría raíz</label>
          <select class="form-select" id="rRoot"><option value="">(Todas)</option>${rootOpts}</select>
          <div class="small text-secondary mt-1">Aplica en Pro (incluye subcategorías).</div>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Texto</label>
          <input class="form-control" id="rQ" placeholder="Buscar en categorías o descripciones..." value="${esc(state.ui.rQ||"")}">
        </div>
      </div>
    </div>
</div>`;

  const body=`${filters}<div id="repHost"></div>`;

  $("#v-reports").innerHTML=card("Reportes",
    `<button class="btn btn-outline-dark" onclick="csvDialog()"><i class="bi bi-filetype-csv"></i> Exportar CSV</button>
     <button class="btn btn-outline-dark" onclick="help('reports')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );

  $("#rY").value=state.ui.rY||"";
  $("#rM").value=state.ui.rM||"";
  $("#rV").value=state.ui.rV||"pro";
  $("#rT").value=state.ui.rT||"";
  $("#rRoot").value=state.ui.rRoot||"";
  $("#rQ").value=state.ui.rQ||"";
  sortSelectOptions("#rRoot", true);

  // auto-aplicar filtros
  $("#rY").onchange=()=>repApply();
  $("#rM").onchange=()=>repApply();
  $("#rV").onchange=()=>repApply();
  $("#rT").onchange=()=>repApply();
  $("#rRoot").onchange=()=>repApply();
  $("#rQ").oninput=()=>debounce("repQ", ()=>repApply(), 260);

  repApply();
}

function repApply(){
  let y = $("#rY")?.value || "";
  let m = $("#rM")?.value || "";
  ({y,m} = normalizeYearMonthInput(y,m,{syncYearFromMonth:true}));

  y = ensureSelectHasValue("#rY", y);
  m = ensureSelectHasValue("#rM", m);

  if(m){
    const my = m.slice(0,4);
    if(!y || y!==my){
      y = ensureSelectHasValue("#rY", my) || my;
    }
  }

  if($("#rY")) $("#rY").value = y;
  if($("#rM")) $("#rM").value = m;

  state.ui.rY = y || "";
  state.ui.rM = m || "";
  state.ui.rV = $("#rV")?.value || "pro";
  state.ui.rT = $("#rT")?.value || "";
  state.ui.rRoot = $("#rRoot")?.value || "";
  state.ui.rQ = $("#rQ")?.value || "";

  // Tendencias (si existen controles)
  const trS=$("#trScope"); if(trS) state.ui.trScope=trS.value||"root";
  const trR=$("#trRoot"); if(trR) state.ui.trRoot=trR.value||"";
  const trC=$("#trCat");  if(trC) state.ui.trCat=trC.value||"";
  const trM=$("#trMetric"); if(trM) state.ui.trMetric=trM.value||"Gasto";

  repRender();
}

function repRender(){
  const y=state.ui.rY||null,m=state.ui.rM||null,v=state.ui.rV||"pro";
  $("#repHost").innerHTML=
    v==="pro"?repPro():
    v==="cashflow"?repCashflow():
    v==="trend"?repTrends():
    v==="statement"?repStatement():
    v==="budgetroot"?repBudgetRoot(y,m):
    v==="summary"?repSummary(y,m):
    v==="detail"?repDetail(y,m):
    v==="budget"?repBudget(y,m):
    v==="recon"?repRecon(y,m):
    repSummary(y,m);
}

function repProToggle(groupKey){
  state.ui.rHide = state.ui.rHide || {};
  state.ui.rHide[groupKey] = !state.ui.rHide[groupKey];
  repRender();
}

function repSummary(year,month){
  const period=month||null;
  const items=state.movements.filter(x=>["Ingreso","Gasto","Transferencia"].includes(x.type))
    .filter(x=>!year||(x.period||"").startsWith(String(year))).filter(x=>!period||x.period===period)
    .filter(x=>!x.isSystem && !x.isOpening);

  const accMap=new Map();
  const b=baseCur();

  for(const x of items){
    const acc=accPath(x.accountId)||"(Cuenta)";

    // Expande gastos con split por categoría
    const parts = [];
    if(x.type==="Gasto" && movementHasSplit(x)){
      const fromCur=accCur(x.accountId);
      const rate = (fromCur!==b) ? (Number(x.rateToBase)||fxRateAt(fromCur,x.date||"")||fxRate(fromCur)||NaN) : 1;
      for(const s of (x.splits||[])){
        if(!s || !s.categoryId) continue;
        const cat = catPath(s.categoryId)||"—";
        const a = Number(s.amountBase!=null ? s.amountBase : roundMoney(toBase(Number(s.amount)||0,fromCur,rate), b)) || 0;
        parts.push({cat,amount:a});
      }
      if(!parts.length){
        parts.push({cat:"—",amount:Number(x.amountBase!=null?x.amountBase:x.amount)||0});
      }
    }else{
      const cat=x.categoryId?catPath(x.categoryId):"—";
      const a=Number(x.amountBase!=null?x.amountBase:x.amount)||0;
      parts.push({cat,amount:a});
    }

    for(const p of parts){
      const k=`${acc}||${p.cat}`;
      const r=accMap.get(k)||{acc,cat:p.cat,in:0,out:0,tr:0};
      if(x.type==="Ingreso") r.in += p.amount;
      if(x.type==="Gasto") r.out += p.amount;
      if(x.type==="Transferencia") r.tr += p.amount;
      accMap.set(k,r);
    }
  }

  let rows=[...accMap.values()];

  const so=getSort("repSum","out","desc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  rows = rows.sort((a,b)=>{
    const av = key==="acc" ? a.acc
      : key==="cat" ? a.cat
      : key==="in" ? Number(a.in||0)
      : key==="out" ? Number(a.out||0)
      : key==="tr" ? Number(a.tr||0)
      : Number(a.out||0);
    const bv = key==="acc" ? b.acc
      : key==="cat" ? b.cat
      : key==="in" ? Number(b.in||0)
      : key==="out" ? Number(b.out||0)
      : key==="tr" ? Number(b.tr||0)
      : Number(b.out||0);
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
    return c*mult;
  });

  const base=b;
  const tr=rows.map(r=>`<tr>
    <td class="fw-semibold">${esc(r.acc)}</td>
    <td>${esc(r.cat)}</td>
    <td class="text-end">${fmtMoney(r.in,base)}</td>
    <td class="text-end">${fmtMoney(r.out,base)}</td>
    <td class="text-end">${fmtMoney(r.tr,base)}</td>
  </tr>`).join("");

  return `<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">Resumen por cuenta / ruta de categoría</div>
      <span class="text-secondary small">Montos en ${esc(base)} (convertidos)</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tblRepSum">
        <thead><tr>
          <th class="th-sort" onclick="toggleSort('repSum','acc',repRender)">Cuenta ${sortIcon('repSum','acc')}</th>
          <th class="th-sort" onclick="toggleSort('repSum','cat',repRender)">Categoría ${sortIcon('repSum','cat')}</th>
          <th class="text-end th-sort" onclick="toggleSort('repSum','in',repRender)">Ingresos ${sortIcon('repSum','in')}</th>
          <th class="text-end th-sort" onclick="toggleSort('repSum','out',repRender)">Gastos ${sortIcon('repSum','out')}</th>
          <th class="text-end th-sort" onclick="toggleSort('repSum','tr',repRender)">Transfer. ${sortIcon('repSum','tr')}</th>
        </tr></thead>
        <tbody>${tr||`<tr><td colspan="5" class="text-secondary">Sin datos.</td></tr>`}</tbody>
      </table>
    </div>
  </div></div>`;
}
function repDetail(year,month){
  const period=month||null;
  let items=state.movements.filter(x=>["Ingreso","Gasto","Transferencia"].includes(x.type))
    .filter(x=>!year||(x.period||"").startsWith(String(year))).filter(x=>!period||x.period===period)
    .filter(x=>!x.isSystem && !x.isOpening);

  const so=getSort("repDet","date","desc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  items = items.sort((a,b)=>{
    const av = key==="date" ? (a.date||"")
      : key==="type" ? (a.type||"")
      : key==="acc" ? (accPath(a.accountId)||"")
      : key==="cat" ? movementCatKey(a)
      : key==="amt" ? Number(a.amountBase!=null?a.amountBase:a.amount||0)
      : key==="desc" ? (a.desc||"")
      : (a.date||"");
    const bv = key==="date" ? (b.date||"")
      : key==="type" ? (b.type||"")
      : key==="acc" ? (accPath(b.accountId)||"")
      : key==="cat" ? movementCatKey(b)
      : key==="amt" ? Number(b.amountBase!=null?b.amountBase:b.amount||0)
      : key==="desc" ? (b.desc||"")
      : (b.date||"");
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
    if(c!==0) return c*mult;
    return String(b.date||"").localeCompare(String(a.date||""));
  });

  const base=baseCur();

  const tr=items.slice(0,800).map(x=>{
    const badge=x.type==="Ingreso"?"text-bg-success":x.type==="Gasto"?"text-bg-danger":"text-bg-primary";
    const fromCur=accCur(x.accountId);
    const isFx=(fromCur!==base);
    const baseAmt=Number(x.amountBase!=null?x.amountBase:x.amount)||0;

    const main= x.type!=="Transferencia"
      ? `<div class="fw-bold">${fmtMoney(Number(x.amount)||0,fromCur)}</div>${isFx?`<div class="small text-secondary">≈ ${fmtMoney(baseAmt,base)}</div>`:""}`
      : (()=>{
          const toCur=accCur(x.accountToId);
          const toAmt=Number(x.amountTo!=null?x.amountTo:Number(x.amount)||0);
          const isFx2=(fromCur!==toCur);
          return `<div class="fw-bold">${fmtMoney(Number(x.amount)||0,fromCur)} <span class="text-secondary">→</span> ${fmtMoney(toAmt,toCur)}</div>${isFx2?`<div class="small text-secondary">≈ ${fmtMoney(baseAmt,base)}</div>`:""}`;
        })();

    let catCell="—";
    if(movementHasSplit(x)){
      const dots=(x.splits||[]).slice(0,3).map(s=>s?.categoryId?`<span class="dot" style="background:${catColor(s.categoryId)}"></span>`:"").join("");
      const list=(x.splits||[]).slice(0,3).map(s=>{
        const nm=catPath(s.categoryId)||"";
        const am=fmtMoney(Number(s.amount)||0,fromCur);
        return `<div class="small text-secondary">${esc(nm)}: ${am}</div>`;
      }).join("");
      const more=((x.splits||[]).length>3)?`<div class="small text-secondary">… +${(x.splits||[]).length-3} más</div>`:"";
      catCell=`<div>
        <div class="d-flex gap-2 align-items-center">${dots}<span class="fw-semibold">Split (${(x.splits||[]).length})</span></div>
        ${list}${more}
      </div>`;
    }else if(x.categoryId){
      catCell=`<div class="d-flex gap-2 align-items-center"><span class="dot" style="background:${catColor(x.categoryId)}"></span><span>${esc(catPath(x.categoryId))}</span></div>`;
    }

    return `<tr>
      <td><div class="fw-semibold">${fmtDate(x.date)}</div><div class="small text-secondary">Periodo: ${esc(monthLabel(x.period))}</div></td>
      <td><span class="badge ${badge} rounded-pill">${x.type}</span></td>
      <td><div class="fw-semibold">${esc(accPath(x.accountId)||"(Cuenta)")}</div>${x.type==="Transferencia"?`<div class="small text-secondary">→ ${esc(accPath(x.accountToId)||"(Cuenta)")}</div>`:""}</td>
      <td>${catCell}</td>
      <td class="text-end">${main}</td>
      <td>${esc(x.desc||"")}</td>
    </tr>`;
  }).join("");

  return `<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">Detalle</div>
      <span class="text-secondary small">Mostrando hasta 800</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tblRepDet">
        <thead><tr>
          <th class="th-sort" onclick="toggleSort('repDet','date',repRender)">Fecha ${sortIcon('repDet','date')}</th>
          <th class="th-sort" onclick="toggleSort('repDet','type',repRender)">Tipo ${sortIcon('repDet','type')}</th>
          <th class="th-sort" onclick="toggleSort('repDet','acc',repRender)">Cuenta ${sortIcon('repDet','acc')}</th>
          <th class="th-sort" onclick="toggleSort('repDet','cat',repRender)">Categoría ${sortIcon('repDet','cat')}</th>
          <th class="text-end th-sort" onclick="toggleSort('repDet','amt',repRender)">Monto (${esc(base)}) ${sortIcon('repDet','amt')}</th>
          <th class="th-sort" onclick="toggleSort('repDet','desc',repRender)">Descripción ${sortIcon('repDet','desc')}</th>
        </tr></thead>
        <tbody>${tr||`<tr><td colspan="6" class="text-secondary">Sin datos.</td></tr>`}</tbody>
      </table>
    </div>
    <div class="small text-secondary mt-2"><b>Nota:</b> cuando la cuenta es distinta a la moneda base (${esc(base)}), se muestra el equivalente según el tipo de cambio guardado en el movimiento.</div>
  </div></div>`;
}
function repBudget(year,month){
  let period=month||null;
  if(!period){const ps=[...new Set(state.budgets.map(b=>b.isRecurring?b.periodFrom:b.period).filter(Boolean))].sort();period=ps.at(-1)||null}
  if(!period)return `<div class="card sgf"><div class="card-body text-secondary">No hay presupuestos. Crea uno en Presupuesto.</div></div>`;

  const buds = effectiveBudgets(period, null);
  const actG=actualByCat(period,"Gasto"),actI=actualByCat(period,"Ingreso");

  const so=getSort("repBud","pct","desc");
  const mult=so.dir==="asc"?1:-1;
  const key=so.key;

  const list = buds.map(b=>{
    const actual=b.type==="Gasto"?(actG.get(b.categoryId)||0):(actI.get(b.categoryId)||0);
    const pct=b.amount>0?clamp((actual/b.amount)*100,0,999):0;
    return {b,actual,pct};
  }).sort((A,B)=>{
    const av = key==="type" ? A.b.type
      : key==="cat" ? (catPath(A.b.categoryId)||"")
      : key==="amount" ? Number(A.b.amount||0)
      : key==="actual" ? Number(A.actual||0)
      : key==="pct" ? Number(A.pct||0)
      : Number(A.pct||0);
    const bv = key==="type" ? B.b.type
      : key==="cat" ? (catPath(B.b.categoryId)||"")
      : key==="amount" ? Number(B.b.amount||0)
      : key==="actual" ? Number(B.actual||0)
      : key==="pct" ? Number(B.pct||0)
      : Number(B.pct||0);
    const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv));
    return c*mult;
  });

  const tr=list.map(({b,actual,pct})=>{
    const cls=b.type==="Gasto"?(pct>=100?"bg-danger":pct>=85?"bg-warning":"bg-primary"):(pct>=100?"bg-success":"bg-primary");
    const tag = b.isRecurring ? `<span class="badge text-bg-dark rounded-pill ms-2">Recurrente</span>` : ``;
    return `<tr>
      <td>${esc(b.type)} ${tag}</td>
      <td><div class="d-flex gap-2 align-items-center"><span class="dot" style="background:${catColor(b.categoryId)}"></span><span class="fw-semibold">${esc(catPath(b.categoryId))}</span></div></td>
      <td class="text-end fw-bold">${fmtMoney(b.amount)}</td><td class="text-end">${fmtMoney(actual)}</td>
      <td style="width:260px"><div class="progress"><div class="progress-bar ${cls}" style="width:${clamp(pct,0,100)}%"></div></div><div class="small text-secondary mt-1">${pct.toFixed(0)}%</div></td>
    </tr>`;
  }).join("");

  return `<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2"><div class="fw-bold">Real vs Presupuesto</div><span class="badge-soft">Periodo: ${esc(monthLabel(period))}</span></div>
    <div class="table-responsive"><table class="table table-hover align-middle" id="tblRepBud">
      <thead><tr>
        <th class="th-sort" onclick="toggleSort('repBud','type',repRender)">Tipo ${sortIcon('repBud','type')}</th>
        <th class="th-sort" onclick="toggleSort('repBud','cat',repRender)">Categoría ${sortIcon('repBud','cat')}</th>
        <th class="text-end th-sort" onclick="toggleSort('repBud','amount',repRender)">Presupuesto ${sortIcon('repBud','amount')}</th>
        <th class="text-end th-sort" onclick="toggleSort('repBud','actual',repRender)">Real ${sortIcon('repBud','actual')}</th>
        <th class="th-sort" onclick="toggleSort('repBud','pct',repRender)">Progreso ${sortIcon('repBud','pct')}</th>
      </tr></thead>
      <tbody>${tr||`<tr><td colspan="5" class="text-secondary">Sin presupuestos en este periodo.</td></tr>`}</tbody>
    </table></div>
    <div class="small text-secondary mt-2"><b>Nota:</b> se aplican presupuestos recurrentes y específicos (override por mes).</div>
  </div></div>`;
}

function repProData(){
  const base=baseCur();
  const end=state.ui.rM||currentPeriod();
  const periods=lastNMonths(end,12);
  const perSet=new Set(periods);
  const type=state.ui.rT||"";
  const root=state.ui.rRoot||"";
  const q=(state.ui.rQ||"").trim().toLowerCase();

  const order=["Ingreso","Gasto","Ahorro"];
  const groupLabel={Ingreso:"Ingresos",Gasto:"Gastos",Ahorro:"Ahorros"};
  const groups={Ingreso:new Map(),Gasto:new Map(),Ahorro:new Map()};
  const totals={
    Ingreso:{byPeriod:new Map(periods.map(p=>[p,0])), total:0, absTotal:0},
    Gasto:{byPeriod:new Map(periods.map(p=>[p,0])), total:0, absTotal:0},
    Ahorro:{byPeriod:new Map(periods.map(p=>[p,0])), total:0, absTotal:0}
  };

  const add=(g,catId,period,amt)=>{
    if(!catId) return;
    if(root && !catOrDesc(catId,root)) return;
    const v=Number(amt)||0;
    if(!Number.isFinite(v) || v===0) return;

    const gm=groups[g];
    if(!gm.has(catId)) gm.set(catId,{group:g,catId,name:catPath(catId)||"",byPeriod:new Map(),total:0});
    const o=gm.get(catId);
    o.byPeriod.set(period,(o.byPeriod.get(period)||0)+v);
    o.total+=v;

    totals[g].byPeriod.set(period,(totals[g].byPeriod.get(period)||0)+v);
    totals[g].total+=v;
    totals[g].absTotal+=Math.abs(v);
  };

  const toBaseAmt=(m,amt)=>{
    const fromCur=m.currency||accCur(m.accountId)||base;
    const rate=(fromCur===base)?1:(Number(m.rateToBase)||fxRateAt(fromCur,m.date||"")||fxRate(fromCur)||1);
    const val=Number(amt)||0;
    return roundMoney(toBase(val, fromCur, rate), base);
  };

  for(const m of state.movements){
    if(!m) continue;
    if(m.isOpening || m.isSystem) continue;
    if(!perSet.has(m.period)) continue;

    const t=String(m.type||"");
    if(!["Ingreso","Gasto","Ahorro","RetiroAhorro"].includes(t)) continue;

    if(type){
      if(type==="Ahorro" && t!=="Ahorro") continue;
      if(type==="RetiroAhorro" && t!=="RetiroAhorro") continue;
      if(type==="Ingreso" && t!=="Ingreso") continue;
      if(type==="Gasto" && t!=="Gasto") continue;
    }

    const g = (t==="Ingreso") ? "Ingreso" : (t==="Gasto") ? "Gasto" : "Ahorro";
    const desc=String(m.desc||"").toLowerCase();
    const sign = (t==="RetiroAhorro") ? -1 : 1;

    if(t==="Gasto" && Array.isArray(m.splits) && m.splits.length){
      for(const s of m.splits){
        const catId=s.categoryId;
        if(!catId) continue;
        const catTxt=String(catPath(catId)||"").toLowerCase();
        const sdesc=String(s.desc||"").toLowerCase();
        if(q && !(catTxt.includes(q) || desc.includes(q) || sdesc.includes(q))) continue;

        let amtBase=Number(s.amountBase);
        if(!Number.isFinite(amtBase)) amtBase=toBaseAmt(m,s.amount);
        add(g, catId, m.period, Math.abs(Number(amtBase)||0));
      }
    }else{
      const catId=m.categoryId;
      if(!catId) continue;
      const catTxt=String(catPath(catId)||"").toLowerCase();
      if(q && !(catTxt.includes(q) || desc.includes(q))) continue;

      let amtBase=Number(m.amountBase);
      if(!Number.isFinite(amtBase)) amtBase=toBaseAmt(m,m.amount);

      const v = (g==="Ahorro") ? (sign*Math.abs(Number(amtBase)||0)) : Math.abs(Number(amtBase)||0);
      add(g, catId, m.period, v);
    }
  }

  const toSorted=(g)=>{
    const arr=[...groups[g].values()];
    return arr.sort((a,b)=>{
      const aa=(g==="Ahorro")?Math.abs(Number(a.total)||0):Number(a.total)||0;
      const bb=(g==="Ahorro")?Math.abs(Number(b.total)||0):Number(b.total)||0;
      return (bb-aa) || String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"});
    });
  };

  const outGroups={Ingreso:toSorted("Ingreso"),Gasto:toSorted("Gasto"),Ahorro:toSorted("Ahorro")};
  const rows=[...outGroups.Ingreso, ...outGroups.Gasto, ...outGroups.Ahorro];

  return {base,end,periods,order,groupLabel,totals,groups:outGroups,rows,type,root,q};
}


function repProDrill(catId, groupKey){
  try{
    if(!catId) return;
    const data = repProData();
    const base = data.base;
    const periods = data.periods || [];
    const perSet = new Set(periods);
    const catName = catPath(catId) || "(Categoría)";
    const rangeLabel = periods.length ? `${monthLabel(periods[0])} → ${monthLabel(periods[periods.length-1])}` : "";

    const toBaseAmt = (m, amt)=>{
      const fromCur = m.currency || accCur(m.accountId) || base;
      const rate = (fromCur===base) ? 1 : (Number(m.rateToBase)||fxRateAt(fromCur,m.date||"")||fxRate(fromCur)||1);
      return roundMoney(toBase(Number(amt)||0, fromCur, rate), base);
    };

    const rows=[];
    for(const m of (state.movements||[])){
      if(!m || m.isOpening || m.isSystem) continue;
      if(!perSet.has(m.period)) continue;
      const t=String(m.type||"");
      const inGroup = (groupKey==="Ingreso") ? (t==="Ingreso")
        : (groupKey==="Gasto") ? (t==="Gasto")
        : (groupKey==="Ahorro") ? (t==="Ahorro"||t==="RetiroAhorro")
        : (t==="Ingreso"||t==="Gasto"||t==="Ahorro"||t==="RetiroAhorro");
      if(!inGroup) continue;

      if(t==="Gasto" && movementHasSplit(m)){
        const fromCur = m.currency || accCur(m.accountId) || base;
        const rate = (fromCur===base) ? 1 : (Number(m.rateToBase)||fxRateAt(fromCur,m.date||"")||fxRate(fromCur)||1);
        for(const s of (m.splits||[])){
          if(!s || !s.categoryId) continue;
          if(!catOrDesc(s.categoryId, catId)) continue;
          let amtBase = Number(s.amountBase);
          if(!Number.isFinite(amtBase)) amtBase = roundMoney(toBase(Number(s.amount)||0, fromCur, rate), base);
          const signed = -Math.abs(Number(amtBase)||0);
          rows.push({id:m.id, date:m.date||"", period:m.period||"", type:t, account:accPath(m.accountId)||"", cat:catPath(s.categoryId)||"", desc:(s.desc||m.desc||""), amountBase:signed, split:true});
        }
        continue;
      }

      const cat = m.categoryId;
      if(!cat) continue;
      if(!catOrDesc(cat, catId)) continue;

      let amtBase = Number(m.amountBase);
      if(!Number.isFinite(amtBase)) amtBase = toBaseAmt(m, m.amount);
      let signed = Math.abs(Number(amtBase)||0);
      if(t==="Gasto" || t==="RetiroAhorro") signed = -signed;
      rows.push({id:m.id, date:m.date||"", period:m.period||"", type:t, account:accPath(m.accountId)||"", cat:catPath(cat)||"", desc:String(m.desc||""), amountBase:signed, split:false});
    }

    rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.period||"").localeCompare(a.period||""));

    const tr = rows.map(r=>{
      const cls = r.amountBase<0 ? 'text-danger' : '';
      const badge = r.split ? '<span class="badge text-bg-secondary rounded-pill ms-2">Split</span>' : '';
      return `<tr>
        <td class="text-nowrap">${esc(r.date)}</td>
        <td class="text-nowrap">${esc(r.period)}</td>
        <td class="text-nowrap">${esc(r.type)}</td>
        <td class="text-truncate" style="max-width:220px" title="${esc(r.account)}">${esc(r.account)}</td>
        <td class="text-truncate" style="max-width:260px" title="${esc(r.cat)}">${esc(r.cat)}${badge}</td>
        <td class="text-truncate" style="max-width:320px" title="${esc(r.desc)}">${esc(r.desc||'')}</td>
        <td class="text-end ${cls}">${r.amountBase?fmtMoney(r.amountBase, base):'<span class="text-secondary">—</span>'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" onclick="repProDrillEdit('${r.id}')" title="Editar"><i class="bi bi-pencil"></i></button>
        </td>
      </tr>`;
    }).join('');

    const body = `<div class="d-flex justify-content-between flex-wrap gap-2">
      <div>
        <div class="fw-bold">Movimientos • ${esc(catName)}</div>
        <div class="small text-secondary">${esc(rangeLabel)} • Base: <b>${esc(base)}</b></div>
      </div>
      <div class="text-secondary small">${rows.length} registro(s)</div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-sm table-hover align-middle">
        <thead><tr>
          <th>Fecha</th><th>Periodo</th><th>Tipo</th><th>Cuenta</th><th>Categoría</th><th>Descripción</th>
          <th class="text-end">Monto (${esc(base)})</th><th></th>
        </tr></thead>
        <tbody>${tr||`<tr><td colspan="8" class="text-secondary">Sin movimientos para esta categoría.</td></tr>`}</tbody>
      </table>
    </div>`;

    const footer = `<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>
      <button class="btn btn-dark" onclick="repProDrillGoMov('${escAttr(catName)}')"><i class="bi bi-arrow-right-circle"></i> Ir a Movimientos</button>`;

    editor({title:"Drill-down", subtitle:"", body, footer});

  }catch(e){
    console.error(e);
    msg({title:"Error", kind:"danger", body:"No se pudo abrir el drill-down."});
  }
}

function repProDrillEdit(id){
  try{ closeEditor(); }catch{}
  try{ go('movements'); }catch{}
  try{ movEdit(id); }catch(e){ console.error(e); }
}

function repProDrillGoMov(q){
  try{ closeEditor(); }catch{}
  try{ go('movements'); }catch{}
  try{ state.ui.mQ = String(q||""); state.ui._mFocus=true; }catch{}
  try{ renderMovements(); }catch(e){ console.error(e); }
}
function repPro(){
  const data=repProData();
  const {base,periods,order,groupLabel,totals,groups,type}=data;
  const rangeLabel = `${monthLabel(periods[0])} → ${monthLabel(periods[periods.length-1])}`;

  const visible = (()=> {
    if(!type) return ["Ingreso","Gasto","Ahorro"];
    if(type==="Ingreso") return ["Ingreso"];
    if(type==="Gasto") return ["Gasto"];
    return ["Ahorro"];
  })();

  const hasAny = visible.some(g=> (groups[g]||[]).length>0);
  if(!hasAny){
    return `<div class="card sgf"><div class="card-body text-secondary">No hay datos para el Reporte Pro con los filtros actuales.</div></div>`;
  }

  const headMonths = periods.map(p=>`<th class="text-end small">${esc(monthLabel(p).replace(" de "," ").replace(" del "," "))}</th>`).join("");

  const rowTotals = (g, cls, label, fmtSign=false)=>{
    const cells = periods.map(p=>{
      const v=Number(totals[g].byPeriod.get(p)||0);
      const klass = (fmtSign && v<0) ? "text-danger" : "";
      return `<td class="text-end ${klass}">${v?fmtMoney(v,base):'<span class="text-secondary">—</span>'}</td>`;
    }).join("");
    const t=Number(totals[g].total||0);
    const tklass=(fmtSign && t<0)?"text-danger":"";
    return `<tr>
      <td class="${cls} fw-semibold">${esc(label)}</td>
      ${cells}
      <td class="text-end fw-semibold ${tklass}">${t?fmtMoney(t,base):'<span class="text-secondary">—</span>'}</td>
    </tr>`;
  };

  const netRow = ()=>{
    const cells = periods.map(p=>{
      const inc=Number(totals.Ingreso.byPeriod.get(p)||0);
      const exp=Number(totals.Gasto.byPeriod.get(p)||0);
      const v=inc-exp;
      const cls=v<0?"text-danger":"";
      return `<td class="text-end fw-semibold ${cls}">${v?fmtMoney(v,base):'<span class="text-secondary">—</span>'}</td>`;
    }).join("");
    const v=Number(totals.Ingreso.total||0) - Number(totals.Gasto.total||0);
    const cls=v<0?"text-danger":"";
    return `<tr class="table-light">
      <td class="fw-bold">Flujo neto (Ingresos - Gastos)</td>
      ${cells}
      <td class="text-end fw-bold ${cls}">${v?fmtMoney(v,base):'<span class="text-secondary">—</span>'}</td>
    </tr>`;
  };

  const summaryTable = `
    <div class="card sgf mb-3"><div class="card-body">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <div class="fw-bold">Reporte Pro (Pivot 12 meses)</div>
          <div class="small text-secondary">${esc(rangeLabel)} • Base: <b>${esc(base)}</b></div>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <span class="badge text-bg-success">Ingresos</span>
          <span class="badge text-bg-danger">Gastos</span>
          <span class="badge text-bg-primary">Ahorros</span>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead><tr><th>Grupo</th>${headMonths}<th class="text-end">Total</th></tr></thead>
          <tbody>
            ${visible.includes("Ingreso")?rowTotals("Ingreso","text-success","Ingresos"):''}
            ${visible.includes("Gasto")?rowTotals("Gasto","text-danger","Gastos"):''}
            ${visible.includes("Ahorro")?rowTotals("Ahorro","text-primary","Ahorros (neto)",true):''}
            ${(!type)?netRow():''}
          </tbody>
        </table>
      </div>

      <div class="small text-secondary">
        Nota: <b>Ahorros (neto)</b> = Ahorros - Retiros. Retiros se muestran con valor negativo.
      </div>
    </div></div>
  `;

  const hidden = state.ui.rHide || {};
  const sec = (g)=>{
    if(!visible.includes(g)) return "";
    const rows = groups[g] || [];
    const t = totals[g];
    const isSav = (g==="Ahorro");
    const title = groupLabel[g] || g;
    const count = rows.length;
    const isHidden = !!hidden[g];
    const btn = `<button class="btn btn-sm btn-outline-dark" onclick="repProToggle('${g}')">
      <i class="bi ${isHidden?'bi-chevron-down':'bi-chevron-up'}"></i> ${isHidden?'Mostrar':'Ocultar'}
    </button>`;

    const headerRow = `<tr class="table-light">
      <td class="fw-bold">${esc(title)} <span class="text-secondary small">(${count})</span></td>
      ${periods.map(p=>{
        const v=Number(t.byPeriod.get(p)||0);
        const cls=(isSav&&v<0)?"text-danger":"";
        return `<td class="text-end fw-bold ${cls}">${v?fmtMoney(v,base):'<span class="text-secondary">—</span>'}</td>`;
      }).join("")}
      <td class="text-end fw-bold ${isSav&&Number(t.total||0)<0?'text-danger':''}">${t.total?fmtMoney(t.total,base):'<span class="text-secondary">—</span>'}</td>
    </tr>`;

    const bodyRows = isHidden ? "" : rows.slice(0,200).map(r=>{
      const cells = periods.map(p=>{
        const v = Number(r.byPeriod.get(p)||0);
        const cls = (isSav && v<0) ? "text-danger" : "";
        return `<td class="text-end ${cls}">${v?fmtMoney(v,base):'<span class="text-secondary">—</span>'}</td>`;
      }).join("");
      const tot = Number(r.total||0);
      const tcls = (isSav && tot<0) ? "text-danger" : "";
      return `<tr>
        <td class="text-truncate" style="max-width:340px" title="${esc(r.name)}"><a class="rep-link" onclick="repProDrill('${r.catId}','${g}')" href="javascript:void(0)">${esc(r.name)}</a></td>
        ${cells}
        <td class="text-end fw-semibold ${tcls}">${tot?fmtMoney(tot,base):'<span class="text-secondary">—</span>'}</td>
      </tr>`;
    }).join("");

    return `
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
        <div class="fw-bold">${esc(title)}</div>
        <div class="d-flex gap-2">${btn}</div>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm align-middle">
          <thead><tr><th>Categoría</th>${headMonths}<th class="text-end">Total</th></tr></thead>
          <tbody>
            ${headerRow}
            ${bodyRows || `<tr><td colspan="${periods.length+2}" class="text-secondary small">${isHidden?'Sección oculta.':'Sin datos.'}</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
  };

  const barsGroup = visible.includes("Gasto") ? "Gasto" : visible[0];
  const top = (groups[barsGroup]||[]).slice(0,8);
  const grand = (Number(totals[barsGroup].absTotal)||0);
  const topBars = top.map(r=>{
    const pct = grand>0 ? (Math.abs(Number(r.total)||0)/grand*100) : 0;
    return `
      <div class="d-flex justify-content-between small mt-2">
        <div class="text-truncate" style="max-width:70%" title="${esc(r.name)}">${esc(r.name)}</div>
        <div class="text-nowrap">${pct.toFixed(1)}%</div>
      </div>
      <div class="progress" style="height:8px"><div class="progress-bar bg-dark" style="width:${pct}%"></div></div>
    `;
  }).join("");

  const topCard = top.length?`
    <div class="card sgf"><div class="card-body">
      <div class="fw-bold">Top categorías (${esc(groupLabel[barsGroup]||barsGroup)})</div>
      <div class="small text-secondary">${esc(rangeLabel)}</div>
      ${topBars}
    </div></div>`:"";

  return summaryTable + topCard + sec("Ingreso") + sec("Gasto") + sec("Ahorro");
}

function repRecon(year,month){
  const base=baseCur();
  const monthsList = month ? [month] : (year ? months().filter(p=>p.startsWith(String(year)+"-")).sort() : lastNMonths(currentPeriod(),12));
  if(!monthsList.length) return `<div class="card sgf"><div class="card-body text-secondary">No hay meses para mostrar.</div></div>`;
  const accs=state.accounts.filter(a=>a.active).slice().sort((a,b)=>String(accPath(a.id)||a.name).localeCompare(String(accPath(b.id)||b.name),"es",{sensitivity:"base"}));

  const monthSections = monthsList.map(ym=>{
    const rg=dateRangeForMonth(ym); if(!rg) return "";
    const prevDay = (()=>{ const d=new Date(rg.start+"T00:00:00"); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
    const rows=[];
    for(const a of accs){
      const accId=a.id;
      const cur=accCur(accId);
      const startBal=accBalanceAt(accId, prevDay);
      const endBal=accBalanceAt(accId, rg.end);

      const movs = state.movements.filter(m=>{
        if(!m||!m.date) return false;
        if(m.isOpening) return false;
        if(!["Ingreso","Gasto","Transferencia"].includes(m.type)) return false;
        if(m.date < rg.start || m.date > rg.end) return false;
        return m.accountId===accId || m.accountToId===accId;
      });

      const rec=recGet(accId,ym);
      if(!rec && movs.length===0) continue; // no actividad y no conciliación

      const startVal = (rec && Number.isFinite(Number(rec.start))) ? Number(rec.start) : startBal;
      const endVal = (rec && Number.isFinite(Number(rec.end))) ? Number(rec.end) : endBal;
      const diff = Number(endVal) - Number(endBal);

      const unrecCount = movs.filter(m=>!(m.reconciled && m.reconMonth===ym)).length;

      rows.push({
        accId,
        accName: accPath(accId)||a.name,
        cur,
        startVal,
        endVal,
        ledgerEnd:endBal,
        diff,
        closed: !!rec?.closed,
        hasRec: !!rec,
        unrecCount
      });
    }

    if(!rows.length) return "";

    const trs = rows.map(r=>{
      const diffCls = Math.abs(Number(r.diff)||0) < 0.00001 ? "text-success" : "text-danger";
      return `<tr>
        <td><div class="text-truncate" style="max-width:260px" title="${esc(r.accName)}">${esc(r.accName)}</div></td>
        <td class="text-center">${r.hasRec? (r.closed?'<span class="badge text-bg-success">Cerrada</span>':'<span class="badge text-bg-warning">Abierta</span>'):'<span class="badge text-bg-secondary">Pendiente</span>'}</td>
        <td class="text-end">${fmtMoney(r.startVal,r.cur)}</td>
        <td class="text-end fw-bold">${fmtMoney(r.endVal,r.cur)}</td>
        <td class="text-end">${fmtMoney(r.ledgerEnd,r.cur)}</td>
        <td class="text-end fw-bold ${diffCls}">${fmtMoney(r.diff,r.cur)}</td>
        <td class="text-end">${r.unrecCount}</td>
      </tr>`;
    }).join("");

    return `
      <div class="card sgf mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
              <div class="fw-bold">${esc(monthLabel(ym))}</div>
              <div class="small text-secondary">Diferencia = Estado de cuenta final − Ledger calculado.</div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-dark" onclick="exportCsv('recon')"><i class="bi bi-filetype-csv"></i> Exportar CSV</button>
            </div>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Cuenta</th>
                  <th class="text-center">Estado</th>
                  <th class="text-end">Inicio</th>
                  <th class="text-end">Final (EC)</th>
                  <th class="text-end">Final (Ledger)</th>
                  <th class="text-end">Diferencia</th>
                  <th class="text-end">No conciliados</th>
                </tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }).join("");

  return monthSections || `<div class="card sgf"><div class="card-body text-secondary">No hay conciliaciones ni actividad en los meses seleccionados.</div></div>`;
}

function dateMinus1(dateStr){
  const s=String(dateStr||"").trim();
  const m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return "";
  const dt=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  dt.setDate(dt.getDate()-1);
  const pad=n=>String(n).padStart(2,"0");
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}

function catRootId(catId){
  if(!catId) return null;
  let cur=state.categories.find(c=>c.id===catId);
  let g=0;
  while(cur?.parentId && g++<20){
    const p=state.categories.find(c=>c.id===cur.parentId);
    if(!p) break;
    cur=p;
  }
  return cur?.id||null;
}

function movAmtBase(m){
  const base=baseCur();
  const fromCur=m.currency||accCur(m.accountId)||base;
  if(Number.isFinite(Number(m.amountBase))) return Number(m.amountBase);
  const r=(fromCur===base)?1:(Number(m.rateToBase)||fxRateAt(fromCur,m.date||"")||fxRate(fromCur)||1);
  return roundMoney(toBase(Number(m.amount)||0,fromCur,r),base);
}

function repCashflow(){
  const base=baseCur();
  const end=state.ui.rM||currentPeriod();
  const periods=lastNMonths(end,12);
  const perSet=new Set(periods);

  const inc=new Map(periods.map(p=>[p,0]));
  const exp=new Map(periods.map(p=>[p,0]));
  const sav=new Map(periods.map(p=>[p,0])); // neto: Ahorro - Retiro

  for(const m of (state.movements||[])){
    if(!m) continue;
    if(m.isOpening || m.isSystem) continue;
    if(!perSet.has(m.period)) continue;
    const t=String(m.type||"");
    if(t==="Ingreso"){
      if(!m.categoryId) continue;
      inc.set(m.period, (inc.get(m.period)||0) + Math.abs(movAmtBase(m)));
    }else if(t==="Gasto"){
      if(movementHasSplit(m)){
        for(const s of (m.splits||[])){
          const v = Number.isFinite(Number(s.amountBase)) ? Number(s.amountBase) : movAmtBase({ ...m, amount:s.amount, amountBase:null });
          exp.set(m.period, (exp.get(m.period)||0) + Math.abs(Number(v)||0));
        }
      }else{
        exp.set(m.period, (exp.get(m.period)||0) + Math.abs(movAmtBase(m)));
      }
    }else if(t==="Ahorro" || t==="RetiroAhorro"){
      const sign = (t==="RetiroAhorro") ? -1 : 1;
      sav.set(m.period, (sav.get(m.period)||0) + sign*Math.abs(movAmtBase(m)));
    }
  }

  const rows = periods.map(p=>{
    const I=inc.get(p)||0;
    const E=exp.get(p)||0;
    const S=sav.get(p)||0;
    const net=I-E;
    const disp=net-S;
    return {p,I,E,S,net,disp};
  });

  const tot = rows.reduce((a,r)=>({
    I:a.I+r.I,E:a.E+r.E,S:a.S+r.S,net:a.net+r.net,disp:a.disp+r.disp
  }), {I:0,E:0,S:0,net:0,disp:0});

  const tr = rows.map(r=>{
    const clsNet=r.net<0?"text-danger":"";
    const clsDisp=r.disp<0?"text-danger":"";
    const clsSav=r.S<0?"text-danger":"";
    return `<tr>
      <td class="fw-semibold">${esc(monthLabel(r.p))}</td>
      <td class="text-end">${r.I?fmtMoney(r.I,base):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end">${r.E?fmtMoney(r.E,base):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end ${clsSav}">${r.S?fmtMoney(r.S,base):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end fw-semibold ${clsNet}">${r.net?fmtMoney(r.net,base):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end fw-semibold ${clsDisp}">${r.disp?fmtMoney(r.disp,base):'<span class="text-secondary">—</span>'}</td>
    </tr>`;
  }).join("");

  return `<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">Cashflow (12 meses)</div>
      <span class="badge-soft">${esc(monthLabel(periods[0]))} → ${esc(monthLabel(periods.at(-1)))}</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead><tr>
          <th>Mes</th>
          <th class="text-end">Ingresos</th>
          <th class="text-end">Gastos</th>
          <th class="text-end">Ahorros (neto)</th>
          <th class="text-end">Flujo neto</th>
          <th class="text-end">Disponible (neto - ahorros)</th>
        </tr></thead>
        <tbody>
          ${tr}
          <tr class="table-light">
            <td class="fw-bold">Total</td>
            <td class="text-end fw-bold">${fmtMoney(tot.I,base)}</td>
            <td class="text-end fw-bold">${fmtMoney(tot.E,base)}</td>
            <td class="text-end fw-bold ${tot.S<0?'text-danger':''}">${fmtMoney(tot.S,base)}</td>
            <td class="text-end fw-bold ${tot.net<0?'text-danger':''}">${fmtMoney(tot.net,base)}</td>
            <td class="text-end fw-bold ${tot.disp<0?'text-danger':''}">${fmtMoney(tot.disp,base)}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="small text-secondary mt-2">
      <b>Notas:</b> excluye <i>Saldo inicial</i> y movimientos <i>Sistema</i>. Ahorros neto = Ahorros − Retiros.
    </div>
  </div></div>`;
}function repTrendData(){
  const base=baseCur();
  const end=state.ui.rM||currentPeriod();
  const periods=lastNMonths(end,12);
  const perSet=new Set(periods);

  const roots=state.categories.filter(c=>c.active && !c.parentId).slice()
    .sort((a,b)=>String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"}));
  const cats=state.categories.filter(c=>c.active).slice()
    .sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));

  const scope=state.ui.trScope||"root"; // root | cat
  const metric=state.ui.trMetric||"Gasto"; // Gasto | Ingreso | Ahorro

  const defaultRoot=roots[0]?.id||"";
  const defaultCat=cats[0]?.id||"";

  let scopeId="";
  if(scope==="cat"){
    scopeId=state.ui.trCat||defaultCat||defaultRoot||"";
  }else{
    scopeId=state.ui.trRoot||state.ui.rRoot||defaultRoot||"";
  }

  if(!scopeId){
    return {base,periods,scope,metric,error:"No hay categorías activas para generar tendencias."};
  }

  const scopeLabel = (scope==="root")
    ? (state.categories.find(c=>c.id===scopeId)?.name || "(Sin nombre)")
    : (catPath(scopeId) || "(Sin categoría)");

  // Set de categorías dentro del alcance (incluye descendientes)
  const byParent=new Map();
  for(const c of (state.categories||[])){
    if(!c || !c.active) continue;
    const pid=c.parentId||"";
    if(!byParent.has(pid)) byParent.set(pid,[]);
    byParent.get(pid).push(c.id);
  }
  const set=new Set();
  const st=[scopeId];
  while(st.length){
    const id=st.pop();
    if(!id || set.has(id)) continue;
    set.add(id);
    const kids=byParent.get(id)||[];
    for(const k of kids) st.push(k);
  }

  // Actual por mes (base)
  const actByPer=new Map(periods.map(p=>[p,0]));

  for(const m of (state.movements||[])){
    if(!m) continue;
    if(m.isOpening || m.isSystem) continue;
    if(!perSet.has(m.period)) continue;
    const t=String(m.type||"");

    if(metric==="Gasto"){
      if(t!=="Gasto") continue;
      if(movementHasSplit(m)){
        for(const s of (m.splits||[])){
          if(!s || !s.categoryId) continue;
          if(!set.has(s.categoryId)) continue;
          const v = Number.isFinite(Number(s.amountBase)) ? Number(s.amountBase) : movAmtBase({ ...m, amount:s.amount, amountBase:null });
          actByPer.set(m.period,(actByPer.get(m.period)||0)+Math.abs(Number(v)||0));
        }
      }else{
        if(!m.categoryId || !set.has(m.categoryId)) continue;
        actByPer.set(m.period,(actByPer.get(m.period)||0)+Math.abs(movAmtBase(m)));
      }
      continue;
    }

    if(metric==="Ingreso"){
      if(t!=="Ingreso") continue;
      if(!m.categoryId || !set.has(m.categoryId)) continue;
      actByPer.set(m.period,(actByPer.get(m.period)||0)+Math.abs(movAmtBase(m)));
      continue;
    }

    // Ahorros (neto): Ahorro - Retiro
    if(t!=="Ahorro" && t!=="RetiroAhorro") continue;
    if(!m.categoryId || !set.has(m.categoryId)) continue;
    const sign = (t==="RetiroAhorro") ? -1 : 1;
    actByPer.set(m.period,(actByPer.get(m.period)||0)+sign*Math.abs(movAmtBase(m)));
  }

  const rows=[];
  for(const p of periods){
    const act=actByPer.get(p)||0;
    let bud=null, diff=null, pct=null;

    if(metric==="Gasto" || metric==="Ingreso"){
      bud=0;
      const buds=effectiveBudgets(p, metric);
      for(const b of buds){
        if(!b || !b.categoryId) continue;
        if(!set.has(b.categoryId)) continue;
        bud += Number(b.amount)||0;
      }
      diff = (metric==="Gasto") ? (bud - act) : (act - bud);
      pct = (bud>0) ? ((act/bud)*100) : null;
    }

    rows.push({period:p, act, bud, diff, pct});
  }

  const last3=rows.slice(-3);
  const sum=(arr)=>arr.reduce((a,x)=>a+(Number(x)||0),0);

  const act12=sum(rows.map(r=>r.act));
  const act3=sum(last3.map(r=>r.act));
  const avg12=act12/(rows.length||1);
  const avg3=act3/(last3.length||1);
  const varPct=(avg12!==0)?((avg3-avg12)/Math.abs(avg12))*100:null;

  let bud12=null,bud3=null,budAvg12=null,budAvg3=null,budVarPct=null;
  if(metric==="Gasto" || metric==="Ingreso"){
    bud12=sum(rows.map(r=>r.bud||0));
    bud3=sum(last3.map(r=>r.bud||0));
    budAvg12=bud12/(rows.length||1);
    budAvg3=bud3/(last3.length||1);
    budVarPct=(budAvg12!==0)?((budAvg3-budAvg12)/Math.abs(budAvg12))*100:null;
  }

  const metricLabel = metric==="Ingreso" ? "Ingresos" : metric==="Gasto" ? "Gastos" : "Ahorros (neto)";
  return {base,periods,scope,scopeId,scopeLabel,metric,metricLabel,rows,totals:{act12,avg12,act3,avg3,varPct,bud12,bud3,budAvg12,budAvg3,budVarPct}};
}

function repTrends(){
  const data=repTrendData();
  const base=data.base||baseCur();

  const roots=state.categories.filter(c=>c.active && !c.parentId).slice()
    .sort((a,b)=>String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"}));
  const cats=state.categories.filter(c=>c.active).slice()
    .sort((a,b)=>String(catPath(a.id)||a.name).localeCompare(String(catPath(b.id)||b.name),"es",{sensitivity:"base"}));

  const scope=state.ui.trScope||"root";
  const trRoot=state.ui.trRoot||state.ui.rRoot||roots[0]?.id||"";
  const trCat=state.ui.trCat||cats[0]?.id||"";
  const trMetric=state.ui.trMetric||"Gasto";

  const scopeOpts=`
    <option value="root">Raíz</option>
    <option value="cat">Categoría</option>`;

  const rootOpts=roots.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join("");
  const catOpts=cats.map(c=>`<option value="${c.id}">${esc(catPath(c.id)||c.name)}</option>`).join("");

  const metricOpts=`
    <option value="Gasto">Gastos</option>
    <option value="Ingreso">Ingresos</option>
    <option value="Ahorro">Ahorros (neto)</option>`;

  // Summary (promedios 3 vs 12)
  const t=data.totals||{};
  const clsVar=(()=>{
    if(t.varPct==null) return "";
    if(trMetric==="Gasto") return (t.varPct>0)?"text-danger":"text-success";
    return (t.varPct>=0)?"text-success":"text-danger";
  })();

  const showBudget=(trMetric==="Gasto" || trMetric==="Ingreso");

  const avgLine=`<div class="d-flex flex-wrap gap-3 small mt-1">
      <div>Total 12m: <b>${fmtMoney(t.act12||0,base)}</b></div>
      <div>Prom. 12m: <b>${fmtMoney(t.avg12||0,base)}</b></div>
      <div>Prom. 3m: <b>${fmtMoney(t.avg3||0,base)}</b></div>
      <div>Var (3 vs 12): <b class="${clsVar}">${t.varPct==null?'<span class="text-secondary">—</span>':`${t.varPct.toFixed(1)}%`}</b></div>
    </div>`;

  const budLine = showBudget ? `<div class="d-flex flex-wrap gap-3 small mt-2">
      <div>Presup. 12m: <b>${fmtMoney(t.bud12||0,base)}</b></div>
      <div>Prom. Presup. 12m: <b>${fmtMoney(t.budAvg12||0,base)}</b></div>
      <div>Prom. Presup. 3m: <b>${fmtMoney(t.budAvg3||0,base)}</b></div>
    </div>` : "";

  const summary = `<div class="card sgf mb-3"><div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
        <div>
          <div class="fw-bold">Tendencias (12 meses)</div>
          <div class="small text-secondary">${esc(data.scopeLabel||"")} • ${esc(data.metricLabel||"")}</div>
        </div>
        <div class="small text-secondary">Tip: usa el filtro <b>Mes</b> arriba para escoger el mes final de la serie.</div>
      </div>
      ${avgLine}
      ${budLine}
    </div></div>`;

  if(data.error){
    return summary + `<div class="alert alert-warning">${esc(data.error)}</div>`;
  }

  const rows = (data.rows||[]).map(r=>{
    const act = Number(r.act)||0;
    const bud = (r.bud==null)?null:Number(r.bud)||0;
    const diff = (r.diff==null)?null:Number(r.diff)||0;
    const pct = r.pct==null?null:Number(r.pct);

    const clsDiff = (diff!=null) ? ((diff>=0) ? "text-success" : "text-danger") : "";
    const clsAct = (trMetric==="Ahorro" && act<0) ? "text-danger" : "";

    return `<tr>
      <td class="fw-semibold">${esc(monthLabel(r.period))}</td>
      ${showBudget?`<td class="text-end">${bud?fmtMoney(bud,base):'<span class="text-secondary">—</span>'}</td>`:""}
      <td class="text-end ${clsAct}">${act?fmtMoney(act,base):'<span class="text-secondary">—</span>'}</td>
      ${showBudget?`<td class="text-end ${clsDiff}">${diff?fmtMoney(diff,base):'<span class="text-secondary">—</span>'}</td>`:""}
      ${showBudget?`<td class="text-end">${pct==null?'<span class="text-secondary">—</span>':`${pct.toFixed(1)}%`}</td>`:""}
    </tr>`;
  }).join("");

  const table = `<div class="card sgf"><div class="card-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
      <div class="fw-bold">Serie mensual</div>
      <div class="d-flex gap-2 flex-wrap align-items-end">
        <div>
          <div class="small text-secondary">Alcance</div>
          <select class="form-select form-select-sm" id="trScope" onchange="repApply()">${scopeOpts}</select>
        </div>
        <div>
          <div class="small text-secondary">Raíz</div>
          <select class="form-select form-select-sm" id="trRoot" onchange="repApply()" ${scope==="root"?"":"disabled"}>${rootOpts}</select>
        </div>
        <div>
          <div class="small text-secondary">Categoría</div>
          <select class="form-select form-select-sm" id="trCat" onchange="repApply()" ${scope==="cat"?"":"disabled"}>${catOpts}</select>
        </div>
        <div>
          <div class="small text-secondary">Métrica</div>
          <select class="form-select form-select-sm" id="trMetric" onchange="repApply()">${metricOpts}</select>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr>
            <th>Mes</th>
            ${showBudget?`<th class="text-end">Presupuesto</th>`:""}
            <th class="text-end">Real</th>
            ${showBudget?`<th class="text-end">Diferencia</th><th class="text-end">%</th>`:""}
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
</div>`;

  // set selected values after rendering (avoid selected attrs for big lists)
  setTimeout(()=>{
    const s=$("#trScope"); if(s) s.value=scope;
    const r=$("#trRoot"); if(r) r.value=trRoot;
    const c=$("#trCat"); if(c) c.value=trCat;
    const m=$("#trMetric"); if(m) m.value=trMetric;
  },0);

  return summary + table;
}


function stmtApply(){
  state.ui.stAcc = $("#stAcc")?.value || "";
  state.ui.stFrom = $("#stFrom")?.value || "";
  state.ui.stTo = $("#stTo")?.value || "";
  state.ui.stSys = $("#stSys")?.checked;
  state.ui.stOpen = $("#stOpen")?.checked;
  state.ui.stType = $("#stType")?.value || "";
  state.ui.stGroup = $("#stGroup")?.value || "day";
  // texto se maneja con debounce para no re-renderizar en cada tecla
  state.ui.stQ = state.ui.stQ || ($("#stQ")?.value || "");
  repRender();
}

function stmtQ(){
  debounce("stmtQ", ()=>{
    state.ui.stQ = $("#stQ")?.value || "";
    repRender();
  }, 250);
}

function repStatement(){
  const accs=(state.accounts||[]).filter(a=>a.active && a.type!=="Ahorro").slice()
    .sort((a,b)=>String(accPath(a.id)).localeCompare(String(accPath(b.id)),"es",{sensitivity:"base"}));
  const opts=accs.map(a=>`<option value="${a.id}">${esc(accPath(a.id))}</option>`).join("");
  const today=new Date();
  const pad=n=>String(n).padStart(2,"0");
  const todayStr=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  const defFrom=`${currentPeriod()}-01`;

  if(!state.ui.stAcc && accs.length) state.ui.stAcc=accs[0].id;
  if(!state.ui.stFrom) state.ui.stFrom=defFrom;
  if(!state.ui.stTo) state.ui.stTo=todayStr;
  if(state.ui.stSys==null) state.ui.stSys=false;
  if(state.ui.stOpen==null) state.ui.stOpen=false;
  if(state.ui.stType==null) state.ui.stType="";
  if(state.ui.stGroup==null) state.ui.stGroup="day";
  if(state.ui.stQ==null) state.ui.stQ="";

  const accId=state.ui.stAcc||"";
  const acc=state.accounts.find(a=>a.id===accId);
  if(!acc){
    return `<div class="card sgf"><div class="card-body text-secondary">No hay cuentas para el estado de cuenta.</div></div>`;
  }

  const base=baseCur();
  const cur=acc.currency||base;
  const showBase = cur!==base;

  const from=String(state.ui.stFrom||"").trim();
  const to=String(state.ui.stTo||"").trim();
  const showSys=!!state.ui.stSys;
  const showOpen=!!state.ui.stOpen;
  const typeF=String(state.ui.stType||"").trim();
  const group=String(state.ui.stGroup||"day").trim();
  const q=String(state.ui.stQ||"").trim().toLowerCase();

  const startBal = from ? accBalanceAt(accId, dateMinus1(from)) : 0;

  const affects=(m)=>(m.accountId===accId || m.accountToId===accId);

  const list=[];
  for(const m of (state.movements||[])){
    if(!m||!m.date) continue;
    if(!affects(m)) continue;
    if(!showSys && m.isSystem) continue;
    if(!showOpen && m.isOpening) continue;
    if(from && String(m.date)<from) continue;
    if(to && String(m.date)>to) continue;

    const t=String(m.type||"");
    if(!["Ingreso","Gasto","Transferencia","Ahorro","RetiroAhorro"].includes(t)) continue;
    if(typeF && t!==typeF) continue;

    // delta en moneda de la cuenta
    let delta=0;
    if(t==="Ingreso"){
      if(m.accountId===accId) delta = Number(m.amount)||0;
    }else if(t==="Gasto"){
      if(m.accountId===accId) delta = -Math.abs(Number(m.amount)||0);
    }else{
      if(m.accountId===accId){
        delta = -Math.abs(Number(m.amount)||0);
      }else if(m.accountToId===accId){
        const toAmt = Number.isFinite(Number(m.amountTo)) ? Number(m.amountTo) : Number(m.amount)||0;
        delta = Math.abs(toAmt);
      }
    }
    if(!delta) continue;

    const cat = m.categoryId ? (catPath(m.categoryId)||"") : (movementHasSplit(m) ? "Split" : "");
    const desc = m.desc||"";

    let counter="";
    if(t==="Transferencia"){
      if(m.accountId===accId && m.accountToId) counter = `A: ${accPath(m.accountToId)||""}`;
      else if(m.accountToId===accId && m.accountId) counter = `De: ${accPath(m.accountId)||""}`;
    }

    // delta en moneda base (informativo)
    let rate=1;
    let deltaBase = delta;
    if(showBase){
      if(m.accountId===accId){
        rate = (Number.isFinite(Number(m.rateToBase)) && Number(m.rateToBase)>0) ? Number(m.rateToBase) : (fxRateAt(cur,m.date)||fxRate(cur)||1);
      }else{
        rate = (Number.isFinite(Number(m.rateToBaseTo)) && Number(m.rateToBaseTo)>0) ? Number(m.rateToBaseTo) : (fxRateAt(cur,m.date)||fxRate(cur)||1);
      }
      deltaBase = toBase(delta,cur,rate);
      if(!Number.isFinite(deltaBase)) deltaBase = 0;
    }

    const hay = (t+" "+cat+" "+desc+" "+counter).toLowerCase();
    if(q && !hay.includes(q)) continue;

    list.push({
      id:m.id,
      date:m.date,
      period:m.period||"",
      type:t,
      cat,
      desc,
      counter,
      delta,
      deltaBase,
      rate,
      isSystem:!!m.isSystem,
      isOpening:!!m.isOpening,
      reconciled:!!m.reconciled
    });
  }

  // Ordenamiento: si hay agrupación, se fuerza por fecha ascendente para que tenga sentido.
  if(group!=="none"){
    list.sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  }else{
    const so=getSort("repStmt","date","desc");
    const mult=so.dir==="asc"?1:-1;
    const key=so.key;
    list.sort((A,B)=>{
      const av = key==="date"?A.date : key==="type"?A.type : key==="cat"?A.cat : key==="desc"?A.desc : key==="delta"?A.delta : key==="rec"?(A.reconciled?1:0):A.date;
      const bv = key==="date"?B.date : key==="type"?B.type : key==="cat"?B.cat : key==="desc"?B.desc : key==="delta"?B.delta : key==="rec"?(B.reconciled?1:0):B.date;
      const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
      return c*mult;
    });
  }

  let bal=startBal;
  let totalIn=0,totalOut=0,totalInB=0,totalOutB=0;

  const cols = showBase ? 10 : 9;

  const rowHtml=(x)=>{
    bal += x.delta;
    const inAmt = x.delta>0 ? x.delta : 0;
    const outAmt = x.delta<0 ? -x.delta : 0;
    totalIn += inAmt; totalOut += outAmt;

    const inB = showBase ? (x.deltaBase>0?x.deltaBase:0) : 0;
    const outB = showBase ? (x.deltaBase<0?-x.deltaBase:0) : 0;
    totalInB += inB; totalOutB += outB;

    const sysTag = x.isOpening ? `<span class="badge text-bg-success ms-2">Saldo inicial</span>` :
      x.isSystem ? `<span class="badge text-bg-secondary ms-2">Sistema</span>` : ``;

    const icon = x.type==="Transferencia" ? `<i class="bi bi-arrow-left-right me-1 text-secondary"></i>` : ``;
    const cp = x.counter ? `<div class="small text-secondary">${esc(x.counter)}</div>` : ``;

    const baseCell = showBase ? `<td class="text-end small">${fmtMoney(x.deltaBase,base)}</td>` : ``;

    return `<tr class="${x.type==="Transferencia"?'table-light':''}">
      <td>${esc(x.date)}</td>
      <td>${esc(x.period?monthLabel(x.period):"")}</td>
      <td>${icon}${esc(x.type)} ${sysTag}</td>
      <td class="small">${esc(x.cat||"")}</td>
      <td class="small">${esc(x.desc||"")}${cp}</td>
      <td class="text-end">${inAmt?fmtMoney(inAmt,cur):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end">${outAmt?fmtMoney(outAmt,cur):'<span class="text-secondary">—</span>'}</td>
      <td class="text-end fw-semibold">${fmtMoney(bal,cur)}</td>
      ${baseCell}
      <td class="text-center">${x.reconciled?'<i class="bi bi-check2-circle text-success"></i>':'<span class="text-secondary">—</span>'}</td>
    </tr>`;
  };

  let trs="";
  if(group==="none"){
    trs = list.map(rowHtml).join("");
  }else{
    let curKey=null;
    let gIn=0,gOut=0,gInB=0,gOutB=0;
    let gOpenBal=bal;
    const keyOf=(x)=> group==="month" ? String(x.date).slice(0,7) : String(x.date);

    const closeGroup=(label)=>{
      const baseGroupCell = showBase ? `<td class="text-end small">${fmtMoney((gInB-gOutB),base)}</td>` : ``;
      trs += `<tr class="table-light small">
        <td colspan="5" class="text-secondary">Totales ${esc(label)}</td>
        <td class="text-end">${gIn?fmtMoney(gIn,cur):'<span class="text-secondary">—</span>'}</td>
        <td class="text-end">${gOut?fmtMoney(gOut,cur):'<span class="text-secondary">—</span>'}</td>
        <td class="text-end fw-semibold">${fmtMoney(bal,cur)}</td>
        ${baseGroupCell}
        <td></td>
      </tr>`;
      gIn=0;gOut=0;gInB=0;gOutB=0;
      gOpenBal=bal;
    };

    for(const x of list){
      const k=keyOf(x);
      if(curKey===null || k!==curKey){
        if(curKey!==null) closeGroup(group==="month"?monthLabel(curKey):curKey);
        curKey=k;
        trs += `<tr class="table-secondary small">
          <td colspan="${cols}" class="fw-semibold">
            ${group==="month"?esc(monthLabel(curKey)):esc(curKey)}
            <span class="text-secondary fw-normal ms-2">Saldo apertura: ${fmtMoney(gOpenBal,cur)}</span>
          </td>
        </tr>`;
      }
      // actualizar totales del grupo según la fila (antes de render se actualiza bal dentro de rowHtml)
      const inAmt = x.delta>0 ? x.delta : 0;
      const outAmt = x.delta<0 ? -x.delta : 0;
      gIn += inAmt; gOut += outAmt;
      if(showBase){
        gInB += x.deltaBase>0?x.deltaBase:0;
        gOutB += x.deltaBase<0?-x.deltaBase:0;
      }
      trs += rowHtml(x);
    }
    if(curKey!==null) closeGroup(group==="month"?monthLabel(curKey):curKey);
  }

  const endBal=bal;
  const net=endBal-startBal;

  const summary = `<div class="card sgf mb-3"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">Estado de cuenta</div>
      <div class="d-flex gap-2 align-items-center">
        <span class="badge-soft">${esc(cur)}</span>
        ${showBase?`<span class="badge-soft">Base: ${esc(base)}</span>`:""}
      </div>
    </div>
    <div class="row g-2">
      <div class="col-12 col-lg-3">
        <div class="p-2 rounded-3 border" style="background:var(--soft)">
          <div class="small text-secondary">Saldo inicial del rango</div>
          <div class="fw-semibold">${fmtMoney(startBal,cur)}</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="p-2 rounded-3 border" style="background:var(--soft)">
          <div class="small text-secondary">Saldo final del rango</div>
          <div class="fw-semibold">${fmtMoney(endBal,cur)}</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="p-2 rounded-3 border" style="background:var(--soft)">
          <div class="small text-secondary">Cambio neto</div>
          <div class="fw-semibold ${net>=0?'text-success':'text-danger'}">${fmtMoney(net,cur)}</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="p-2 rounded-3 border" style="background:var(--soft)">
          <div class="small text-secondary">Entradas / Salidas</div>
          <div class="fw-semibold">${fmtMoney(totalIn,cur)} <span class="text-secondary">/</span> ${fmtMoney(totalOut,cur)}</div>
          ${showBase?`<div class="small text-secondary mt-1">Equiv. base: ${fmtMoney(totalInB,base)} / ${fmtMoney(totalOutB,base)}</div>`:""}
        </div>
      </div>
    </div>
    <div class="small text-secondary mt-2">
      <b>Saldo acumulado</b> en la moneda de la cuenta. ${showBase?`La columna <b>Δ Base</b> es informativa usando el tipo de cambio guardado.`:""}
    </div>
  </div></div>`;

  const controls = `<div class="card sgf mb-3"><div class="card-body">
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <label class="form-label">Cuenta</label>
        <select class="form-select" id="stAcc" onchange="stmtApply()">${opts}</select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" id="stFrom" onchange="stmtApply()">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" id="stTo" onchange="stmtApply()">
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="stType" onchange="stmtApply()">
          <option value="">(Todos)</option>
          <option>Ingreso</option>
          <option>Gasto</option>
          <option>Transferencia</option>
          <option value="Ahorro">Ahorro</option>
          <option value="RetiroAhorro">RetiroAhorro</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">Agrupar</label>
        <select class="form-select" id="stGroup" onchange="stmtApply()">
          <option value="day">Por día</option>
          <option value="month">Por mes</option>
          <option value="none">Sin agrupar</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">Texto</label>
        <input class="form-control" id="stQ" placeholder="Buscar en tipo, categoría, descripción o contra-cuenta..." oninput="stmtQ()">
      </div>

      <div class="col-12">
        <div class="d-flex flex-wrap gap-3 mt-1">
          <label class="form-check"><input class="form-check-input" type="checkbox" id="stSys" onchange="stmtApply()"><span class="form-check-label">Incluir Sistema</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" id="stOpen" onchange="stmtApply()"><span class="form-check-label">Incluir Saldo inicial</span></label>
        </div>
      </div>
    </div>
  </div></div>`;

  const baseTh = showBase ? `<th class="text-end">Δ Base (${esc(base)})</th>` : ``;

  const table = `<div class="card sgf"><div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">${esc(accPath(accId))}</div>
      <span class="badge-soft">Saldo inicial: ${fmtMoney(startBal,cur)}</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tblRepStmt">
        <thead><tr>
          <th class="th-sort" onclick="toggleSort('repStmt','date',repRender)">Fecha ${sortIcon('repStmt','date')}</th>
          <th>Periodo</th>
          <th class="th-sort" onclick="toggleSort('repStmt','type',repRender)">Tipo ${sortIcon('repStmt','type')}</th>
          <th class="th-sort" onclick="toggleSort('repStmt','cat',repRender)">Categoría ${sortIcon('repStmt','cat')}</th>
          <th class="th-sort" onclick="toggleSort('repStmt','desc',repRender)">Descripción ${sortIcon('repStmt','desc')}</th>
          <th class="text-end">Entrada</th>
          <th class="text-end">Salida</th>
          <th class="text-end">Saldo</th>
          ${baseTh}
          <th class="text-center th-sort" onclick="toggleSort('repStmt','rec',repRender)">OK ${sortIcon('repStmt','rec')}</th>
        </tr></thead>
        <tbody>${trs||`<tr><td colspan="${cols}" class="text-secondary">Sin movimientos para el rango seleccionado.</td></tr>`}</tbody>
      </table>
    </div>
  </div></div>`;

  setTimeout(()=>{
    if($("#stAcc")) $("#stAcc").value=state.ui.stAcc||"";
    if($("#stFrom")) $("#stFrom").value=state.ui.stFrom||"";
    if($("#stTo")) $("#stTo").value=state.ui.stTo||"";
    if($("#stSys")) $("#stSys").checked=!!state.ui.stSys;
    if($("#stOpen")) $("#stOpen").checked=!!state.ui.stOpen;
    if($("#stType")) $("#stType").value=state.ui.stType||"";
    if($("#stGroup")) $("#stGroup").value=state.ui.stGroup||"day";
    if($("#stQ")) $("#stQ").value=state.ui.stQ||"";
  },0);

  return summary + controls + table;
}

function repBudDrill(rootId, subId=null){
  state.ui = state.ui || {};
  state.ui.rBudDrill = {rootId: rootId||null, subId: subId||null};
  repRender();
}
function repBudDrillBack(){
  state.ui = state.ui || {};
  if(state.ui.rBudDrill?.subId){
    state.ui.rBudDrill.subId = null;
  }else{
    state.ui.rBudDrill = null;
  }
  repRender();
}
function repBudDrillHome(){
  state.ui = state.ui || {};
  state.ui.rBudDrill = null;
  repRender();
}

function repBudgetRoot(year,month){
  let period = month || currentPeriod();
  const base=baseCur();

  const cats = state.categories.filter(c=>c && c.active);
  const byId = new Map(cats.map(c=>[c.id,c]));
  const roots = cats.filter(c=>!c.parentId).slice()
    .sort((a,b)=>String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"}));

  const drill = state.ui?.rBudDrill || null;
  const rootId = drill?.rootId || null;
  const subId  = drill?.subId  || null;

  const buds = effectiveBudgets(period, null);
  const actG = actualByCat(period,"Gasto");
  const actI = actualByCat(period,"Ingreso");

  const sum=(map,key,val)=> map.set(key,(map.get(key)||0)+(Number(val)||0));

  const directUnder = (parentId, cid)=>{
    if(!cid) return null;
    if(cid===parentId) return "__self__";
    let cur = byId.get(cid);
    let g=0;
    while(cur && cur.parentId && g++<20){
      if(cur.parentId===parentId) return cur.id;
      cur = byId.get(cur.parentId);
    }
    return null;
  };

const scopeTotals = (scopeId)=>{
    let bg=0, bi=0, ag=0, ai=0;
    for(const b of buds){
      const k = directUnder(scopeId, b.categoryId);
      if(k===null) continue;
      if(b.type==="Gasto") bg += Number(b.amount)||0;
      if(b.type==="Ingreso") bi += Number(b.amount)||0;
    }
    for(const [cid,v] of actG.entries()){
      const k = directUnder(scopeId, cid);
      if(k!==null) ag += Number(v)||0;
    }
    for(const [cid,v] of actI.entries()){
      const k = directUnder(scopeId, cid);
      if(k!==null) ai += Number(v)||0;
    }
    const dg = bg - ag; // positivo=mejor
    const di = ai - bi; // positivo=mejor
    return {
      bg, ag, dg, pg: (bg>0 ? (ag/bg)*100 : 0),
      bi, ai, di, pi: (bi>0 ? (ai/bi)*100 : 0)
    };
  };

  const scopeTotalsCard = (scopeId, label)=>{
    const t = scopeTotals(scopeId);
    const clsG = t.dg>=0 ? "text-success" : "text-danger";
    const clsI = t.di>=0 ? "text-success" : "text-danger";
    return `<div class="card sgf mb-3"><div class="card-body">
      <div class="fw-bold mb-2">Totales del nivel — ${esc(label)}</div>
      <div class="row g-2">
        <div class="col-12 col-lg-6">
          <div class="p-2 rounded-3 border" style="background:var(--soft)">
            <div class="fw-semibold">Gastos</div>
            <div class="d-flex flex-wrap gap-3 small mt-1">
              <div>Presup.: <b>${fmtMoney(t.bg,base)}</b></div>
              <div>Real: <b>${fmtMoney(t.ag,base)}</b></div>
              <div>Difer.: <b class="${clsG}">${fmtMoney(t.dg,base)}</b></div>
              <div>%: <b>${t.pg?`${t.pg.toFixed(1)}%`:""}</b></div>
            </div>
            <div class="small text-secondary mt-1">Diferencia = Presupuesto - Real.</div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="p-2 rounded-3 border" style="background:var(--soft)">
            <div class="fw-semibold">Ingresos</div>
            <div class="d-flex flex-wrap gap-3 small mt-1">
              <div>Presup.: <b>${fmtMoney(t.bi,base)}</b></div>
              <div>Real: <b>${fmtMoney(t.ai,base)}</b></div>
              <div>Difer.: <b class="${clsI}">${fmtMoney(t.di,base)}</b></div>
              <div>%: <b>${t.pi?`${t.pi.toFixed(1)}%`:""}</b></div>
            </div>
            <div class="small text-secondary mt-1">Diferencia = Real - Presupuesto.</div>
          </div>
        </div>
      </div>
    </div></div>`;
  };

  const buildForScope = (scopeId, labelBreadcrumb)=>{
    const children = cats.filter(c=>c.parentId===scopeId).slice()
      .sort((a,b)=>String(a.name).localeCompare(String(b.name),"es",{sensitivity:"base"}));

    const budG=new Map(), budI=new Map(), actGr=new Map(), actIr=new Map();

    // Budgets -> agrupar por hijo directo dentro del scope
    for(const b of buds){
      const key = directUnder(scopeId, b.categoryId);
      if(!key) continue;
      if(b.type==="Gasto") sum(budG,key,b.amount);
      if(b.type==="Ingreso") sum(budI,key,b.amount);
    }

    // Actuals -> agrupar por hijo directo dentro del scope
    for(const [cid,v] of actG.entries()){
      const key = directUnder(scopeId, cid);
      if(key) sum(actGr,key,v);
    }
    for(const [cid,v] of actI.entries()){
      const key = directUnder(scopeId, cid);
      if(key) sum(actIr,key,v);
    }

    const nameOf = (key)=>{
      if(key==="__self__") return "(Sin subcategoría)";
      return byId.get(key)?.name || "";
    };

    const clickOf = (key)=>{
      if(key==="__self__") return "";
      // solo permite drill si existe siguiente nivel
      const hasKids = cats.some(c=>c.parentId===key);
      if(!hasKids) return "";
      return `onclick="repBudDrill('${esc(rootId||scopeId)}','${esc(key)}')"`;
    };

    const buildTable = (type)=>{
      const levelKey = `scope_${scopeId}_${type}`;
      const so=getSort("repBudRoot_"+levelKey,"diff","desc");
      const mult=so.dir==="asc"?1:-1;
      const key=so.key;

      const keys = new Set([
        ...[...budG.keys()],... [...budI.keys()],... [...actGr.keys()],... [...actIr.keys()]
      ]);
      // limitar a keys en este type (para evitar mostrar basura)
      const rows = [...keys].map(k=>{
        const b = Number((type==="Gasto"?budG:budI).get(k)||0);
        const a = Number((type==="Gasto"?actGr:actIr).get(k)||0);
        const diff = (type==="Ingreso") ? (a-b) : (b-a); // positivo=mejor
        const pct = b>0 ? (a/b)*100 : 0;
        return {k,b,a,diff,pct};
      }).filter(x=>x.b!==0 || x.a!==0).sort((A,B)=>{
        const av = key==="cat"?nameOf(A.k) : key==="b"?A.b : key==="a"?A.a : key==="diff"?A.diff : key==="pct"?A.pct : A.diff;
        const bv = key==="cat"?nameOf(B.k) : key==="b"?B.b : key==="a"?B.a : key==="diff"?B.diff : key==="pct"?B.pct : B.diff;
        const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
        return c*mult;
      });

      const tr = rows.map(x=>{
        const good = x.diff>=0;
        const cls = good ? "text-success" : "text-danger";
        const btn = clickOf(x.k);
        const nm = nameOf(x.k);
        const nmHtml = btn ? `<button class="btn btn-link p-0 text-decoration-none fw-semibold" ${btn}>${esc(nm)} <i class="bi bi-chevron-right small"></i></button>` : `<span class="fw-semibold">${esc(nm)}</span>`;
        return `<tr>
          <td>${nmHtml}</td>
          <td class="text-end">${fmtMoney(x.b,base)}</td>
          <td class="text-end">${fmtMoney(x.a,base)}</td>
          <td class="text-end ${cls}">${fmtMoney(x.diff,base)}</td>
          <td class="text-end">${x.pct?`${x.pct.toFixed(1)}%`:""}</td>
        </tr>`;
      }).join("");

      return `<div class="card sgf mb-3"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
          <div>
            <div class="fw-bold">${type==="Gasto"?"Gastos":"Ingresos"} — ${esc(labelBreadcrumb)}</div>
            <div class="small text-secondary">Periodo: <b>${esc(period)}</b></div>
          </div>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr>
              <th style="min-width:220px" onclick="toggleSort('repBudRoot_'+ '${levelKey}','cat',repRender)">Categoría ${sortIcon('repBudRoot_'+levelKey,'cat')}</th>
              <th class="text-end" onclick="toggleSort('repBudRoot_'+ '${levelKey}','b',repRender)">Presup. ${sortIcon('repBudRoot_'+levelKey,'b')}</th>
              <th class="text-end" onclick="toggleSort('repBudRoot_'+ '${levelKey}','a',repRender)">Real ${sortIcon('repBudRoot_'+levelKey,'a')}</th>
              <th class="text-end" onclick="toggleSort('repBudRoot_'+ '${levelKey}','diff',repRender)">Diferencia ${sortIcon('repBudRoot_'+levelKey,'diff')}</th>
              <th class="text-end" onclick="toggleSort('repBudRoot_'+ '${levelKey}','pct',repRender)">% ${sortIcon('repBudRoot_'+levelKey,'pct')}</th>
            </tr></thead>
            <tbody>${tr||`<tr><td colspan="5" class="text-secondary">Sin datos para este nivel.</td></tr>`}</tbody>
          </table>
        </div>
        <div class="small text-secondary mt-2">${type==="Ingreso"?"Diferencia = Real - Presupuesto (positivo es bueno).":"Diferencia = Presupuesto - Real (positivo es bueno)."}</div>
      </div></div>`;
    };

    return `<div>${buildTable("Gasto")}${buildTable("Ingreso")}</div>`;
  };

  // =========================
  // Vista raíz (sin drill)
  // =========================
  if(!rootId){
    // reutiliza lógica anterior: agrupa por raíces
    const sum=(map,key,val)=> map.set(key,(map.get(key)||0)+(Number(val)||0));
    const budG=new Map(), budI=new Map(), actGr=new Map(), actIr=new Map();

    for(const b of buds){
      const r=catRootId(b.categoryId); if(!r) continue;
      if(b.type==="Gasto") sum(budG,r,b.amount);
      if(b.type==="Ingreso") sum(budI,r,b.amount);
    }
    for(const [cid,v] of actG.entries()){ const r=catRootId(cid); if(r) sum(actGr,r,v); }
    for(const [cid,v] of actI.entries()){ const r=catRootId(cid); if(r) sum(actIr,r,v); }

    const build = (type)=>{
      const soKey = "repBudRoot_roots_"+type;
      const so=getSort(soKey,"diff","desc");
      const mult=so.dir==="asc"?1:-1;
      const key=so.key;

      const rows = roots.map(r=>{
        const b = Number((type==="Gasto"?budG:budI).get(r.id)||0);
        const a = Number((type==="Gasto"?actGr:actIr).get(r.id)||0);
        const diff = (type==="Ingreso") ? (a-b) : (b-a); // positivo=mejor
        const pct = b>0 ? (a/b)*100 : 0;
        return {root:r,b,a,diff,pct};
      }).filter(x=>x.b!==0 || x.a!==0).sort((A,B)=>{
        const av = key==="root"?A.root.name : key==="b"?A.b : key==="a"?A.a : key==="diff"?A.diff : key==="pct"?A.pct : A.diff;
        const bv = key==="root"?B.root.name : key==="b"?B.b : key==="a"?B.a : key==="diff"?B.diff : key==="pct"?B.pct : B.diff;
        const c = (typeof av==="number" && typeof bv==="number") ? (av-bv) : String(av).localeCompare(String(bv),"es",{sensitivity:"base"});
        return c*mult;
      });

      const tr=rows.map(x=>{
        const good=x.diff>=0;
        const cls=good?"text-success":"text-danger";
        const hasKids=cats.some(c=>c.parentId===x.root.id);
        const nm=hasKids
          ? `<button class="btn btn-link p-0 text-decoration-none fw-semibold" onclick="repBudDrill('${esc(x.root.id)}',null)">${esc(x.root.name)} <i class="bi bi-chevron-right small"></i></button>`
          : `<span class="fw-semibold">${esc(x.root.name)}</span>`;
        return `<tr>
          <td>${nm}</td>
          <td class="text-end">${fmtMoney(x.b,base)}</td>
          <td class="text-end">${fmtMoney(x.a,base)}</td>
          <td class="text-end ${cls}">${fmtMoney(x.diff,base)}</td>
          <td class="text-end">${x.pct?`${x.pct.toFixed(1)}%`:""}</td>
        </tr>`;
      }).join("");

      const title = type==="Gasto" ? "Gastos por categoría raíz" : "Ingresos por categoría raíz";
      return `<div class="card sgf mb-3"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
          <div>
            <div class="fw-bold">${title}</div>
            <div class="small text-secondary">Periodo: <b>${esc(period)}</b> • Click en una raíz para ver subcategorías.</div>
          </div>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr>
              <th style="min-width:240px" onclick="toggleSort('${soKey}','root',repRender)">Raíz ${sortIcon('${soKey}','root')}</th>
              <th class="text-end" onclick="toggleSort('${soKey}','b',repRender)">Presup. ${sortIcon('${soKey}','b')}</th>
              <th class="text-end" onclick="toggleSort('${soKey}','a',repRender)">Real ${sortIcon('${soKey}','a')}</th>
              <th class="text-end" onclick="toggleSort('${soKey}','diff',repRender)">Diferencia ${sortIcon('${soKey}','diff')}</th>
              <th class="text-end" onclick="toggleSort('${soKey}','pct',repRender)">% ${sortIcon('${soKey}','pct')}</th>
            </tr></thead>
            <tbody>${tr||`<tr><td colspan="5" class="text-secondary">Sin datos para este periodo.</td></tr>`}</tbody>
          </table>
        </div>
        <div class="small text-secondary mt-2">${type==="Ingreso"?"Diferencia = Real - Presupuesto (positivo es bueno).":"Diferencia = Presupuesto - Real (positivo es bueno)."}</div>
      </div></div>`;
    };

    return `<div>${build("Gasto")}${build("Ingreso")}</div>`;
  }

  // =========================
  // Drill: Root -> Nivel 2
  // =========================
  const root = byId.get(rootId);
  if(!root) { state.ui.rBudDrill=null; return repBudgetRoot(year,month); }

  if(!subId){
    const bc = `Raíces / ${root.name}`;
    const head = `<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div class="fw-bold">Presupuesto vs Real — ${esc(root.name)} (nivel 2)</div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-dark" onclick="repBudDrillHome()"><i class="bi bi-house"></i> Raíces</button>
      </div>
    </div>
    <div class="small text-secondary mb-3">Click en una subcategoría para ver nivel 3. ${esc(bc)}</div>`;
    return head + scopeTotalsCard(rootId, root.name) + buildForScope(rootId, root.name);
  }

  // =========================
  // Drill: Root -> Nivel 3 (subId)
  // =========================
  const sub = byId.get(subId);
  if(!sub || sub.parentId!==rootId){
    state.ui.rBudDrill={rootId:rootId,subId:null};
    return repBudgetRoot(year,month);
  }
  const head = `<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <div class="fw-bold">Presupuesto vs Real — ${esc(root.name)} / ${esc(sub.name)} (nivel 3)</div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-dark" onclick="repBudDrillBack()"><i class="bi bi-arrow-left"></i> Atrás</button>
      <button class="btn btn-sm btn-outline-dark" onclick="repBudDrillHome()"><i class="bi bi-house"></i> Raíces</button>
    </div>
  </div>
  <div class="small text-secondary mb-3">Nivel 3 muestra los hijos directos de <b>${esc(sub.name)}</b>. Si no hay, verás vacío.</div>`;

  return head + scopeTotalsCard(subId, `${root.name} / ${sub.name}`) + buildForScope(subId, `${root.name} / ${sub.name}`);
}




/* Settings + demo grande */
function diagnoseState(){
  const rep={at:new Date().toISOString(),issues:[]};
  const byId=(arr)=>{const m=new Map(); for(const x of (arr||[])){ if(x?.id) m.set(x.id,x); } return m;};
  const acc=byId(state.accounts), cat=byId(state.categories);

  const orphanAcc=[], orphanCat=[];
  for(const a of acc.values()){ if(a.parentId && !acc.has(a.parentId)) orphanAcc.push(a.id); }
  for(const c of cat.values()){ if(c.parentId && !cat.has(c.parentId)) orphanCat.push(c.id); }
  if(orphanAcc.length) rep.issues.push({k:"orphanAcc",n:orphanAcc.length,ids:orphanAcc});
  if(orphanCat.length) rep.issues.push({k:"orphanCat",n:orphanCat.length,ids:orphanCat});

  const findCycles=(m)=>{
    const visiting=new Set(), visited=new Set(), cyc=new Set();
    const dfs=(id)=>{
      if(visiting.has(id)){cyc.add(id);return;}
      if(visited.has(id)) return;
      visiting.add(id);
      const p=m.get(id)?.parentId;
      if(p && m.has(p)) dfs(p);
      visiting.delete(id);
      visited.add(id);
    };
    for(const id of m.keys()) dfs(id);
    return [...cyc];
  };
  const cycA=findCycles(acc), cycC=findCycles(cat);
  if(cycA.length) rep.issues.push({k:"cycleAcc",n:cycA.length,ids:cycA});
  if(cycC.length) rep.issues.push({k:"cycleCat",n:cycC.length,ids:cycC});

  const missAcc=[], missAccTo=[], missCat=[], missCatReq=[], missCatSplit=[], missBudCat=[];
  for(const m of (state.movements||[])){
    if(!m||!m.id) continue;
    if(m.accountId && !acc.has(m.accountId)) missAcc.push(m.id);
    if(m.accountToId && !acc.has(m.accountToId)) missAccTo.push(m.id);
    if(m.categoryId && !cat.has(m.categoryId)){
      if(m.type==="Ahorro"||m.type==="RetiroAhorro") missCatReq.push(m.id);
      else missCat.push(m.id);
    }
    if(movementHasSplit(m)){
      const bad = (m.splits||[]).some(s=>s?.categoryId && !cat.has(s.categoryId));
      if(bad) missCatSplit.push(m.id);
    }
  }
  for(const b of (state.budgets||[])){ if(b?.categoryId && !cat.has(b.categoryId)) missBudCat.push(b.id); }

  if(missAcc.length) rep.issues.push({k:"movMissingAccount",n:missAcc.length,ids:missAcc});
  if(missAccTo.length) rep.issues.push({k:"movMissingAccountTo",n:missAccTo.length,ids:missAccTo});
  if(missCatReq.length) rep.issues.push({k:"movMissingCategoryRequired",n:missCatReq.length,ids:missCatReq});
  if(missCat.length) rep.issues.push({k:"movMissingCategory",n:missCat.length,ids:missCat});
  if(missCatSplit.length) rep.issues.push({k:"movMissingSplitCategory",n:missCatSplit.length,ids:missCatSplit});
  if(missBudCat.length) rep.issues.push({k:"budMissingCategory",n:missBudCat.length,ids:missBudCat});


  const recBad=[];
  for(const r of (state.reconciliations||[])){
    if(!r||!r.accountId) continue;
    if(!acc.has(r.accountId)) recBad.push(r.id||"(sin id)");
  }
  if(recBad.length) rep.issues.push({k:"recMissingAccount",n:recBad.length,ids:recBad});

  const savC=state.config.savingsAccountId, savU=state.config.savingsAccountIdUSD;
  const aC=savC?acc.get(savC):null, aU=savU?acc.get(savU):null;
  const savIssues=[];
  if(savC && !aC) savIssues.push("Cuenta Ahorros CRC no existe.");
  if(savU && !aU) savIssues.push("Cuenta Ahorros USD no existe.");
  if(aC && (aC.type!=="Ahorro" || (aC.currency||baseCur())!==baseCur())) savIssues.push("Cuenta Ahorros CRC inconsistente (tipo/moneda).");
  if(aU && (aU.type!=="Ahorro" || (aU.currency||"USD")!=="USD")) savIssues.push("Cuenta Ahorros USD inconsistente (tipo/moneda).");
  if(savIssues.length) rep.issues.push({k:"savingsIntegrity",n:savIssues.length,ids:savIssues});
  return rep;
}

function applyRepair(rep){
  const accBy=(id)=>state.accounts.find(a=>a.id===id);
  const catBy=(id)=>state.categories.find(c=>c.id===id);

  rep._actions=[];
  const addLog=(t)=>{ try{rep._actions.push(t);}catch{} };

  const badRec = new Set();
  const badBud = new Set();
  const toRemove = new Set();

  const markCascade=(id)=>{
    if(!id) return;
    toRemove.add(id);
    const m=state.movements.find(x=>x.id===id);
    if(!m) return;
    if(m.linkedTransferId) toRemove.add(m.linkedTransferId);
    if(m.linkedTo) toRemove.add(m.linkedTo);
    const logical = state.movements.find(x=>x.linkedTransferId===id); if(logical) toRemove.add(logical.id);
    const sys = state.movements.find(x=>x.linkedTo===id); if(sys) toRemove.add(sys.id);
  };

  for(const it of (rep.issues||[])){
    const ids = it.ids || [];
    switch(it.k){
      case "recMissingAccount":
        for(const id of ids) badRec.add(id);
        break;

      case "orphanAcc":
      case "cycleAcc":
        for(const id of ids){
          const a=accBy(id);
          if(a){ a.parentId=null; addLog(`Cuenta ${a.name}: parentId->null`); }
        }
        break;

      case "orphanCat":
      case "cycleCat":
        for(const id of ids){
          const c=catBy(id);
          if(c){ c.parentId=null; addLog(`Categoría ${c.name}: parentId->null`); }
        }
        break;

      case "movMissingCategory":
        for(const id of ids){
          const m=state.movements.find(x=>x.id===id);
          if(m){ m.categoryId=null; addLog(`Movimiento ${id}: categoryId->null`); }
        }
        break;

      case "movMissingSplitCategory":
        for(const id of ids){
          const m=state.movements.find(x=>x.id===id);
          if(m && Array.isArray(m.splits)){
            const before=m.splits.length;
            m.splits = m.splits.filter(s=>s && s.categoryId && catBy(s.categoryId));
            if(!m.splits.length) delete m.splits;
            addLog(`Movimiento ${id}: split depurado (${before}→${m.splits?m.splits.length:0})`);
          }
        }
        break;

      case "movMissingAccount":
      case "movMissingAccountTo":
      case "movMissingCategoryRequired":
        for(const id of ids) markCascade(id);
        break;

      case "budMissingCategory":
        for(const id of ids) badBud.add(id);
        break;
    }
  }

  if(badRec.size){
    state.reconciliations = (state.reconciliations||[]).filter(r=>!(r && badRec.has(r.id)));
    addLog(`Conciliaciones eliminadas: ${badRec.size}`);
  }

  if(toRemove.size){
    state.movements = state.movements.filter(x=>!toRemove.has(x.id));
    addLog(`Movimientos eliminados: ${toRemove.size}`);
  }

  if(badBud.size){
    state.budgets = (state.budgets||[]).filter(b=>!badBud.has(b.id));
    addLog(`Presupuestos eliminados: ${badBud.size}`);
  }

  for(const r of (state.recurrings||[])){
    if(r.active===undefined) r.active=true;
    if(r.name===undefined) r.name="";
    if(r.type===undefined) r.type="Gasto";
    if(r.accountId===undefined) r.accountId=null;
    if(r.accountToId===undefined) r.accountToId=null;
    if(r.categoryId===undefined) r.categoryId=null;
    if(r.amount===undefined) r.amount=0;
    if(r.day===undefined) r.day=1;
    if(r.regOffset===undefined) r.regOffset=0; // -1 mes anterior, 0 mismo mes, +1 mes siguiente
    if(r.startPeriod===undefined) r.startPeriod=null;
    if(r.endPeriod===undefined) r.endPeriod=null;
    if(r.desc===undefined) r.desc="";
  }

  ensureSavingsAccount();
  normalizeCurrencyModel();
  try{ sanitizeColorsInState(); }catch{}

  logEvent("repair","system",null,`Repair aplicado. Cambios: ${(rep._actions||[]).length}`);
  state.meta=state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
  state.meta.lastRepairReport=rep;
  save();
  render(state.ui.route);
  toast("Reparación aplicada.","success");
}

function showDiagnostics(){
  const rep=diagnoseState();
  const mapName=(k)=>{
    const m={
      orphanAcc:"Cuentas con padre inexistente",
      orphanCat:"Categorías con padre inexistente",
      cycleAcc:"Ciclos en cuentas",
      cycleCat:"Ciclos en categorías",
      movMissingAccount:"Movimientos con cuenta origen inexistente",
      movMissingAccountTo:"Movimientos con cuenta destino inexistente",
      movMissingCategoryRequired:"Ahorros/retiros sin categoría válida",
      movMissingCategory:"Movimientos con categoría inexistente",
      budMissingCategory:"Presupuestos con categoría inexistente",
      savingsIntegrity:"Integridad Ahorros (SGF)",
      recMissingAccount:"Conciliaciones con cuenta inexistente"
    };
    return m[k]||k;
  };
  const rows=(rep.issues||[]).map(it=>`<tr><td>${esc(mapName(it.k))}</td><td class="text-end">${esc(String(it.n||0))}</td></tr>`).join("");
  const empty = !(rep.issues||[]).length;
  msg({title:"Diagnóstico",kind: empty?"success":"warning",body:`
    <div class="small text-secondary">Fecha: ${esc(rep.at)}</div>
    ${empty?`<div class="alert alert-success border-0 mt-2" style="background:rgba(16,185,129,.12)">No se detectaron inconsistencias.</div>`:
    `<div class="table-responsive mt-2"><table class="table table-sm align-middle">
      <thead><tr><th>Hallazgo</th><th class="text-end">Cantidad</th></tr></thead><tbody>${rows}</tbody></table></div>
     <div class="d-grid gap-2 mt-3"><button class="btn btn-dark" onclick="bootstrap.Modal.getInstance($('#msgM'))?.hide();applyRepair(diagnoseState())"><i class="bi bi-wrench-adjustable"></i> Aplicar reparación</button></div>`}
  `});
}

function settingsEnhance(){
  // FX histórico section
  const base=baseCur();
  const other=CURRENCIES.filter(c=>c.code!==base);
  const fxh=$("#cfgFxHist");
  if(fxh){
    const hist=Array.isArray(state.config.fxHistory)?state.config.fxHistory:[];
    const rows=[...hist].filter(x=>x&&x.currency&&x.date).sort((a,b)=> (a.currency||"").localeCompare(b.currency||"") || String(b.date).localeCompare(String(a.date)));
    fxh.innerHTML = `
      <div class="fw-semibold">FX histórico (por fecha)</div>
      <div class="small text-secondary mt-1">Opcional. Se usa como valor por defecto en formularios cuando el movimiento es en moneda distinta a la base.</div>
      <div class="card sgf mt-2"><div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4"><label class="form-label">Moneda</label>
            <select class="form-select" id="fxhCur">${other.map(c=>`<option value="${c.code}">${c.label}</option>`).join("")}</select>
          </div>
          <div class="col-12 col-md-4"><label class="form-label">Fecha</label>
            <input type="date" class="form-control" id="fxhDate">
          </div>
          <div class="col-12 col-md-4"><label class="form-label">Rate</label>
            <input class="form-control" id="fxhRate" inputmode="decimal" placeholder="Ej: 520">
          </div>
          <div class="col-12 d-grid d-md-block mt-1">
            <button class="btn btn-outline-dark" id="fxhAdd"><i class="bi bi-plus"></i> Agregar</button>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>Moneda</th><th>Fecha</th><th class="text-end">Rate</th><th class="text-end">Acción</th></tr></thead>
            <tbody id="fxhTb"></tbody>
          </table>
        </div>
      </div></div>
    `;
    const tb=$("#fxhTb");
    if(tb){
      tb.innerHTML = rows.map(x=>`<tr>
        <td>${esc(x.currency)}</td>
        <td>${esc(x.date)}</td>
        <td class="text-end">${esc(String(x.rate))}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="fxHistDel('${esc(x.currency)}','${esc(x.date)}')"><i class="bi bi-trash"></i></button></td>
      </tr>`).join("") || `<tr><td colspan="4" class="text-secondary small">Sin registros.</td></tr>`;
    }
    const fxhAdd=$("#fxhAdd");
    if(fxhAdd) fxhAdd.addEventListener("click",()=>{
      const cur=$("#fxhCur")?.value;
      const date=$("#fxhDate")?.value;
      const rate=parseAmount($("#fxhRate")?.value||"");
      if(!cur||!date||!(Number.isFinite(rate)&&rate>0)){
        msg({title:"FX histórico",kind:"warning",body:"Complete <b>Moneda</b>, <b>Fecha</b> y un <b>Rate</b> válido."});return;
      }
      state.config.fxHistory = Array.isArray(state.config.fxHistory)?state.config.fxHistory:[];
      const key=`${cur}|${date}`;
      let done=false;
      state.config.fxHistory = state.config.fxHistory.map(x=>{
        const k=`${x?.currency||""}|${x?.date||""}`;
        if(k===key){ done=true; return {currency:cur,date,rate}; }
        return x;
      });
      if(!done) state.config.fxHistory.push({currency:cur,date,rate});
      logEvent("upsert","fxHistory",null,`${cur} ${date}=${rate}`);
      save();
      toast("FX histórico actualizado.","success");
      settingsEnhance();
    });
  }

  const extra=$("#cfgExtra");
  if(extra){
    const list=getBackups().slice().reverse();
    const bRows=list.map(b=>{
      const sz=Number(b.size||0);
      const kb=sz?(sz/1024).toFixed(0)+" KB":"";
      return `<tr>
        <td>${esc((b.ts||"").replace("T"," ").slice(0,16))}</td>
        <td class="text-end">${esc(kb)}</td>
        <td class="text-end d-flex justify-content-end gap-1">
          <button class="btn btn-sm btn-outline-dark" onclick="backupRestore('${esc(b.ts)}')" title="Restaurar"><i class="bi bi-arrow-counterclockwise"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="backupExport('${esc(b.ts)}')" title="Exportar"><i class="bi bi-download"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="backupDelete('${esc(b.ts)}')" title="Eliminar"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="3" class="text-secondary small">Sin auto-backups.</td></tr>`;

    const aud=(Array.isArray(state.audit)?state.audit:[]).slice().reverse().slice(0,200);
    const aRows=aud.map(e=>`<tr>
      <td class="small text-secondary">${esc((e.ts||"").replace("T"," ").slice(0,16))}</td>
      <td>${esc(e.action||"")}</td>
      <td>${esc(e.entity||"")}</td>
      <td class="small">${esc(e.detail||"")}</td>
    </tr>`).join("") || `<tr><td colspan="4" class="text-secondary small">Sin eventos.</td></tr>`;

    extra.innerHTML = `
      <div class="card sgf mt-3"><div class="card-body">
        <div class="fw-bold">Auto-backups</div>
        <div class="small text-secondary mt-1">Backups automáticos en el navegador (rotación). Exportar JSON sigue siendo el respaldo principal.</div>
        <div class="row g-2 mt-2">
          <div class="col-12 col-md-4"><label class="form-label">Habilitado</label>
            <select class="form-select" id="abEn"><option value="1">Sí</option><option value="0">No</option></select>
          </div>
          <div class="col-6 col-md-4"><label class="form-label">Cada (ops)</label>
            <input class="form-control" id="abEvery" inputmode="numeric">
          </div>
          <div class="col-6 col-md-4"><label class="form-label">Máx</label>
            <input class="form-control" id="abMax" inputmode="numeric">
          </div>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button class="btn btn-outline-dark" id="abSave"><i class="bi bi-check2"></i> Guardar Auto-backup</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>Fecha</th><th class="text-end">Tamaño</th><th class="text-end">Acción</th></tr></thead>
            <tbody>${bRows}</tbody>
          </table>
        </div>
      </div></div>

      <div class="card sgf mt-3"><div class="card-body">
        <div class="fw-bold">Auditoría</div>
        <div class="small text-secondary mt-1">Registro de cambios (crear/editar/eliminar/importar/exportar/reparar).</div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-outline-dark btn-sm" id="audExport"><i class="bi bi-download"></i> Exportar auditoría</button>
          <button class="btn btn-outline-danger btn-sm" id="audClear"><i class="bi bi-trash3"></i> Limpiar</button>
        </div>
        <div class="table-responsive mt-3" style="max-height:260px;overflow:auto">
          <table class="table table-sm align-middle mb-0">
            <thead class="sticky-top bg-white"><tr><th>Fecha</th><th>Acción</th><th>Entidad</th><th>Detalle</th></tr></thead>
            <tbody>${aRows}</tbody>
          </table>
        </div>
      </div></div>
    `;
    const abEn=$("#abEn"); if(abEn) abEn.value=state.config.autoBackupEnabled?"1":"0";
    const abEvery=$("#abEvery"); if(abEvery) abEvery.value=String(state.config.autoBackupEveryOps||25);
    const abMax=$("#abMax"); if(abMax) abMax.value=String(state.config.autoBackupMax||5);

    const abSave=$("#abSave");
    if(abSave) abSave.addEventListener("click",()=>{
      state.config.autoBackupEnabled = ($("#abEn")?.value==="1");
      state.config.autoBackupEveryOps = Math.max(1,parseInt($("#abEvery")?.value||"25",10)||25);
      state.config.autoBackupMax = Math.max(1,parseInt($("#abMax")?.value||"5",10)||5);
      logEvent("update","config",null,`Auto-backup: ${state.config.autoBackupEnabled} every:${state.config.autoBackupEveryOps} max:${state.config.autoBackupMax}`);
      save();
      toast("Auto-backup guardado.","success");
      settingsEnhance();
    });

    const audExport=$("#audExport");
    if(audExport) audExport.addEventListener("click",()=>exportAudit());
    const audClear=$("#audClear");
    if(audClear) audClear.addEventListener("click",()=>{
      msg({title:"Limpiar auditoría",kind:"warning",body:`Se eliminará el historial de auditoría (no afecta datos financieros).
        <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="audClearOk()"><i class="bi bi-trash3"></i> Sí, limpiar</button></div>`});
    });
  }
}

function renderSettings(){
  const base=baseCur();
  const curOpts=CURRENCIES.map(c=>`<option value="${c.code}">${c.label}</option>`).join("");
  const other=CURRENCIES.filter(c=>c.code!==base);
  const savAccs=state.accounts.filter(a=>a.active && a.type==='Ahorro');
  const savAccOpts=savAccs.map(a=>`<option value="${a.id}">${esc(accPath(a.id)||a.name)} (${esc(a.currency||baseCur())})</option>`).join("");
  const fxRows=other.map(c=>{
    const val=Number(state.config.fxRates?.[c.code]||"");
    const lbl=`1 ${c.code} = ? ${base}`;
    return `<div class="mt-3">
      <label class="form-label">${esc(lbl)}</label>
      <input class="form-control" id="fx_${c.code}" inputmode="decimal" placeholder="Ej: 520" value="${Number.isFinite(val)&&val>0?String(val):""}">
      <div class="small text-secondary mt-1">Se usa como <b>valor por defecto</b> en nuevos movimientos y para consolidar saldos.</div>
    </div>`;
  }).join("");

  const body=`<div class="row g-3 sgf-land-stack">
    <div class="col-12 col-lg-6">
      <div class="card sgf"><div class="card-body">
        <div class="fw-bold">Preferencias</div>
        <div class="mt-2">
          <label class="form-label">Tema</label>
          <div class="btn-group w-100" role="group" aria-label="Tema">
            <button class="btn btn-outline-primary" id="btnThemePro" onclick="setTheme('finpro')"><i class="bi bi-sun"></i> Claro Pro</button>
            <button class="btn btn-outline-primary" id="btnThemeSoft" onclick="setTheme('finsoft')"><i class="bi bi-palette"></i> Claro Suave</button>
            <button class="btn btn-outline-primary" id="btnThemeDark" onclick="setTheme('darkledger')"><i class="bi bi-moon-stars"></i> Dark</button>
          </div>
          <div class="small text-secondary mt-1">Se aplica y guarda automáticamente.</div>
        </div>

        <div class="mt-3">
          <label class="form-label">Menú</label>
          <div class="btn-group w-100" role="group" aria-label="Menú">
            <button class="btn btn-outline-primary" id="btnNavSide" onclick="setNavLayout('side')"><i class="bi bi-layout-sidebar-inset"></i> Lateral</button>
            <button class="btn btn-outline-primary" id="btnNavTop" onclick="setNavLayout('top')"><i class="bi bi-layout-text-window"></i> Superior</button>
          </div>
          <div class="small text-secondary mt-1">Se aplica y guarda automáticamente.</div>
        </div>
        <div class="mt-3"><label class="form-label">Moneda base</label>
          <select class="form-select" id="cfgBase">${curOpts}</select>
          <div class="small text-secondary mt-1">Presupuestos y reportes se consolidan en moneda base. Las cuentas pueden tener otra moneda.</div>
        </div>
        ${fxRows?`<div class="mt-2"><div class="fw-semibold">Tipos de cambio</div>${fxRows}</div>`:""}
        <div id="cfgFxHist" class="mt-3"></div>
        <div class="mt-3"><div class="fw-semibold">Ahorros (SGF)</div>
          <div class="small text-secondary mt-1">Se usa una cuenta por moneda (CRC y USD).</div>
          <div class="mt-2"><label class="form-label">Cuenta Ahorros (SGF) CRC</label>
            <select class="form-select" id="cfgSavC"><option value="">(Automático)</option>${savAccOpts}</select></div>
          <div class="mt-2"><label class="form-label">Cuenta Ahorros (SGF) USD</label>
            <select class="form-select" id="cfgSavU"><option value="">(Automático)</option>${savAccOpts}</select></div>
        </div>
        <div class="d-grid gap-2 mt-3"><button class="btn btn-dark" onclick="cfgSave()"><i class="bi bi-check2"></i> Guardar</button></div>
      </div></div>

      <div class="card sgf mt-3"><div class="card-body">
        <div class="fw-bold">Backups (JSON)</div>
        <div class="small text-secondary mt-1">Recomendado: exporta antes de limpiar datos.</div>
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-outline-dark" onclick="exportJson()"><i class="bi bi-download"></i> Exportar</button>
          <div class="input-group">
            <input type="file" class="form-control" id="impF" accept="application/json">
            <button class="btn btn-dark" onclick="importJson()"><i class="bi bi-upload"></i> Importar</button>
          </div>
        </div>
      </div></div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card sgf"><div class="card-body">
        <div class="fw-bold">Datos</div>
        <div class="small text-secondary mt-1">Incluye <b>datos de prueba grandes</b> para pruebas.</div>
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-outline-primary" onclick="loadDefaults()"><i class="bi bi-magic"></i> Cargar estructura</button>
          <button class="btn btn-outline-success" onclick="loadBigDemo()"><i class="bi bi-database-add"></i> Cargar demo grande</button>
          <button class="btn btn-outline-danger" onclick="resetAll()"><i class="bi bi-trash"></i> Reset completo</button>
<button class="btn btn-outline-dark" onclick="showDiagnostics()"><i class="bi bi-wrench-adjustable"></i> Diagnóstico y reparar</button>
        </div>
        <hr class="my-3"/>
        <div id="cfgExtra"></div>
</div></div>
    </div>
</div>`;

  $("#v-settings").innerHTML=card("Configuración",
    `<button class="btn btn-outline-dark" onclick="help('settings')"><i class="bi bi-question-circle"></i> Ayuda</button>`,
    body
  );
  $("#cfgBase").value=base;
  const sc=$("#cfgSavC"); if(sc){sc.value=state.config.savingsAccountId||""; sortSelectOptions("#cfgSavC",true);}
  const su=$("#cfgSavU"); if(su){su.value=state.config.savingsAccountIdUSD||""; sortSelectOptions("#cfgSavU",true);} 
  updateThemeButtons();
  try{ settingsEnhance(); }catch(e){console.error(e);}

}
function cfgSave(){
  const newBase=$("#cfgBase").value||"CRC";
  // safety: changing base currency does not convert history
  if(newBase!==state.config.baseCurrency && state.movements.length){
    msg({title:"No permitido",kind:"warning",body:"Cambiar la <b>moneda base</b> con movimientos existentes no está permitido (no convierte historial). Exporta/Reset si deseas cambiarla."});
    $("#cfgBase").value=state.config.baseCurrency||"CRC";
    return;
  }
  state.config.baseCurrency=newBase;
  state.config.fxRates=state.config.fxRates||{};
  // savings accounts (optional override)

  const sc=document.getElementById("cfgSavC");
  const su=document.getElementById("cfgSavU");
  if(sc && sc.value) state.config.savingsAccountId=sc.value;
  if(su && su.value) state.config.savingsAccountIdUSD=su.value;

  // read fx inputs for other currencies
  for(const c of CURRENCIES){
    if(c.code===newBase) continue;
    const el=document.getElementById(`fx_${c.code}`);
    if(!el) continue;
    const v=parseAmount(el.value);
    if(Number.isFinite(v)&&v>0) state.config.fxRates[c.code]=v;
  }

  for(const r of state.recurrings){
    if(r.active===undefined) r.active=true;
    if(r.name===undefined) r.name="";
    if(r.type===undefined) r.type="Gasto";
    if(r.accountId===undefined) r.accountId=null;
    if(r.accountToId===undefined) r.accountToId=null;
    if(r.categoryId===undefined) r.categoryId=null;
    if(r.amount===undefined) r.amount=0;
    if(r.day===undefined) r.day=1;
    if(r.regOffset===undefined) r.regOffset=0; // -1 mes anterior, 0 mismo mes, +1 mes siguiente
    if(r.startPeriod===undefined) r.startPeriod=null;
    if(r.endPeriod===undefined) r.endPeriod=null;
    if(r.desc===undefined) r.desc="";
  }

  ensureSavingsAccount();
  normalizeCurrencyModel();
  logEvent("update","config",null,"Configuración guardada");
  save();
  toast("Configuración guardada.","success");
  render(state.ui.route);
}
function mergeImportedState(obj){
  const rep={mode:"merge",at:new Date().toISOString(),added:{},updated:{},warnings:[]};
  const byId=(arr)=>{ const m=new Map(); for(const x of (arr||[])){ if(x?.id) m.set(x.id,x); } return m; };

  // config merge: keep current baseCurrency, merge fxRates, merge fxHistory (dedupe by currency+date)
  const curCfg=state.config||{};
  const inCfg=obj.config||{};
  const base=curCfg.baseCurrency||inCfg.baseCurrency||"CRC";
  const fx=Object.assign({},curCfg.fxRates||{},inCfg.fxRates||{});
  const hist=[...(Array.isArray(curCfg.fxHistory)?curCfg.fxHistory:[])];
  const seen=new Set(hist.map(h=>`${h?.currency||""}|${h?.date||""}`));
  for(const h of (Array.isArray(inCfg.fxHistory)?inCfg.fxHistory:[])){
    const key=`${h?.currency||""}|${h?.date||""}`;
    if(!h||!h.currency||!h.date) continue;
    const r=Number(h.rate);
    if(!(Number.isFinite(r)&&r>0)) continue;
    if(!seen.has(key)){ hist.push({currency:h.currency,date:String(h.date),rate:r}); seen.add(key); }
  }
  const autoBackupEnabled = (inCfg.autoBackupEnabled!==undefined) ? inCfg.autoBackupEnabled : (curCfg.autoBackupEnabled!==undefined?curCfg.autoBackupEnabled:true);
  const autoBackupEveryOps = Number(inCfg.autoBackupEveryOps||curCfg.autoBackupEveryOps||25);
  const autoBackupMax = Number(inCfg.autoBackupMax||curCfg.autoBackupMax||5);

  state.config={...curCfg,...inCfg,baseCurrency:base,fxRates:fx,fxHistory:hist,autoBackupEnabled,autoBackupEveryOps,autoBackupMax};
  rep.updated.config=1;

  const mergeArr=(name, targetArr, incomingArr)=>{
    const t=byId(targetArr); const added=[]; const updated=[];
    for(const it of (incomingArr||[])){
      if(!it||!it.id) continue;
      if(t.has(it.id)){ t.set(it.id,{...t.get(it.id),...it}); updated.push(it.id); }
      else { t.set(it.id,it); added.push(it.id); }
    }
    state[name]=[...t.values()];
    rep.added[name]=added.length;
    rep.updated[name]=updated.length;
  };

  mergeArr("accounts", state.accounts, obj.accounts);
  mergeArr("categories", state.categories, obj.categories);
  mergeArr("movements", state.movements, obj.movements);
  mergeArr("budgets", state.budgets, obj.budgets);
  mergeArr("goals", state.goals, obj.goals);
  mergeArr("recurrings", state.recurrings, obj.recurrings);
  mergeArr("reconciliations", state.reconciliations, obj.reconciliations);

  const aCur=Array.isArray(state.audit)?state.audit:[];
  const aIn=Array.isArray(obj.audit)?obj.audit:[];
  state.audit=[...aCur,...aIn].slice(-AUDIT_MAX);
  rep.updated.audit=aIn.length;

  state.meta=state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
  state.meta.lastImportReport=rep;

  sanitizeState();
  save();
  return rep;
}

function showImportReport(rep){
  try{
    const a=rep?.added||{}; const u=rep?.updated||{};
    const rows=[
      ["Cuentas",a.accounts||0,u.accounts||0],
      ["Categorías",a.categories||0,u.categories||0],
      ["Movimientos",a.movements||0,u.movements||0],
      ["Presupuestos",a.budgets||0,u.budgets||0],
      ["Recurrentes",a.recurrings||0,u.recurrings||0],
      ["Conciliaciones",a.reconciliations||0,u.reconciliations||0],
      ["Auditoría",0,u.audit||0],
      ["Config",0,u.config||0]
    ];
    const tb=rows.map(r=>`<tr><td>${esc(r[0])}</td><td class="text-end">${esc(String(r[1]))}</td><td class="text-end">${esc(String(r[2]))}</td></tr>`).join("");
    const warn=(rep?.warnings||[]).map(w=>`<li>${esc(w)}</li>`).join("");
    msg({title:"Resultado de importación",kind:"success",body:`<div class="small text-secondary">Modo: <b>${esc(rep.mode||"")}</b> • ${esc(rep.at||"")}</div>
      <div class="table-responsive mt-2"><table class="table table-sm align-middle">
        <thead><tr><th>Entidad</th><th class="text-end">Agregados</th><th class="text-end">Actualizados</th></tr></thead>
        <tbody>${tb}</tbody>
      </table></div>
      ${warn?`<div class="mt-2"><div class="fw-semibold">Advertencias</div><ul class="mb-0">${warn}</ul></div>`:""}
    `});
  }catch{}
}

function importJson(mode="replace"){
  const f=$("#impF").files?.[0];
  if(!f){msg({title:"Importar",kind:"warning",body:"Seleccione un JSON."});return}
  const r=new FileReader();r.onload=()=>{
    try{
      const d=JSON.parse(String(r.result||"{}"));
      const obj=d.config?d:(d[STORAGE_KEY]||d);
      if(!obj.config||!Array.isArray(obj.accounts)||!Array.isArray(obj.categories)||!Array.isArray(obj.movements)||!Array.isArray(obj.budgets)){
        msg({title:"Importar",kind:"danger",body:"El JSON no tiene estructura válida."});return;
      }
      if(mode==="merge"){
        const rep=mergeImportedState(obj);
        logEvent("import-merge","system",null,`Import merge: +A:${rep.added.accounts} +C:${rep.added.categories} +M:${rep.added.movements} +B:${rep.added.budgets}`);
        toast("Datos importados (fusionados).","success");
        render(state.ui.route);
        
        try{ sessionStorage.removeItem(AUTH_SESSION_KEY); }catch{}
        try{ if(state?.config?.auth?.enabled){ authShow('login'); } }catch{}
showImportReport(rep);
      }else{
        applyImportedState(obj);
        state.meta=state.meta||{opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};
        state.meta.lastImportReport={mode:"replace",at:new Date().toISOString()};
        logEvent("import-replace","system",null,"Import replace");
        toast("Datos importados.","success");
        render(state.ui.route);
      
        try{ sessionStorage.removeItem(AUTH_SESSION_KEY); }catch{}
        try{ if(state?.config?.auth?.enabled){ authShow('login'); } }catch{}
}
    }catch(e){
      console.error(e);
      msg({title:"Importar",kind:"danger",body:"No se pudo leer el JSON."})
    }
  };
  r.readAsText(f);
}

function exportJson(){
  try{
    const ver = (typeof APP_VERSION!=="undefined" && APP_VERSION) ? APP_VERSION : "v1.0";
    const payload={
      meta:{app:"SGF",version:ver,exportedAt:new Date().toISOString()},
      config:state.config,
      accounts:state.accounts,
      categories:state.categories,
      movements:state.movements,
      budgets:state.budgets,
      goals:state.goals,
      recurrings:state.recurrings,
      reconciliations:state.reconciliations,
      audit:state.audit,
      meta:state.meta
    };
    const json=JSON.stringify(payload,(k,v)=>{
      if(v instanceof Map) return [...v.entries()];
      if(v instanceof Set) return [...v];
      if(typeof v==="function") return undefined;
      if(typeof v==="number" && !Number.isFinite(v)) return null;
      return v;
    },2);
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    const d=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const stamp=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    a.href=url;
    a.download=`SGF_backup_${ver}_${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),500);
    logEvent("export","system",null,`Export JSON (${ver})`);
    toast("Exportación generada.","success");
  }catch(e){
    console.error(e);
    msg({title:"Exportar",kind:"danger",body:"No se pudo exportar el JSON. Abre la consola (F12) para ver el error y usa la versión corregida."});
  }
}

function csvDialog(){
  msg({
    title:"Exportar CSV",
    kind:"info",
    body:`
      <div class="d-grid gap-2">
        <button class="btn btn-outline-dark" onclick="exportCsv('mov')"><i class="bi bi-table"></i> Movimientos</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('sav')"><i class="bi bi-piggy-bank"></i> Ahorros</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('bud')"><i class="bi bi-bar-chart-steps"></i> Presupuestos</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('recon')"><i class="bi bi-check2-square"></i> Conciliaciones</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('pivot')"><i class="bi bi-grid-3x3-gap"></i> Reporte Pro (Pivot)</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('cash')"><i class="bi bi-graph-up"></i> Cashflow</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('trend')"><i class="bi bi-activity"></i> Tendencias</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('budroot')"><i class="bi bi-diagram-3"></i> Presupuesto vs Real (Raíz)</button>
        <button class="btn btn-outline-dark" onclick="exportCsv('stmt')"><i class="bi bi-receipt"></i> Estado de cuenta</button>
      </div>
      <div class="small text-secondary mt-2">
        Nota: en Movimientos, los <b>splits</b> de gastos se exportan como filas separadas.
      </div>`
  });
}

function csvCell(v){
  if(v===null||v===undefined) return "";
  const s=String(v);
  if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function rowsToCsv(rows){
  const allKeys=new Set();
  rows.forEach(r=>Object.keys(r||{}).forEach(k=>allKeys.add(k)));
  const headers=[...allKeys];
  const lines=[headers.map(csvCell).join(",")];
  for(const r of rows){
    lines.push(headers.map(h=>csvCell(r?.[h]??"")).join(","));
  }
  return lines.join("\n");
}
function downloadCsv(filename, csvText){
  const blob=new Blob([csvText],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),500);
}

function exportCsv(kind){
  try{
    const ver = (typeof APP_VERSION!=="undefined" && APP_VERSION) ? APP_VERSION : "v1.0";
    const d=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const stamp=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    const base=baseCur();

    let rows=[], fname=`SGF_${kind}_${ver}_${stamp}.csv`;

    if(kind==="mov"){
      rows=[];
      for(const m of state.movements){
        if(!m) continue;
        const t=String(m.type||"");
        if(!["Ingreso","Gasto","Transferencia","Ahorro","RetiroAhorro"].includes(t)) continue;
        const fromAcc=accPath(m.accountId)||"";
        const toAcc=m.accountToId?(accPath(m.accountToId)||""):"";
        const cur=m.currency||accCur(m.accountId)||base;
        const rate=Number(m.rateToBase||"");
        const common={
          id:m.id,date:m.date||"",period:m.period||"",type:t,
          cuentaOrigen:fromAcc,cuentaDestino:toAcc,
          categoria:catPath(m.categoryId)||"",
          moneda:cur,
          monto:Number(m.amount||0),
          montoBase:Number(m.amountBase!=null?m.amountBase:""),
          montoDestino:Number(m.amountTo!=null?m.amountTo:""),
          monedaDestino:(m.currencyTo||accCur(m.accountToId)||""),
          descripcion:m.desc||"",
          sistema:!!m.isSystem,
          saldoInicial:!!m.isOpening,
          reconciliado:!!m.reconciled,
          mesConciliacion:m.reconMonth||"",
          fxRate:(Number.isFinite(rate)&&rate>0)?rate:""
        };

        if(t==="Gasto" && Array.isArray(m.splits) && m.splits.length){
          let idx=0;
          for(const s of m.splits){
            idx++;
            const sb=Number(s.amountBase!=null?s.amountBase:"");
            rows.push({
              ...common,
              splitIndex:idx,
              splitCategoria:catPath(s.categoryId)||"",
              splitMonto:Number(s.amount||0),
              splitMontoBase:Number.isFinite(sb)?sb:""
            });
          }
        }else{
          rows.push({...common, splitIndex:"", splitCategoria:"", splitMonto:"", splitMontoBase:""});
        }
      }
    }
    else if(kind==="sav"){
      rows=[];
      for(const m of state.movements){
        if(!m) continue;
        const t=String(m.type||"");
        if(!["Ahorro","RetiroAhorro"].includes(t)) continue;
        const baseRow={
          id:m.id,date:m.date||"",period:m.period||"",type:t,
          cuentaOrigen:accPath(m.accountId)||"",
          cuentaDestino:m.accountToId?(accPath(m.accountToId)||""):"",
          categoria:catPath(m.categoryId)||"",
          moneda:(m.currency||accCur(m.accountId)||base),
          monto:Number(m.amount||0),
          montoBase:Number(m.amountBase!=null?m.amountBase:""),
          descripcion:m.desc||""
        };
        rows.push(baseRow);
      }
      fname=`SGF_ahorros_${ver}_${stamp}.csv`;
    }
    else if(kind==="bud"){
      rows = state.budgets.map(b=>({
        id:b.id,
        tipo:b.type||"",
        recurrente:!!b.isRecurring,
        periodo:b.period||"",
        periodoDesde:b.periodFrom||"",
        periodoHasta:b.periodTo||"",
        categoria:catPath(b.categoryId)||"",
        monto:Number(b.amount||0),
        descripcion:b.desc||""
      }));
      fname=`SGF_presupuestos_${ver}_${stamp}.csv`;
    }
    else if(kind==="recon"){
      rows=[];
      const months = (()=> {
        if(state.ui.rM) return [state.ui.rM];
        if(state.ui.rY) return months().filter(p=>p.startsWith(String(state.ui.rY)+"-")).sort();
        return lastNMonths(currentPeriod(),12);
      })();
      const monthSet=new Set(months);
      const recs=Array.isArray(state.reconciliations)?state.reconciliations.filter(r=>r && monthSet.has(r.month)):[];
      for(const r of recs){
        const accId=r.accountId;
        const cur=accCur(accId);
        const rg=dateRangeForMonth(r.month); if(!rg) continue;
        const endBal=accBalanceAt(accId, rg.end);
        const diff=Number(r.end||0) - Number(endBal||0);
        rows.push({
          id:r.id,
          cuenta:accPath(accId)||"",
          mes:r.month,
          moneda:cur,
          estadoCuentaInicio:Number(r.start||0),
          estadoCuentaFinal:Number(r.end||0),
          ledgerFinal:Number(endBal||0),
          diferencia:Number.isFinite(diff)?diff:"",
          cerrado:!!r.closed,
          actualizado:r.updatedAt||""
        });
      }
      fname=`SGF_conciliaciones_${ver}_${stamp}.csv`;
    }
        else if(kind==="pivot"){
      const data = repProData();
      const periods = data.periods||[];
      const groups = data.groups||{};
      const order = data.order||["Ingreso","Gasto","Ahorro"];
      rows=[];
      for(const g of order){
        const arr = groups[g]||[];
        for(const r of arr){
          const obj={grupo:(data.groupLabel?.[g]||g),categoria:r.name,total:Number(r.total||0)};
          periods.forEach(p=> obj[p]=Number(r.byPeriod?.get(p)||0));
          rows.push(obj);
        }

    if(kind==="cash"){
      const base=baseCur();
      const end=state.ui.rM||currentPeriod();
      const periods=lastNMonths(end,12);
      const perSet=new Set(periods);
      const inc=new Map(periods.map(p=>[p,0]));
      const exp=new Map(periods.map(p=>[p,0]));
      const sav=new Map(periods.map(p=>[p,0]));
      for(const m of (state.movements||[])){
        if(!m) continue;
        if(m.isOpening || m.isSystem) continue;
        if(!perSet.has(m.period)) continue;
        const t=String(m.type||"");
        if(t==="Ingreso"){
          inc.set(m.period,(inc.get(m.period)||0)+Math.abs(movAmtBase(m)));
        }else if(t==="Gasto"){
          if(movementHasSplit(m)){
            for(const s of (m.splits||[])){
              const v = Number.isFinite(Number(s.amountBase)) ? Number(s.amountBase) : movAmtBase({ ...m, amount:s.amount, amountBase:null });
              exp.set(m.period,(exp.get(m.period)||0)+Math.abs(Number(v)||0));
            }
          }else{
            exp.set(m.period,(exp.get(m.period)||0)+Math.abs(movAmtBase(m)));
          }
        }else if(t==="Ahorro" || t==="RetiroAhorro"){
          const sign=(t==="RetiroAhorro")?-1:1;
          sav.set(m.period,(sav.get(m.period)||0)+sign*Math.abs(movAmtBase(m)));
        }
      }
      rows = [["periodo","ingresos_base","gastos_base","ahorros_neto_base","flujo_neto_base","disponible_base"]];
      for(const p of periods){
        const I=inc.get(p)||0, E=exp.get(p)||0, S=sav.get(p)||0;
        const net=I-E;
        const disp=net-S;
        rows.push([p, I, E, S, net, disp]);
      }
      fname=`SGF_cashflow_${ver}_${stamp}.csv`;
    }

    if(kind==="trend"){
      const data=repTrendData();
      rows=[["periodo","alcance","idAlcance","etiqueta","metrica","presupuesto_base","real_base","diferencia_base","pct"]];
      if(data.error){
        rows.push(["","","",data.error,"","","","",""]);
      }else{
        for(const r of (data.rows||[])){
          rows.push([
            r.period,
            data.scope,
            data.scopeId,
            data.scopeLabel,
            data.metric,
            (r.bud==null)?"":Number(r.bud||0),
            Number(r.act||0),
            (r.diff==null)?"":Number(r.diff||0),
            (r.pct==null)?"":Number(r.pct||0)
          ]);
        }
      }
      fname=`SGF_tendencias_${ver}_${stamp}.csv`;
    }

    if(kind==="budroot"){
      const period=state.ui.rM||currentPeriod();
      const roots=state.categories.filter(c=>c.active && !c.parentId);
      const buds=effectiveBudgets(period,null);
      const actG=actualByCat(period,"Gasto");
      const actI=actualByCat(period,"Ingreso");

      const sum=(map,k,v)=>map.set(k,(map.get(k)||0)+(Number(v)||0));
      const budG=new Map(), budI=new Map(), actGr=new Map(), actIr=new Map();

      for(const b of buds){
        const r=catRootId(b.categoryId); if(!r) continue;
        if(b.type==="Gasto") sum(budG,r,b.amount);
        if(b.type==="Ingreso") sum(budI,r,b.amount);
      }
      for(const [cid,v] of actG.entries()){const r=catRootId(cid); if(r) sum(actGr,r,v);}
      for(const [cid,v] of actI.entries()){const r=catRootId(cid); if(r) sum(actIr,r,v);}

      rows=[["periodo","tipo","raiz","presupuesto_base","real_base","diferencia_base","pct"]];
      for(const r of roots){
        const b=Number(budG.get(r.id)||0), a=Number(actGr.get(r.id)||0);
        if(b||a){
          const diff=b-a; const pct=b? (a/b)*100 : "";
          rows.push([period,"Gasto",r.name,b,a,diff,pct]);
        }
      }
      for(const r of roots){
        const b=Number(budI.get(r.id)||0), a=Number(actIr.get(r.id)||0);
        if(b||a){
          const diff=a-b; const pct=b? (a/b)*100 : "";
          rows.push([period,"Ingreso",r.name,b,a,diff,pct]);
        }
      }
      fname=`SGF_presupuesto_vs_real_raiz_${ver}_${stamp}.csv`;
    }

    if(kind==="stmt"){
      const accId=state.ui.stAcc||"";
      const from=String(state.ui.stFrom||"").trim();
      const to=String(state.ui.stTo||"").trim();
      const showSys=!!state.ui.stSys;
      const showOpen=!!state.ui.stOpen;
      const typeF=String(state.ui.stType||"").trim();
      const group=String(state.ui.stGroup||"day").trim();
      const q=String(state.ui.stQ||"").trim().toLowerCase();

      const acc=state.accounts.find(a=>a.id===accId);
      if(!accId || !acc){ throw new Error("Selecciona una cuenta en Reportes > Estado de cuenta para exportar."); }

      const base=baseCur();
      const cur=acc.currency||base;
      const showBase = cur!==base;
      const affects=(m)=>(m.accountId===accId || m.accountToId===accId);

      const items=[];
      for(const m of (state.movements||[])){
        if(!m||!m.date) continue;
        if(!affects(m)) continue;
        if(!showSys && m.isSystem) continue;
        if(!showOpen && m.isOpening) continue;
        if(from && String(m.date)<from) continue;
        if(to && String(m.date)>to) continue;
        const t=String(m.type||"");
        if(!["Ingreso","Gasto","Transferencia","Ahorro","RetiroAhorro"].includes(t)) continue;
        if(typeF && t!==typeF) continue;

        let delta=0;
        if(t==="Ingreso"){
          if(m.accountId===accId) delta = Number(m.amount)||0;
        }else if(t==="Gasto"){
          if(m.accountId===accId) delta = -Math.abs(Number(m.amount)||0);
        }else{
          if(m.accountId===accId) delta = -Math.abs(Number(m.amount)||0);
          else if(m.accountToId===accId){
            const toAmt=Number.isFinite(Number(m.amountTo))?Number(m.amountTo):Number(m.amount)||0;
            delta = Math.abs(toAmt);
          }
        }
        if(!delta) continue;

        const cat = m.categoryId ? (catPath(m.categoryId)||"") : (movementHasSplit(m) ? "Split" : "");
        const desc = m.desc||"";
        let counter="";
        if(t==="Transferencia"){
          if(m.accountId===accId && m.accountToId) counter = `A: ${accPath(m.accountToId)||""}`;
          else if(m.accountToId===accId && m.accountId) counter = `De: ${accPath(m.accountId)||""}`;
        }

        let rate=1, deltaBase="";
        if(showBase){
          if(m.accountId===accId){
            rate = (Number.isFinite(Number(m.rateToBase)) && Number(m.rateToBase)>0) ? Number(m.rateToBase) : (fxRateAt(cur,m.date)||fxRate(cur)||1);
          }else{
            rate = (Number.isFinite(Number(m.rateToBaseTo)) && Number(m.rateToBaseTo)>0) ? Number(m.rateToBaseTo) : (fxRateAt(cur,m.date)||fxRate(cur)||1);
          }
          const db = toBase(delta,cur,rate);
          deltaBase = Number.isFinite(db) ? db : 0;
        }

        const hay=(t+" "+cat+" "+desc+" "+counter).toLowerCase();
        if(q && !hay.includes(q)) continue;

        items.push({date:m.date, period:m.period||"", type:t, counter, cat, desc, delta, deltaBase, rate, isSystem:!!m.isSystem, isOpening:!!m.isOpening, reconciled:!!m.reconciled});
      }

      items.sort((a,b)=>String(a.date).localeCompare(String(b.date)));

      let bal = from ? accBalanceAt(accId, dateMinus1(from)) : 0;

      rows=[["cuenta","moneda","base","desde","hasta","grupo","fecha","periodo","tipo","contra_cuenta","categoria","descripcion","entrada","salida","saldo","delta_base","rate_to_base","sistema","saldo_inicial","conciliado"]];
      for(const x of items){
        bal += x.delta;
        const entrada = x.delta>0?x.delta:"";
        const salida = x.delta<0?(-x.delta):"";
        const g = (group==="month") ? String(x.date).slice(0,7) : (group==="day") ? String(x.date) : "";
        rows.push([
          accPath(accId), cur, base, from, to, g,
          x.date, x.period, x.type, x.counter, x.cat, x.desc,
          entrada, salida, bal,
          showBase?x.deltaBase:"", showBase?x.rate:"",
          x.isSystem?1:0, x.isOpening?1:0, x.reconciled?1:0
        ]);
      }
      fname=`SGF_estado_cuenta_${ver}_${stamp}.csv`;
    }
      }
      fname=`SGF_reportePro_pivot_${ver}_${stamp}.csv`;
    }

    if(!rows.length){ msg({title:"Exportar CSV",kind:"warning",body:"No hay datos para exportar."}); return; }

    const csv=rowsToCsv(rows);
    downloadCsv(fname,csv);
    logEvent("export-csv","system",null,`Export CSV ${kind}`);
    toast("CSV generado.","success");
  }catch(e){
    console.error(e);
    msg({title:"Exportar CSV",kind:"danger",body:"No se pudo exportar el CSV. Abre la consola (F12) para ver el error."});
  }
}



function canDeleteAccount(id){
  if(!id) return {ok:false,reason:"Id inválido."};
  if(id===state.config?.savingsAccountId || id===state.config?.savingsAccountIdUSD) return {ok:false,reason:"No se puede eliminar <b>Ahorros (SGF)</b>."};
  if(state.accounts.some(a=>a.parentId===id)) return {ok:false,reason:"No se puede eliminar una cuenta con <b>subcuentas</b>."};
  if(state.movements.some(m=>m && !m.isOpening && (m.accountId===id || m.accountToId===id))) return {ok:false,reason:"No se puede eliminar una cuenta con <b>movimientos</b>."};
  for(const b of (state.budgets||[])){
    if(!b) continue;
    if(b.accountId===id) return {ok:false,reason:"No se puede eliminar una cuenta usada en <b>Presupuestos</b>."};
    const items=b.items||b.lines||b.rows;
    if(Array.isArray(items)){
      for(const it of items){ if(it && it.accountId===id) return {ok:false,reason:"No se puede eliminar una cuenta usada en <b>Presupuestos</b>."}; }
    }
  }
  return {ok:true,reason:""};
}
function accDelete(id){
  const a=state.accounts.find(x=>x.id===id);
  if(!a){msg({title:"Eliminar",kind:"warning",body:"Cuenta no encontrada."});return}
  const chk=canDeleteAccount(id);
  if(!chk.ok){msg({title:"No permitido",kind:"warning",body:chk.reason});return}
  msg({title:"Eliminar cuenta",kind:"warning",body:`Se eliminará la cuenta <b>${esc(a.name)}</b>.<br>Esta acción no se puede deshacer.
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="accDeleteOk('${id}')"><i class="bi bi-trash"></i> Eliminar</button></div>`});
}
function accDeleteOk(id){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  state.accounts = state.accounts.filter(x=>x.id!==id);
  // borrar saldo inicial (si existiera)
  state.movements = state.movements.filter(m=>!(m && m.isOpening && m.accountId===id));
  // borrar conciliaciones de la cuenta
  state.reconciliations = (state.reconciliations||[]).filter(r=>!(r && r.accountId===id));
  // si estaba seleccionada
  if(state.ui.selAcc===id) state.ui.selAcc=null;
  logEvent("delete","account",id,accById(id)?.name||"");
  save(); toast("Cuenta eliminada.","success");
  renderAccounts();
}

function canDeleteCategory(id){
  if(!id) return {ok:false,reason:"Id inválido."};
  if(state.categories.some(c=>c.parentId===id)) return {ok:false,reason:"No se puede eliminar una categoría con <b>subcategorías</b>."};
  if(catUsageCount(id)>0) return {ok:false,reason:"No se puede eliminar una categoría <b>en uso</b> (movimientos, splits, presupuestos o recurrentes)."};
  return {ok:true,reason:""};
}
function catDelete(id){
  const c=state.categories.find(x=>x.id===id);
  if(!c){msg({title:"Eliminar",kind:"warning",body:"Categoría no encontrada."});return}
  const chk=canDeleteCategory(id);
  if(!chk.ok){msg({title:"No permitido",kind:"warning",body:chk.reason});return}
  msg({title:"Eliminar categoría",kind:"warning",body:`Se eliminará la categoría <b>${esc(c.name)}</b>.<br>Esta acción no se puede deshacer.
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="catDeleteOk('${id}')"><i class="bi bi-trash"></i> Eliminar</button></div>`});
}
function catDeleteOk(id){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  state.categories = state.categories.filter(x=>x.id!==id);
  if(state.ui.selCat===id) state.ui.selCat=null;
  logEvent("delete","category",id,catById(id)?.name||"");
  save(); toast("Categoría eliminada.","success");
  renderCategories();
}

function resetAll(){
  msg({title:"Reset completo",kind:"warning",body:`Esto borrará todos los datos del dispositivo.
    <div class="d-grid gap-2 mt-3"><button class="btn btn-danger" onclick="resetOk()"><i class="bi bi-trash"></i> Sí, borrar</button></div>`});
}
function resetOk(){
  bootstrap.Modal.getInstance($("#msgM"))?.hide();
  try{
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(COLL_KEYS.acc);
    localStorage.removeItem(COLL_KEYS.cat);
    localStorage.removeItem(BACKUP_KEY);
  }catch{}

  state.config={
    baseCurrency:"CRC",
    fxRates:{USD:520},
    fxHistory:[],
    savingsAccountId:null,
    savingsAccountIdUSD:null,
    autoBackupEnabled:true,
    autoBackupEveryOps:25,
    autoBackupMax:5
  };

  state.accounts=[];
  state.categories=[];
  state.movements=[];
  state.budgets=[];
  state.goals=[];
  state.recurrings=[];
  state.reconciliations=[];
  state.audit=[];
  state.meta={opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};

  state.ui.selAcc=null;state.ui.selCat=null;
  state.ui.accCol=new Set();state.ui.catCol=new Set();

  ensureSavingsAccount();
  save();
  toast("Datos eliminados.","success");
  go("dashboard");
}
function loadDefaults(){
  if(!isBootstrapEmpty()){msg({title:"Estructura",kind:"warning",body:"Ya existen datos. Usa <b>Reset completo</b> si quieres reiniciar."});return}
  // limpiar para evitar duplicados (incluye cuentas SGF)
  state.accounts=[];state.categories=[];state.movements=[];state.budgets=[];state.goals=[];state.recurrings=[];state.reconciliations=[];state.audit=[];
  state.meta={opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};

  // reset UI (selecciones y colapsados)
  state.ui.selAcc=null;state.ui.selCat=null;
  state.ui.accCol=new Set();state.ui.catCol=new Set();
  try{ localStorage.removeItem(COLL_KEYS.acc); localStorage.removeItem(COLL_KEYS.cat); }catch{}

  const preset = (typeof STRUCTURE_PRESET_JKSOTOROJAS!=="undefined") ? STRUCTURE_PRESET_JKSOTOROJAS : null;
  if(!preset || !Array.isArray(preset.accounts) || !Array.isArray(preset.categories)){
    msg({title:"Estructura",kind:"warning",body:"No se encontró una estructura predefinida válida."});
    return;
  }

  const clone = (x)=> (typeof structuredClone==="function") ? structuredClone(x) : JSON.parse(JSON.stringify(x));

  // config base + preset (sin cargar datos reales)
  const defCfg={theme:"finpro",navLayout:"side",baseCurrency:"CRC",fxRates:{USD:520},fxHistory:[],savingsAccountId:null,savingsAccountIdUSD:null,autoBackupEnabled:true,autoBackupEveryOps:25,autoBackupMax:5};
  state.config = Object.assign({}, defCfg, state.config||{}, preset.config||{});
  state.config.theme = normalizeTheme(state.config.theme);
  state.config.navLayout = normalizeNavLayout(state.config.navLayout);
  applyTheme(state.config.theme);
  applyNavLayout(state.config.navLayout);

  // estructura
  state.accounts = clone(preset.accounts||[]);
  state.categories = clone(preset.categories||[]);

  // normalizar (campos requeridos + colores seguros)
  for(const a of state.accounts){
    if(!a) continue;
    if(!a.id) a.id=uuid();
    a.name = String(a.name||"").trim() || "Cuenta";
    a.type = String(a.type||"Banco");
    a.parentId = a.parentId ? String(a.parentId) : null;
    a.active = (a.active!==false);
    a.color = safeColor(a.color,"#111827");
    a.currency = a.currency ? String(a.currency) : state.config.baseCurrency;
    if(a.allowNegative===undefined) a.allowNegative = (a.type==="Tarjeta");
  }
  for(const c of state.categories){
    if(!c) continue;
    if(!c.id) c.id=uuid();
    c.name = String(c.name||"").trim() || "Categoría";
    c.parentId = c.parentId ? String(c.parentId) : null;
    c.active = (c.active!==false);
    c.color = safeColor(c.color,"#9ca3af");
  }

  ensureSavingsAccount();
  normalizeCurrencyModel(); // herencias/consistencia (moneda/color + conversiones)

  save();
  toast("Estructura cargada (categorías y cuentas).","success");
  render(state.ui.route);
}
function loadBigDemo(){
  if(!isBootstrapEmpty()){
    msg({title:"Demo",kind:"warning",body:"Ya existen datos. Usa <b>Reset completo</b> primero."});
    return;
  }

  // limpiar (para evitar duplicados si existían cuentas SGF)
  state.accounts=[];
  state.categories=[];
  state.movements=[];
  state.budgets=[];
  state.goals=[];
  state.recurrings=[];
  state.reconciliations=[];
  state.audit=[];
  state.meta={opCount:0,lastBackupAt:null,lastImportReport:null,lastRepairReport:null};

  const b=baseCur();

  // =========================
  // Cuentas (3 niveles máx)
  // =========================
  const grpCash={id:uuid(),name:"Efectivo",type:"Efectivo",parentId:null,active:true,color:"#111827",currency:b};
  const grpBanks={id:uuid(),name:"Bancos",type:"Banco",parentId:null,active:true,color:"#0d6efd",currency:b};
  const grpCards={id:uuid(),name:"Tarjetas",type:"Tarjeta",parentId:null,active:true,color:"#f59e0b",currency:b};
  const grpInvest={id:uuid(),name:"Inversiones",type:"Banco",parentId:null,active:true,color:"#16a34a",currency:b};

  const bankCRC={id:uuid(),name:"BAC Colones",type:"Banco",parentId:grpBanks.id,active:true,color:"#2563eb",currency:"CRC"};
  const bankUSD={id:uuid(),name:"BAC Dólares",type:"Banco",parentId:grpBanks.id,active:true,color:"#1d4ed8",currency:"USD"};
  const bank2CRC={id:uuid(),name:"BCR Colones",type:"Banco",parentId:grpBanks.id,active:true,color:"#3b82f6",currency:"CRC"};
  const wallet={id:uuid(),name:"Billetera",type:"Efectivo",parentId:grpCash.id,active:true,color:"#374151",currency:"CRC"};

  const cardCRC={id:uuid(),name:"BAC Walmart Colones",type:"Tarjeta",parentId:grpCards.id,active:true,color:"#fbbf24",currency:"CRC"};
  const cardUSD={id:uuid(),name:"BAC Amex Dólares",type:"Tarjeta",parentId:grpCards.id,active:true,color:"#f59e0b",currency:"USD"};

  const invCRC={id:uuid(),name:"Fondo inversión (CRC)",type:"Banco",parentId:grpInvest.id,active:true,color:"#22c55e",currency:"CRC"};

  state.accounts.push(grpCash,grpBanks,grpCards,grpInvest,bankCRC,bankUSD,bank2CRC,wallet,cardCRC,cardUSD,invCRC);
  ensureSavingsAccount();

  // =========================
  // Categorías (3 niveles máx)
  // =========================
  const cat=(name,parentId,color)=>({id:uuid(),name,parentId:parentId||null,active:true,color});
  const C=[];

  // Ingresos
  const cInc=cat("Ingresos",null,"#10b981");C.push(cInc);
  const cSal=cat("Salario",cInc.id,"#22c55e");C.push(cSal);
  const cFre=cat("Freelance",cInc.id,"#34d399");C.push(cFre);
  const cInt=cat("Intereses",cInc.id,"#86efac");C.push(cInt);
  const cOp=cat("Saldo inicial",cInc.id,"#22c55e");C.push(cOp);

  // Gastos
  const cExp=cat("Gastos",null,"#ef4444");C.push(cExp);

  const cHome=cat("Vivienda",cExp.id,"#f97316");C.push(cHome);
  const cSrv=cat("Servicios Públicos",cHome.id,"#fb923c");C.push(cSrv);
  const cEle=cat("Electricidad",cSrv.id,"#f59e0b");C.push(cEle);
  const cNet=cat("Internet",cSrv.id,"#fdba74");C.push(cNet);
  const cWater=cat("Agua",cSrv.id,"#fed7aa");C.push(cWater);
  const cRent=cat("Renta / Hipoteca",cHome.id,"#fb7185");C.push(cRent);

  const cSup=cat("Supermercado",cExp.id,"#f43f5e");C.push(cSup);
  const cFood=cat("Alimentos",cSup.id,"#fb7185");C.push(cFood);
  const cHyg=cat("Hogar / Limpieza",cSup.id,"#fda4af");C.push(cHyg);
  const cPets=cat("Mascotas",cSup.id,"#fecdd3");C.push(cPets);

  const cRest=cat("Restaurantes",cExp.id,"#ef4444");C.push(cRest);
  const cTrans=cat("Transporte",cExp.id,"#ec4899");C.push(cTrans);
  const cMed=cat("Médicos",cExp.id,"#a78bfa");C.push(cMed);

  const cEnt=cat("Entretenimiento",cExp.id,"#22c55e");C.push(cEnt);
  const cSub=cat("Suscripciones",cEnt.id,"#4ade80");C.push(cSub);
  const cOut=cat("Cine / Salidas",cEnt.id,"#86efac");C.push(cOut);

  const cEdu=cat("Educación",cExp.id,"#60a5fa");C.push(cEdu);

  const cBan=cat("Bancarios",cExp.id,"#111827");C.push(cBan);
  const cFees=cat("Comisiones",cBan.id,"#374151");C.push(cFees);
  const cTax=cat("Impuestos / Seguros",cBan.id,"#4b5563");C.push(cTax);

  const cOther=cat("Otros",cExp.id,"#9ca3af");C.push(cOther);
  const cGift=cat("Regalos / Donaciones",cOther.id,"#d1d5db");C.push(cGift);

  // Ahorros (categorías para el módulo)
  const cSav=cat("Ahorros",null,"#3b82f6");C.push(cSav);
  const cEmer=cat("Fondo de emergencia",cSav.id,"#60a5fa");C.push(cEmer);
  const cGoals=cat("Metas",cSav.id,"#93c5fd");C.push(cGoals);
  const cTrip=cat("Viajes",cSav.id,"#bfdbfe");C.push(cTrip);
  const cInv=cat("Inversiones",cSav.id,"#a5b4fc");C.push(cInv);

  state.categories.push(...C);

  // =========================
  // Helpers
  // =========================
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const pick=(arr)=>arr[rand(0,arr.length-1)];
  const mkDate=(per,day)=>`${per}-${String(day).padStart(2,"0")}`;

  // =========================
  // Saldos iniciales (no cuentan como ingreso KPI)
  // =========================
  const openDate=(()=>{
    const now=new Date();
    return `${now.getFullYear()}-01-01`;
  })();

  const open=(acc,amt,cur)=>{
    state.movements.push({
      id:uuid(),type:"Ingreso",isSystem:true,isOpening:true,
      date:openDate,period:openDate.slice(0,7),
      accountId:acc.id,accountToId:null,
      categoryId:cOp.id,amount:roundMoney(amt,cur||acc.currency||b),
      currency:(cur||acc.currency||b),
      rateToBase: (cur && cur!==b) ? (fxRateAt(cur,openDate)||fxRate(cur)||1) : 1,
      amountBase: (cur && cur!==b) ? roundMoney(toBase(amt,cur,(fxRateAt(cur,openDate)||fxRate(cur)||1)),b) : roundMoney(amt,b),
      desc:"(Sistema) Saldo inicial"
    });
  };
  open(bankCRC, 1450000, "CRC");
  open(bank2CRC, 390000, "CRC");
  open(wallet, 65000, "CRC");
  open(cardCRC, 0, "CRC");
  open(bankUSD, 850, "USD");
  open(cardUSD, 120, "USD");
  open(invCRC, 500000, "CRC");

  // =========================
  // Presupuestos (recurrentes + algunos específicos)
  // =========================
  const now=new Date();
  const start=new Date(now.getFullYear(), now.getMonth()-23, 1);
  const months=[];
  for(let i=0;i<24;i++){
    const d=new Date(start.getFullYear(), start.getMonth()+i, 1);
    months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`);
  }
  const from=months[0];

  const budRec=(type,catId,amt)=>state.budgets.push({id:uuid(),period:"",isRecurring:true,periodFrom:from,periodTo:"",type,categoryId:catId,amount:amt});
  budRec("Gasto", cEle.id, 26000);
  budRec("Gasto", cNet.id, 32000);
  budRec("Gasto", cWater.id, 9000);
  budRec("Gasto", cRent.id, 210000);
  budRec("Gasto", cTrans.id, 65000);
  budRec("Gasto", cFood.id, 220000);
  budRec("Gasto", cRest.id, 80000);
  budRec("Gasto", cSub.id, 18000);
  budRec("Gasto", cMed.id, 25000);
  budRec("Gasto", cTax.id, 20000);
  budRec("Ingreso", cSal.id, 900000);

  // presupuestos específicos por mes (para tener mucha data)
  for(const per of months){
    state.budgets.push({id:uuid(),period:per,isRecurring:false,periodFrom:"",periodTo:"",type:"Gasto",categoryId:cFood.id,amount:rand(190000,280000)});
    state.budgets.push({id:uuid(),period:per,isRecurring:false,periodFrom:"",periodTo:"",type:"Gasto",categoryId:cTrans.id,amount:rand(45000,95000)});
    state.budgets.push({id:uuid(),period:per,isRecurring:false,periodFrom:"",periodTo:"",type:"Gasto",categoryId:cRest.id,amount:rand(55000,110000)});
    if(Math.random()<0.40) state.budgets.push({id:uuid(),period:per,isRecurring:false,periodFrom:"",periodTo:"",type:"Gasto",categoryId:cMed.id,amount:rand(15000,45000)});
  }

  // sobrescribir un mes (ej: diciembre más alto en regalos)
  const dec = months.find(p=>p.endsWith("-12"));
  if(dec){
    state.budgets.push({id:uuid(),period:dec,isRecurring:false,periodFrom:"",periodTo:"",type:"Gasto",categoryId:cGift.id,amount:120000});
  }

  // =========================
  // Recurrentes (plantillas)
  // =========================
  state.recurrings = [
    {id:uuid(),name:"Salario",type:"Ingreso",active:true,accountId:bankCRC.id,accountToId:null,categoryId:cSal.id,amount:900000,day:1,regOffset:0,startPeriod:from,endPeriod:null,desc:"Salario mensual"},
    {id:uuid(),name:"Luz",type:"Gasto",active:true,accountId:bankCRC.id,accountToId:null,categoryId:cEle.id,amount:26000,day:5,regOffset:0,startPeriod:from,endPeriod:null,desc:"Servicio eléctrico"},
    {id:uuid(),name:"Internet",type:"Gasto",active:true,accountId:bankCRC.id,accountToId:null,categoryId:cNet.id,amount:32000,day:8,regOffset:0,startPeriod:from,endPeriod:null,desc:"Internet hogar"},
    {id:uuid(),name:"Suscripciones",type:"Gasto",active:true,accountId:cardCRC.id,accountToId:null,categoryId:cSub.id,amount:18000,day:12,regOffset:0,startPeriod:from,endPeriod:null,desc:"Streaming / apps"},
    {id:uuid(),name:"Pago tarjeta CRC",type:"Transferencia",active:true,accountId:bankCRC.id,accountToId:cardCRC.id,categoryId:cFees.id,amount:180000,day:28,regOffset:-1,startPeriod:from,endPeriod:null,desc:"Pago tarjeta (registro mes anterior)"}
  ];

  // =========================
  // Movimientos masivos
  // =========================
  const fxUSD = fxRateAt("USD", openDate) || fxRate("USD") || 520;

  const addMov=(m)=>{ state.movements.push(m); };

  // helpers ahorro/ retiro (crea logical + transferencia sistema)
  const savIdCRC=state.config.savingsAccountId;
  const savIdUSD=state.config.savingsAccountIdUSD;

  const addAhorro=(date,period,fromAccId,cur,amt,catId,desc)=>{
    const needsFx = cur!==b;
    const r = needsFx ? (fxRateAt(cur,date)||fxRate(cur)||1) : 1;
    const baseAmt = needsFx ? roundMoney(toBase(amt,cur,r),b) : roundMoney(amt,b);
    const logical=uuid(), transfer=uuid();
    const savId = (cur==="USD") ? savIdUSD : savIdCRC;

    addMov({id:logical,date,period,type:"Ahorro",accountId:fromAccId,accountToId:savId,categoryId:catId,amount:roundMoney(amt,cur),currency:cur,rateToBase:r,amountBase:baseAmt,desc,isSystem:false,linkedTransferId:transfer});
    addMov({id:transfer,date,period,type:"Transferencia",accountId:fromAccId,accountToId:savId,categoryId:catId,amount:roundMoney(amt,cur),currency:cur,rateToBase:r,amountBase:baseAmt,currencyTo:cur,rateToBaseTo:r,amountTo:roundMoney(amt,cur),desc:`(Sistema) Transferencia por Ahorro • ${catPath(catId)||'—'}`,isSystem:true,linkedTo:logical});
  };

  const addRetiro=(date,period,toAccId,cur,amt,catId,desc)=>{
    const needsFx = cur!==b;
    const r = needsFx ? (fxRateAt(cur,date)||fxRate(cur)||1) : 1;
    const baseAmt = needsFx ? roundMoney(toBase(amt,cur,r),b) : roundMoney(amt,b);
    const logical=uuid(), transfer=uuid();
    const savId = (cur==="USD") ? savIdUSD : savIdCRC;

    addMov({id:logical,date,period,type:"RetiroAhorro",accountId:savId,accountToId:toAccId,categoryId:catId,amount:roundMoney(amt,cur),currency:cur,rateToBase:r,amountBase:baseAmt,desc,isSystem:false,linkedTransferId:transfer});
    addMov({id:transfer,date,period,type:"Transferencia",accountId:savId,accountToId:toAccId,categoryId:catId,amount:roundMoney(amt,cur),currency:cur,rateToBase:r,amountBase:baseAmt,currencyTo:cur,rateToBaseTo:r,amountTo:roundMoney(amt,cur),desc:`(Sistema) Transferencia por RetiroAhorro • ${catPath(catId)||'—'}`,isSystem:true,linkedTo:logical});
  };

  const expCats=[cEle.id,cNet.id,cWater.id,cRent.id,cFood.id,cHyg.id,cPets.id,cRest.id,cTrans.id,cMed.id,cSub.id,cEdu.id,cFees.id,cTax.id,cGift.id,cOther.id];
  const splitCats=[cFood.id,cHyg.id,cPets.id,cOther.id];

  for(const per of months){
    // salario
    addMov({id:uuid(),date:mkDate(per,1),period:per,type:"Ingreso",accountId:bankCRC.id,accountToId:null,categoryId:cSal.id,amount:900000,desc:"Salario",isSystem:false});

    // freelance algunos meses
    if(Math.random()<0.45){
      addMov({id:uuid(),date:mkDate(per,rand(10,20)),period:per,type:"Ingreso",accountId:bankCRC.id,accountToId:null,categoryId:cFre.id,amount:rand(80000,260000),desc:"Freelance",isSystem:false});
    }

    // intereses ocasional
    if(Math.random()<0.25){
      addMov({id:uuid(),date:mkDate(per,rand(2,8)),period:per,type:"Ingreso",accountId:invCRC.id,accountToId:null,categoryId:cInt.id,amount:rand(5000,18000),desc:"Intereses",isSystem:false});
    }

    // gastos masivos (80-130)
    const n=rand(95,140);
    for(let i=0;i<n;i++){
      const day=rand(1,28);
      const date=mkDate(per,day);

      const useUsd=Math.random()<0.20;
      if(useUsd){
        const amt=roundMoney(rand(3,160) + (Math.random()<0.35?0.99:0), "USD");
        addMov({
          id:uuid(),date,period:per,type:"Gasto",
          accountId:cardUSD.id,accountToId:null,categoryId:pick([cRest.id,cTrans.id,cMed.id,cEnt.id,cEdu.id,cOther.id]),
          amount:amt,currency:"USD",rateToBase:fxUSD,amountBase:roundMoney(toBase(amt,"USD",fxUSD),b),
          desc:"Gasto USD",isSystem:false
        });
      }else{
        const acc=pick([bankCRC.id,bank2CRC.id,wallet.id,cardCRC.id]);
        const catId=pick(expCats);
        const amt=rand(1000,120000);
        addMov({id:uuid(),date,period:per,type:"Gasto",accountId:acc,accountToId:null,categoryId:catId,amount:amt,desc:"Gasto",isSystem:false});
      }
    }

    // splits de supermercado (6 por mes)
    for(let k=0;k<6;k++){
      const day=rand(1,28);
      const date=mkDate(per,day);
      const acc=pick([bankCRC.id,cardCRC.id]);
      const total=rand(25000,110000);
      const parts=[];
      let remaining=total;
      for(let j=0;j<3;j++){
        const a = (j===2) ? remaining : rand(5000, Math.max(6000, Math.floor(remaining*0.6)));
        remaining -= a;
        parts.push({categoryId: splitCats[j%splitCats.length], amount:a, desc:""});
      }
      if(remaining>0) parts.push({categoryId: splitCats[3], amount:remaining, desc:""});
      const rateFrom=1;
      const norm = normalizeSplits(parts, total, "CRC", rateFrom);
      addMov({
        id:uuid(),date,period:per,type:"Gasto",
        accountId:acc,accountToId:null,categoryId:null,
        amount:total,desc:"Supermercado (Split)",isSystem:false,
        splits:norm
      });
    }

    // transferencias recurrentes varias
    // retiro de efectivo
    if(Math.random()<0.55){
      addMov({id:uuid(),date:mkDate(per,rand(5,12)),period:per,type:"Transferencia",accountId:bankCRC.id,accountToId:wallet.id,categoryId:cFees.id,amount:rand(10000,60000),amountTo:null,desc:"Retiro efectivo",isSystem:false});
    }
    // pago tarjeta
    if(Math.random()<0.75){
      addMov({id:uuid(),date:mkDate(per,rand(23,28)),period:per,type:"Transferencia",accountId:bankCRC.id,accountToId:cardCRC.id,categoryId:cFees.id,amount:rand(120000,260000),amountTo:null,desc:"Pago tarjeta",isSystem:false});
    }
    // compra USD desde banco CRC hacia banco USD (muestra multi-moneda)
    if(Math.random()<0.35){
      const crcAmt=rand(50000,220000);
      const usdAmt=roundMoney(fromBase(crcAmt,"USD",fxUSD),"USD");
      addMov({id:uuid(),date:mkDate(per,rand(12,24)),period:per,type:"Transferencia",accountId:bankCRC.id,accountToId:bankUSD.id,categoryId:cFees.id,amount:crcAmt,currency:"CRC",rateToBase:1,amountBase:crcAmt,currencyTo:"USD",rateToBaseTo:fxUSD,amountTo:usdAmt,desc:"Compra USD",isSystem:false});
    }

    // ahorros (2-4 por mes)
    addAhorro(mkDate(per,5),per,bankCRC.id,"CRC",rand(15000,45000),pick([cEmer.id,cGoals.id,cTrip.id,cInv.id]),"Ahorro mensual");
    if(Math.random()<0.65) addAhorro(mkDate(per,18),per,bankCRC.id,"CRC",rand(8000,25000),pick([cGoals.id,cTrip.id]),"Ahorro extra");

    // ahorros USD ocasional
    if(Math.random()<0.35){
      addAhorro(mkDate(per,22),per,bankUSD.id,"USD",roundMoney(rand(10,80),"USD"),pick([cGoals.id,cTrip.id]),"Ahorro USD");
    }

    // retiros cada 4 meses (CRC)
    const mNum=parseInt(per.slice(5),10);
    if(mNum%4===0){
      addRetiro(mkDate(per,20),per,wallet.id,"CRC",rand(25000,90000),pick([cGoals.id,cTrip.id]),"Uso de ahorro");
    }
  }

  // =========================
  // Conciliaciones demo (últimos 3 meses banco CRC)
  // =========================
  const last3 = months.slice(-3);
  for(const ym of last3){
    const startAmt = rand(800000,1200000);
    const endAmt = startAmt + rand(-150000,120000);
    recUpsert(bankCRC.id, ym, startAmt, endAmt, false);
  }

  // marcar conciliados algunos movimientos del último mes (solo para mostrar)
  const last = months.at(-1);
  const mids = state.movements.filter(m=>m && m.period===last && (m.accountId===bankCRC.id || m.accountToId===bankCRC.id)).slice(0,35);
  for(const m of mids){
    m.reconciled=true;
    m.reconMonth=last;
    m.reconciledAt=new Date().toISOString();
  }

  normalizeCurrencyModel();
  logEvent("demo","system",null,`Demo grande cargada (${state.movements.length} movimientos)`);
  save();
  toast("Demo grande cargada.","success");
  render(state.ui.route);
}

// ----- Help texts (botón en modal) -----
const HELP={
  global:{
    title:"Ayuda general",
    body:`
      <p class="mb-2"><b>Sistema de Gestión Financiera</b> organiza tu información en: <b>Cuentas</b>, <b>Categorías</b>, <b>Movimientos</b>, <b>Ahorros</b> y <b>Presupuesto</b>.</p>

      <div class="alert alert-warning border-0 mb-3" style="background:rgba(245,158,11,.12)">
        <b>Periodo contable</b> (mes/año) puede ser distinto a la <b>fecha</b> real del registro.
        <div class="small text-secondary mt-1">Ejemplo: fecha 31/01 pero periodo 02/2026.</div>
      </div>

      <h6 class="mb-2">Guía rápida</h6>
      <ol class="mb-3">
        <li><b>Cuentas</b> y <b>Categorías</b>: TreeView tipo Explorador (hasta 3 niveles).</li>
        <li><b>Movimientos</b>: solo <b>Ingreso</b>, <b>Gasto</b> y <b>Transferencia</b>.</li>
        <li><b>Ahorros</b>: crear ahorro/retirar (usa la cuenta especial <b>Ahorros (SGF)</b>). Requiere categoría.</li>
        <li><b>Presupuesto</b>: permite <b>recurrente mensual</b> y <b>override</b> por mes; usa barras de progreso.</li>
        <li><b>Reportes</b>: resumen, detalle y presupuesto. Puedes ocultar movimientos del sistema.</li>
        <li><b>Configuración</b>: moneda base, tipos de cambio, backup JSON, demo grande y reset.</li>
      </ol>
`
  },
  dashboard:{title:"Ayuda — Dashboard",body:`Filtros por <b>periodo contable</b>. KPIs + estado del periodo (consolidado en moneda base).`},
  accounts:{title:"Ayuda — Cuentas",body:`Árbol estilo Explorer. Máximo <b>3 niveles</b>. Cada cuenta tiene <b>moneda</b> (si tiene padre, hereda).`},
  reconciliation:{title:"Ayuda — Conciliación mensual",body:`
<p class="mb-2">La <b>Conciliación mensual</b> compara el saldo y los movimientos del sistema contra tu <b>extracto bancario</b> para una <b>cuenta</b> y un <b>mes</b>. Sirve para detectar movimientos faltantes, duplicados o con montos incorrectos.</p>

<h6 class="mt-2">Flujo recomendado</h6>
<ol class="mb-2">
  <li>En <b>Cuentas</b>, abre el <b>detalle</b> de la cuenta y baja a <b>Conciliación mensual</b>.</li>
  <li>Elige el <b>Mes a conciliar</b>. La conciliación se basa en la <b>fecha real</b> del movimiento (lo que ve el banco), no en el periodo contable.</li>
  <li>Ingresa los <b>saldos del extracto</b>: <b>Saldo inicial</b> y <b>Saldo final</b> (en la moneda de la cuenta).</li>
  <li>Revisa la lista de movimientos del mes y marca con el <b>check</b> los que sí aparecen en el extracto.</li>
  <li>La pantalla calcula el <b>Neto conciliado</b>, el <b>Neto pendiente</b> y la <b>Diferencia</b> con el extracto. Ajusta (o crea/edita) movimientos hasta que la diferencia sea <b>0</b>.</li>
  <li>Cuando esté en 0, usa <b>Cerrar mes</b> para dejar trazabilidad. Luego puedes abrir otro mes y repetir.</li>
</ol>

<div class="alert alert-info py-2 mb-2">
  <b>Importante:</b> La conciliación <u>no cambia</u> los movimientos automáticamente; solo te ayuda a marcar/validar. Si algo no cuadra, debes <b>crear</b>, <b>editar</b> o <b>eliminar</b> el movimiento correspondiente.
</div>

<h6 class="mt-2">Buenas prácticas</h6>
<ul class="mb-0">
  <li><b>Periodo contable vs Fecha:</b> el banco usa fecha; el SGF permite que un movimiento pertenezca a otro periodo. En conciliación manda la <b>fecha</b>.</li>
  <li><b>Transferencias:</b> verifica ambos lados (origen y destino). En multi‑moneda, revisa el equivalente.</li>
  <li><b>Tarjetas:</b> si el extracto es por corte (no calendario), elige el mes que mejor represente el periodo o registra movimientos con la fecha real del estado.</li>
  <li><b>Cierre:</b> cerrar mes es una marca de control. Si necesitas corregir, puedes editar movimientos y volver a conciliar.</li>
</ul>
`},
  categories:{title:"Ayuda — Categorías",body:`Árbol estilo Explorer. Máximo <b>3 niveles</b>. Usa colores para identificar.`},
  movements:{title:"Ayuda — Movimientos",body:`Solo registra <b>Ingreso</b>, <b>Gasto</b> y <b>Transferencia</b>. <b>Fecha</b> ≠ <b>Periodo</b>. No permite saldos negativos.<div class="mt-2"><b>Split de gastos:</b> en un <b>Gasto</b> puedes usar <b>Dividir</b> para repartir el monto en varias categorías. Esto impacta <b>Presupuesto</b> y <b>Reportes</b>.</div>`},
  savings:{title:"Ayuda — Ahorros",body:`Registra <b>Ahorro</b> (a Ahorros SGF) y <b>Retiro</b> (desde Ahorros SGF). Categoría requerida. Al crear ahorro verás el <b>saldo disponible</b> de la cuenta seleccionada.`},
  budgets:{title:"Ayuda — Presupuesto",body:`Selecciona un <b>periodo</b> para ver el <b>Real</b> y la <b>barra de progreso</b>. Puedes crear presupuestos <b>recurrentes</b> (mensuales) y presupuestos específicos por mes (override).`},
  reports:{title:"Ayuda — Reportes",body:`<b>Filtros generales</b><br>
• <b>Año</b>/<b>Mes</b> filtran los reportes mensuales. En vistas de 12 meses, <b>Mes</b> es el “mes final” de la serie (si lo dejas vacío usa el mes actual).<br>
• Los montos se muestran en <b>moneda base</b> (CRC por defecto), excepto <b>Estado de cuenta</b> que usa la moneda de la cuenta.<br>
• Se excluyen movimientos <i>Sistema</i> y <i>Saldo inicial</i> en los reportes de análisis (Cashflow/Tendencias/Pro).<br>
• Los <b>splits</b> de gastos se reparten por categoría y se reflejan en Presupuesto y Reportes.<br><br>

<b>Pro (Pivot 12 meses)</b><br>
• Pivot por <b>categoría</b> (filas) y <b>mes</b> (columnas), agrupado en <b>Ingresos</b>, <b>Gastos</b> y <b>Ahorros (neto)</b>.<br>
• <b>Tipo</b> limita a Ingreso/Gasto/Ahorro/Retiro. Transferencias no se incluyen (no tienen categoría).<br>
• <b>Categoría raíz</b> incluye automáticamente subcategorías. <b>Texto</b> busca en ruta de categoría y descripción.<br><br>

<b>Cashflow (12 meses)</b><br>
• Resumen mensual: <b>Ingresos</b>, <b>Gastos</b>, <b>Ahorros neto</b>, <b>Flujo neto</b> y <b>Disponible</b>.<br>
• Ahorros neto = Ahorros − Retiros.<br><br>

<b>Tendencias (12 meses)</b><br>
• Selecciona <b>Alcance</b> (Raíz o Categoría) y <b>Métrica</b> (Gastos/Ingresos/Ahorros neto).<br>
• Muestra serie mensual y comparativos: <b>Promedio 3m</b> vs <b>Promedio 12m</b> y variación.<br>
• Si la métrica es Gastos o Ingresos, también calcula <b>Presupuesto</b> y <b>Diferencia</b>.<br><br>

<b>Estado de cuenta</b><br>
• Elige <b>Cuenta</b> y <b>Rango de fechas</b>. Puedes filtrar por texto/tipo e <b>agrupar</b> (día/mes/sin agrupar).<br>
• Muestra <b>saldo acumulado</b> y resalta transferencias con la contra-cuenta. Si la cuenta es USD, muestra un equivalente a base (informativo).<br><br>

<b>Presupuesto vs Real (Raíz)</b><br>
• Tabla por mes. Click en una <b>raíz</b> para ver subcategorías (nivel 2) y luego nivel 3 (drill‑down).<br>
• <b>Gastos:</b> Diferencia = Presupuesto − Real (positivo = mejor).<br>
• <b>Ingresos:</b> Diferencia = Real − Presupuesto (positivo = mejor).<br><br>

<b>Resumen / Detalle</b><br>
• Resumen agrupa por Cuenta+Categoría; Detalle lista movimientos. Útil para auditoría rápida.<br><br>

<b>Conciliación</b><br>
• Por mes y cuenta: Final (EC), Final (Ledger), Diferencia y No conciliados. Diferencia = Estado de cuenta final − Ledger calculado.<br><br>

<b>Exportar CSV</b><br>
• Descarga CSV de Movimientos/Ahorros/Presupuestos/Conciliaciones y reportes (Pivot, Cashflow, Tendencias, Presupuesto vs Real).<br>
• En Movimientos, los <i>splits</i> se exportan como filas separadas para análisis.`},
  settings:{title:"Ayuda — Configuración",body:`Moneda base, tipos de cambio por defecto, export/import JSON, demo grande y reset.`}
};

// ----- Boot -----

/* --- AUTH (local) --- */
const AUTH_SESSION_KEY = "sgf_auth_ok_v1";
const AUTH_MIN_LEN = 4;

function authGet(){
  // 1) Si ya está cargado en memoria
  try{
    state.config = state.config || {};
    if(state.config.auth) return state.config.auth;
  }catch{}

  // 2) Pre-boot: leer auth desde localStorage (para no pedir setup siempre)
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const d = JSON.parse(raw);
      const cfg = d?.config || d?.[STORAGE_KEY]?.config || null;
      const a = cfg?.auth || null;
      if(a){
        try{ state.config = state.config || {}; state.config.auth = a; }catch{}
        return a;
      }
    }
  }catch{}
  return null;
}
function authSet(a){
  state.config = state.config || {};
  state.config.auth = a;
  save();
}

async function sha256hex(text){
  try{
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }catch{
    let h=2166136261;
    for(let i=0;i<text.length;i++){ h ^= text.charCodeAt(i); h = Math.imul(h, 16777619); }
    return ("00000000"+(h>>>0).toString(16)).slice(-8).repeat(8);
  }
}

function authOverlayHtml(mode){
  const isSetup = mode==="setup";
  const title = isSetup ? "Crear acceso" : "Iniciar sesión";
  const sub = isSetup ? "Defina usuario y contraseña para usar SGF en este dispositivo."
                      : "Ingrese sus credenciales para continuar.";
  const extra = isSetup
    ? `<div class="small text-secondary">Esto es <b>local</b> (se guarda en este navegador).</div>`
    : `<div class="small text-secondary">Si olvidó la contraseña, deberá restablecerla borrando los datos del navegador (localStorage) de esta app.</div>`;

  return `<div class="auth-overlay" id="authOV">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-title">${esc(title)}</div>
        <div class="auth-sub">${sub}</div>
      </div>
      <div class="auth-body">
        <div>
          <label class="form-label">Usuario</label>
          <input class="form-control" id="authUser" autocomplete="username" maxlength="60" placeholder="Ej: admin">
        </div>
        <div>
          <label class="form-label">Contraseña</label>
          <input class="form-control" id="authPass" type="password" autocomplete="${isSetup?'new-password':'current-password'}" maxlength="200" placeholder="••••••••">
        </div>
        ${isSetup ? `<div>
          <label class="form-label">Confirmar contraseña</label>
          <input class="form-control" id="authPass2" type="password" autocomplete="new-password" maxlength="200" placeholder="••••••••">
        </div>` : ``}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="authRemember" ${isSetup?'checked':''}>
          <label class="form-check-label" for="authRemember">Mantener sesión en esta pestaña</label>
        </div>
        ${extra}
      </div>
      <div class="auth-msg" id="authMsg"></div>
      <div class="auth-actions">
        <button class="btn btn-dark" type="button" id="authOk"><i class="bi bi-shield-lock"></i> ${isSetup?'Guardar':'Entrar'}</button>
      </div>
    </div>
  </div>`;
}

function authShow(mode){
  try{ document.getElementById("authOV")?.remove(); }catch{}
  document.body.insertAdjacentHTML("beforeend", authOverlayHtml(mode));

  const msgEl = document.getElementById("authMsg");
  const say = (kind, text)=>{
    if(!msgEl) return;
    const cls = kind==="danger" ? "alert-danger" : (kind==="warning" ? "alert-warning" : "alert-success");
    msgEl.innerHTML = `<div class="alert ${cls} border-0 m-0" style="background:rgba(2,6,23,.06)">${text}</div>`;
  };

  const okBtn = document.getElementById("authOk");
  const uEl = document.getElementById("authUser");
  const pEl = document.getElementById("authPass");
  const p2El = document.getElementById("authPass2");
  const remEl = document.getElementById("authRemember");

  const cur = authGet();
  if(mode==="login" && (!cur || !cur.enabled)) return authShow("setup");

  okBtn.onclick = async ()=>{
    const user = (uEl.value||"").trim();
    const pass = (pEl.value||"").trim();
    const remember = !!remEl?.checked;

    if(user.length < 1){ say("warning","Ingrese el <b>Usuario</b>."); return; }
    if(pass.length < AUTH_MIN_LEN){ say("warning",`La <b>Contraseña</b> debe tener al menos ${AUTH_MIN_LEN} caracteres.`); return; }

    if(mode==="setup"){
      const pass2 = (p2El.value||"").trim();
      if(pass !== pass2){ say("warning","La confirmación de contraseña no coincide."); return; }

      const salt = crypto?.getRandomValues
        ? Array.from(crypto.getRandomValues(new Uint8Array(12))).map(b=>b.toString(16).padStart(2,"0")).join("")
        : String(Date.now());
      const passHash = await sha256hex(`${salt}:${pass}`);
      authSet({ enabled:true, user, salt, passHash, updatedAt: new Date().toISOString() });

      if(remember) sessionStorage.setItem(AUTH_SESSION_KEY,"1");
      say("success","Acceso guardado. Ingresando...");
      setTimeout(()=>{ document.getElementById("authOV")?.remove(); bootAfterAuth(); }, 250);
      return;
    }

    const a = authGet();
    const ok = a && a.enabled && (user === a.user) && ((await sha256hex(`${a.salt}:${pass}`)) === a.passHash);
    if(!ok){ say("danger","Credenciales inválidas."); return; }

    if(remember) sessionStorage.setItem(AUTH_SESSION_KEY,"1");
    say("success","Ingresando...");
    setTimeout(()=>{ document.getElementById("authOV")?.remove(); bootAfterAuth(); }, 200);
  };

  [uEl,pEl,p2El].filter(Boolean).forEach(el=>{
    el.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter"){ okBtn.click(); }});
  });

  setTimeout(()=>{ (uEl?.value? pEl : uEl)?.focus(); }, 60);
}

function authGate(){
  const a = authGet();
  if(!a || !a.enabled){ authShow("setup"); return true; }
  const ok = sessionStorage.getItem(AUTH_SESSION_KEY)==="1";
  if(!ok){ authShow("login"); return true; }
  return false;
}


function authLogout(){
  try{ sessionStorage.removeItem(AUTH_SESSION_KEY); }catch{}
  try{ document.getElementById("authOV")?.remove(); }catch{}
  try{ authShow("login"); }catch{ location.reload(); }
}


function bootAfterAuth(){ /* asignado por boot() */ }



function boot(){
  try{ bootAfterAuth = bootCore; }catch{}
  try{ if(authGate()) return; }catch{}
  bootCore();
}


function bootCore(){
  buildNav();loadCollapsed();
  const ok=load(); if(!ok){ensureSavingsAccount();save();}
  applyTheme(state.config?.theme);
  applyNavLayout(state.config?.navLayout);
  // start collapsed by default
  if(!localStorage.getItem(COLL_KEYS.acc)){const parents=new Set(state.accounts.map(x=>x.parentId).filter(Boolean));parents.forEach(id=>state.ui.accCol.add(id));}
  if(!localStorage.getItem(COLL_KEYS.cat)){const parents=new Set(state.categories.map(x=>x.parentId).filter(Boolean));parents.forEach(id=>state.ui.catCol.add(id));}
  saveCollapsed();
  go("dashboard");
}

try{ boot(); }
catch(e){
  try{ console.error(e); }catch{}
  try{
    const details = String(e && (e.stack || e.message) || e);
    const escHtml = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    document.body.innerHTML = `<div style="padding:20px;font-family:system-ui;max-width:980px;margin:0 auto">
      <h2 style="margin:0 0 8px">SGF — Error de arranque</h2>
      <div style="margin:0 0 12px;color:#555">Ocurrió un error al iniciar la aplicación. Revisa el detalle abajo.</div>
      <pre style="white-space:pre-wrap;background:#f6f7f9;border:1px solid #e5e7eb;padding:12px;border-radius:10px;overflow:auto">${escHtml(details)}</pre>
      <div style="margin-top:12px;color:#555">
        Sugerencias rápidas:
        <ul style="margin:6px 0 0 18px">
          <li>Recarga dura (Ctrl+F5) o abre en incógnito.</li>
          <li>Si vienes de una versión rota, borra el LocalStorage del sitio (clave: <code>sgf_v1_0</code>).</li>
        </ul>
      </div>
    </div>`;
  }catch{}
  try{ alert("SGF: error al iniciar. Revisa consola para detalle."); }catch{}
}



let __crashShown=false;
window.addEventListener("error",(ev)=>{
  try{
    if(__crashShown) return;
    __crashShown=true;
    console.error(ev.error||ev.message||ev);
    msg({title:"Error inesperado",kind:"danger",body:"Ocurrió un error. Recomendación: <b>Exporta</b> tu información y recarga la página. Si persiste, limpia datos del sitio o usa otro navegador."});
  }catch{}
});
window.addEventListener("unhandledrejection",(ev)=>{
  try{
    if(__crashShown) return;
    __crashShown=true;
    console.error(ev.reason||ev);
    msg({title:"Error inesperado",kind:"danger",body:"Ocurrió un error (promesa). Recomendación: <b>Exporta</b> tu información y recarga la página."});
  }catch{}
});
  </script>

  <!-- Small UI bridge: topbar title + quick buttons -->
  <script>
  (function(){
    const MAP={
      dashboard:{t:"Sistema de Gestión Financiera",c:"KPIs • Resumen"},
      accounts:{t:"Cuentas",c:"Treeview • Detalle • Saldos"},
      categories:{t:"Categorías",c:"Jerarquía (3 niveles) • Colores • Validaciones"},
      movements:{t:"Movimientos",c:"Ingreso / Gasto / Transferencia • Splits • Filtros"},
      reconciliations:{t:"Conciliaciones",c:"Resumen por cuenta/mes • Cierre • Export"},
      savings:{t:"Ahorros",c:"Aportes / retiros • Saldos por moneda"},
      budgets:{t:"Presupuestos",c:"Plan vs real • Recurrente mensual"},
      reports:{t:"Reportes",c:"Pivot • Cashflow • Tendencias • Estado"},
      settings:{t:"Configuración",c:"Tema • Moneda base • FX • Backups"}
    };
    function upd(k){
      const t=document.getElementById("pageTitle");
      const c=document.getElementById("pageCrumb");
      const r=MAP[k]||{t:"SGF",c:""};
      if(t) t.textContent="Sistema de Gestión Financiera";
      if(c) c.textContent=r.c;
    }
    try{
      const _go=window.go;
      if(typeof _go==="function"){
        window.go=function(k){ _go(k); upd(k); };
      }
      upd(window.state?.ui?.route||"dashboard");
    }catch(e){}

    const qa=document.getElementById("btnQuickAdd");
    if(qa) qa.addEventListener("click",()=>{ try{ window.go("movements"); window.movEdit?.(); }catch(e){ console.error(e); } });
    const sc=document.getElementById("btnShortcuts");
    if(sc) sc.addEventListener("click",()=>{ /* modal via data-bs-* */ });

    // Ctrl+K: rota finpro -> finsoft -> darkledger
    document.addEventListener("keydown",(ev)=>{
      if((ev.ctrlKey||ev.metaKey) && (ev.key==="k"||ev.key==="K")){
        ev.preventDefault();
        const t=(window.state?.config?.theme)||"finpro";
        const next=(t==="finpro")?"finsoft":(t==="finsoft")?"darkledger":"finpro";
        if(typeof window.setTheme==="function") window.setTheme(next);
      }
    });
  })();
  </script>

  <!-- Modal: Atajos -->
  <div class="modal fade sgf-modal" id="modalShortcuts" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title h5 m-0">Atajos</div>
            <div class="small text-muted">Acciones rápidas y teclas útiles</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-dark" type="button" data-bs-dismiss="modal" onclick="go('movements');movEdit();">
              <i class="bi bi-plus-circle"></i> Nuevo movimiento
            </button>
            <button class="btn btn-outline-dark" type="button" data-bs-dismiss="modal" onclick="go('reports');">
              <i class="bi bi-file-earmark-bar-graph"></i> Ver reportes
            </button>
            <button class="btn btn-outline-dark" type="button" data-bs-dismiss="modal" onclick="go('settings');">
              <i class="bi bi-gear"></i> Configuración
            </button>
            <button class="btn btn-outline-dark" type="button" data-bs-dismiss="modal" onclick="help('global');">
              <i class="bi bi-question-circle"></i> Ayuda
            </button>
            <div class="p-3 rounded-3" style="background:var(--panel2);border:1px solid var(--border)">
              <div class="fw-semibold mb-1"><i class="bi bi-keyboard"></i> Teclado</div>
              <div class="small text-muted mb-1"><span class="badge-soft">Ctrl + K</span> Cambiar tema</div>
              <div class="small text-muted"><span class="badge-soft">Esc</span> Cerrar modales</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-dark" type="button" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>


<script>
(function(){
  function initFiltersCollapse(){
    document.querySelectorAll('.filters-bar').forEach(function(el){
      if(el.dataset.collapseInit === '1') return;
      el.dataset.collapseInit = '1';

      var kids = Array.prototype.slice.call(el.children);
      if(kids.length < 2) return;

      var head = kids[0];
      var wrap = document.createElement('div');
      wrap.className = 'sgf-filters-collapsible';

      for(var i=1;i<kids.length;i++){ wrap.appendChild(kids[i]); }
      el.appendChild(wrap);

      // actions container (donde están Aplicar/Limpiar)
      var actions = head.querySelector('.d-flex.gap-2.flex-wrap') || head.querySelector('.d-flex.gap-2') || head;
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-outline-secondary sgf-filters-toggle';
      btn.title = 'Contraer/Expandir filtros';
      btn.innerHTML = '<i class="bi bi-chevron-up"></i>';
      actions.appendChild(btn);
      // estado inicial según clase
      (function(){
        var icon = btn.querySelector('i');
        var collapsed0 = el.classList.contains('sgf-filters-collapsed');
        if(icon) icon.className = collapsed0 ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
      })();

      btn.addEventListener('click', function(){
        var collapsed = el.classList.toggle('sgf-filters-collapsed');
        var icon = btn.querySelector('i');
        if(icon) icon.className = collapsed ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
      });
    });
  }

  // Observer para cuando SGF re-renderiza vistas
  var content = document.querySelector('section.content') || document.body;
  try{
    var mo = new MutationObserver(function(){ initFiltersCollapse(); });
    mo.observe(content, { childList:true, subtree:true });
  }catch(e){}

  document.addEventListener('DOMContentLoaded', initFiltersCollapse);
  window.addEventListener('hashchange', function(){ setTimeout(initFiltersCollapse, 0); });
  // por si SGF navega sin hashchange
  setTimeout(initFiltersCollapse, 200);
})();

// ===== Adjuntos (URLs) helpers =====
function normalizeAttachments(arr){
  if(!Array.isArray(arr)) return [];
  return arr.map(a=>({
    id: a?.id || uuid(),
    aType: String(a?.aType || a?.type || "url"),
    name: String(a?.name||""),
    url: String(a?.url||""),
    addedAt: a?.addedAt || new Date().toISOString()
  })).filter(a=>a.name||a.url);
}
function isAllowedAttachmentUrl(u){
  u = String(u||"").trim();
  if(!u) return true;
  const low = u.toLowerCase();
  // bloquear esquemas peligrosos
  if(low.startsWith("javascript:") || low.startsWith("data:") || low.startsWith("vbscript:")) return false;
  return true;
}
function normalizeOpenUrl(u){
  u = String(u||"").trim();
  if(!u) return "";
  const low = u.toLowerCase();
  if(low.startsWith("http://") || low.startsWith("https://") || low.startsWith("file://") || low.startsWith("mailto:")) return u;

  // Windows drive: C:\ruta\archivo.pdf  o  C:/ruta/archivo.pdf
  if(/^[a-zA-Z]:[\\/]/.test(u)){
    const p = u.replace(/\\/g,"/"); // C:/...
    return "file:///" + p;
  }

  // UNC path: \\server\share\file.pdf
  if(u.startsWith("\\\\")){
    const p = u.replace(/\\/g,"/"); // //server/share/...
    return "file:" + p;
  }

  // Unix absolute: /Users/... or /home/...
  if(u.startsWith("/")){
    return "file://" + u; // file:///...
  }

  // relativo o cualquier otra ruta: dejar que el navegador resuelva
  return u;
}
function openAttachmentUrl(u){
  if(!isAllowedAttachmentUrl(u)) return;
  const url = normalizeOpenUrl(u);
  try{ window.open(url, "_blank", "noopener,noreferrer"); }catch(e){}
}
function attView(movId){
  const m = state.movements.find(x=>x.id===movId);
  if(!m) return;
  const atts = normalizeAttachments(m.attachments||m.adjuntos||[]);
  const body = atts.length ? `<div class="d-grid gap-2">${
    atts.map(a=>`<div class="d-flex align-items-center gap-2 p-2 rounded border" style="border-color:var(--border)!important">
      <div class="flex-grow-1">
        <div class="fw-semibold">${esc(a.name||"(Sin nombre)")}</div>
        <div class="small text-secondary text-truncate">${esc(a.url||"")}</div>
      </div>
      <button class="btn btn-sm btn-outline-primary" type="button" onclick="openAttachmentUrl('${escAttr(a.url)}')"><i class="bi bi-box-arrow-up-right"></i></button>
    </div>`).join("")
  }</div>` : `<div class="text-secondary">Sin adjuntos.</div>`;
  editor({title:"Adjuntos", body, footer:`<button class="btn btn-outline-dark" data-bs-dismiss="modal">Cerrar</button>`});
}

</script>

</body>
</html>

